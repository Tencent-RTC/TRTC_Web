var __defProp=Object.defineProperty,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,i,r)=>i in e?__defProp(e,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[i]=r,__spreadValues=(e,i)=>{for(var r in i||(i={}))__hasOwnProp.call(i,r)&&__defNormalProp(e,r,i[r]);if(__getOwnPropSymbols)for(var r of __getOwnPropSymbols(i))__propIsEnum.call(i,r)&&__defNormalProp(e,r,i[r]);return e},__publicField=(e,i,r)=>__defNormalProp(e,"symbol"!=typeof i?i+"":i,r),layoutProperty={x:{required:!0,type:"number"},y:{required:!0,type:"number"},width:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},height:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},zIndex:{required:!0,type:"number"},fillMode:{required:!1,type:"string"},mirror:{required:!1,type:"boolean"},rotation:{required:!1,type:"number"},hidden:{required:!1,type:"boolean"}},canvasValidateRule=(e,i=!1)=>({type:"object",required:i,properties:{canvasColor:{required:!1,type:["string",CanvasGradient,CanvasPattern]},width:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},height:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},frameRate:{required:!1,type:"number",notLessThanZero:!0,min:1,max:60}},validate(i,r,t){const{RtcError:o,ErrorCode:a,ErrorCodeDictionary:s}=e.errorModule;if(!i)return;const{width:n,height:c}=i;if(n&&c&&n*c>8294400)throw new o({code:a.INVALID_PARAMETER,message:"The mix resolution cannot be set higher than 3840 * 2160."})}}),viewValidateRule=e=>({required:!1,type:["string",HTMLElement,null],validate(i,r,t){const{RtcError:o,ErrorCode:a,ErrorCodeDictionary:s}=e.errorModule;if(e.utils.isString(i)){if(!document.getElementById(i))throw new o({code:a.INVALID_PARAMETER,extraCode:s.INVALID_ELEMENT_ID,fnName:t,messageParams:{key:r}})}}}),layoutValidateRule=(e,i=!0)=>({type:"object",required:i,properties:__spreadValues({},layoutProperty),validate(i,r,t){const{RtcError:o,ErrorCode:a,ErrorCodeDictionary:s}=e.errorModule;if(i){if(i.fillMode&&!["contain","cover","fill"].includes(i.fillMode))throw new o({code:a.INVALID_PARAMETER,extraCode:s.INVALID_PARAMETER_TYPE,message:"The fillMode parameter must be 'contain', 'cover' or 'fill'",fnName:t});if(i.rotation&&![0,90,180,270].includes(i.rotation))throw new o({code:a.INVALID_PARAMETER,extraCode:s.INVALID_PARAMETER_TYPE,message:"The rotation parameter must be 0, 90, 180 or 270",fnName:t})}}}),cameraValidateRule=e=>({type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},cameraId:{required:!1,type:"string"},videoTrack:{required:!1,instanceof:MediaStreamTrack},profile:{required:!1,type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},layout:__spreadValues({},layoutValidateRule(e))}}}),screenValidateRule=e=>({type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},profile:{required:!1,type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},captureElement:{required:!1,type:HTMLElement},preferDisplaySurface:{required:!1,type:"string"},layout:__spreadValues({},layoutValidateRule(e))},validate(i,r,t){const{RtcError:o,ErrorCode:a,ErrorCodeDictionary:s}=e.errorModule;if(!e.rtcDectection.isScreenCaptureApiAvailable())throw new o({code:a.ENV_NOT_SUPPORTED,fnName:t,extraCode:s.NOT_SUPPORTED_SCREEN_SHARE})}}}),textValidateRule=e=>({type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},content:{required:!0,type:"string"},font:{required:!1,type:"string"},color:{required:!1,type:["string",CanvasGradient,CanvasPattern]},layout:__spreadValues({},layoutValidateRule(e))}}}),imageValidateRule=e=>({type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},url:{required:!0,type:"string"},layout:__spreadValues({},layoutValidateRule(e))}}}),videoValidateRule=e=>({type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},url:{required:!0,type:"string"},layout:__spreadValues({},layoutValidateRule(e))}}});function startValidateRule(e){return{name:"VideoMixerOptions",type:"object",required:!0,allowEmpty:!1,properties:{view:__spreadValues({},viewValidateRule(e)),canvasInfo:__spreadValues({},canvasValidateRule(e,!0)),camera:__spreadValues({},cameraValidateRule(e)),screen:__spreadValues({},screenValidateRule(e)),text:__spreadValues({},textValidateRule(e)),image:__spreadValues({},imageValidateRule(e)),video:__spreadValues({},videoValidateRule(e))},validate(i,r,t,o){const{RtcError:a,ErrorCode:s,ErrorCodeDictionary:n}=e.errorModule;if(e.environment.isMobile())throw new a({code:s.ENV_NOT_SUPPORTED,message:"VideoMixer is not supported on mobile devices currently"});const{onScreenShareStop:c}=i;if(c&&!e.utils.isFunction(c))throw new a({code:s.INVALID_PARAMETER,extraCode:n.INVALID_PARAMETER_TYPE,fnName:t,messageParams:{key:"onScreenShareStop",value:typeof c,rule:{type:"Function"}}})}}}function updateValidateRule(e){return{name:"VideoMixerOptions",type:"object",required:!1,allowEmpty:!1,properties:{view:__spreadValues({},viewValidateRule(e)),canvasInfo:__spreadValues({},canvasValidateRule(e)),camera:__spreadValues({},cameraValidateRule(e)),screen:__spreadValues({},screenValidateRule(e)),text:__spreadValues({},textValidateRule(e)),image:__spreadValues({},imageValidateRule(e)),video:__spreadValues({},videoValidateRule(e))}}}function stopValidateRule(e){return{name:"StopVideoMixerOptions",required:!1}}var videoMixSeq=0,_VideoMixer=class e{constructor(e){this.core=e,__publicField(this,"seq"),__publicField(this,"log"),__publicField(this,"localMixVideoTrack",null),__publicField(this,"systemAudioTrackList",{}),__publicField(this,"_mixVideoConfig"),__publicField(this,"onScreenShareStop"),videoMixSeq+=1,this.seq=videoMixSeq,this.log=e.log.createChild({id:`${this.getAlias()}${videoMixSeq}`}),this.log.info("created")}getName(){return e.Name}getAlias(){return"vmix"}getValidateRule(e){switch(e){case"start":return startValidateRule(this.core);case"update":return updateValidateRule(this.core);case"stop":return stopValidateRule(this.core)}}getGroup(){return"vmix"}async start(e){this.localMixVideoTrack||(this.localMixVideoTrack=new this.core.LocalMixVideoTrack(this.core.room.videoManager)),this._mixVideoConfig={canvasInfo:{width:1920,height:1080}},e=this.core.utils.deepCloneBasic(e);const{view:i,onScreenShareStop:r}=e,t=await this.parseMixOptions(e);return r&&(this.onScreenShareStop=r,this._mixVideoConfig.onScreenShareStop=r),this._updatePreview({view:i,track:this.localMixVideoTrack}),this.core.utils.isUndefined(i)||(this._mixVideoConfig.view=i),await this.localMixVideoTrack.startMix(),{track:this.localMixVideoTrack._outputTrack,systemAudioTrackList:this.systemAudioTrackList,result:t}}async update(e){const{RtcError:i,ErrorCode:r}=this.core.errorModule;if(!this.localMixVideoTrack)throw new i({code:r.INVALID_OPERATION,message:"mixTrack doesn't initialize!"});e=this.core.utils.deepCloneBasic(e);const{view:t}=e,o=await this.parseMixOptions(e);return await this._updatePreview({view:t,track:this.localMixVideoTrack,prevConfig:this._mixVideoConfig}),this.core.utils.isUndefined(t)||(this._mixVideoConfig.view=t),{track:this.localMixVideoTrack._outputTrack,systemAudioTrackList:this.systemAudioTrackList,result:o}}async parseMixOptions(e){let i={successOptions:{},failedDetails:[]};const{RtcError:r,ErrorCode:t,ErrorCodeDictionary:o}=this.core.errorModule;if(!this.localMixVideoTrack||!this._mixVideoConfig)return i;const a=[],s=__spreadValues({},e),{canvasInfo:n,camera:c,screen:d,text:l,image:u,video:p}=e;let h=0,m=0;if(n){const{canvasColor:e,width:i,height:r,frameRate:t}=n;e&&this.localMixVideoTrack.setMixBackground(e),t&&this.localMixVideoTrack.setFps(t),this.localMixVideoTrack.resizeMixCanvas(i,r),this._mixVideoConfig.canvasInfo=n}if(c){h++;const{finalOptions:e,errors:i}=await this.parseCameraOptions(this.localMixVideoTrack,c,this._mixVideoConfig.camera);this._mixVideoConfig.camera=e,s.camera=e,i.length>0&&(a.push(...i),i.length===c.length&&m++)}if(d){h++;const{finalOptions:e,errors:i}=await this.parseScreenOptions(this.localMixVideoTrack,d,this._mixVideoConfig.screen);this._mixVideoConfig.screen=e,s.screen=e,i.length>0&&(a.push(...i),i.length===d.length&&m++)}if(l){h++;const{finalOptions:e,errors:i}=await this.parseTextOptions(this.localMixVideoTrack,l,this._mixVideoConfig.text);this._mixVideoConfig.text=e,s.text=e,i.length>0&&(a.push(...i),i.length===l.length&&m++)}if(u){h++;const{finalOptions:e,errors:i}=await this.parseImageOptions(this.localMixVideoTrack,u,this._mixVideoConfig.image);this._mixVideoConfig.image=e,s.image=e,i.length>0&&(a.push(...i),i.length===u.length&&m++)}if(p){h++;const{finalOptions:e,errors:i}=await this.parseVideoOptions(this.localMixVideoTrack,p,this._mixVideoConfig.video);this._mixVideoConfig.video=e,s.video=e,i.length>0&&(a.push(...i),i.length===p.length&&m++)}if(m>0&&m===h)throw new r({code:t.INVALID_PARAMETER,message:"all sources mix failed",data:{failedDetails:a}});return i={successOptions:s,failedDetails:a},i}async parseCameraOptions(e,i,r=[]){var t,o;const a=new Set(i.map(e=>e.id)),s=r.filter(e=>!a.has(e.id)).map(e=>e.id);for(const i of s)e.removeCameraSource(i);const n=new Map(r.map(e=>[e.id,e])),c=[],d=[];for(const r of i){const{id:i,layout:a,profile:s}=r;try{if(e.inputLocalVideoTracks.has(i)){const n=null==(t=e.inputLocalVideoTracks.get(i))?void 0:t.mediaTrack;await this.updateCameraProfile(r);const c=null==(o=e.inputLocalVideoTracks.get(i))?void 0:o.mediaTrack;let d;s&&(d=this.core.utils.isString(s)?this.core.constants.videoProfileMap[s]:s),c!==n?e.updateCameraSource(i,a,c,d):e.updateCameraSource(i,a,null,d)}else{const t=await this.captureCamera(r);try{e.addCameraSource(i,t,a)}catch(e){throw t.close(),e}}c.push(r)}catch(e){d.push({id:i,error:e}),n.has(i)&&c.push(n.get(i))}}return{finalOptions:c,errors:d}}async parseScreenOptions(e,i,r=[]){const{removeIdList:t,preOptionsMap:o}=this.prepareScreenOptions(i,r);this.removeUnusedScreenSources(e,t);const{finalOptions:a,errors:s}=await this.processScreenSources(e,i,o);return{finalOptions:a,errors:s}}prepareScreenOptions(e,i){const r=new Set(e.map(e=>e.id));return{removeIdList:i.filter(e=>!r.has(e.id)).map(e=>e.id),preOptionsMap:new Map(i.map(e=>[e.id,e]))}}removeUnusedScreenSources(e,i){for(const r of i)e.removeScreenSource(r),this.removeSystemAudioTrack(r)}async processScreenSources(e,i,r){const t=[],o=[];for(const a of i)try{await this.processSingleScreenSource(e,a,r,t)}catch(e){this.handleScreenSourceError(a.id,e,r,t,o)}return{finalOptions:t,errors:o}}async processSingleScreenSource(e,i,r,t){const{id:o,layout:a}=i,s=r.get(o),n=e.inputLocalScreenTracks.has(o),c=!(null==s?void 0:s.systemAudio)&&i.systemAudio;n&&!c?await this.updateExistingScreenSource(e,o,a,s,i):await this.addNewScreenSource(e,i,s),t.push(i)}async updateExistingScreenSource(e,i,r,t,o){e.updateScreenSource(i,r),(null==t?void 0:t.systemAudio)&&!o.systemAudio&&this.removeSystemAudioTrack(i)}async addNewScreenSource(e,i,r){const t=await this.captureScreen(i);!(null==r?void 0:r.systemAudio)&&i.systemAudio&&e.inputLocalScreenTracks.has(i.id)&&e.removeScreenSource(i.id);try{e.addScreenSource(i.id,t,i.layout)}catch(e){throw t.close(),e}}handleScreenSourceError(e,i,r,t,o){o.push({id:e,error:i}),r.has(e)&&t.push(r.get(e))}async parseTextOptions(e,i,r=[]){const t=new Set(i.map(e=>e.id)),o=r.filter(e=>!t.has(e.id)).map(e=>e.id);for(const i of o)e.removeTextSource(i);const a=new Map(r.map(e=>[e.id,e])),s=[],n=[];for(const t of i){const{id:i}=t;try{r.some(e=>e.id===i)?e.updateTextSource(t):e.addTextSource(t),s.push(t)}catch(e){n.push({id:i,error:e}),a.has(i)&&s.push(a.get(i))}}return{finalOptions:s,errors:n}}async parseImageOptions(e,i,r=[]){const t=new Set(i.map(e=>e.id)),o=r.filter(e=>!t.has(e.id)).map(e=>e.id);for(const i of o)e.removeImageSource(i);const a=new Map(r.map(e=>[e.id,e])),s=[],n=[];for(const t of i){const{id:i,url:o,layout:c}=t;try{const a=r.find(e=>e.id===i);if(a){let r;a.url!==o&&(r=await this.core.utils.loadImage(o)),e.updateImageSource(i,c,r)}else{const r=await this.core.utils.loadImage(o);e.addImageSource(i,r,c)}s.push(t)}catch(e){n.push({id:i,error:e}),a.has(i)&&s.push(a.get(i))}}return{finalOptions:s,errors:n}}async parseVideoOptions(e,i,r=[]){const t=new Set(i.map(e=>e.id)),o=r.filter(e=>!t.has(e.id)).map(e=>e.id);for(const i of o)e.removeVideoSource(i);const a=new Map(r.map(e=>[e.id,e])),s=[],n=[];for(const t of i){const{id:i,url:o,layout:c}=t;try{const a=r.find(e=>e.id===i);let n;if(a)a.url!==o&&(n=await this.core.utils.loadVideo(o)),e.updateVideoSource(i,c,n);else{const r=await this.core.utils.loadVideo(o);e.addVideoSource(i,r,c)}s.push(t)}catch(e){n.push({id:i,error:e}),a.has(i)&&s.push(a.get(i))}}return{finalOptions:s,errors:n}}async captureCamera(e){const{id:i,cameraId:r,videoTrack:t,profile:o}=e,a=new this.core.LocalVideoTrack;a.log.id+=`-${i}`;const s={};return r?s.deviceId=r:this.core.utils.isUndefined(t)||(s.customSource=t),this.core.utils.isUndefined(o)||(this.core.utils.isString(o)?this.core.constants.videoProfileMap[o]&&a.setProfile(this.core.constants.videoProfileMap[o]):a.setProfile(o)),await a.capture(s),a}async updateCameraProfile(e){var i;const{id:r,cameraId:t,videoTrack:o,profile:a}=e,s=null==(i=this.localMixVideoTrack)?void 0:i.inputLocalVideoTracks.get(r);s&&(t?await s.switchDevice(t):this.core.utils.isUndefined(o)||await s.setInputMediaStreamTrack(o),this.core.utils.isUndefined(a)||(this.core.utils.isString(a)?this.core.constants.videoProfileMap[a]&&s.setProfile(this.core.constants.videoProfileMap[a]):s.setProfile(a),t&&s.isNeedToSwitchDevice(t)||await s.applyProfile()))}async captureScreen(e){const{id:i,profile:r,captureElement:t,preferDisplaySurface:o}=e,a=new this.core.LocalScreenTrack;a.log.id+=`-${i}`;const s={};this.core.utils.isUndefined(r)||(this.core.utils.isString(r)?this.core.constants.screenProfileMap[r]&&a.setProfile(this.core.constants.screenProfileMap[r]):a.setProfile(r)),t&&(s.captureElement=t),o&&(s.preferDisplaySurface=o),s.systemAudio=e.systemAudio;const n=await a.capture(s);return s.systemAudio&&n.getAudioTracks().length>0?(this.systemAudioTrackList[i]=n.getAudioTracks()[0],this.log.info(i+" system audio track captured")):this.removeSystemAudioTrack(i),a.mediaTrack.addEventListener(this.core.constants.NAME.ENDED,()=>{var e,r,t;null==(e=this.localMixVideoTrack)||e.removeScreenSource(i),(null==(r=this._mixVideoConfig)?void 0:r.screen)&&(this._mixVideoConfig.screen=this._mixVideoConfig.screen.filter(e=>e.id!==i)),null==(t=this.onScreenShareStop)||t.call(this,i)}),a}async _updatePreview({view:e,track:i,prevConfig:r}){if(this.core.utils.isUndefined(e)&&r&&r.view){const e=this.core.utils.getViewListFromView(r.view);e.length>0&&await i.play(e)}if(!this.core.utils.isUndefined(e)){const r=this.core.utils.getViewListFromView(e);r.length>0?await i.play(r):i.stop()}}stop(){var e;null==(e=this.localMixVideoTrack)||e.close(),this.localMixVideoTrack=null,Object.values(this.systemAudioTrackList).forEach(e=>e.stop()),this.systemAudioTrackList={},delete this.onScreenShareStop,delete this._mixVideoConfig}removeSystemAudioTrack(e){this.systemAudioTrackList[e]&&(this.systemAudioTrackList[e].stop(),this.log.info(e+" system audio track stop"),delete this.systemAudioTrackList[e])}};__publicField(_VideoMixer,"Name","VideoMixer");var VideoMixer=_VideoMixer,index_default=VideoMixer;export{index_default as default};export{VideoMixer};