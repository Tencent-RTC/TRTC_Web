!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e="undefined"!=typeof globalThis?globalThis:e||self).VideoMixer=r()}(this,function(){"use strict";function e(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function r(e,r,t,n,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,i)}function t(e){return function(){var t=this,n=arguments;return new Promise(function(i,o){var a=e.apply(t,n);function s(e){r(a,i,o,s,c,"next",e)}function c(e){r(a,i,o,s,c,"throw",e)}s(void 0)})}}function n(e,r,t){return r&&function(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,u(n.key),n)}}(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=f(e))||r){t&&(e=t);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==t.return||t.return()}finally{if(s)throw o}}}}function o(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var e,r,t="function"==typeof Symbol?Symbol:{},n=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,n,i,o){var s=n&&n.prototype instanceof u?n:u,l=Object.create(s.prototype);return a(l,"_invoke",function(t,n,i){var o,a,s,u=0,l=i||[],f=!1,d={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(r,t){return o=r,a=0,s=e,d.n=t,c}};function p(t,n){for(a=t,s=n,r=0;!f&&u&&!i&&r<l.length;r++){var i,o=l[r],p=d.p,h=o[2];t>3?(i=h===n)&&(s=o[(a=o[4])?5:(a=3,3)],o[4]=o[5]=e):o[0]<=p&&((i=t<2&&p<o[1])?(a=0,d.v=n,d.n=o[1]):p<h&&(i=t<3||o[0]>n||n>h)&&(o[4]=t,o[5]=n,d.n=h,a=0))}if(i||t>1)return c;throw f=!0,n}return function(i,l,h){if(u>1)throw TypeError("Generator is already running");for(f&&1===l&&p(l,h),a=l,s=h;(r=a<2?e:s)||!f;){o||(a?a<3?(a>1&&(d.n=-1),p(a,s)):d.n=s:d.v=s);try{if(u=2,o){if(a||(i="next"),r=o[i]){if(!(r=r.call(o,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,a<2&&(a=0)}else 1===a&&(r=o.return)&&r.call(o),a<2&&(s=TypeError("The iterator does not provide a '"+i+"' method"),a=1);o=e}else if((r=(f=d.n<0)?s:t.call(n,d))!==c)break}catch(r){o=e,a=1,s=r}finally{u=1}}return{value:r,done:f}}}(t,i,o),!0),l}var c={};function u(){}function l(){}function f(){}r=Object.getPrototypeOf;var d=[][n]?r(r([][n]())):(a(r={},n,function(){return this}),r),p=f.prototype=u.prototype=Object.create(d);function h(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,a(e,i,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=f,a(p,"constructor",f),a(f,"constructor",l),l.displayName="GeneratorFunction",a(f,i,"GeneratorFunction"),a(p),a(p,i,"Generator"),a(p,n,function(){return this}),a(p,"toString",function(){return"[object Generator]"}),(o=function(){return{w:s,m:h}})()}function a(e,r,t,n){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}a=function(e,r,t,n){function o(r,t){a(e,r,function(e){return this._invoke(r,t,e)})}r?i?i(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n}):e[r]=t:(o("next",0),o("throw",1),o("return",2))},a(e,r,t,n)}function s(e){if(null!=e){var r=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],t=0;if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}throw new TypeError(typeof e+" is not iterable")}function c(r){return function(r){if(Array.isArray(r))return e(r)}(r)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||f(r)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e){var r=function(e,r){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,r);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof r?r:r+""}function l(e){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l(e)}function f(r,t){if(r){if("string"==typeof r)return e(r,t);var n={}.toString.call(r).slice(8,-1);return"Object"===n&&r.constructor&&(n=r.constructor.name),"Map"===n||"Set"===n?Array.from(r):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(r,t):void 0}}var d=Object.defineProperty,p=Object.getOwnPropertySymbols,h=Object.prototype.hasOwnProperty,m=Object.prototype.propertyIsEnumerable,y=function(e,r,t){return r in e?d(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t},v=function(e,r){for(var t in r||(r={}))h.call(r,t)&&y(e,t,r[t]);if(p){var n,o=i(p(r));try{for(o.s();!(n=o.n()).done;){t=n.value;m.call(r,t)&&y(e,t,r[t])}}catch(e){o.e(e)}finally{o.f()}}return e},g=function(e,r,t){return y(e,"symbol"!==l(r)?r+"":r,t)},b={x:{required:!0,type:"number"},y:{required:!0,type:"number"},width:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},height:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},zIndex:{required:!0,type:"number"},fillMode:{required:!1,type:"string"},mirror:{required:!1,type:"boolean"},rotation:{required:!1,type:"number"},hidden:{required:!1,type:"boolean"}},k=function(e){return{type:"object",required:arguments.length>1&&void 0!==arguments[1]&&arguments[1],properties:{canvasColor:{required:!1,type:["string",CanvasGradient,CanvasPattern]},width:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},height:{required:!0,type:"number",notLessThanZero:!0,min:1,max:3840},frameRate:{required:!1,type:"number",notLessThanZero:!0,min:1,max:60}},validate:function(r,t,n){var i=e.errorModule,o=i.RtcError,a=i.ErrorCode;if(i.ErrorCodeDictionary,r){var s=r.width,c=r.height;if(s&&c&&s*c>8294400)throw new o({code:a.INVALID_PARAMETER,message:"The mix resolution cannot be set higher than 3840 * 2160."})}}}},S=function(e){return{required:!1,type:["string",HTMLElement,null],validate:function(r,t,n){var i=e.errorModule,o=i.RtcError,a=i.ErrorCode,s=i.ErrorCodeDictionary;if(e.utils.isString(r)&&!document.getElementById(r))throw new o({code:a.INVALID_PARAMETER,extraCode:s.INVALID_ELEMENT_ID,fnName:n,messageParams:{key:t}})}}},w=function(e){return{type:"object",required:!(arguments.length>1&&void 0!==arguments[1])||arguments[1],properties:v({},b),validate:function(r,t,n){var i=e.errorModule,o=i.RtcError,a=i.ErrorCode,s=i.ErrorCodeDictionary;if(r){if(r.fillMode&&!["contain","cover","fill"].includes(r.fillMode))throw new o({code:a.INVALID_PARAMETER,extraCode:s.INVALID_PARAMETER_TYPE,message:"The fillMode parameter must be 'contain', 'cover' or 'fill'",fnName:n});if(r.rotation&&![0,90,180,270].includes(r.rotation))throw new o({code:a.INVALID_PARAMETER,extraCode:s.INVALID_PARAMETER_TYPE,message:"The rotation parameter must be 0, 90, 180 or 270",fnName:n})}}}},T=function(e){return{type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},cameraId:{required:!1,type:"string"},videoTrack:{required:!1,instanceof:MediaStreamTrack},profile:{required:!1,type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},layout:v({},w(e))}}}},x=function(e){return{type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},profile:{required:!1,type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},captureElement:{required:!1,type:HTMLElement},preferDisplaySurface:{required:!1,type:"string"},layout:v({},w(e))},validate:function(r,t,n){var i=e.errorModule,o=i.RtcError,a=i.ErrorCode,s=i.ErrorCodeDictionary;if(!e.rtcDectection.isScreenCaptureApiAvailable())throw new o({code:a.ENV_NOT_SUPPORTED,fnName:n,extraCode:s.NOT_SUPPORTED_SCREEN_SHARE})}}}},V=function(e){return{type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},content:{required:!0,type:"string"},font:{required:!1,type:"string"},color:{required:!1,type:["string",CanvasGradient,CanvasPattern]},layout:v({},w(e))}}}},E=function(e){return{type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},url:{required:!0,type:"string"},layout:v({},w(e))}}}},M=function(e){return{type:"array",required:!1,arrayItem:{type:"object",properties:{id:{required:!0,type:"string"},url:{required:!0,type:"string"},layout:v({},w(e))}}}};var A=0,C=function(){function e(r){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),this.core=r,g(this,"seq"),g(this,"log"),g(this,"localMixVideoTrack",null),g(this,"systemAudioTrackList",{}),g(this,"_mixVideoConfig"),g(this,"onScreenShareStop"),A+=1,this.seq=A,this.log=r.log.createChild({id:"".concat(this.getAlias()).concat(A)}),this.log.info("created")}return n(e,[{key:"getName",value:function(){return e.Name}},{key:"getAlias",value:function(){return"vmix"}},{key:"getValidateRule",value:function(e){switch(e){case"start":return r=this.core,{name:"VideoMixerOptions",type:"object",required:!0,allowEmpty:!1,properties:{view:v({},S(r)),canvasInfo:v({},k(r,!0)),camera:v({},T(r)),screen:v({},x(r)),text:v({},V(r)),image:v({},E(r)),video:v({},M(r))},validate:function(e,t,n,i){var o=r.errorModule,a=o.RtcError,s=o.ErrorCode,c=o.ErrorCodeDictionary;if(r.environment.isMobile())throw new a({code:s.ENV_NOT_SUPPORTED,message:"VideoMixer is not supported on mobile devices currently"});var u=e.onScreenShareStop;if(u&&!r.utils.isFunction(u))throw new a({code:s.INVALID_PARAMETER,extraCode:c.INVALID_PARAMETER_TYPE,fnName:n,messageParams:{key:"onScreenShareStop",value:l(u),rule:{type:"Function"}}})}};case"update":return function(e){return{name:"VideoMixerOptions",type:"object",required:!1,allowEmpty:!1,properties:{view:v({},S(e)),canvasInfo:v({},k(e)),camera:v({},T(e)),screen:v({},x(e)),text:v({},V(e)),image:v({},E(e)),video:v({},M(e))}}}(this.core);case"stop":return this.core,{name:"StopVideoMixerOptions",required:!1}}var r}},{key:"getGroup",value:function(){return"vmix"}},{key:"start",value:(_=t(o().m(function e(r){var t,n,i,a;return o().w(function(e){for(;;)switch(e.n){case 0:return this.localMixVideoTrack||(this.localMixVideoTrack=new this.core.LocalMixVideoTrack(this.core.room.videoManager)),this._mixVideoConfig={canvasInfo:{width:1920,height:1080}},r=this.core.utils.deepCloneBasic(r),n=(t=r).view,i=t.onScreenShareStop,e.n=1,this.parseMixOptions(r);case 1:return a=e.v,i&&(this.onScreenShareStop=i,this._mixVideoConfig.onScreenShareStop=i),this._updatePreview({view:n,track:this.localMixVideoTrack}),this.core.utils.isUndefined(n)||(this._mixVideoConfig.view=n),e.n=2,this.localMixVideoTrack.startMix();case 2:return e.a(2,{track:this.localMixVideoTrack._outputTrack,systemAudioTrackList:this.systemAudioTrackList,result:a})}},e,this)})),function(e){return _.apply(this,arguments)})},{key:"update",value:(P=t(o().m(function e(r){var t,n,i,a,s;return o().w(function(e){for(;;)switch(e.n){case 0:if(t=this.core.errorModule,n=t.RtcError,i=t.ErrorCode,this.localMixVideoTrack){e.n=1;break}throw new n({code:i.INVALID_OPERATION,message:"mixTrack doesn't initialize!"});case 1:return r=this.core.utils.deepCloneBasic(r),a=r.view,e.n=2,this.parseMixOptions(r);case 2:return s=e.v,e.n=3,this._updatePreview({view:a,track:this.localMixVideoTrack,prevConfig:this._mixVideoConfig});case 3:return this.core.utils.isUndefined(a)||(this._mixVideoConfig.view=a),e.a(2,{track:this.localMixVideoTrack._outputTrack,systemAudioTrackList:this.systemAudioTrackList,result:s})}},e,this)})),function(e){return P.apply(this,arguments)})},{key:"parseMixOptions",value:(I=t(o().m(function e(r){var t,n,i,a,s,u,l,f,d,p,h,m,y,g,b,k,S,w,T,x,V,E,M,A,C,O,I,P,_,L,q,R,N;return o().w(function(e){for(;;)switch(e.n){case 0:if(t={successOptions:{},failedDetails:[]},n=this.core.errorModule,i=n.RtcError,a=n.ErrorCode,n.ErrorCodeDictionary,this.localMixVideoTrack&&this._mixVideoConfig){e.n=1;break}return e.a(2,t);case 1:if(s=[],u=v({},r),l=r.canvasInfo,f=r.camera,d=r.screen,p=r.text,h=r.image,m=r.video,y=0,g=0,l&&(b=l.canvasColor,k=l.width,S=l.height,w=l.frameRate,b&&this.localMixVideoTrack.setMixBackground(b),w&&this.localMixVideoTrack.setFps(w),this.localMixVideoTrack.resizeMixCanvas(k,S),this._mixVideoConfig.canvasInfo=l),!f){e.n=3;break}return y++,e.n=2,this.parseCameraOptions(this.localMixVideoTrack,f,this._mixVideoConfig.camera);case 2:T=e.v,x=T.finalOptions,V=T.errors,this._mixVideoConfig.camera=x,u.camera=x,V.length>0&&(s.push.apply(s,c(V)),V.length===f.length&&g++);case 3:if(!d){e.n=5;break}return y++,e.n=4,this.parseScreenOptions(this.localMixVideoTrack,d,this._mixVideoConfig.screen);case 4:E=e.v,M=E.finalOptions,A=E.errors,this._mixVideoConfig.screen=M,u.screen=M,A.length>0&&(s.push.apply(s,c(A)),A.length===d.length&&g++);case 5:if(!p){e.n=7;break}return y++,e.n=6,this.parseTextOptions(this.localMixVideoTrack,p,this._mixVideoConfig.text);case 6:C=e.v,O=C.finalOptions,I=C.errors,this._mixVideoConfig.text=O,u.text=O,I.length>0&&(s.push.apply(s,c(I)),I.length===p.length&&g++);case 7:if(!h){e.n=9;break}return y++,e.n=8,this.parseImageOptions(this.localMixVideoTrack,h,this._mixVideoConfig.image);case 8:P=e.v,_=P.finalOptions,L=P.errors,this._mixVideoConfig.image=_,u.image=_,L.length>0&&(s.push.apply(s,c(L)),L.length===h.length&&g++);case 9:if(!m){e.n=11;break}return y++,e.n=10,this.parseVideoOptions(this.localMixVideoTrack,m,this._mixVideoConfig.video);case 10:q=e.v,R=q.finalOptions,N=q.errors,this._mixVideoConfig.video=R,u.video=R,N.length>0&&(s.push.apply(s,c(N)),N.length===m.length&&g++);case 11:if(!(g>0&&g===y)){e.n=12;break}throw new i({code:a.INVALID_PARAMETER,message:"all sources mix failed",data:{failedDetails:s}});case 12:return t={successOptions:u,failedDetails:s},e.a(2,t)}},e,this)})),function(e){return I.apply(this,arguments)})},{key:"parseCameraOptions",value:(O=t(o().m(function e(r,t){var n,a,s,c,u,l,f,d,p,h,m,y,v,g,b,k,S,w,T,x,V,E,M,A,C=arguments;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:n=C.length>2&&void 0!==C[2]?C[2]:[],c=new Set(t.map(function(e){return e.id})),u=n.filter(function(e){return!c.has(e.id)}).map(function(e){return e.id}),l=i(u);try{for(l.s();!(f=l.n()).done;)d=f.value,r.removeCameraSource(d)}catch(e){l.e(e)}finally{l.f()}p=new Map(n.map(function(e){return[e.id,e]})),h=[],m=[],y=i(t),e.p=1,y.s();case 2:if((v=y.n()).done){e.n=12;break}if(g=v.value,b=g.id,k=g.layout,S=g.profile,e.p=3,!r.inputLocalVideoTracks.has(b)){e.n=5;break}return w=null==(a=r.inputLocalVideoTracks.get(b))?void 0:a.mediaTrack,e.n=4,this.updateCameraProfile(g);case 4:T=null==(s=r.inputLocalVideoTracks.get(b))?void 0:s.mediaTrack,x=void 0,S&&(x=this.core.utils.isString(S)?this.core.constants.videoProfileMap[S]:S),T!==w?r.updateCameraSource(b,k,T,x):r.updateCameraSource(b,k,null,x),e.n=9;break;case 5:return e.n=6,this.captureCamera(g);case 6:V=e.v,e.p=7,r.addCameraSource(b,V,k),e.n=9;break;case 8:throw e.p=8,E=e.v,V.close(),E;case 9:h.push(g),e.n=11;break;case 10:e.p=10,M=e.v,m.push({id:b,error:M}),p.has(b)&&h.push(p.get(b));case 11:e.n=2;break;case 12:e.n=14;break;case 13:e.p=13,A=e.v,y.e(A);case 14:return e.p=14,y.f(),e.f(14);case 15:return e.a(2,{finalOptions:h,errors:m})}},e,this,[[7,8],[3,10],[1,13,14,15]])})),function(e,r){return O.apply(this,arguments)})},{key:"parseScreenOptions",value:(C=t(o().m(function e(r,t){var n,i,a,s,c,u,l,f=arguments;return o().w(function(e){for(;;)switch(e.n){case 0:return n=f.length>2&&void 0!==f[2]?f[2]:[],i=this.prepareScreenOptions(t,n),a=i.removeIdList,s=i.preOptionsMap,this.removeUnusedScreenSources(r,a),e.n=1,this.processScreenSources(r,t,s);case 1:return c=e.v,u=c.finalOptions,l=c.errors,e.a(2,{finalOptions:u,errors:l})}},e,this)})),function(e,r){return C.apply(this,arguments)})},{key:"prepareScreenOptions",value:function(e,r){var t=new Set(e.map(function(e){return e.id}));return{removeIdList:r.filter(function(e){return!t.has(e.id)}).map(function(e){return e.id}),preOptionsMap:new Map(r.map(function(e){return[e.id,e]}))}}},{key:"removeUnusedScreenSources",value:function(e,r){var t,n=i(r);try{for(n.s();!(t=n.n()).done;){var o=t.value;e.removeScreenSource(o),this.removeSystemAudioTrack(o)}}catch(e){n.e(e)}finally{n.f()}}},{key:"processScreenSources",value:(w=t(o().m(function e(r,t,n){var a,s,c,u,l,f,d;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:a=[],s=[],c=i(t),e.p=1,c.s();case 2:if((u=c.n()).done){e.n=7;break}return l=u.value,e.p=3,e.n=4,this.processSingleScreenSource(r,l,n,a);case 4:e.n=6;break;case 5:e.p=5,f=e.v,this.handleScreenSourceError(l.id,f,n,a,s);case 6:e.n=2;break;case 7:e.n=9;break;case 8:e.p=8,d=e.v,c.e(d);case 9:return e.p=9,c.f(),e.f(9);case 10:return e.a(2,{finalOptions:a,errors:s})}},e,this,[[3,5],[1,8,9,10]])})),function(e,r,t){return w.apply(this,arguments)})},{key:"processSingleScreenSource",value:(b=t(o().m(function e(r,t,n,i){var a,s,c,u,l;return o().w(function(e){for(;;)switch(e.n){case 0:if(a=t.id,s=t.layout,c=n.get(a),u=r.inputLocalScreenTracks.has(a),l=!(null==c?void 0:c.systemAudio)&&t.systemAudio,!u||l){e.n=2;break}return e.n=1,this.updateExistingScreenSource(r,a,s,c,t);case 1:e.n=3;break;case 2:return e.n=3,this.addNewScreenSource(r,t,c);case 3:i.push(t);case 4:return e.a(2)}},e,this)})),function(e,r,t,n){return b.apply(this,arguments)})},{key:"updateExistingScreenSource",value:(y=t(o().m(function e(r,t,n,i,a){return o().w(function(e){for(;;)switch(e.n){case 0:r.updateScreenSource(t,n),(null==i?void 0:i.systemAudio)&&!a.systemAudio&&this.removeSystemAudioTrack(t);case 1:return e.a(2)}},e,this)})),function(e,r,t,n,i){return y.apply(this,arguments)})},{key:"addNewScreenSource",value:(m=t(o().m(function e(r,t,n){var i,a;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,this.captureScreen(t);case 1:i=e.v,!(null==n?void 0:n.systemAudio)&&t.systemAudio&&r.inputLocalScreenTracks.has(t.id)&&r.removeScreenSource(t.id),e.p=2,r.addScreenSource(t.id,i,t.layout),e.n=4;break;case 3:throw e.p=3,a=e.v,i.close(),a;case 4:return e.a(2)}},e,this,[[2,3]])})),function(e,r,t){return m.apply(this,arguments)})},{key:"handleScreenSourceError",value:function(e,r,t,n,i){i.push({id:e,error:r}),t.has(e)&&n.push(t.get(e))}},{key:"parseTextOptions",value:(h=t(o().m(function e(r,t){var n,a,c,u,l,f,d,p,h,m,y,v,g,b=arguments;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:n=b.length>2&&void 0!==b[2]?b[2]:[],a=new Set(t.map(function(e){return e.id})),c=n.filter(function(e){return!a.has(e.id)}).map(function(e){return e.id}),u=i(c);try{for(u.s();!(l=u.n()).done;)f=l.value,r.removeTextSource(f)}catch(e){u.e(e)}finally{u.f()}d=new Map(n.map(function(e){return[e.id,e]})),p=[],h=[],m=i(t),e.p=1,v=o().m(function e(){var t,i;return o().w(function(e){for(;;)switch(e.n){case 0:t=y.value,i=t.id;try{n.some(function(e){return e.id===i})?r.updateTextSource(t):r.addTextSource(t),p.push(t)}catch(e){h.push({id:i,error:e}),d.has(i)&&p.push(d.get(i))}case 1:return e.a(2)}},e)}),m.s();case 2:if((y=m.n()).done){e.n=4;break}return e.d(s(v()),3);case 3:e.n=2;break;case 4:e.n=6;break;case 5:e.p=5,g=e.v,m.e(g);case 6:return e.p=6,m.f(),e.f(6);case 7:return e.a(2,{finalOptions:p,errors:h})}},e,null,[[1,5,6,7]])})),function(e,r){return h.apply(this,arguments)})},{key:"parseImageOptions",value:(p=t(o().m(function e(r,t){var n,a,c,u,l,f,d,p,h,m,y,v,g,b=this,k=arguments;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:n=k.length>2&&void 0!==k[2]?k[2]:[],a=new Set(t.map(function(e){return e.id})),c=n.filter(function(e){return!a.has(e.id)}).map(function(e){return e.id}),u=i(c);try{for(u.s();!(l=u.n()).done;)f=l.value,r.removeImageSource(f)}catch(e){u.e(e)}finally{u.f()}d=new Map(n.map(function(e){return[e.id,e]})),p=[],h=[],m=i(t),e.p=1,v=o().m(function e(){var t,i,a,s,c,u,l,f;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=y.value,i=t.id,a=t.url,s=t.layout,e.p=1,!(c=n.find(function(e){return e.id===i}))){e.n=4;break}if(c.url===a){e.n=3;break}return e.n=2,b.core.utils.loadImage(a);case 2:u=e.v;case 3:r.updateImageSource(i,s,u),e.n=6;break;case 4:return e.n=5,b.core.utils.loadImage(a);case 5:l=e.v,r.addImageSource(i,l,s);case 6:p.push(t),e.n=8;break;case 7:e.p=7,f=e.v,h.push({id:i,error:f}),d.has(i)&&p.push(d.get(i));case 8:return e.a(2)}},e,null,[[1,7]])}),m.s();case 2:if((y=m.n()).done){e.n=4;break}return e.d(s(v()),3);case 3:e.n=2;break;case 4:e.n=6;break;case 5:e.p=5,g=e.v,m.e(g);case 6:return e.p=6,m.f(),e.f(6);case 7:return e.a(2,{finalOptions:p,errors:h})}},e,null,[[1,5,6,7]])})),function(e,r){return p.apply(this,arguments)})},{key:"parseVideoOptions",value:(d=t(o().m(function e(r,t){var n,a,c,u,l,f,d,p,h,m,y,v,g,b=this,k=arguments;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:n=k.length>2&&void 0!==k[2]?k[2]:[],a=new Set(t.map(function(e){return e.id})),c=n.filter(function(e){return!a.has(e.id)}).map(function(e){return e.id}),u=i(c);try{for(u.s();!(l=u.n()).done;)f=l.value,r.removeVideoSource(f)}catch(e){u.e(e)}finally{u.f()}d=new Map(n.map(function(e){return[e.id,e]})),p=[],h=[],m=i(t),e.p=1,v=o().m(function e(){var t,i,a,s,c,u,l,f;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=y.value,i=t.id,a=t.url,s=t.layout,e.p=1,!(c=n.find(function(e){return e.id===i}))){e.n=4;break}if(c.url===a){e.n=3;break}return e.n=2,b.core.utils.loadVideo(a);case 2:u=e.v;case 3:r.updateVideoSource(i,s,u),e.n=6;break;case 4:return e.n=5,b.core.utils.loadVideo(a);case 5:l=e.v,r.addVideoSource(i,l,s);case 6:p.push(t),e.n=8;break;case 7:e.p=7,f=e.v,h.push({id:i,error:f}),d.has(i)&&p.push(d.get(i));case 8:return e.a(2)}},e,null,[[1,7]])}),m.s();case 2:if((y=m.n()).done){e.n=4;break}return e.d(s(v()),3);case 3:e.n=2;break;case 4:e.n=6;break;case 5:e.p=5,g=e.v,m.e(g);case 6:return e.p=6,m.f(),e.f(6);case 7:return e.a(2,{finalOptions:p,errors:h})}},e,null,[[1,5,6,7]])})),function(e,r){return d.apply(this,arguments)})},{key:"captureCamera",value:(f=t(o().m(function e(r){var t,n,i,a,s,c;return o().w(function(e){for(;;)switch(e.n){case 0:return t=r.id,n=r.cameraId,i=r.videoTrack,a=r.profile,(s=new this.core.LocalVideoTrack).log.id+="-".concat(t),c={},n?c.deviceId=n:this.core.utils.isUndefined(i)||(c.customSource=i),this.core.utils.isUndefined(a)||(this.core.utils.isString(a)?this.core.constants.videoProfileMap[a]&&s.setProfile(this.core.constants.videoProfileMap[a]):s.setProfile(a)),e.n=1,s.capture(c);case 1:return e.a(2,s)}},e,this)})),function(e){return f.apply(this,arguments)})},{key:"updateCameraProfile",value:(u=t(o().m(function e(r){var t,n,i,a,s,c;return o().w(function(e){for(;;)switch(e.n){case 0:if(n=r.id,i=r.cameraId,a=r.videoTrack,s=r.profile,c=null==(t=this.localMixVideoTrack)?void 0:t.inputLocalVideoTracks.get(n)){e.n=1;break}return e.a(2);case 1:if(!i){e.n=3;break}return e.n=2,c.switchDevice(i);case 2:e.n=4;break;case 3:if(this.core.utils.isUndefined(a)){e.n=4;break}return e.n=4,c.setInputMediaStreamTrack(a);case 4:if(this.core.utils.isUndefined(s)){e.n=5;break}if(this.core.utils.isString(s)?this.core.constants.videoProfileMap[s]&&c.setProfile(this.core.constants.videoProfileMap[s]):c.setProfile(s),i&&c.isNeedToSwitchDevice(i)){e.n=5;break}return e.n=5,c.applyProfile();case 5:return e.a(2)}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"captureScreen",value:(a=t(o().m(function e(r){var t,n,i,a,s,c,u,l=this;return o().w(function(e){for(;;)switch(e.n){case 0:return t=r.id,n=r.profile,i=r.captureElement,a=r.preferDisplaySurface,(s=new this.core.LocalScreenTrack).log.id+="-".concat(t),c={},this.core.utils.isUndefined(n)||(this.core.utils.isString(n)?this.core.constants.screenProfileMap[n]&&s.setProfile(this.core.constants.screenProfileMap[n]):s.setProfile(n)),i&&(c.captureElement=i),a&&(c.preferDisplaySurface=a),c.systemAudio=r.systemAudio,e.n=1,s.capture(c);case 1:return u=e.v,c.systemAudio&&u.getAudioTracks().length>0?(this.systemAudioTrackList[t]=u.getAudioTracks()[0],this.log.info(t+" system audio track captured")):this.removeSystemAudioTrack(t),s.mediaTrack.addEventListener(this.core.constants.NAME.ENDED,function(){var e,r,n;null==(e=l.localMixVideoTrack)||e.removeScreenSource(t),(null==(r=l._mixVideoConfig)?void 0:r.screen)&&(l._mixVideoConfig.screen=l._mixVideoConfig.screen.filter(function(e){return e.id!==t})),null==(n=l.onScreenShareStop)||n.call(l,t)}),e.a(2,s)}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"_updatePreview",value:(r=t(o().m(function e(r){var t,n,i,a,s;return o().w(function(e){for(;;)switch(e.n){case 0:if(t=r.view,n=r.track,i=r.prevConfig,!(this.core.utils.isUndefined(t)&&i&&i.view)){e.n=1;break}if(!((a=this.core.utils.getViewListFromView(i.view)).length>0)){e.n=1;break}return e.n=1,n.play(a);case 1:if(this.core.utils.isUndefined(t)){e.n=4;break}if(!((s=this.core.utils.getViewListFromView(t)).length>0)){e.n=3;break}return e.n=2,n.play(s);case 2:e.n=4;break;case 3:n.stop();case 4:return e.a(2)}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"stop",value:function(){var e;null==(e=this.localMixVideoTrack)||e.close(),this.localMixVideoTrack=null,Object.values(this.systemAudioTrackList).forEach(function(e){return e.stop()}),this.systemAudioTrackList={},delete this.onScreenShareStop,delete this._mixVideoConfig}},{key:"removeSystemAudioTrack",value:function(e){this.systemAudioTrackList[e]&&(this.systemAudioTrackList[e].stop(),this.log.info(e+" system audio track stop"),delete this.systemAudioTrackList[e])}}]);var r,a,u,f,d,p,h,m,y,b,w,C,O,I,P,_}();return g(C,"Name","VideoMixer"),C});
