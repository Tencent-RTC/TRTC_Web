!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(r="undefined"!=typeof globalThis?globalThis:r||self).RealtimeTranscriber=e()}(this,function(){"use strict";function r(r,e,t,o,n,a,i){try{var s=r[a](i),c=s.value}catch(r){return void t(r)}s.done?e(c):Promise.resolve(c).then(o,n)}function e(e){return function(){var t=this,o=arguments;return new Promise(function(n,a){var i=e.apply(t,o);function s(e){r(i,n,a,s,c,"next",e)}function c(e){r(i,n,a,s,c,"throw",e)}s(void 0)})}}function t(r,e,t){return e&&function(r,e){for(var t=0;t<e.length;t++){var o=e[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(r,a(o.key),o)}}(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}function o(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var r,e,t="function"==typeof Symbol?Symbol:{},a=t.iterator||"@@iterator",i=t.toStringTag||"@@toStringTag";function s(t,o,a,i){var s=o&&o.prototype instanceof u?o:u,d=Object.create(s.prototype);return n(d,"_invoke",function(t,o,n){var a,i,s,u=0,d=n||[],l=!1,f={p:0,n:0,v:r,a:p,f:p.bind(r,4),d:function(e,t){return a=e,i=0,s=r,f.n=t,c}};function p(t,o){for(i=t,s=o,e=0;!l&&u&&!n&&e<d.length;e++){var n,a=d[e],p=f.p,m=a[2];t>3?(n=m===o)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=r):a[0]<=p&&((n=t<2&&p<a[1])?(i=0,f.v=o,f.n=a[1]):p<m&&(n=t<3||a[0]>o||o>m)&&(a[4]=t,a[5]=o,f.n=m,i=0))}if(n||t>1)return c;throw l=!0,o}return function(n,d,m){if(u>1)throw TypeError("Generator is already running");for(l&&1===d&&p(d,m),i=d,s=m;(e=i<2?r:s)||!l;){a||(i?i<3?(i>1&&(f.n=-1),p(i,s)):f.n=s:f.v=s);try{if(u=2,a){if(i||(n="next"),e=a[n]){if(!(e=e.call(a,s)))throw TypeError("iterator result is not an object");if(!e.done)return e;s=e.value,i<2&&(i=0)}else 1===i&&(e=a.return)&&e.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+n+"' method"),i=1);a=r}else if((e=(l=f.n<0)?s:t.call(o,f))!==c)break}catch(e){a=r,i=1,s=e}finally{u=1}}return{value:e,done:l}}}(t,a,i),!0),d}var c={};function u(){}function d(){}function l(){}e=Object.getPrototypeOf;var f=[][a]?e(e([][a]())):(n(e={},a,function(){return this}),e),p=l.prototype=u.prototype=Object.create(f);function m(r){return Object.setPrototypeOf?Object.setPrototypeOf(r,l):(r.__proto__=l,n(r,i,"GeneratorFunction")),r.prototype=Object.create(p),r}return d.prototype=l,n(p,"constructor",l),n(l,"constructor",d),d.displayName="GeneratorFunction",n(l,i,"GeneratorFunction"),n(p),n(p,i,"Generator"),n(p,a,function(){return this}),n(p,"toString",function(){return"[object Generator]"}),(o=function(){return{w:s,m:m}})()}function n(r,e,t,o){var a=Object.defineProperty;try{a({},"",{})}catch(r){a=0}n=function(r,e,t,o){function i(e,t){n(r,e,function(r){return this._invoke(e,t,r)})}e?a?a(r,e,{value:t,enumerable:!o,configurable:!o,writable:!o}):r[e]=t:(i("next",0),i("throw",1),i("return",2))},n(r,e,t,o)}function a(r){var e=function(r,e){if("object"!=typeof r||!r)return r;var t=r[Symbol.toPrimitive];if(void 0!==t){var o=t.call(r,e);if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}(r,"string");return"symbol"==typeof e?e:e+""}function i(r){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},i(r)}var s=Object.defineProperty,c=function(r,e,t){return function(r,e,t){return e in r?s(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t}(r,"symbol"!==i(e)?e+"":e,t)},u={name:"option",required:!0,properties:{sourceLanguage:{type:"string",required:!0},translationLanguages:{type:["string","array"],required:!1},userIdsToTranscribe:{type:["string","array"],required:!1},transcriberRobotId:{type:"string",required:!1}}},d={name:"option",required:!0,properties:{transcriberRobotId:{type:"string",required:!0}}},l=new Set([2002,4003]),f=function(){function r(e){!function(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),this.core=e,c(this,"disableRandomCall",!0),c(this,"activeTranscriberMap",new Map),c(this,"_log"),this._log=this.core.log.createChild({id:"".concat(this.getAlias())})}return t(r,[{key:"getName",value:function(){return r.Name}},{key:"getAlias",value:function(){return"rt-trans"}},{key:"getGroup",value:function(){return"*"}},{key:"getValidateRule",value:function(r){switch(r){case"start":return u;case"update":return{};case"stop":return d}}},{key:"start",value:(i=e(o().m(function r(e){var t,n,a,i,s,c,u,d,l,f,p,m,b,y,g,h,v,_,w=this;return o().w(function(r){for(;;)switch(r.p=r.n){case 0:if(n=this.core.errorModule,a=n.RtcError,i=n.ErrorCode,this.core.room.sendSignalMessage){r.n=1;break}throw new a({code:i.ENV_NOT_SUPPORTED});case 1:return s=e.sourceLanguage,c=e.translationLanguages,u=e.userIdsToTranscribe,d=void 0===u?"all":u,l=e.transcriberRobotId,f=l||"transcriber_".concat(this.core.room.roomId,"_robot_").concat(this.core.room.userId),p={sdkappid:this.core.room.sdkAppId,roomid:String(this.core.room.roomId),roomType:this.core.room.useStringRoomId?1:0,agentParam:{cdnRobotUserid:f,lifecycleUserid:this.core.room.userId,maxIdletime:30},subscribeParams:{subUsers:[]},asrParams:{lang:s,vadSilenceTime:1e3},translationParams:{mode:1,targetLangs:[""]}},c&&c.length>0&&(p.translationParams.mode=1,p.translationParams.targetLangs=Array.isArray(c)?c:[c]),"all"===d?p.subscribeParams.subUsers=[]:Array.isArray(d)?p.subscribeParams.subUsers=d.map(function(r){return{userId:r,roomType:w.core.room.useStringRoomId?1:0,roomid:String(w.core.room.roomId)}}):d&&(p.subscribeParams.subUsers=[{userId:d,roomType:this.core.room.useStringRoomId?1:0,roomid:String(this.core.room.roomId)}]),r.p=2,this._log.info("start_cloud_transcription ".concat(JSON.stringify(p))),r.n=3,this.core.room.sendSignalMessage({command:"start_cloud_transcription",responseCommand:String(8268),data:p,retries:0});case 3:if(m=r.v,b=m.data,y=b.code,g=b.data,0===y){r.n=4;break}throw h=(null==(t=m.data)?void 0:t.message)||"",this._log.error("start_cloud_transcription failed",{extraCode:y,reason:h,data:g}),new a({code:i.SERVER_ERROR,extraCode:y,message:h});case 4:if(v=g.taskId){r.n=5;break}throw this._log.error("taskId is required",{data:m.data}),new a({code:i.SERVER_ERROR,message:"taskId is required"});case 5:return this.activeTranscriberMap.set(v,e),this._log.info("start_cloud_transcription success ".concat(v,", activeSize: ").concat(this.activeTranscriberMap.size)),r.a(2,v);case 6:throw r.p=6,_=r.v,this._log.error("start_cloud_transcription failed",{error:_}),_;case 7:return r.a(2)}},r,this,[[2,6]])})),function(r){return i.apply(this,arguments)})},{key:"update",value:(a=e(o().m(function r(){return o().w(function(r){for(;;)if(0===r.n)return r.a(2)},r)})),function(){return a.apply(this,arguments)})},{key:"stop",value:(n=e(o().m(function r(e){var t,n,a,i,s,c,u,d,f;return o().w(function(r){for(;;)switch(r.p=r.n){case 0:if(t=e.transcriberRobotId,a=this.core.errorModule,i=a.RtcError,s=a.ErrorCode,this.core.room.sendSignalMessage){r.n=1;break}throw new i({code:s.ENV_NOT_SUPPORTED});case 1:return r.p=1,r.n=2,this.core.room.sendSignalMessage({command:"stop_cloud_transcription",responseCommand:String(8270),data:{taskId:t},retries:3});case 2:if(0===(c=r.v).data.code){r.n=4;break}if(u=c.data.code,d=(null==(n=c.data)?void 0:n.message)||"",!l.has(u)){r.n=3;break}this._log.warn("stop_cloud_transcription ignored error",{extraCode:u,reason:d,data:c.data.data}),r.n=4;break;case 3:throw this._log.error("stop_cloud_transcription failed",{extraCode:u,reason:d,data:c.data.data}),new i({code:s.SERVER_ERROR,extraCode:u,message:d});case 4:this.activeTranscriberMap.delete(t),r.n=6;break;case 5:throw r.p=5,f=r.v,this._log.error("stop_cloud_transcription failed",{error:f}),f;case 6:return r.a(2)}},r,this,[[1,5]])})),function(r){return n.apply(this,arguments)})},{key:"destroy",value:function(){this.activeTranscriberMap.clear()}}]);var n,a,i}();return c(f,"Name","RealtimeTranscriber"),f});
