var __defProp=Object.defineProperty,__defNormalProp=(r,e,a)=>e in r?__defProp(r,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[e]=a,__publicField=(r,e,a)=>__defNormalProp(r,"symbol"!=typeof e?e+"":e,a),StartValidateRule={name:"option",required:!0,properties:{sourceLanguage:{type:"string",required:!0},translationLanguages:{type:["string","array"],required:!1},userIdsToTranscribe:{type:["string","array"],required:!1},transcriberRobotId:{type:"string",required:!1}}},StopValidateRule={name:"option",required:!0,properties:{transcriberRobotId:{type:"string",required:!0}}},STOP_IGNORE_CODES=new Set([2002,4003]),_RealtimeTranscriber=class r{constructor(r){this.core=r,__publicField(this,"disableRandomCall",!0),__publicField(this,"activeTranscriberMap",new Map),__publicField(this,"_log"),this._log=this.core.log.createChild({id:`${this.getAlias()}`})}getName(){return r.Name}getAlias(){return"rt-trans"}getGroup(){return"*"}getValidateRule(r){switch(r){case"start":return StartValidateRule;case"update":return{};case"stop":return StopValidateRule}}async start(r){var e;const{RtcError:a,ErrorCode:t}=this.core.errorModule;if(!this.core.room.sendSignalMessage)throw new a({code:t.ENV_NOT_SUPPORTED});const{sourceLanguage:o,translationLanguages:s,userIdsToTranscribe:i="all",transcriberRobotId:n}=r,d=n||`transcriber_${this.core.room.roomId}_robot_${this.core.room.userId}`,c={sdkappid:this.core.room.sdkAppId,roomid:String(this.core.room.roomId),roomType:this.core.room.useStringRoomId?1:0,agentParam:{cdnRobotUserid:d,lifecycleUserid:this.core.room.userId,maxIdletime:30},subscribeParams:{subUsers:[]},asrParams:{lang:o,vadSilenceTime:1e3},translationParams:{mode:1,targetLangs:[""]}};s&&s.length>0&&(c.translationParams.mode=1,c.translationParams.targetLangs=Array.isArray(s)?s:[s]),"all"===i?c.subscribeParams.subUsers=[]:Array.isArray(i)?c.subscribeParams.subUsers=i.map(r=>({userId:r,roomType:this.core.room.useStringRoomId?1:0,roomid:String(this.core.room.roomId)})):i&&(c.subscribeParams.subUsers=[{userId:i,roomType:this.core.room.useStringRoomId?1:0,roomid:String(this.core.room.roomId)}]);try{this._log.info(`start_cloud_transcription ${JSON.stringify(c)}`);const o=await this.core.room.sendSignalMessage({command:"start_cloud_transcription",responseCommand:String(8268),data:c,retries:0}),{code:s,data:i}=o.data;if(0!==s){const r=(null==(e=o.data)?void 0:e.message)||"";throw this._log.error("start_cloud_transcription failed",{extraCode:s,reason:r,data:i}),new a({code:t.SERVER_ERROR,extraCode:s,message:r})}const{taskId:n}=i;if(!n)throw this._log.error("taskId is required",{data:o.data}),new a({code:t.SERVER_ERROR,message:"taskId is required"});return this.activeTranscriberMap.set(n,r),this._log.info(`start_cloud_transcription success ${n}, activeSize: ${this.activeTranscriberMap.size}`),n}catch(r){throw this._log.error("start_cloud_transcription failed",{error:r}),r}}async update(){}async stop({transcriberRobotId:r}){var e;const{RtcError:a,ErrorCode:t}=this.core.errorModule;if(!this.core.room.sendSignalMessage)throw new a({code:t.ENV_NOT_SUPPORTED});try{const o=await this.core.room.sendSignalMessage({command:"stop_cloud_transcription",responseCommand:String(8270),data:{taskId:r},retries:3});if(0!==o.data.code){const r=o.data.code,s=(null==(e=o.data)?void 0:e.message)||"";if(!STOP_IGNORE_CODES.has(r))throw this._log.error("stop_cloud_transcription failed",{extraCode:r,reason:s,data:o.data.data}),new a({code:t.SERVER_ERROR,extraCode:r,message:s});this._log.warn("stop_cloud_transcription ignored error",{extraCode:r,reason:s,data:o.data.data})}this.activeTranscriberMap.delete(r)}catch(r){throw this._log.error("stop_cloud_transcription failed",{error:r}),r}}destroy(){this.activeTranscriberMap.clear()}};__publicField(_RealtimeTranscriber,"Name","RealtimeTranscriber");var RealtimeTranscriber=_RealtimeTranscriber,index_default=RealtimeTranscriber;export{index_default as default};export{RealtimeTranscriber};