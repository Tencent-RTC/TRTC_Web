!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).LEBPlayer=t()}(this,function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function t(e,t,r,n,i,o,a){try{var c=e[o](a),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,i)}function r(e){return function(){var r=this,n=arguments;return new Promise(function(i,o){var a=e.apply(r,n);function c(e){t(a,i,o,c,s,"next",e)}function s(e){t(a,i,o,c,s,"throw",e)}c(void 0)})}}function n(e,t,r){return t=s(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,l()?Reflect.construct(t,r||[],s(e).constructor):t.apply(e,r))}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,y(n.key),n)}}function a(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=g(e))||t){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(c)throw o}}}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}function d(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",i=r.toStringTag||"@@toStringTag";function o(r,n,i,o){var s=n&&n.prototype instanceof c?n:c,u=Object.create(s.prototype);return f(u,"_invoke",function(r,n,i){var o,c,s,u=0,l=i||[],d=!1,f={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,r){return o=t,c=0,s=e,f.n=r,a}};function p(r,n){for(c=r,s=n,t=0;!d&&u&&!i&&t<l.length;t++){var i,o=l[t],p=f.p,h=o[2];r>3?(i=h===n)&&(s=o[(c=o[4])?5:(c=3,3)],o[4]=o[5]=e):o[0]<=p&&((i=r<2&&p<o[1])?(c=0,f.v=n,f.n=o[1]):p<h&&(i=r<3||o[0]>n||n>h)&&(o[4]=r,o[5]=n,f.n=h,c=0))}if(i||r>1)return a;throw d=!0,n}return function(i,l,h){if(u>1)throw TypeError("Generator is already running");for(d&&1===l&&p(l,h),c=l,s=h;(t=c<2?e:s)||!d;){o||(c?c<3?(c>1&&(f.n=-1),p(c,s)):f.n=s:f.v=s);try{if(u=2,o){if(c||(i="next"),t=o[i]){if(!(t=t.call(o,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,c<2&&(c=0)}else 1===c&&(t=o.return)&&t.call(o),c<2&&(s=TypeError("The iterator does not provide a '"+i+"' method"),c=1);o=e}else if((t=(d=f.n<0)?s:r.call(n,f))!==a)break}catch(t){o=e,c=1,s=t}finally{u=1}}return{value:t,done:d}}}(r,i,o),!0),u}var a={};function c(){}function s(){}function u(){}t=Object.getPrototypeOf;var l=[][n]?t(t([][n]())):(f(t={},n,function(){return this}),t),p=u.prototype=c.prototype=Object.create(l);function h(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,f(e,i,"GeneratorFunction")),e.prototype=Object.create(p),e}return s.prototype=u,f(p,"constructor",u),f(u,"constructor",s),s.displayName="GeneratorFunction",f(u,i,"GeneratorFunction"),f(p),f(p,i,"Generator"),f(p,n,function(){return this}),f(p,"toString",function(){return"[object Generator]"}),(d=function(){return{w:o,m:h}})()}function f(e,t,r,n){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}f=function(e,t,r,n){function o(t,r){f(e,t,function(e){return this._invoke(t,r,e)})}t?i?i(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(o("next",0),o("throw",1),o("return",2))},f(e,t,r,n)}function p(e,t){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},p(e,t)}function h(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,o,a,c=[],s=!0,u=!1;try{if(o=(r=r.call(e)).next,0===t);else for(;!(s=(n=o.call(r)).done)&&(c.push(n.value),c.length!==t);s=!0);}catch(e){u=!0,i=e}finally{try{if(!s&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(u)throw i}}return c}}(e,t)||g(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||g(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function g(t,r){if(t){if("string"==typeof t)return e(t,r);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,r):void 0}}function S(e){var t="function"==typeof Map?new Map:void 0;return S=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return function(e,t,r){if(l())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&p(i,r.prototype),i}(e,arguments,s(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),p(r,e)},S(e)}var b,w,P=Object.create,k=Object.defineProperty,E=Object.getOwnPropertyDescriptor,R=Object.getOwnPropertyNames,_=Object.getOwnPropertySymbols,T=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable,A=function(e,t,r){return t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r},O=function(e,t){for(var r in t||(t={}))I.call(t,r)&&A(e,r,t[r]);if(_){var n,i=c(_(t));try{for(i.s();!(n=i.n()).done;){r=n.value;D.call(t,r)&&A(e,r,t[r])}}catch(e){i.e(e)}finally{i.f()}}return e},C=function(e,t,r,n){for(var i,o=E(t,r),a=e.length-1;a>=0;a--)(i=e[a])&&(o=i(t,r,o)||o);return o&&k(t,r,o),o},j=function(e,t,r){return A(e,"symbol"!==m(t)?t+"":t,r)},L=(b={"../node_modules/.pnpm/eventemitter3@4.0.7/node_modules/eventemitter3/index.js":function(e,t){var r=Object.prototype.hasOwnProperty,n="~";function i(){}function o(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function a(e,t,r,i,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var c=new o(r,i||e,a),s=n?n+t:t;return e._events[s]?e._events[s].fn?e._events[s]=[e._events[s],c]:e._events[s].push(c):(e._events[s]=c,e._eventsCount++),e}function c(e,t){0===--e._eventsCount?e._events=new i:delete e._events[t]}function s(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),s.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(n?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},s.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,a=new Array(o);i<o;i++)a[i]=r[i].fn;return a},s.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},s.prototype.emit=function(e,t,r,i,o,a){var c=n?n+e:e;if(!this._events[c])return!1;var s,u,l=this._events[c],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,o),!0;case 6:return l.fn.call(l.context,t,r,i,o,a),!0}for(u=1,s=new Array(d-1);u<d;u++)s[u-1]=arguments[u];l.fn.apply(l.context,s)}else{var f,p=l.length;for(u=0;u<p;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),d){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,r);break;case 4:l[u].fn.call(l[u].context,t,r,i);break;default:if(!s)for(f=1,s=new Array(d-1);f<d;f++)s[f-1]=arguments[f];l[u].fn.apply(l[u].context,s)}}return!0},s.prototype.on=function(e,t,r){return a(this,e,t,r,!1)},s.prototype.once=function(e,t,r){return a(this,e,t,r,!0)},s.prototype.removeListener=function(e,t,r,i){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return c(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||i&&!a.once||r&&a.context!==r||c(this,o);else{for(var s=0,u=[],l=a.length;s<l;s++)(a[s].fn!==t||i&&!a[s].once||r&&a[s].context!==r)&&u.push(a[s]);u.length?this._events[o]=1===u.length?u[0]:u:c(this,o)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&c(this,t)):(this._events=new i,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,void 0!==t&&(t.exports=s)}},function(){return w||(0,b[R(b)[0]])((w={exports:{}}).exports,w),w.exports}),M={name:"option",required:!0,properties:{view:{type:["string",HTMLElement],required:!0},url:{type:"string",required:!0},muted:{type:"boolean",required:!1},volume:{type:"number",required:!1},fillMode:{type:"string",required:!1,values:["contain","cover","fill"]},loggerConfig:{type:"object",required:!0,properties:{sdkAppId:{type:"number",required:!0},userId:{type:"string",required:!0}}}}},x=function(e){var t=e.split("\r\n"),r=[];t.forEach(function(e){var t=e.toLowerCase();t.includes("a=rtpmap")&&t.includes("h264")&&r.push(e)});var n=r.map(function(e){var t=/a=rtpmap:(\d+)\s/.exec(e);return t&&t.length>1?t[1]:null}).filter(function(e){return null!==e}),i=[];return t.forEach(function(e){var t=e;if(e.includes("a=fmtp:111")&&(t="".concat(e,";stereo=1")),e.includes("a=fmtp")){var r=/a=fmtp:(\d+)\s/.exec(e);r&&r.length>1&&n.includes(r[1])&&(t="".concat(e,";sps-pps-idr-in-keyframe=1"))}i.push(t)}),function(e){if(!navigator.userAgent.includes("Firefox"))return e;var t=e.split("\r\n"),r=[],n=[];t.forEach(function(e){var t=e.toLowerCase();t.includes("a=rtpmap")&&t.includes("h264")&&r.push(e)}),r.length>1&&n.push.apply(n,v(r.slice(1)));var i=n.map(function(e){var t=/a=rtpmap:(\d+)\s/.exec(e);return t&&t.length>1?t[1]:null}).filter(function(e){return null!==e}),o=[];return t.forEach(function(e){var t=e;if(e.includes("a=setup")&&(t="a=setup:passive"),(e.includes("m=audio")||e.includes("m=video"))&&(t=e.split(" ").filter(function(e,t){return t<3||!i.includes(e)}).join(" ")),e.includes("a=fmtp")||e.includes("a=rtcp-fb")||e.includes("a=rtpmap")){var r=/a=(?:fmtp|rtcp-fb|rtpmap):(\d+)\s/.exec(e);if(r&&r.length>1&&i.includes(r[1]))return}o.push(t)}),o.join("\r\n")}(i.join("\r\n"))},N=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21,t="",r=crypto.getRandomValues(new Uint8Array(e|=0));e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&r[e]];return t},F=function(e){return"function"==typeof e};var U=function(e){var t=e.retryFunction,n=e.settings,i=e.onError,o=e.onRetrying,a=e.onRetryFailed,c=e.onRetrySuccess,s=e.context;return function(){for(var e=this,u=arguments.length,l=new Array(u),f=0;f<u;f++)l[f]=arguments[f];var p=n.retries,h=void 0===p?5:p,v=n.timeout,y=void 0===v?1e3:v,m=0,g=-1,S=0,b=function(){var n=r(d().m(function r(n,u){var f,p,v,w,P;return d().w(function(r){for(;;)switch(r.p=r.n){case 0:return f=s||e,r.p=1,r.n=2,t.apply(f,l);case 2:p=r.v,m>0&&c&&c.call(e,m),m=0,n(p),r.n=4;break;case 3:r.p=3,P=r.v,v=function(){clearTimeout(g),m=0,S=2,u(P)},w=function(){2!==S&&m<(F(h)?h():h)?(m++,S=1,F(o)&&o.call(e,m,v),g=window.setTimeout(function(){g=-1,b(n,u)},F(y)?y(m):y)):(v(),F(a)&&a.call(e,P))},F(i)?i.call(e,{error:P,retry:w,reject:u,retryFuncArgs:l,retriedCount:m}):w();case 4:return r.a(2)}},r,null,[[1,3]])}));return function(e,t){return n.apply(this,arguments)}}();return new Promise(b)}},B=new WeakMap;var V=function(){return a(function e(t,r){i(this,e),this.core=r,j(this,"peerConnection"),j(this,"audioTransceiver",null),j(this,"videoTransceiver",null),j(this,"timerId",null),j(this,"callback",null),j(this,"previousRawStats",null),j(this,"_prevReportTime",0),j(this,"_prevDecoderImplementation",""),j(this,"_decodeMap",new Map),this.peerConnection=t,this.findTransceivers()},[{key:"statInterval",get:function(){return 0===this._prevReportTime?2:(Date.now()-this._prevReportTime)/1e3}},{key:"findTransceivers",value:function(){var e,t=c(this.peerConnection.getTransceivers());try{for(t.s();!(e=t.n()).done;){var r=e.value;if(r.receiver&&r.receiver.track){var n=r.receiver.track;"audio"===n.kind?this.audioTransceiver=r:"video"===n.kind&&(this.videoTransceiver=r)}}}catch(e){t.e(e)}finally{t.f()}}},{key:"start",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3;this.stop(),this.callback=e,this.collectStats(),this.timerId=window.setInterval(function(){t.collectStats()},r)}},{key:"stop",value:function(){null!==this.timerId&&(clearInterval(this.timerId),this.timerId=null),this.callback=null,this.previousRawStats=null,this._prevReportTime=0}},{key:"collectStats",value:(e=r(d().m(function e(){var t,r,n,i,o,a,c,s;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.callback){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,this.peerConnection.getStats();case 2:t=e.v,r=new Set(["inbound-rtp","track","candidate-pair","media-source","codec"]),n=[],t.forEach(function(e){return r.has(e.type)&&n.push(e)}),i=Date.now(),o=this.parseAudioStats(n),a=this.parseVideoStats(n),c=this.parseNetworkStats(n),this._prevReportTime=i,this.callback({audio:o,video:a,network:c}),e.n=4;break;case 3:e.p=3,s=e.v,this.core.log.error("Failed to collect WebRTC stats:",s);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return e.apply(this,arguments)})},{key:"getDifferenceValue",value:function(e,t){if(this.core.utils.isUndefined(e))return t;var r=(t||0)-e;return r<0?0:r}},{key:"parseAudioStats",value:function(e){var t,r,n,i,o,a={bitrate:0,volume:0,packetLossRate:0,jitterBufferDelay:0,bytesReceived:0,packetsReceived:0,packetsLost:0},s=c(e);try{for(s.s();!(o=s.n()).done;){var u=o.value;if("inbound-rtp"===u.type&&("audio"===u.mediaType||"audio"===u.kind)){if(a.bytesReceived=u.bytesReceived||0,a.packetsReceived=u.packetsReceived||0,a.packetsLost=u.packetsLost||0,this.previousRawStats&&this.previousRawStats.audio){var l=this.getDifferenceValue(this.previousRawStats.audio.bytesReceived,a.bytesReceived);a.bitrate=Math.round(8*l/this.statInterval/1e3)}var d=this.getDifferenceValue(null==(t=this.previousRawStats)?void 0:t.audio.packetsLost,a.packetsLost),f=this.getDifferenceValue(null==(r=this.previousRawStats)?void 0:r.audio.packetsReceived,a.packetsReceived)+d;if(f>0&&(a.packetLossRate=Math.round(d/f*100)),this.core.utils.isUndefined(u.audioLevel)||(a.volume=u.audioLevel||0),u.jitterBufferDelay&&u.jitterBufferEmittedCount){var p=u.jitterBufferEmittedCount,h=u.jitterBufferDelay;(null==(n=this.previousRawStats)?void 0:n.audio)&&(p=this.getDifferenceValue(this.previousRawStats.audio.jitterBufferEmittedCount,u.jitterBufferEmittedCount),h=this.getDifferenceValue(this.previousRawStats.audio.jitterBufferDelay,u.jitterBufferDelay)),p>0&&(a.jitterBufferDelay=Math.floor(h/p*1e3)),this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.audio.jitterBufferDelay=u.jitterBufferDelay,this.previousRawStats.audio.jitterBufferEmittedCount=u.jitterBufferEmittedCount}this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.audio.bytesReceived=a.bytesReceived,this.previousRawStats.audio.packetsReceived=a.packetsReceived,this.previousRawStats.audio.packetsLost=a.packetsLost}!this.core.utils.isUndefined(u.audioLevel)&&(null==(i=this.audioTransceiver)?void 0:i.receiver.track)&&u.trackIdentifier===this.audioTransceiver.receiver.track.id&&(a.volume=u.audioLevel||0)}}catch(e){s.e(e)}finally{s.f()}return a}},{key:"parseVideoStats",value:function(e){var t,r,n,i,o,a,s={bitrate:0,frameRate:0,width:0,height:0,packetLossRate:0,jitterBufferDelay:0,bytesReceived:0,packetsReceived:0,packetsLost:0,framesDecoded:0},u=c(e);try{for(u.s();!(a=u.n()).done;){var l=a.value;if("codec"===l.type&&this._decodeMap.set(l.id,l),"inbound-rtp"===l.type&&("video"===l.mediaType||"video"===l.kind)){if(s.bytesReceived=l.bytesReceived||0,s.packetsReceived=l.packetsReceived||0,s.packetsLost=l.packetsLost||0,s.framesDecoded=l.framesDecoded||0,this.core.utils.isUndefined(l.framesPerSecond)||(s.frameRate=Math.round(l.framesPerSecond)),l.decoderImplementation&&this._prevDecoderImplementation!==l.decoderImplementation){var d=this._decodeMap.get(l.codecId),f=(null==(t=null==d?void 0:d.mimeType)?void 0:t.split("/")[1])||"unknown",p=l.powerEfficientDecoder;this.core.log.info("decoderImplementation change to ".concat(l.decoderImplementation,"(").concat(f,") HWDecoder: ").concat(p)),this._prevDecoderImplementation=l.decoderImplementation}if(this.previousRawStats&&this.previousRawStats.video){var h=this.getDifferenceValue(this.previousRawStats.video.bytesReceived,s.bytesReceived);s.bitrate=Math.round(8*h/this.statInterval/1e3)}var v=this.getDifferenceValue(null==(r=this.previousRawStats)?void 0:r.video.packetsLost,s.packetsLost),y=this.getDifferenceValue(null==(n=this.previousRawStats)?void 0:n.video.packetsReceived,s.packetsReceived)+v;if(y>0&&(s.packetLossRate=Math.round(v/y*100)),l.jitterBufferDelay&&l.jitterBufferEmittedCount){var m=l.jitterBufferEmittedCount,g=l.jitterBufferDelay;(null==(i=this.previousRawStats)?void 0:i.video)&&(m=this.getDifferenceValue(this.previousRawStats.video.jitterBufferEmittedCount,l.jitterBufferEmittedCount),g=this.getDifferenceValue(this.previousRawStats.video.jitterBufferDelay,l.jitterBufferDelay)),m>0&&(s.jitterBufferDelay=Math.floor(g/m*1e3)),this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.video.jitterBufferDelay=l.jitterBufferDelay,this.previousRawStats.video.jitterBufferEmittedCount=l.jitterBufferEmittedCount}this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.video.bytesReceived=s.bytesReceived,this.previousRawStats.video.packetsReceived=s.packetsReceived,this.previousRawStats.video.packetsLost=s.packetsLost}!this.core.utils.isUndefined(l.frameWidth)&&(null==(o=this.videoTransceiver)?void 0:o.receiver.track)&&l.trackIdentifier===this.videoTransceiver.receiver.track.id&&(s.width=l.frameWidth,s.height=l.frameHeight)}}catch(e){u.e(e)}finally{u.f()}return s}},{key:"parseNetworkStats",value:function(e){var t,r={rtt:0},n=c(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;if("candidate-pair"===i.type)if((i.selected||"succeeded"===i.state)&&this.core.utils.isNumber(i.currentRoundTripTime)){r.rtt=Math.floor(1e3*i.currentRoundTripTime);break}}}catch(e){n.e(e)}finally{n.f()}return r}},{key:"initPreviousRawStats",value:function(){this.previousRawStats={timestamp:Date.now(),audio:{bytesReceived:0,packetsReceived:0,packetsLost:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0}}}}]);var e}(),W=function(e,t,r){return r=null!=e?P(T(e)):{},function(e,t,r,n){if(t&&"object"===m(t)||"function"==typeof t){var i,o=c(R(t));try{var a=function(){var o=i.value;I.call(e,o)||o===r||k(e,o,{get:function(){return t[o]},enumerable:!(n=E(t,o))||n.enumerable})};for(o.s();!(i=o.n()).done;)a()}catch(e){o.e(e)}finally{o.f()}}return e}(k(r,"default",{value:e,enumerable:!0}),e)}(L()),q=Symbol("instance"),G=Symbol("cacheResult"),H=function(){return a(function e(t,r,n){i(this,e),this.oldState=t,this.newState=r,this.action=n,this.aborted=!1},[{key:"abort",value:function(e){this.aborted=!0,X.call(e,this.oldState,new Error("action '".concat(this.action,"' aborted")))}},{key:"toString",value:function(){return"".concat(this.action,"ing")}}])}(),Y=function(e){function t(e,r,o){var a;return i(this,t),(a=n(this,t,[r])).state=e,a.message=r,a.cause=o,a}return u(t,e),a(t)}(S(Error));var J=new Map;function K(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function(n,i,o){var a=r.action||i;if(!r.context){var c=J.get(n)||[];J.has(n)||J.set(n,c),c.push({from:e,to:t,action:a})}var s=o.value;o.value=function(){for(var n,i=this,o=this,c=arguments.length,u=new Array(c),l=0;l<c;l++)u[l]=arguments[l];r.context&&(o=$.get("function"==typeof r.context?(n=r.context).call.apply(n,[this].concat(u)):r.context));if(o.state===t)return r.sync?o[G]:Promise.resolve(o[G]);o.state instanceof H&&o.state.action==r.abortAction&&o.state.abort(o);var d=null;Array.isArray(e)?0==e.length?o.state instanceof H&&o.state.abort(o):"string"==typeof o.state&&e.includes(o.state)||(d=new Y(o._state,"".concat(o.name," ").concat(a," to ").concat(t," failed: current state ").concat(o._state," not from ").concat(e.join("|")))):e!==o.state&&(d=new Y(o._state,"".concat(o.name," ").concat(a," to ").concat(t," failed: current state ").concat(o._state," not from ").concat(e)));var f=function(e){if(r.fail&&r.fail.call(i,e),r.sync){if(r.ignoreError)return e;throw e}return r.ignoreError?Promise.resolve(e):Promise.reject(e)};if(d)return f(d);var p=o.state,h=new H(p,t,a);X.call(o,h);var v,y=function(e){var n;return o[G]=e,h.aborted||(X.call(o,t),null===(n=r.success)||void 0===n||n.call(i,o[G])),e},g=function(e){return X.call(o,p,e),f(e)};try{var S=s.apply(this,u);return"object"===m(v=S)&&v&&"then"in v?S.then(y).catch(g):r.sync?y(S):Promise.resolve(y(S))}catch(r){return g(new Y(o._state,"".concat(o.name," ").concat(a," from ").concat(e," to ").concat(t," failed: ").concat(r),r instanceof Error?r:new Error(String(r))))}}}}var z,Z,Q=(z="undefined"!=typeof window&&window.__AFSM__,Z="undefined"!=typeof importScripts,z?function(e,t){window.dispatchEvent(new CustomEvent(e,{detail:t}))}:Z?function(e,t){postMessage({type:e,payload:t})}:function(){});function X(e,t){var r=this._state;this._state=e;var n=e.toString();e&&this.emit(n,r),this.emit($.STATECHANGED,e,r,t),this.updateDevTools({value:e,old:r,err:t instanceof Error?t.message:String(t)})}var $=function(e){function t(e,r,o){var a;i(this,t),(a=n(this,t)).name=e,a.groupName=r,a._state=t.INIT,e||(e=Date.now().toString(36)),o?Object.setPrototypeOf(a,o):o=Object.getPrototypeOf(a),r||(a.groupName=a.constructor.name);var c=o[q];return c?a.name=c.name+"-"+c.count++:o[q]={name:a.name,count:0},a.updateDevTools({diagram:a.stateDiagram}),a}return u(t,e),a(t,[{key:"stateDiagram",get:function(){var e=Object.getPrototypeOf(this),t=J.get(e)||[],r=new Set,n=[],i=[],o=new Set,a=Object.getPrototypeOf(e);J.has(a)&&(a.stateDiagram.forEach(function(e){return r.add(e)}),a.allStates.forEach(function(e){return o.add(e)})),t.forEach(function(e){var t=e.from,r=e.to,o=e.action;"string"==typeof t?n.push({from:t,to:r,action:o}):t.length?t.forEach(function(e){n.push({from:e,to:r,action:o})}):i.push({to:r,action:o})}),n.forEach(function(e){var t=e.from,n=e.to,i=e.action;o.add(t),o.add(n),o.add(i+"ing"),r.add("".concat(t," --\x3e ").concat(i,"ing : ").concat(i)),r.add("".concat(i,"ing --\x3e ").concat(n," : ").concat(i," ðŸŸ¢")),r.add("".concat(i,"ing --\x3e ").concat(t," : ").concat(i," ðŸ”´"))}),i.forEach(function(e){var t=e.to,n=e.action;r.add("".concat(n,"ing --\x3e ").concat(t," : ").concat(n," ðŸŸ¢")),o.forEach(function(e){e!==t&&r.add("".concat(e," --\x3e ").concat(n,"ing : ").concat(n))})});var c=v(r);return Object.defineProperties(e,{stateDiagram:{value:c},allStates:{value:o}}),c}},{key:"updateDevTools",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Q(t.UPDATEAFSM,Object.assign({name:this.name,group:this.groupName},e))}},{key:"state",get:function(){return this._state},set:function(e){X.call(this,e)}}],[{key:"get",value:function(e){var r;return"string"==typeof e?(r=t.instances.get(e))||t.instances.set(e,r=new t(e,void 0,Object.create(t.prototype))):(r=t.instances2.get(e))||t.instances2.set(e,r=new t(e.constructor.name,void 0,Object.create(t.prototype))),r}},{key:"getState",value:function(e){var r;return null===(r=t.get(e))||void 0===r?void 0:r.state}}])}(W.default);$.STATECHANGED="stateChanged",$.UPDATEAFSM="updateAFSM",$.INIT="[*]",$.ON="on",$.OFF="off",$.instances=new Map,$.instances2=new WeakMap;var ee=function(e){function t(e,r){var o;return i(this,t),(o=n(this,t)).core=e,j(o,"audioPlayer"),j(o,"videoPlayer"),j(o,"callback"),j(o,"avPlayerStateSyncManager"),j(o,"_log"),j(o,"lastPausedReason"),j(o,"muted",!1),o._log=r,o.videoPlayer=new e.VideoPlayer({id:"vp",log:o._log.createChild({id:"vp"}),track:null,muted:!1,container:null,enableLogTrackState:!0}),o.audioPlayer=new e.RemoteAudioPlayer({id:"ap",log:o._log.createChild({id:"ap"}),track:null,muted:!1,container:null,enableVolumeControlInIOS:!0,enableLogTrackState:!0}),o.videoPlayer.on(e.PlayerEvent.LOAD_START,function(){return o.handleLoadStart("video")}),o.audioPlayer.on(e.PlayerEvent.LOAD_START,function(){return o.handleLoadStart("audio")}),o.videoPlayer.on(e.PlayerEvent.PLAYER_STATE_CHANGED,o.handlePlayerStateChanged,o),o.audioPlayer.on(e.PlayerEvent.PLAYER_STATE_CHANGED,o.handlePlayerStateChanged,o),o.videoPlayer.on(e.PlayerEvent.ENTER_PICTURE_IN_PICTURE,o.handleEnterPictureInPicture,o),o.videoPlayer.on(e.PlayerEvent.LEAVE_PICTURE_IN_PICTURE,o.handleLeavePictureInPicture,o),o.videoPlayer.on(e.PlayerEvent.ENTER_FULL_SCREEN,o.handleEnterFullScreen,o),o.videoPlayer.on(e.PlayerEvent.LEAVE_FULL_SCREEN,o.handleLeaveFullScreen,o),o.avPlayerStateSyncManager=new e.AVPlayerStateSyncManager({log:o._log,audioPlayer:o.audioPlayer,videoPlayer:o.videoPlayer}),o}return u(t,e),a(t,[{key:"isPlaying",get:function(){return this.videoPlayer.isPlaying&&this.audioPlayer.isPlaying}},{key:"isPaused",get:function(){return this.videoPlayer.isPaused&&this.audioPlayer.isPaused}},{key:"isStopped",get:function(){return this.videoPlayer.isStopped&&this.audioPlayer.isStopped}},{key:"setCallback",value:function(e){this.callback=e}},{key:"handleLoadStart",value:function(e){this.onLoadStart()}},{key:"handlePlayerStateChanged",value:function(e){"PLAYING"===e.state&&this.isPlaying&&this.onPlaying(),"PAUSED"===e.state&&this.isPaused&&this.onPaused(e.reason),"STOPPED"===e.state&&this.isStopped&&this.onStopped()}},{key:"handleEnterPictureInPicture",value:(p=r(d().m(function e(){var t,r;return d().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.videoPlayer.enterPIPPromise;case 1:null==(r=null==(t=this.callback)?void 0:t.onPictureInPictureStateChanged)||r.call(t,{isPictureInPicture:!0,pictureInPictureWindow:this.videoPlayer.pipWindow});case 2:return e.a(2)}},e,this)})),function(){return p.apply(this,arguments)})},{key:"handleLeavePictureInPicture",value:function(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onPictureInPictureStateChanged)||t.call(e,{isPictureInPicture:!1})}},{key:"handleEnterFullScreen",value:function(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onFullScreenStateChanged)||t.call(e,{isFullScreen:!0})}},{key:"handleLeaveFullScreen",value:function(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onFullScreenStateChanged)||t.call(e,{isFullScreen:!1})}},{key:"onLoadStart",value:function(){}},{key:"onPlaying",value:function(){}},{key:"onPaused",value:function(e){this.lastPausedReason=e}},{key:"onStopped",value:function(){}},{key:"setVideoContainer",value:function(e){if(this.core.utils.isString(e)){var t=document.getElementById(e);t&&this.videoPlayer.setContainer(t)}else this.videoPlayer.setContainer(e)}},{key:"setVolume",value:function(e){this.core.utils.isUndefined(e)||this.audioPlayer.setVolume(e/100)}},{key:"setMuted",value:function(e){this.core.utils.isUndefined(e)||(this.muted=e,this.audioPlayer.setMuted(e))}},{key:"setFillMode",value:function(e){e&&this.videoPlayer.setObjectFit(e)}},{key:"setAudioTrack",value:function(e){this.audioPlayer.setTrack(e)}},{key:"setVideoTrack",value:function(e){this.videoPlayer.setTrack(e)}},{key:"play",value:(f=r(d().m(function e(){var t,r,n=this;return d().w(function(e){for(;;)switch(e.n){case 0:return t=this.videoPlayer.play().catch(function(e){var t,r;n.handleAutoPlayFailed(n.videoPlayer,e),null==(r=null==(t=n.callback)?void 0:t.onAutoPlayFailed)||r.call(t,{type:"video",resume:function(){return n.videoPlayer.resume()}})}),r=this.audioPlayer.play().catch(function(e){var t,r;n.handleAutoPlayFailed(n.audioPlayer,e),null==(r=null==(t=n.callback)?void 0:t.onAutoPlayFailed)||r.call(t,{type:"audio",resume:function(){return n.audioPlayer.resume()}})}),e.n=1,Promise.all([t,r]);case 1:return e.a(2)}},e,this)})),function(){return f.apply(this,arguments)})},{key:"handleAutoPlayFailed",value:function(e,t){var r=this;this._log.warn("handleAutoPlayFailed",t);var n=function(){r.audioPlayer.resume().then(function(){document.removeEventListener("click",n,!0)})};document.addEventListener("click",n,!0)}},{key:"pause",value:function(){this.videoPlayer.pause(!1),this.audioPlayer.setMuted(!0),this.audioPlayer.pause()}},{key:"resume",value:function(){this.videoPlayer.resume(!0),this.audioPlayer.setMuted(this.muted),this.audioPlayer.resume()}},{key:"enterFullscreen",value:(l=r(d().m(function e(){return d().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.videoPlayer.enterFullscreen();case 1:return e.a(2)}},e,this)})),function(){return l.apply(this,arguments)})},{key:"exitFullscreen",value:(s=r(d().m(function e(){return d().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.videoPlayer.exitFullscreen();case 1:return e.a(2)}},e,this)})),function(){return s.apply(this,arguments)})},{key:"enterPictureInPicture",value:(c=r(d().m(function e(){return d().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.videoPlayer.enterPictureInPicture();case 1:return e.a(2)}},e,this)})),function(){return c.apply(this,arguments)})},{key:"exitPictureInPicture",value:(o=r(d().m(function e(){return d().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.videoPlayer.exitPictureInPicture();case 1:return e.a(2)}},e,this)})),function(){return o.apply(this,arguments)})},{key:"stop",value:function(){this.videoPlayer&&this.videoPlayer.stop(),this.audioPlayer&&(this.audioPlayer.stop(),this.audioPlayer.setMuted(!1))}}]);var o,c,s,l,f,p}($);C([K([$.INIT,"PAUSED"],"LOADSTART",{ignoreError:!0,sync:!0,success:function(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onLoadStart)||t.call(e)},fail:function(e){this._log.warn("onLoadStart",e)}})],ee.prototype,"onLoadStart"),C([K(["LOADSTART","PAUSED"],"PLAYING",{ignoreError:!0,sync:!0,success:function(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onPlaying)||t.call(e)},fail:function(e){this._log.warn("onPlaying",e)}})],ee.prototype,"onPlaying"),C([K("PLAYING","PAUSED",{ignoreError:!0,sync:!0,success:function(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onPaused)||t.call(e,{reason:this.lastPausedReason})},fail:function(e){this._log.warn("onPaused",e)}})],ee.prototype,"onPaused"),C([K([],$.INIT,{ignoreError:!0,sync:!0,success:function(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onStopped)||t.call(e)},fail:function(e){this._log.warn("onStopped",e)}})],ee.prototype,"onStopped");var te,re,ne,ie,oe,ae,ce,se,ue,le,de,fe=ee,pe=["overseas-webrtc.tlivewebrtc.com","oswebrtc-lint.tliveplay.com"],he=function(){function e(t){i(this,e),this.core=t,j(this,"_sdkAppId"),j(this,"_userId"),j(this,"connectedRoomIdSet",new Set),j(this,"updateSeq",0),j(this,"_log"),j(this,"player"),j(this,"peerConnection"),j(this,"svrSig"),j(this,"streamURL"),j(this,"signalURL"),j(this,"insertableStreamsAbortMap",new Map),j(this,"scriptTransformWorker"),j(this,"connectionState","disconnected"),j(this,"isStarted",!1),j(this,"isStopped",!0),j(this,"isReconnecting",!1),j(this,"callback"),j(this,"isFireWallErrorEmitted",!1),j(this,"stat"),j(this,"isH264DecodeSupported"),j(this,"connectionTimeoutId"),t.loggerManager.startUpload(),this._log=this.core.log.createChild({id:"".concat(this.getAlias())}),this.player=new fe(t,this._log),t.innerEmitter.on(t.INNER_EVENT.SEI_MESSAGE,this.onSEIMessage,this)}return a(e,[{key:"getName",value:function(){return e.Name}},{key:"getAlias",value:function(){return"LEB"}},{key:"getGroup",value:function(){return""}},{key:"getValidateRule",value:function(e){switch(e){case"start":return M;case"update":case"stop":return{}}}},{key:"enableSEI",get:function(){return this.core.room.enableSEI&&(this.core.rtcDectection.IS_INSERTABLE_STREAM_SUPPORTED||this.core.rtcDectection.IS_SCRIPT_TRANSFORM_SUPPORTED)}},{key:"start",value:(v=r(d().m(function e(t){var r,n,i,o,a,c,s,u,l,f,p,h,v,y,m,g,S,b=this;return d().w(function(e){for(;;)switch(e.n){case 0:if(this.isStopped=!1,n=t.view,i=t.url,o=t.volume,a=t.muted,c=t.fillMode,s=t.loggerConfig,u=t.callback,this.callback=u,this.player.setCallback(u),l=this.core,f=l.errorModule,p=f.RtcError,h=f.ErrorCode,v=f.ErrorCodeDictionary,y=l.loggerManager,m=l.rtcDectection,this._sdkAppId=s.sdkAppId,this._userId=s.userId,this._log.setSdkAppId(s.sdkAppId),this._log.setUserId(s.userId),y.addJoinedUser(s),m.isWebRTCSupported()&&m.isAddTransceiverSupported()){e.n=1;break}throw new p({code:h.ENV_NOT_SUPPORTED,extraCode:v.NOT_SUPPORTED_WEBRTC,message:"webrtc not supported"});case 1:return e.n=2,m.decodeSupportStatus();case 2:if(S=!e.v.isH264DecodeSupported){e.n=3;break}S=!1===this.isH264DecodeSupported;case 3:if(!S){e.n=4;break}throw this.isH264DecodeSupported=!1,new p({code:h.ENV_NOT_SUPPORTED,extraCode:v.NOT_SUPPORTED_H264_DECODE,message:"h264 not supported"});case 4:return!m.IS_SEI_SUPPORTED&&(null==u?void 0:u.onSEIMessage)&&(null==(r=u.onError)||r.call(u,new p({code:h.ENV_NOT_SUPPORTED,extraCode:v.NOT_SUPPORTED_SEI,message:"sei not supported"}))),this.player.setVideoContainer(n),this.player.setMuted(a),this.player.setFillMode(c),e.n=5,this.connect(i);case 5:return this.stat=new V(this.peerConnection,this.core),this.stat.start(function(e){var t,r;return null==(r=null==(t=b.callback)?void 0:t.onStats)?void 0:r.call(t,e)}),g=this.player.play(),this.player.setVolume(o),e.n=6,g;case 6:this.isStarted=!0;case 7:return e.a(2)}},e,this)})),function(e){return v.apply(this,arguments)})},{key:"connect",value:function(e){var t=this;return new Promise(function(r,n){try{t.initScriptTransformWorker();var i={encodedInsertableStreams:t.enableSEI,iceServers:[],sdpSemantics:"unified-plan",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"},o=new RTCPeerConnection(i);t.peerConnection=o,o.onconnectionstatechange=function(){t.connectionState=o.connectionState,t._log.info("connectionState",o.connectionState),"failed"!==o.connectionState&&"closed"!==o.connectionState||(t.isStarted?t.reconnect(e):n(new Error("connection is ".concat(o.connectionState)))),"connected"===o.connectionState&&(t.logSelectedCandidate(),r())},o.ontrack=function(e){return t.onTrack(e)},o.addTransceiver("audio",{direction:"recvonly"}),o.addTransceiver("video",{direction:"recvonly"}),t._log.info("createOffer"),o.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1}).then(function(e){return e.sdp=x(e.sdp),t._log.info("setOffer"),o.setLocalDescription(e)}).then(function(){var r={sessionId:N(),streamurl:e,clientinfo:t.core.environment.getOSString(),localsdp:o.localDescription};return t.exchangeSDP(e,r)}).then(function(e){return t._log.info("setAnswer"),o.setRemoteDescription(e)}).catch(n)}catch(e){n(e)}t.connectionTimeoutId=setTimeout(function(){return n(new Error("connection timeout"))},1e4)})}},{key:"exchangeSDP",value:(p=r(d().m(function e(t,r){var n,i,o,a,c,s,u,l,f,p,h=this;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,this._log.info("exchangeSDP"),a=Se(t)){e.n=1;break}throw new Error("streamDomain is empty");case 1:return e.n=2,this.fetchSignalDomain(a);case 2:if(c=e.v,s=c.signalDomain,u=c.cached,!s){e.n=4;break}return this._log.info("try exchangeSDP signalDomain:",s,u),e.n=3,this.doExchangeSDP("https://".concat(s),r,3);case 3:l=e.v,n=l.url,i=l.remoteSdp,o=l.svrSig,e.n=5;break;case 4:throw new Error("signalDomain is empty");case 5:e.n=8;break;case 6:return e.p=6,p=e.v,this._log.warn("exchangeSDP failed, fallback",p),e.n=7,this.core.utils.promiseAny(pe.map(function(e){return h.doExchangeSDP("https://".concat(e),r,3)}));case 7:f=e.v,n=f.url,i=f.remoteSdp,o=f.svrSig;case 8:return this.streamURL=t,this.signalURL=n,this.svrSig=o,e.a(2,i)}},e,this,[[0,6]])})),function(e,t){return p.apply(this,arguments)})},{key:"reconnect",value:(f=r(d().m(function e(t){var r;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!this.isReconnecting){e.n=1;break}return e.a(2);case 1:return this.isReconnecting=!0,e.p=2,this._log.warn("start reconnect"),e.n=3,this.connect(t);case 3:this._log.warn("reconnect success"),e.n=5;break;case 4:e.p=4,r=e.v,this._log.error("reconnect error",r);case 5:return e.p=5,this.isReconnecting=!1,e.f(5);case 6:return e.a(2)}},e,this,[[2,4,5,6]])})),function(e){return f.apply(this,arguments)})},{key:"logSelectedCandidate",value:(l=r(d().m(function e(){var t,r,n,i,o,a,s,u;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.peerConnection){e.n=1;break}return e.a(2);case 1:return e.n=2,this.peerConnection.getStats();case 2:t=e.v,r=c(t),e.p=3,r.s();case 4:if((n=r.n()).done){e.n=6;break}if((i=h(n.value,2))[0],o=i[1],!this.core.rtcDectection.isSelectedCandidatePair(o)){e.n=5;break}return a=t.get(o.localCandidateId),s=t.get(o.remoteCandidateId),a&&this._log.info("local candidate: ".concat(a.candidateType," ").concat(a.protocol,":").concat(a.ip||a.address,":").concat(a.port," ").concat(a.networkType||""," ").concat(a.relayProtocol?"relayProtocol:".concat(a.relayProtocol," url: ").concat(a.url):"")),s&&this._log.info("remote candidate: ".concat(s.candidateType," ").concat(s.protocol,":").concat(s.ip||s.address,":").concat(s.port)),e.a(3,6);case 5:e.n=4;break;case 6:e.n=8;break;case 7:e.p=7,u=e.v,r.e(u);case 8:return e.p=8,r.f(),e.f(8);case 9:return e.a(2)}},e,this,[[3,7,8,9]])})),function(){return l.apply(this,arguments)})},{key:"doExchangeSDP",value:(u=r(d().m(function e(t,r,n){var i,o,a,c,s,u,l;return d().w(function(e){for(;;)switch(e.n){case 0:return i="".concat(t,"/webrtc/v1/pullstream"),e.n=1,ye(i,r,{timeout:n});case 1:if(o=e.v,a=o.errcode,c=o.errmsg,s=o.remotesdp,u=o.svrsig,0===a){e.n=2;break}throw(l=new Error("errCode:".concat(a,", errMsg:").concat(c))).name="RequestSignalError",l;case 2:return e.a(2,{url:t,remoteSdp:s,svrSig:u})}},e)})),function(e,t,r){return u.apply(this,arguments)})},{key:"createEncodedStreams",value:function(e){var t,r=this;if(this.enableSEI&&this.core.rtcDectection.IS_INSERTABLE_STREAM_SUPPORTED)try{if(this._log.warn("enableSEI",this.enableSEI),!this.insertableStreamsAbortMap.has(e)){var n=e.createEncodedStreams(),i=new AbortController,o={abortController:i,enqueue:function(t){return"audio"===e.track.kind?t:r.decodeVideoFrame(t)}};n.readable.pipeThrough(new TransformStream({transform:function(e,t){var r=o.enqueue(e);r&&t.enqueue(r)}})).pipeTo(n.writable,i).catch(function(e){"destroy"!==e&&r._log.warn(e)}),null==(t=this.insertableStreamsAbortMap.get(e))||t.abort("destroy"),this.insertableStreamsAbortMap.set(e,i)}}catch(t){this._log.warn("createEncodedStreams ".concat(e.track.kind," failed"),t)}}},{key:"initReceiverTransform",value:function(e,t){this.peerConnection&&this.enableSEI&&this.scriptTransformWorker&&!e.transform&&(e.transform=new RTCRtpScriptTransform(this.scriptTransformWorker,{isReceiver:!0,isAudio:t,userId:"",streamType:this.core.enums.RemoteStreamType.Main}))}},{key:"initScriptTransformWorker",value:function(){var e=this,t=this.core,r=t.room,n=t.rtcDectection,i=t.createScriptTransformWorker;t.trtc,t.TRTC,!this.enableSEI||n.IS_INSERTABLE_STREAM_SUPPORTED||this.scriptTransformWorker||n.IS_SCRIPT_TRANSFORM_SUPPORTED&&(this._log.info("initScriptTransformWorker"),this.scriptTransformWorker=i({videoEncodePipeline:r.videoManager.encodePipeline,videoDecodePipeline:r.videoManager.decodePipeline,audioEncodePipeline:r.audioManager.encodePipeline,audioDecodePipeline:r.audioManager.decodePipeline}),this.scriptTransformWorker.onmessage=function(t){var r,n;"sei"===t.data.type&&(null==(n=null==(r=e.callback)?void 0:r.onSEIMessage)||n.call(r,{data:t.data.data,seiPayloadType:t.data.seiPayloadType}))},this.scriptTransformWorker.onerror=function(t){e._log.error("scriptTransformWorker error: ",t.message)})}},{key:"decodeVideoFrame",value:function(e){if(!this.core.room.videoManager)return e;var t,r=c(this.core.room.videoManager.decodePipeline);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n&&!(e=n({frame:e})))return}}catch(e){r.e(e)}finally{r.f()}return e}},{key:"fetchStopStream",value:(s=r(d().m(function e(){var t,r,n,i,o;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.streamURL&&this.svrSig&&this.signalURL){e.n=1;break}return e.a(2);case 1:return e.p=1,t="".concat(this.signalURL,"/webrtc/v1/stopstream"),e.n=2,ye(t,{streamurl:this.streamURL,svrsig:this.svrSig},{timeout:3});case 2:if(r=e.v,n=r.errcode,i=r.errmsg,0===n){e.n=3;break}throw new Error("errCode:".concat(n,", errmsg:").concat(i));case 3:return e.a(2,r);case 4:e.p=4,o=e.v,this._log.error("fetchStopStream error",o);case 5:return e.a(2)}},e,this,[[1,4]])})),function(){return s.apply(this,arguments)})},{key:"onTrack",value:function(e){var t=e.track;this.createEncodedStreams(e.receiver),this.initReceiverTransform(e.receiver,"audio"===t.kind),"audio"===t.kind?this.player.setAudioTrack(t):this.player.setVideoTrack(t)}},{key:"update",value:(o=r(d().m(function e(t){var r,n,i,o,a,c,s;return d().w(function(e){for(;;)switch(e.n){case 0:if(r=t.view,n=t.volume,i=t.muted,o=t.fillMode,a=t.action,c=t.fullScreen,s=t.pictureInPicture,this.player.setMuted(i),this.player.setVolume(n),this.player.setFillMode(o),r&&this.player.videoPlayer.setContainer(this.core.utils.isString(r)?document.getElementById(r):r),"pause"===a?this.player.pause():"resume"===a&&this.player.resume(),!this.core.utils.isBoolean(c)){e.n=3;break}if(!c){e.n=2;break}return e.n=1,this.player.enterFullscreen();case 1:e.n=3;break;case 2:return e.n=3,this.player.exitFullscreen();case 3:if(!this.core.utils.isBoolean(s)){e.n=6;break}if(!s){e.n=5;break}return e.n=4,this.player.enterPictureInPicture();case 4:e.n=6;break;case 5:return e.n=6,this.player.exitPictureInPicture();case 6:return e.a(2)}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"stop",value:(n=r(d().m(function e(){var t=this;return d().w(function(e){for(;;)switch(e.n){case 0:if(this.isStopped=!0,this.player.stop(),!this.peerConnection){e.n=2;break}return clearTimeout(this.connectionTimeoutId),this.peerConnection.close(),this.peerConnection.getReceivers().forEach(function(e){return t.insertableStreamsAbortMap.delete(e)}),delete this.peerConnection,e.n=1,this.fetchStopStream();case 1:delete this.streamURL,delete this.signalURL,delete this.svrSig;case 2:this.stat&&(this.stat.stop(),delete this.stat),this.core.room.keyPointManager.uploadKVStat(this.core.kvStatManager,this._sdkAppId);case 3:return e.a(2)}},e,this)})),function(){return n.apply(this,arguments)})},{key:"destroy",value:function(){this.stop(),this.core.innerEmitter.off(this.core.INNER_EVENT.SEI_MESSAGE,this.onSEIMessage,this)}},{key:"onSEIMessage",value:function(e){var t,r,n=e.room,i=e.nalu;n===this.core.room&&(null==(r=null==(t=this.callback)?void 0:t.onSEIMessage)||r.call(t,{data:i.seiPayload.buffer,seiPayloadType:i.seiPayloadType}))}},{key:"fetchSignalDomain",value:(t=r(d().m(function e(t){var r,n,i,o,a,c,s,u,l,f,p,h,v=arguments;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=v.length>1&&void 0!==v[1]?v[1]:me[0],n="https://".concat(r,"/signal_query"),e.p=1,!(i=window.localStorage.getItem(ge))){e.n=2;break}if(!((o=JSON.parse(i))[t].expire-(new Date).getTime()>0)){e.n=2;break}return e.a(2,{signalDomain:o[t].signal,cached:!0});case 2:return e.n=3,ye(n,{domain:t,requestid:N(16),client_type:"Web",client_info:window.navigator.userAgent});case 3:if(a=e.v,c=a.errcode,s=a.data,0!==c){e.n=4;break}u=s.signal_domain,l=s.cache_time,f={},(p=window.localStorage.getItem(ge))&&(f=JSON.parse(p)),f[t]={signal:u,expire:(new Date).getTime()+1e3*l};try{window.localStorage.setItem(ge,JSON.stringify(f))}catch(e){}return e.a(2,{signalDomain:u,cached:!1});case 4:throw new Error("errCode:".concat(c));case 5:if(e.p=5,h=e.v,this._log.error("fetchSignalDomain error",h),r===me[1]){e.n=6;break}return e.a(2,this.fetchSignalDomain(t,me[1]));case 6:return e.a(2,{signalDomain:"",cached:!1});case 7:return e.a(2)}},e,this,[[1,5]])})),function(e){return t.apply(this,arguments)})}]);var t,n,o,s,u,l,f,p,v}();j(he,"Name","LEBPlayer"),C([(te={settings:{retries:1/0,timeout:2e3},onRetrying:function(e){var t;if(this._log.warn("retry connect ".concat(e)),e>=3&&(null==(t=this.callback)?void 0:t.onError)&&!this.isFireWallErrorEmitted){var r=this.core.errorModule,n=r.RtcError,i=r.ErrorCode,o=r.ErrorCodeDictionary;this.isFireWallErrorEmitted=!0,this.callback.onError(new n({code:i.OPERATION_FAILED,extraCode:o.FIREWALL_RESTRICTION,message:"firewall restriction"}))}},onError:function(e,t,r,n){var i;if(this._log.warn("connect failed",e),this.peerConnection&&(this.peerConnection.close(),delete this.peerConnection),!this.isStopped&&(null==(i=e.message||e)?void 0:i.includes("connection")))t();else{var o=this.core.errorModule;r(new(0,o.RtcError)({code:o.ErrorCode.UNKNOWN_ERROR,message:e.message}))}}},re=te.settings,ne=void 0===re?{retries:5,timeout:2e3}:re,ie=te.onError,oe=te.onRetrying,ae=te.onRetryFailed,function(e,t,r){var n=U({retryFunction:r.value,settings:ne,onError:function(r){var n,i=r.error,o=r.retry,a=r.reject,c=r.retryFuncArgs;ie?ie.call(this,i,function(){var r;(null==(r=B.get(e))?void 0:r.has(t))?o():a(i)},a,c):(null==(n=B.get(e))?void 0:n.has(t))?o():a(i)},onRetrying:function(r,n){var i;F(oe)&&oe.call(this,r,n),(null==(i=B.get(e))?void 0:i.has(t))&&(B.get(e).get(t).stopRetry=n)},onRetryFailed:ae});return r.value=function(){for(var r=B.get(e),i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return r?r.set(t,{args:o}):B.set(e,new Map([[t,{args:o}]])),n.apply(this,o).finally(function(){var r;return null==(r=B.get(e))?void 0:r.delete(t)})},r})],he.prototype,"connect"),C([(ce={fnName:"connect"},se=ce.fnName,ue=ce.callback,le=ce.validateArgs,de=void 0===le||le,function(e,t,r){var n=r.value;return r.value=function(){for(var t,r,i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];if(null==(t=B.get(e))?void 0:t.has(se)){var s=B.get(e).get(se),u=s.stopRetry,l=s.args,d=!0;if(de){var f,p=c(l);try{var h=function(){var e=f.value;if(!o.find(function(t){return t===e}))return d=!1,1};for(p.s();!(f=p.n()).done&&!h(););}catch(e){p.e(e)}finally{p.f()}}d&&(ue&&ue.apply(this,o),u&&u(),null==(r=B.get(e))||r.delete(se))}return n.apply(this,o)},r})],he.prototype,"stop");var ve=he,ye=function(){var e=r(d().m(function e(t,r){var n,i,o,a,c,s,u=arguments;return d().w(function(e){for(;;)switch(e.n){case 0:return n=(u.length>2&&void 0!==u[2]?u[2]:{}).timeout,i=void 0===n?10:n,a=0,c={},window.AbortController&&(o=new window.AbortController,c={signal:o.signal},a=window.setTimeout(function(){return o.abort()},1e3*i)),e.n=1,fetch(t,O({body:JSON.stringify(r),cache:"no-cache",credentials:"same-origin",headers:{"content-type":"text/plain;charset=utf-8"},method:"POST",mode:"cors"},c));case 1:if(s=e.v,a&&window.clearTimeout(a),200===s.status){e.n=2;break}throw new Error("Network Error, status code:".concat(s.status));case 2:return e.a(2,s.json())}},e)}));return function(t,r){return e.apply(this,arguments)}}(),me=["webrtc-signal-scheduler.tlivesource.com","bak-webrtc-signal-scheduler.tlivesource.com"],ge="LEB_PLAYER_STORAGE_KEY",Se=function(e){var t=/^(?:webrtc:\/\/)([0-9.\-A-Za-z_]+)(?:\/)(?:[0-9.\-A-Za-z_=]+)(?:\/)(?:[^?#]*)(?:\?*)(?:[^?#]*)/.exec(e);return t?t[1]:""};return ve});
