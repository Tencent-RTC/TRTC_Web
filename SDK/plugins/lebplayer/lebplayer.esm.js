var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getOwnPropSymbols=Object.getOwnPropertySymbols,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__spreadValues=(e,t)=>{for(var i in t||(t={}))__hasOwnProp.call(t,i)&&__defNormalProp(e,i,t[i]);if(__getOwnPropSymbols)for(var i of __getOwnPropSymbols(t))__propIsEnum.call(t,i)&&__defNormalProp(e,i,t[i]);return e},__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,i,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of __getOwnPropNames(t))__hasOwnProp.call(e,s)||s===i||__defProp(e,s,{get:()=>t[s],enumerable:!(r=__getOwnPropDesc(t,s))||r.enumerable});return e},__toESM=(e,t,i)=>(i=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?i:__defProp(i,"default",{value:e,enumerable:!0}),e)),__decorateClass=(e,t,i,r)=>{for(var s,a=r>1?void 0:r?__getOwnPropDesc(t,i):t,o=e.length-1;o>=0;o--)(s=e[o])&&(a=(r?s(t,i,a):s(a))||a);return r&&a&&__defProp(t,i,a),a},__publicField=(e,t,i)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),require_eventemitter3=__commonJS({"../node_modules/.pnpm/eventemitter3@4.0.7/node_modules/eventemitter3/index.js"(e,t){"use strict";var i=Object.prototype.hasOwnProperty,r="~";function s(){}function a(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function o(e,t,i,s,o){if("function"!=typeof i)throw new TypeError("The listener must be a function");var n=new a(i,s||e,o),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],n]:e._events[c].push(n):(e._events[c]=n,e._eventsCount++),e}function n(e,t){0===--e._eventsCount?e._events=new s:delete e._events[t]}function c(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(r=!1)),c.prototype.eventNames=function(){var e,t,s=[];if(0===this._eventsCount)return s;for(t in e=this._events)i.call(e,t)&&s.push(r?t.slice(1):t);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},c.prototype.listeners=function(e){var t=r?r+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var s=0,a=i.length,o=new Array(a);s<a;s++)o[s]=i[s].fn;return o},c.prototype.listenerCount=function(e){var t=r?r+e:e,i=this._events[t];return i?i.fn?1:i.length:0},c.prototype.emit=function(e,t,i,s,a,o){var n=r?r+e:e;if(!this._events[n])return!1;var c,l,d=this._events[n],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,i),!0;case 4:return d.fn.call(d.context,t,i,s),!0;case 5:return d.fn.call(d.context,t,i,s,a),!0;case 6:return d.fn.call(d.context,t,i,s,a,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c)}else{var h,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,i);break;case 4:d[l].fn.call(d[l].context,t,i,s);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];d[l].fn.apply(d[l].context,c)}}return!0},c.prototype.on=function(e,t,i){return o(this,e,t,i,!1)},c.prototype.once=function(e,t,i){return o(this,e,t,i,!0)},c.prototype.removeListener=function(e,t,i,s){var a=r?r+e:e;if(!this._events[a])return this;if(!t)return n(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||i&&o.context!==i||n(this,a);else{for(var c=0,l=[],d=o.length;c<d;c++)(o[c].fn!==t||s&&!o[c].once||i&&o[c].context!==i)&&l.push(o[c]);l.length?this._events[a]=1===l.length?l[0]:l:n(this,a)}return this},c.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&n(this,t)):(this._events=new s,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=r,c.EventEmitter=c,void 0!==t&&(t.exports=c)}}),StartValidateRule={name:"option",required:!0,properties:{view:{type:["string",HTMLElement],required:!0},url:{type:"string",required:!0},muted:{type:"boolean",required:!1},volume:{type:"number",required:!1},fillMode:{type:"string",required:!1,values:["contain","cover","fill"]},loggerConfig:{type:"object",required:!0,properties:{sdkAppId:{type:"number",required:!0},userId:{type:"string",required:!0}}}}},UpdateValidateRule={name:"option",required:!0,properties:{view:{type:["string",HTMLElement],required:!1},volume:{type:"number",required:!1},muted:{type:"boolean",required:!1},fillMode:{type:"string",required:!1,values:["contain","cover","fill"]},action:{type:"string",required:!1,values:["pause","resume"]},fullScreen:{type:"boolean",required:!1},pictureInPicture:{type:"boolean",required:!1}}},updateSdpForFirefox=e=>{if(!navigator.userAgent.includes("Firefox"))return e;const t=e.split("\r\n"),i=[],r=[];t.forEach(e=>{const t=e.toLowerCase();t.includes("a=rtpmap")&&t.includes("h264")&&i.push(e)}),i.length>1&&r.push(...i.slice(1));const s=r.map(e=>{const t=/a=rtpmap:(\d+)\s/.exec(e);return t&&t.length>1?t[1]:null}).filter(e=>null!==e),a=[];return t.forEach(e=>{let t=e;if(e.includes("a=setup")&&(t="a=setup:passive"),(e.includes("m=audio")||e.includes("m=video"))&&(t=e.split(" ").filter((e,t)=>t<3||!s.includes(e)).join(" ")),e.includes("a=fmtp")||e.includes("a=rtcp-fb")||e.includes("a=rtpmap")){const t=/a=(?:fmtp|rtcp-fb|rtpmap):(\d+)\s/.exec(e);if(t&&t.length>1&&s.includes(t[1]))return}a.push(t)}),a.join("\r\n")},updateSdpRestriction=e=>{const t=e.split("\r\n"),i=[];t.forEach(e=>{const t=e.toLowerCase();t.includes("a=rtpmap")&&t.includes("h264")&&i.push(e)});const r=i.map(e=>{const t=/a=rtpmap:(\d+)\s/.exec(e);return t&&t.length>1?t[1]:null}).filter(e=>null!==e),s=[];t.forEach(e=>{let t=e;if(e.includes("a=fmtp:111")&&(t=`${e};stereo=1`),e.includes("a=fmtp")){const i=/a=fmtp:(\d+)\s/.exec(e);i&&i.length>1&&r.includes(i[1])&&(t=`${e};sps-pps-idr-in-keyframe=1`)}s.push(t)});const a=s.join("\r\n");return updateSdpForFirefox(a)},urlAlphabet="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid=(e=21)=>{let t="",i=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+=urlAlphabet[63&i[e]];return t},isFunction=e=>"function"==typeof e,RETRY_STATE_NOT_START=0,RETRY_STATE_STARTED=1,RETRY_STATE_STOPPED=2;function promiseRetry({retryFunction:e,settings:t,onError:i,onRetrying:r,onRetryFailed:s,onRetrySuccess:a,context:o}){return function(...n){const{retries:c=5,timeout:l=1e3}=t;let d=0,u=-1,h=RETRY_STATE_NOT_START;const p=async(t,f)=>{const v=o||this;try{const i=await e.apply(v,n);d>0&&a&&a.call(this,d),d=0,t(i)}catch(e){const a=()=>{clearTimeout(u),d=0,h=RETRY_STATE_STOPPED,f(e)},o=()=>{h!==RETRY_STATE_STOPPED&&d<(isFunction(c)?c():c)?(d++,h=RETRY_STATE_STARTED,isFunction(r)&&r.call(this,d,a),u=window.setTimeout(()=>{u=-1,p(t,f)},isFunction(l)?l(d):l)):(a(),isFunction(s)&&s.call(this,e))};isFunction(i)?i.call(this,{error:e,retry:o,reject:f,retryFuncArgs:n,retriedCount:d}):o()}};return new Promise(p)}}var retry_default=promiseRetry,retryingMap=new WeakMap;function addPromiseRetry({settings:e={retries:5,timeout:2e3},onError:t,onRetrying:i,onRetryFailed:r}){return function(s,a,o){const n=retry_default({retryFunction:o.value,settings:e,onError({error:e,retry:i,reject:r,retryFuncArgs:o}){var n;t?t.call(this,e,()=>{var t;(null==(t=retryingMap.get(s))?void 0:t.has(a))?i():r(e)},r,o):(null==(n=retryingMap.get(s))?void 0:n.has(a))?i():r(e)},onRetrying(e,t){var r;isFunction(i)&&i.call(this,e,t),(null==(r=retryingMap.get(s))?void 0:r.has(a))&&(retryingMap.get(s).get(a).stopRetry=t)},onRetryFailed:r});return o.value=function(...e){const t=retryingMap.get(s);return t?t.set(a,{args:e}):retryingMap.set(s,new Map([[a,{args:e}]])),n.apply(this,e).finally(()=>{var e;return null==(e=retryingMap.get(s))?void 0:e.delete(a)})},o}}function removePromiseRetry({fnName:e,callback:t,validateArgs:i=!0}){return function(r,s,a){const o=a.value;return a.value=function(...s){var a,n;if(null==(a=retryingMap.get(r))?void 0:a.has(e)){const{stopRetry:a,args:o}=retryingMap.get(r).get(e);let c=!0;if(i)for(const e of o)if(!s.find(t=>t===e)){c=!1;break}c&&(t&&t.apply(this,s),a&&a(),null==(n=retryingMap.get(r))||n.delete(e))}return o.apply(this,s)},a}}var Stat=class{constructor(e,t){this.core=t,__publicField(this,"peerConnection"),__publicField(this,"audioTransceiver",null),__publicField(this,"videoTransceiver",null),__publicField(this,"timerId",null),__publicField(this,"callback",null),__publicField(this,"previousRawStats",null),__publicField(this,"_prevReportTime",0),__publicField(this,"_prevDecoderImplementation",""),__publicField(this,"_decodeMap",new Map),this.peerConnection=e,this.findTransceivers()}get statInterval(){return 0===this._prevReportTime?2:(Date.now()-this._prevReportTime)/1e3}findTransceivers(){const e=this.peerConnection.getTransceivers();for(const t of e)if(t.receiver&&t.receiver.track){const{track:e}=t.receiver;"audio"===e.kind?this.audioTransceiver=t:"video"===e.kind&&(this.videoTransceiver=t)}}start(e,t=2e3){this.stop(),this.callback=e,this.collectStats(),this.timerId=window.setInterval(()=>{this.collectStats()},t)}stop(){null!==this.timerId&&(clearInterval(this.timerId),this.timerId=null),this.callback=null,this.previousRawStats=null,this._prevReportTime=0}async collectStats(){if(this.callback)try{const e=await this.peerConnection.getStats(),t=new Set(["inbound-rtp","track","candidate-pair","media-source","codec"]),i=[];e.forEach(e=>t.has(e.type)&&i.push(e));const r=Date.now(),s=this.parseAudioStats(i),a=this.parseVideoStats(i),o=this.parseNetworkStats(i);this._prevReportTime=r,this.callback({audio:s,video:a,network:o})}catch(e){this.core.log.error("Failed to collect WebRTC stats:",e)}}getDifferenceValue(e,t){if(this.core.utils.isUndefined(e))return t;const i=(t||0)-e;return i<0?0:i}parseAudioStats(e){var t,i,r,s;const a={bitrate:0,volume:0,packetLossRate:0,jitterBufferDelay:0,bytesReceived:0,packetsReceived:0,packetsLost:0};for(const o of e){if("inbound-rtp"===o.type&&("audio"===o.mediaType||"audio"===o.kind)){if(a.bytesReceived=o.bytesReceived||0,a.packetsReceived=o.packetsReceived||0,a.packetsLost=o.packetsLost||0,this.previousRawStats&&this.previousRawStats.audio){const e=this.getDifferenceValue(this.previousRawStats.audio.bytesReceived,a.bytesReceived);a.bitrate=Math.round(8*e/this.statInterval/1e3)}const e=this.getDifferenceValue(null==(t=this.previousRawStats)?void 0:t.audio.packetsLost,a.packetsLost),s=this.getDifferenceValue(null==(i=this.previousRawStats)?void 0:i.audio.packetsReceived,a.packetsReceived)+e;if(s>0&&(a.packetLossRate=Math.round(e/s*100)),this.core.utils.isUndefined(o.audioLevel)||(a.volume=o.audioLevel||0),o.jitterBufferDelay&&o.jitterBufferEmittedCount){let{jitterBufferEmittedCount:e}=o,{jitterBufferDelay:t}=o;(null==(r=this.previousRawStats)?void 0:r.audio)&&(e=this.getDifferenceValue(this.previousRawStats.audio.jitterBufferEmittedCount,o.jitterBufferEmittedCount),t=this.getDifferenceValue(this.previousRawStats.audio.jitterBufferDelay,o.jitterBufferDelay)),e>0&&(a.jitterBufferDelay=Math.floor(t/e*1e3)),this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.audio.jitterBufferDelay=o.jitterBufferDelay,this.previousRawStats.audio.jitterBufferEmittedCount=o.jitterBufferEmittedCount}this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.audio.bytesReceived=a.bytesReceived,this.previousRawStats.audio.packetsReceived=a.packetsReceived,this.previousRawStats.audio.packetsLost=a.packetsLost}!this.core.utils.isUndefined(o.audioLevel)&&(null==(s=this.audioTransceiver)?void 0:s.receiver.track)&&o.trackIdentifier===this.audioTransceiver.receiver.track.id&&(a.volume=o.audioLevel||0)}return a}parseVideoStats(e){var t,i,r,s,a;const o={bitrate:0,frameRate:0,width:0,height:0,packetLossRate:0,jitterBufferDelay:0,bytesReceived:0,packetsReceived:0,packetsLost:0,framesDecoded:0};for(const n of e){if("codec"===n.type&&this._decodeMap.set(n.id,n),"inbound-rtp"===n.type&&("video"===n.mediaType||"video"===n.kind)){if(o.bytesReceived=n.bytesReceived||0,o.packetsReceived=n.packetsReceived||0,o.packetsLost=n.packetsLost||0,o.framesDecoded=n.framesDecoded||0,this.core.utils.isUndefined(n.framesPerSecond)||(o.frameRate=Math.round(n.framesPerSecond)),n.decoderImplementation&&this._prevDecoderImplementation!==n.decoderImplementation){const e=this._decodeMap.get(n.codecId),i=(null==(t=null==e?void 0:e.mimeType)?void 0:t.split("/")[1])||"unknown",r=n.powerEfficientDecoder;this.core.log.info(`decoderImplementation change to ${n.decoderImplementation}(${i}) HWDecoder: ${r}`),this._prevDecoderImplementation=n.decoderImplementation}if(this.previousRawStats&&this.previousRawStats.video){const e=this.getDifferenceValue(this.previousRawStats.video.bytesReceived,o.bytesReceived);o.bitrate=Math.round(8*e/this.statInterval/1e3)}const e=this.getDifferenceValue(null==(i=this.previousRawStats)?void 0:i.video.packetsLost,o.packetsLost),a=this.getDifferenceValue(null==(r=this.previousRawStats)?void 0:r.video.packetsReceived,o.packetsReceived)+e;if(a>0&&(o.packetLossRate=Math.round(e/a*100)),n.jitterBufferDelay&&n.jitterBufferEmittedCount){let{jitterBufferEmittedCount:e}=n,{jitterBufferDelay:t}=n;(null==(s=this.previousRawStats)?void 0:s.video)&&(e=this.getDifferenceValue(this.previousRawStats.video.jitterBufferEmittedCount,n.jitterBufferEmittedCount),t=this.getDifferenceValue(this.previousRawStats.video.jitterBufferDelay,n.jitterBufferDelay)),e>0&&(o.jitterBufferDelay=Math.floor(t/e*1e3)),this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.video.jitterBufferDelay=n.jitterBufferDelay,this.previousRawStats.video.jitterBufferEmittedCount=n.jitterBufferEmittedCount}this.previousRawStats||this.initPreviousRawStats(),this.previousRawStats.video.bytesReceived=o.bytesReceived,this.previousRawStats.video.packetsReceived=o.packetsReceived,this.previousRawStats.video.packetsLost=o.packetsLost}!this.core.utils.isUndefined(n.frameWidth)&&(null==(a=this.videoTransceiver)?void 0:a.receiver.track)&&n.trackIdentifier===this.videoTransceiver.receiver.track.id&&(o.width=n.frameWidth,o.height=n.frameHeight)}return o}parseNetworkStats(e){const t={rtt:0};for(const i of e)if("candidate-pair"===i.type){if((i.selected||"succeeded"===i.state)&&this.core.utils.isNumber(i.currentRoundTripTime)){t.rtt=Math.floor(1e3*i.currentRoundTripTime);break}}return t}initPreviousRawStats(){this.previousRawStats={timestamp:Date.now(),audio:{bytesReceived:0,packetsReceived:0,packetsLost:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0}}}},import_eventemitter3=__toESM(require_eventemitter3(),1),instance=Symbol("instance"),abortCtrl=Symbol("abortCtrl"),cacheResult=Symbol("cacheResult"),MiddleState=class{constructor(e,t,i){this.oldState=e,this.newState=t,this.action=i,this.aborted=!1}abort(e){this.aborted=!0,setState.call(e,this.oldState,new Error(`action '${this.action}' aborted`))}toString(){return`${this.action}ing`}},FSMError=class extends Error{constructor(e,t,i){super(t),this.state=e,this.message=t,this.cause=i}};function thenAble(e){return"object"==typeof e&&e&&"then"in e}var stateDiagram=new Map;function ChangeState(e,t,i={}){return(r,s,a)=>{const o=i.action||s;if(!i.context){const i=stateDiagram.get(r)||[];stateDiagram.has(r)||stateDiagram.set(r,i),i.push({from:e,to:t,action:o})}const n=a.value;a.value=function(...r){let s=this;if(i.context&&(s=FSM.get("function"==typeof i.context?i.context.call(this,...r):i.context)),s.state===t)return i.sync?s[cacheResult]:Promise.resolve(s[cacheResult]);s.state instanceof MiddleState&&s.state.action==i.abortAction&&s.state.abort(s);let a=null;Array.isArray(e)?0==e.length?s.state instanceof MiddleState&&s.state.abort(s):"string"==typeof s.state&&e.includes(s.state)||(a=new FSMError(s._state,`${s.name} ${o} to ${t} failed: current state ${s._state} not from ${e.join("|")}`)):e!==s.state&&(a=new FSMError(s._state,`${s.name} ${o} to ${t} failed: current state ${s._state} not from ${e}`));const c=e=>{if(i.fail&&i.fail.call(this,e),i.sync){if(i.ignoreError)return e;throw e}return i.ignoreError?Promise.resolve(e):Promise.reject(e)};if(a)return c(a);const l=s.state,d=new MiddleState(l,t,o);setState.call(s,d);const u=e=>{var r;return s[cacheResult]=e,d.aborted||(setState.call(s,t),null===(r=i.success)||void 0===r||r.call(this,s[cacheResult])),e},h=e=>(setState.call(s,l,e),c(e));try{const e=n.apply(this,r);return thenAble(e)?e.then(u).catch(h):i.sync?u(e):Promise.resolve(u(e))}catch(i){return h(new FSMError(s._state,`${s.name} ${o} from ${e} to ${t} failed: ${i}`,i instanceof Error?i:new Error(String(i))))}}}}var sendDevTools=(()=>{const e="undefined"!=typeof window&&window.__AFSM__,t="undefined"!=typeof importScripts;return e?(e,t)=>{window.dispatchEvent(new CustomEvent(e,{detail:t}))}:t?(e,t)=>{postMessage({type:e,payload:t})}:()=>{}})();function setState(e,t){const i=this._state;this._state=e;const r=e.toString();e&&this.emit(r,i),this.emit(FSM.STATECHANGED,e,i,t),this.updateDevTools({value:e,old:i,err:t instanceof Error?t.message:String(t)})}var FSM=class e extends import_eventemitter3.default{constructor(t,i,r){super(),this.name=t,this.groupName=i,this._state=e.INIT,t||(t=Date.now().toString(36)),r?Object.setPrototypeOf(this,r):r=Object.getPrototypeOf(this),i||(this.groupName=this.constructor.name);const s=r[instance];s?this.name=s.name+"-"+s.count++:r[instance]={name:this.name,count:0},this.updateDevTools({diagram:this.stateDiagram})}get stateDiagram(){const e=Object.getPrototypeOf(this),t=stateDiagram.get(e)||[];let i=new Set,r=[],s=[];const a=new Set,o=Object.getPrototypeOf(e);stateDiagram.has(o)&&(o.stateDiagram.forEach(e=>i.add(e)),o.allStates.forEach(e=>a.add(e))),t.forEach(({from:e,to:t,action:i})=>{"string"==typeof e?r.push({from:e,to:t,action:i}):e.length?e.forEach(e=>{r.push({from:e,to:t,action:i})}):s.push({to:t,action:i})}),r.forEach(({from:e,to:t,action:r})=>{a.add(e),a.add(t),a.add(r+"ing"),i.add(`${e} --\x3e ${r}ing : ${r}`),i.add(`${r}ing --\x3e ${t} : ${r} ðŸŸ¢`),i.add(`${r}ing --\x3e ${e} : ${r} ðŸ”´`)}),s.forEach(({to:e,action:t})=>{i.add(`${t}ing --\x3e ${e} : ${t} ðŸŸ¢`),a.forEach(r=>{r!==e&&i.add(`${r} --\x3e ${t}ing : ${t}`)})});const n=[...i];return Object.defineProperties(e,{stateDiagram:{value:n},allStates:{value:a}}),n}static get(t){let i;return"string"==typeof t?(i=e.instances.get(t),i||e.instances.set(t,i=new e(t,void 0,Object.create(e.prototype)))):(i=e.instances2.get(t),i||e.instances2.set(t,i=new e(t.constructor.name,void 0,Object.create(e.prototype)))),i}static getState(t){var i;return null===(i=e.get(t))||void 0===i?void 0:i.state}updateDevTools(t={}){sendDevTools(e.UPDATEAFSM,Object.assign({name:this.name,group:this.groupName},t))}get state(){return this._state}set state(e){setState.call(this,e)}};FSM.STATECHANGED="stateChanged",FSM.UPDATEAFSM="updateAFSM",FSM.INIT="[*]",FSM.ON="on",FSM.OFF="off",FSM.instances=new Map,FSM.instances2=new WeakMap;var Player=class extends FSM{constructor(e,t){super(),this.core=e,__publicField(this,"audioPlayer"),__publicField(this,"videoPlayer"),__publicField(this,"callback"),__publicField(this,"avPlayerStateSyncManager"),__publicField(this,"_log"),__publicField(this,"lastPausedReason"),__publicField(this,"muted",!1),this._log=t,this.videoPlayer=new e.VideoPlayer({id:"vp",log:this._log.createChild({id:"vp"}),track:null,muted:!1,container:null,enableLogTrackState:!0}),this.audioPlayer=new e.RemoteAudioPlayer({id:"ap",log:this._log.createChild({id:"ap"}),track:null,muted:!1,container:null,enableVolumeControlInIOS:!0,enableLogTrackState:!0}),this.videoPlayer.on(e.PlayerEvent.LOAD_START,()=>this.handleLoadStart("video")),this.audioPlayer.on(e.PlayerEvent.LOAD_START,()=>this.handleLoadStart("audio")),this.videoPlayer.on(e.PlayerEvent.PLAYER_STATE_CHANGED,this.handlePlayerStateChanged,this),this.audioPlayer.on(e.PlayerEvent.PLAYER_STATE_CHANGED,this.handlePlayerStateChanged,this),this.videoPlayer.on(e.PlayerEvent.ENTER_PICTURE_IN_PICTURE,this.handleEnterPictureInPicture,this),this.videoPlayer.on(e.PlayerEvent.LEAVE_PICTURE_IN_PICTURE,this.handleLeavePictureInPicture,this),this.videoPlayer.on(e.PlayerEvent.ENTER_FULL_SCREEN,this.handleEnterFullScreen,this),this.videoPlayer.on(e.PlayerEvent.LEAVE_FULL_SCREEN,this.handleLeaveFullScreen,this),this.avPlayerStateSyncManager=new e.AVPlayerStateSyncManager({log:this._log,audioPlayer:this.audioPlayer,videoPlayer:this.videoPlayer})}get isPlaying(){return this.videoPlayer.isPlaying&&this.audioPlayer.isPlaying}get isPaused(){return this.videoPlayer.isPaused&&this.audioPlayer.isPaused}get isStopped(){return this.videoPlayer.isStopped&&this.audioPlayer.isStopped}setCallback(e){this.callback=e}handleLoadStart(e){this.onLoadStart()}handlePlayerStateChanged(e){"PLAYING"===e.state&&this.isPlaying&&this.onPlaying(),"PAUSED"===e.state&&this.isPaused&&this.onPaused(e.reason),"STOPPED"===e.state&&this.isStopped&&this.onStopped()}async handleEnterPictureInPicture(){var e,t;await this.videoPlayer.enterPIPPromise,null==(t=null==(e=this.callback)?void 0:e.onPictureInPictureStateChanged)||t.call(e,{isPictureInPicture:!0,pictureInPictureWindow:this.videoPlayer.pipWindow})}handleLeavePictureInPicture(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onPictureInPictureStateChanged)||t.call(e,{isPictureInPicture:!1})}handleEnterFullScreen(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onFullScreenStateChanged)||t.call(e,{isFullScreen:!0})}handleLeaveFullScreen(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onFullScreenStateChanged)||t.call(e,{isFullScreen:!1})}onLoadStart(){}onPlaying(){}onPaused(e){this.lastPausedReason=e}onStopped(){}setVideoContainer(e){if(this.core.utils.isString(e)){const t=document.getElementById(e);t&&this.videoPlayer.setContainer(t)}else this.videoPlayer.setContainer(e)}setVolume(e){this.core.utils.isUndefined(e)||this.audioPlayer.setVolume(e/100)}setMuted(e){this.core.utils.isUndefined(e)||(this.muted=e,this.audioPlayer.setMuted(e))}setFillMode(e){e&&this.videoPlayer.setObjectFit(e)}setAudioTrack(e){this.audioPlayer.setTrack(e)}setVideoTrack(e){this.videoPlayer.setTrack(e)}async play(){const e=this.videoPlayer.play().catch(e=>{var t,i;this.handleAutoPlayFailed(this.videoPlayer,e),null==(i=null==(t=this.callback)?void 0:t.onAutoPlayFailed)||i.call(t,{type:"video",resume:()=>this.videoPlayer.resume()})}),t=this.audioPlayer.play().catch(e=>{var t,i;this.handleAutoPlayFailed(this.audioPlayer,e),null==(i=null==(t=this.callback)?void 0:t.onAutoPlayFailed)||i.call(t,{type:"audio",resume:()=>this.audioPlayer.resume()})});await Promise.all([e,t])}handleAutoPlayFailed(e,t){this._log.warn("handleAutoPlayFailed",t);const i=()=>{this.audioPlayer.resume().then(()=>{document.removeEventListener("click",i,!0)})};document.addEventListener("click",i,!0)}pause(){this.videoPlayer.pause(!1),this.audioPlayer.setMuted(!0),this.audioPlayer.pause()}resume(){this.videoPlayer.resume(!0),this.audioPlayer.setMuted(this.muted),this.audioPlayer.resume()}async enterFullscreen(){await this.videoPlayer.enterFullscreen()}async exitFullscreen(){await this.videoPlayer.exitFullscreen()}async enterPictureInPicture(){await this.videoPlayer.enterPictureInPicture()}async exitPictureInPicture(){await this.videoPlayer.exitPictureInPicture()}stop(){this.videoPlayer&&this.videoPlayer.stop(),this.audioPlayer&&(this.audioPlayer.stop(),this.audioPlayer.setMuted(!1))}};__decorateClass([ChangeState([FSM.INIT,"PAUSED"],"LOADSTART",{ignoreError:!0,sync:!0,success(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onLoadStart)||t.call(e)},fail(e){this._log.warn("onLoadStart",e)}})],Player.prototype,"onLoadStart",1),__decorateClass([ChangeState(["LOADSTART","PAUSED"],"PLAYING",{ignoreError:!0,sync:!0,success(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onPlaying)||t.call(e)},fail(e){this._log.warn("onPlaying",e)}})],Player.prototype,"onPlaying",1),__decorateClass([ChangeState("PLAYING","PAUSED",{ignoreError:!0,sync:!0,success(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onPaused)||t.call(e,{reason:this.lastPausedReason})},fail(e){this._log.warn("onPaused",e)}})],Player.prototype,"onPaused",1),__decorateClass([ChangeState([],FSM.INIT,{ignoreError:!0,sync:!0,success(){var e,t;null==(t=null==(e=this.callback)?void 0:e.onStopped)||t.call(e)},fail(e){this._log.warn("onStopped",e)}})],Player.prototype,"onStopped",1);var player_default=Player,SIGNAL_DOMAIN_NAME_LIST=["overseas-webrtc.tlivewebrtc.com","oswebrtc-lint.tliveplay.com"],_LEBPlayer=class e{constructor(e){this.core=e,__publicField(this,"_sdkAppId"),__publicField(this,"_userId"),__publicField(this,"connectedRoomIdSet",new Set),__publicField(this,"updateSeq",0),__publicField(this,"_log"),__publicField(this,"player"),__publicField(this,"peerConnection"),__publicField(this,"svrSig"),__publicField(this,"streamURL"),__publicField(this,"signalURL"),__publicField(this,"insertableStreamsAbortMap",new Map),__publicField(this,"scriptTransformWorker"),__publicField(this,"connectionState","disconnected"),__publicField(this,"isStarted",!1),__publicField(this,"isStopped",!0),__publicField(this,"isReconnecting",!1),__publicField(this,"callback"),__publicField(this,"isFireWallErrorEmitted",!1),__publicField(this,"stat"),__publicField(this,"isH264DecodeSupported"),__publicField(this,"connectionTimeoutId"),e.loggerManager.startUpload(),this._log=this.core.log.createChild({id:`${this.getAlias()}`}),this.player=new player_default(e,this._log),e.innerEmitter.on(e.INNER_EVENT.SEI_MESSAGE,this.onSEIMessage,this)}getName(){return e.Name}getAlias(){return"LEB"}getGroup(){return""}getValidateRule(e){switch(e){case"start":return StartValidateRule;case"update":case"stop":return{}}}get enableSEI(){return this.core.room.enableSEI&&(this.core.rtcDectection.IS_INSERTABLE_STREAM_SUPPORTED||this.core.rtcDectection.IS_SCRIPT_TRANSFORM_SUPPORTED)}async start(e){var t;this.isStopped=!1;const{view:i,url:r,volume:s,muted:a,fillMode:o,loggerConfig:n,callback:c}=e;this.callback=c,this.player.setCallback(c);const{errorModule:{RtcError:l,ErrorCode:d,ErrorCodeDictionary:u},loggerManager:h,rtcDectection:p}=this.core;if(this._sdkAppId=n.sdkAppId,this._userId=n.userId,this._log.setSdkAppId(n.sdkAppId),this._log.setUserId(n.userId),h.addJoinedUser(n),!p.isWebRTCSupported()||!p.isAddTransceiverSupported())throw new l({code:d.ENV_NOT_SUPPORTED,extraCode:u.NOT_SUPPORTED_WEBRTC,message:"webrtc not supported"});if(!(await p.decodeSupportStatus()).isH264DecodeSupported||!1===this.isH264DecodeSupported)throw this.isH264DecodeSupported=!1,new l({code:d.ENV_NOT_SUPPORTED,extraCode:u.NOT_SUPPORTED_H264_DECODE,message:"h264 not supported"});!p.IS_SEI_SUPPORTED&&(null==c?void 0:c.onSEIMessage)&&(null==(t=c.onError)||t.call(c,new l({code:d.ENV_NOT_SUPPORTED,extraCode:u.NOT_SUPPORTED_SEI,message:"sei not supported"}))),this.player.setVideoContainer(i),this.player.setMuted(a),this.player.setFillMode(o),await this.connect(r),this.stat=new Stat(this.peerConnection,this.core),this.stat.start(e=>{var t,i;return null==(i=null==(t=this.callback)?void 0:t.onStats)?void 0:i.call(t,e)});const f=this.player.play();this.player.setVolume(s),await f,this.isStarted=!0}connect(e){return new Promise((t,i)=>{try{this.initScriptTransformWorker();const r={encodedInsertableStreams:this.enableSEI,iceServers:[],sdpSemantics:"unified-plan",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"},s=new RTCPeerConnection(r);this.peerConnection=s,s.onconnectionstatechange=()=>{this.connectionState=s.connectionState,this._log.info("connectionState",s.connectionState),"failed"!==s.connectionState&&"closed"!==s.connectionState||(this.isStarted?this.reconnect(e):i(new Error(`connection is ${s.connectionState}`))),"connected"===s.connectionState&&(this.logSelectedCandidate(),t())},s.ontrack=e=>this.onTrack(e),s.addTransceiver("audio",{direction:"recvonly"}),s.addTransceiver("video",{direction:"recvonly"}),this._log.info("createOffer"),s.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1}).then(e=>(e.sdp=updateSdpRestriction(e.sdp),this._log.info("setOffer"),s.setLocalDescription(e))).then(()=>{const t={sessionId:nanoid(),streamurl:e,clientinfo:this.core.environment.getOSString(),localsdp:s.localDescription};return this.exchangeSDP(e,t)}).then(e=>(this._log.info("setAnswer"),s.setRemoteDescription(e))).catch(i)}catch(e){i(e)}this.connectionTimeoutId=setTimeout(()=>i(new Error("connection timeout")),1e4)})}async exchangeSDP(e,t){let i,r,s;try{this._log.info("exchangeSDP");const a=getStreamDomain(e);if(!a)throw new Error("streamDomain is empty");const{signalDomain:o,cached:n}=await this.fetchSignalDomain(a);if(!o)throw new Error("signalDomain is empty");{this._log.info("try exchangeSDP signalDomain:",o,n);const e=await this.doExchangeSDP(`https://${o}`,t,3);i=e.url,r=e.remoteSdp,s=e.svrSig}}catch(e){this._log.warn("exchangeSDP failed, fallback",e);const a=await this.core.utils.promiseAny(SIGNAL_DOMAIN_NAME_LIST.map(e=>this.doExchangeSDP(`https://${e}`,t,3)));i=a.url,r=a.remoteSdp,s=a.svrSig}return this.streamURL=e,this.signalURL=i,this.svrSig=s,r}async reconnect(e){if(!this.isReconnecting){this.isReconnecting=!0;try{this._log.warn("start reconnect"),await this.connect(e),this._log.warn("reconnect success")}catch(e){this._log.error("reconnect error",e)}finally{this.isReconnecting=!1}}}async logSelectedCandidate(){if(!this.peerConnection)return;const e=await this.peerConnection.getStats();for(const[t,i]of e)if(this.core.rtcDectection.isSelectedCandidatePair(i)){const t=e.get(i.localCandidateId),r=e.get(i.remoteCandidateId);t&&this._log.info(`local candidate: ${t.candidateType} ${t.protocol}:${t.ip||t.address}:${t.port} ${t.networkType||""} ${t.relayProtocol?`relayProtocol:${t.relayProtocol} url: ${t.url}`:""}`),r&&this._log.info(`remote candidate: ${r.candidateType} ${r.protocol}:${r.ip||r.address}:${r.port}`);break}}async doExchangeSDP(e,t,i){const r=`${e}/webrtc/v1/pullstream`,s=await fetchPost(r,t,{timeout:i}),{errcode:a,errmsg:o,remotesdp:n,svrsig:c}=s;if(0!==a){const e=new Error(`errCode:${a}, errMsg:${o}`);throw e.name="RequestSignalError",e}return{url:e,remoteSdp:n,svrSig:c}}createEncodedStreams(e){var t;if(this.enableSEI&&this.core.rtcDectection.IS_INSERTABLE_STREAM_SUPPORTED)try{if(this._log.warn("enableSEI",this.enableSEI),!this.insertableStreamsAbortMap.has(e)){const i=e.createEncodedStreams(),r=new AbortController,s={abortController:r,enqueue:t=>"audio"===e.track.kind?t:this.decodeVideoFrame(t)};i.readable.pipeThrough(new TransformStream({transform:(e,t)=>{const i=s.enqueue(e);i&&t.enqueue(i)}})).pipeTo(i.writable,r).catch(e=>{"destroy"!==e&&this._log.warn(e)}),null==(t=this.insertableStreamsAbortMap.get(e))||t.abort("destroy"),this.insertableStreamsAbortMap.set(e,r)}}catch(t){this._log.warn(`createEncodedStreams ${e.track.kind} failed`,t)}}initReceiverTransform(e,t){this.peerConnection&&this.enableSEI&&this.scriptTransformWorker&&!e.transform&&(e.transform=new RTCRtpScriptTransform(this.scriptTransformWorker,{isReceiver:!0,isAudio:t,userId:"",streamType:this.core.enums.RemoteStreamType.Main}))}initScriptTransformWorker(){const{room:e,rtcDectection:t,createScriptTransformWorker:i,trtc:r,TRTC:s}=this.core;!this.enableSEI||t.IS_INSERTABLE_STREAM_SUPPORTED||this.scriptTransformWorker||t.IS_SCRIPT_TRANSFORM_SUPPORTED&&(this._log.info("initScriptTransformWorker"),this.scriptTransformWorker=i({videoEncodePipeline:e.videoManager.encodePipeline,videoDecodePipeline:e.videoManager.decodePipeline,audioEncodePipeline:e.audioManager.encodePipeline,audioDecodePipeline:e.audioManager.decodePipeline}),this.scriptTransformWorker.onmessage=e=>{var t,i;"sei"===e.data.type&&(null==(i=null==(t=this.callback)?void 0:t.onSEIMessage)||i.call(t,{data:e.data.data,seiPayloadType:e.data.seiPayloadType}))},this.scriptTransformWorker.onerror=e=>{this._log.error("scriptTransformWorker error: ",e.message)})}decodeVideoFrame(e){if(!this.core.room.videoManager)return e;for(const t of this.core.room.videoManager.decodePipeline)if(t&&!(e=t({frame:e})))return;return e}async fetchStopStream(){if(this.streamURL&&this.svrSig&&this.signalURL)try{const e=`${this.signalURL}/webrtc/v1/stopstream`,t=await fetchPost(e,{streamurl:this.streamURL,svrsig:this.svrSig},{timeout:3}),{errcode:i,errmsg:r}=t;if(0!==i)throw new Error(`errCode:${i}, errmsg:${r}`);return t}catch(e){this._log.error("fetchStopStream error",e)}}onTrack(e){const{track:t}=e;this.createEncodedStreams(e.receiver),this.initReceiverTransform(e.receiver,"audio"===t.kind),"audio"===t.kind?this.player.setAudioTrack(t):this.player.setVideoTrack(t)}async update(e){const{view:t,volume:i,muted:r,fillMode:s,action:a,fullScreen:o,pictureInPicture:n}=e;this.player.setMuted(r),this.player.setVolume(i),this.player.setFillMode(s),t&&this.player.videoPlayer.setContainer(this.core.utils.isString(t)?document.getElementById(t):t),"pause"===a?this.player.pause():"resume"===a&&this.player.resume(),this.core.utils.isBoolean(o)&&(o?await this.player.enterFullscreen():await this.player.exitFullscreen()),this.core.utils.isBoolean(n)&&(n?await this.player.enterPictureInPicture():await this.player.exitPictureInPicture())}async stop(){this.isStopped=!0,this.player.stop(),this.peerConnection&&(clearTimeout(this.connectionTimeoutId),this.peerConnection.close(),this.peerConnection.getReceivers().forEach(e=>this.insertableStreamsAbortMap.delete(e)),delete this.peerConnection,await this.fetchStopStream(),delete this.streamURL,delete this.signalURL,delete this.svrSig),this.stat&&(this.stat.stop(),delete this.stat),this.core.room.keyPointManager.uploadKVStat(this.core.kvStatManager,this._sdkAppId)}destroy(){this.stop(),this.core.innerEmitter.off(this.core.INNER_EVENT.SEI_MESSAGE,this.onSEIMessage,this)}onSEIMessage({room:e,nalu:t}){var i,r;e===this.core.room&&(null==(r=null==(i=this.callback)?void 0:i.onSEIMessage)||r.call(i,{data:t.seiPayload.buffer,seiPayloadType:t.seiPayloadType}))}async fetchSignalDomain(e,t=REQUEST_DOMAIN_NAME_LIST[0]){const i=`https://${t}/signal_query`;try{const t=window.localStorage.getItem(SIGNAL_DOMAIN_NAME_DATA_KEY);if(t){const i=JSON.parse(t);if(i[e].expire-(new Date).getTime()>0)return{signalDomain:i[e].signal,cached:!0}}const r=await fetchPost(i,{domain:e,requestid:nanoid(16),client_type:"Web",client_info:window.navigator.userAgent}),{errcode:s,data:a}=r;if(0===s){const{signal_domain:t,cache_time:i}=a;let r={};const s=window.localStorage.getItem(SIGNAL_DOMAIN_NAME_DATA_KEY);s&&(r=JSON.parse(s)),r[e]={signal:t,expire:(new Date).getTime()+1e3*i};try{window.localStorage.setItem(SIGNAL_DOMAIN_NAME_DATA_KEY,JSON.stringify(r))}catch(e){}return{signalDomain:t,cached:!1}}throw new Error(`errCode:${s}`)}catch(i){return this._log.error("fetchSignalDomain error",i),REQUEST_DOMAIN_NAME_LIST[1]&&t!==REQUEST_DOMAIN_NAME_LIST[1]?this.fetchSignalDomain(e,REQUEST_DOMAIN_NAME_LIST[1]):{signalDomain:"",cached:!1}}}};__publicField(_LEBPlayer,"Name","LEBPlayer"),__decorateClass([addPromiseRetry({settings:{retries:1/0,timeout:2e3},onRetrying(e){var t;if(this._log.warn(`retry connect ${e}`),e>=3&&(null==(t=this.callback)?void 0:t.onError)&&!this.isFireWallErrorEmitted){const{RtcError:e,ErrorCode:t,ErrorCodeDictionary:i}=this.core.errorModule;this.isFireWallErrorEmitted=!0,this.callback.onError(new e({code:t.OPERATION_FAILED,extraCode:i.FIREWALL_RESTRICTION,message:"firewall restriction"}))}},onError(e,t,i,r){var s;if(this._log.warn("connect failed",e),this.peerConnection&&(this.peerConnection.close(),delete this.peerConnection),!this.isStopped&&(null==(s=e.message||e)?void 0:s.includes("connection")))t();else{const{RtcError:t,ErrorCode:r}=this.core.errorModule;i(new t({code:r.UNKNOWN_ERROR,message:e.message}))}}})],_LEBPlayer.prototype,"connect",1),__decorateClass([removePromiseRetry({fnName:"connect"})],_LEBPlayer.prototype,"stop",1);var LEBPlayer=_LEBPlayer,fetchPost=async(e,t,i={})=>{const{timeout:r=10}=i;let s,a=0,o={};window.AbortController&&(s=new window.AbortController,o={signal:s.signal},a=window.setTimeout(()=>s.abort(),1e3*r));const n=await fetch(e,__spreadValues({body:JSON.stringify(t),cache:"no-cache",credentials:"same-origin",headers:{"content-type":"text/plain;charset=utf-8"},method:"POST",mode:"cors"},o));if(a&&window.clearTimeout(a),200!==n.status)throw new Error(`Network Error, status code:${n.status}`);return n.json()},REQUEST_DOMAIN_NAME_LIST=["webrtc-signal-scheduler.tlivesource.com","bak-webrtc-signal-scheduler.tlivesource.com"],SIGNAL_DOMAIN_NAME_DATA_KEY="LEB_PLAYER_STORAGE_KEY",getStreamDomain=e=>{const t=/^(?:webrtc:\/\/)([0-9.\-A-Za-z_]+)(?:\/)(?:[0-9.\-A-Za-z_=]+)(?:\/)(?:[^?#]*)(?:\?*)(?:[^?#]*)/.exec(e);return t?t[1]:""},index_default=LEBPlayer;export{index_default as default};export{LEBPlayer};