function e(e,t,i,n,s){var r={};return Object.keys(n).forEach((function(e){r[e]=n[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}let t=!0,i=!0;function n(e,t,i){const n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)}function s(e,t,i){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return s.apply(this,arguments);const r=e=>{const t=i(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,r),s.apply(this,[e,r])};const r=n.removeEventListener;n.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return r.apply(this,arguments);if(!this._eventMap[t].has(i))return r.apply(this,arguments);const n=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,r.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function r(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(t=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function o(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function a(){if("object"==typeof window){if(t)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function c(e,t){i&&console.warn(e+" is deprecated, please use "+t+" instead.")}function d(e){return"[object Object]"===Object.prototype.toString.call(e)}function l(e){return d(e)?Object.keys(e).reduce((function(t,i){const n=d(e[i]),s=n?l(e[i]):e[i],r=n&&!Object.keys(s).length;return void 0===s||r?t:Object.assign(t,{[i]:s})}),{}):e}function h(e,t,i){const n=i?"outbound-rtp":"inbound-rtp",s=new Map;if(null===t)return s;const r=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&r.push(e)}),r.forEach(t=>{e.forEach(i=>{i.type===n&&i.trackId===t.id&&function e(t,i,n){i&&!n.has(i.id)&&(n.set(i.id,i),Object.keys(i).forEach(s=>{s.endsWith("Id")?e(t,t.get(i[s]),n):s.endsWith("Ids")&&i[s].forEach(i=>{e(t,t.get(i),n)})}))}(e,i,s)})}),s}const u=a;function p(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const s=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[s("min",i)]=n.ideal,t.optional.push(e),e={},e[s("max",i)]=n.ideal,t.optional.push(e)):(e[s("",i)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[s("",i)]=n.exact):["min","max"].forEach(e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[s(e,i)]=n[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,s){if(t.version>=61)return s(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let r=e.video.facingMode;r=r&&("object"==typeof r?r:{ideal:r});const o=t.version<66;if(r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||o)){let t;if(delete e.video.facingMode,"environment"===r.exact||"environment"===r.ideal?t=["back","rear"]:"user"!==r.exact&&"user"!==r.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then(i=>{let o=(i=i.filter(e=>"videoinput"===e.kind)).find(e=>t.some(t=>e.label.toLowerCase().includes(t)));return!o&&i.length&&t.includes("back")&&(o=i[i.length-1]),o&&(e.video.deviceId=r.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=n(e.video),u("chrome: "+JSON.stringify(e)),s(e)})}e.video=n(e.video)}return u("chrome: "+JSON.stringify(e)),s(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,n){s(e,e=>{i.webkitGetUserMedia(e,t,e=>{n&&n(r(e))})})}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return s(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(r(e))))}}}function _(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function m(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===i.track.id):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s)}),t.stream.getTracks().forEach(i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===i.id):{track:i};const s=new Event("track");s.track=i,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else s(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function g(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let s=i.apply(this,arguments);return s||(s=t(this,e),this._senders.push(s)),s};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function f(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const s=function(e){const t={};return e.result().forEach(e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{i[t]=e.stat(t)}),t[i.id]=i}),t},r=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};if(arguments.length>=2){const n=function(e){i(r(s(e)))};return t.apply(this,[n,e])}return new Promise((e,i)=>{t.apply(this,[function(t){e(r(s(t)))},i])}).then(i,n)}}function v(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>h(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),s(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>h(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,n;return this.getSenders().forEach(i=>{i.track===e&&(t?n=!0:t=i)}),this.getReceivers().forEach(t=>(t.track===e&&(i?n=!0:i=t),t.track===e)),n||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function S(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),s.apply(this,arguments)}}function y(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return S(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};const s=e.RTCPeerConnection.prototype.removeStream;function r(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],s=e._streams[n.id];i=i.replace(new RegExp(s.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:i})}function o(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],s=e._streams[n.id];i=i.replace(new RegExp(n.id,"g"),s.id)}),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const s=this.getSenders().find(e=>e.track===t);if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[i.id];if(r)r.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const n=new e.MediaStream([t]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=r(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then(e=>r(this,e))}};e.RTCPeerConnection.prototype[t]=n[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:r(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(i=>{this._streams[i].getTracks().find(t=>e.track===t)&&(t=this._streams[i])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function I(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}))}function T(e,t){s(e,"negotiationneeded",e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e})}var E=Object.freeze({__proto__:null,shimMediaStream:_,shimOnTrack:m,shimGetSendersWithDtmf:g,shimGetStats:f,shimSenderReceiverGetStats:v,shimAddTrackRemoveTrackWithNative:S,shimAddTrackRemoveTrack:y,shimPeerConnection:I,fixNegotiationNeeded:T,shimGetUserMedia:p,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(t=>{const n=i.video&&i.video.width,s=i.video&&i.video.height,r=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:r||3}},n&&(i.video.mandatory.maxWidth=n),s&&(i.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});var b="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function R(e,t){return e(t={exports:{}},t.exports),t.exports}var C=R((function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((function(e){return 0===e.indexOf(i)}))},t.parseCandidate=function(e){for(var t,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":i.relatedAddress=t[n+1];break;case"rport":i.relatedPort=parseInt(t[n+1],10);break;case"tcptype":i.tcpType=t[n+1];break;case"ufrag":i.ufrag=t[n+1],i.usernameFragment=t[n+1];break;default:i[t[n]]=t[n+1]}return i},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,i={},n=e.substr(e.indexOf(" ")+1).split(";"),s=0;s<n.length;s++)i[(t=n[s].trim().split("="))[0].trim()]=t[1];return i},t.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(i.attribute=e.substr(t+1,n-t-1),i.value=e.substr(n+1)):i.attribute=e.substr(t+1),i},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],s=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substr(12),password:s.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" "),s=3;s<n.length;s++){var r=n[s],o=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(o){var a=t.parseRtpMap(o),c=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(a.parameters=c.length?t.parseFmtp(c[0]):{},a.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),i.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(a.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){i.headerExtensions.push(t.parseExtmap(e))})),i},t.writeRtpDescription=function(e,i){var n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=i.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((function(e){n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));var s=0;return i.codecs.forEach((function(e){e.maxptime>s&&(s=e.maxptime)})),s>0&&(n+="a=maxptime:"+s+"\r\n"),n+="a=rtcp-mux\r\n",i.headerExtensions&&i.headerExtensions.forEach((function(e){n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){var i,n=[],s=t.parseRtpParameters(e),r=-1!==s.fecMechanisms.indexOf("RED"),o=-1!==s.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(i=d[0][1]),s.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&i&&(t.rtx={ssrc:i}),n.push(t),r&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(t))}})),0===n.length&&c&&n.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach((function(e){e.maxBitrate=l}))),n},t.parseRtcpParameters=function(e){var i={},n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);var s=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=0===s.length;var r=t.matchPrefix(e,"a=rtcp-mux");return i.mux=r.length>0,i},t.parseMsid=function(e){var i,n=t.matchPrefix(e,"a=msid:");if(1===n.length)return{stream:(i=n[0].substr(7).split(" "))[0],track:i[1]};var s=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return s.length>0?{stream:(i=s[0].value.split(" "))[0],track:i[1]}:void 0},t.parseSctpDescription=function(e){var i,n=t.parseMLine(e),s=t.matchPrefix(e,"a=max-message-size:");s.length>0&&(i=parseInt(s[0].substr(19),10)),isNaN(i)&&(i=65536);var r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substr(12),10),protocol:n.fmt,maxMessageSize:i};if(t.matchPrefix(e,"a=sctpmap:").length>0){var o=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(o[0],10),protocol:o[1],maxMessageSize:i}}},t.writeSctpDescription=function(e,t){var i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,n){var s=void 0!==i?i:2;return"v=0\r\no="+(n||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,i,n,s){var r=t.writeRtpDescription(e.kind,i);if(r+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),r+="a=mid:"+e.mid+"\r\n",e.direction?r+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?r+="a=sendrecv\r\n":e.rtpSender?r+="a=sendonly\r\n":e.rtpReceiver?r+="a=recvonly\r\n":r+="a=inactive\r\n",e.rtpSender){var o="msid:"+s.id+" "+e.rtpSender.track.id+"\r\n";r+="a="+o,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,r+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),r},t.getDirection=function(e,i){for(var n=t.splitLines(e),s=0;s<n.length;s++)switch(n[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[s].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var i=t.splitLines(e)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var i=t.splitLines(e),n=0;n<i.length;n++)if(i[n].length<2||"="!==i[n].charAt(1))return!1;return!0},e.exports=t}));function w(e,t,i,n,s){var r=C.writeRtpDescription(e.kind,t);if(r+=C.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=C.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":s||"active"),r+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?r+="a=sendrecv\r\n":e.rtpSender?r+="a=sendonly\r\n":e.rtpReceiver?r+="a=recvonly\r\n":r+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var a="msid:"+(n?n.id:"-")+" "+o+"\r\n";r+="a="+a,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,r+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+C.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+C.localCName+"\r\n"),r}function k(e,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var i=0;i<t.length;i++)if(t[i].payloadType===e||t[i].preferredPayloadType===e)return t[i]},s=function(e,t,i,s){var r=n(e.parameters.apt,i),o=n(t.parameters.apt,s);return r&&o&&r.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach((function(n){for(var r=0;r<t.codecs.length;r++){var o=t.codecs[r];if(n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&o.parameters.apt&&!s(n,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(n.numChannels,o.numChannels),i.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var s=t.headerExtensions[n];if(e.uri===s.uri){i.headerExtensions.push(s);break}}})),i}function A(e,t,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(i)}function D(e,t){var i=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return i||e.addRemoteCandidate(t),!i}function P(e,t){var i=new Error(t);return i.name=e,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],i}var N=function(e,t){function i(t,i){i.addTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function n(t,i,n,s){var r=new Event("track");r.track=i,r.receiver=n,r.transceiver={receiver:n},r.streams=s,e.setTimeout((function(){t._dispatchEvent("track",r)}))}var s=function(i){var n=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=s[e].bind(s)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw P("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var s="string"==typeof n;return s&&(n=[n]),n=n.filter((function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!i?(i=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")})),delete e.url,e.urls=s?n[0]:n,!!n.length}}))}(i.iceServers||[],t),this._iceGatherers=[],i.iceCandidatePoolSize)for(var r=i.iceCandidatePoolSize;r>0;r--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=C.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(s.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(s.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),s.prototype.onicecandidate=null,s.prototype.onaddstream=null,s.prototype.ontrack=null,s.prototype.onremovestream=null,s.prototype.onsignalingstatechange=null,s.prototype.oniceconnectionstatechange=null,s.prototype.onconnectionstatechange=null,s.prototype.onicegatheringstatechange=null,s.prototype.onnegotiationneeded=null,s.prototype.ondatachannel=null,s.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},s.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},s.prototype.getConfiguration=function(){return this._config},s.prototype.getLocalStreams=function(){return this.localStreams},s.prototype.getRemoteStreams=function(){return this.remoteStreams},s.prototype._createTransceiver=function(e,t){var i=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var s=this._createIceAndDtlsTransports();n.iceTransport=s.iceTransport,n.dtlsTransport=s.dtlsTransport}return t||this.transceivers.push(n),n},s.prototype.addTrack=function(t,i){if(this._isClosed)throw P("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw P("InvalidAccessError","Track already exists.");for(var s=0;s<this.transceivers.length;s++)this.transceivers[s].track||this.transceivers[s].kind!==t.kind||(n=this.transceivers[s]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),n.track=t,n.stream=i,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},s.prototype.addStream=function(e){var i=this;if(t>=15025)e.getTracks().forEach((function(t){i.addTrack(t,e)}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var i=n.getTracks()[t];e.addEventListener("enabled",(function(e){i.enabled=e.enabled}))})),n.getTracks().forEach((function(e){i.addTrack(e,n)}))}},s.prototype.removeTrack=function(t){if(this._isClosed)throw P("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find((function(e){return e.rtpSender===t}));if(!i)throw P("InvalidAccessError","Sender was not created by this connection.");var n=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},s.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var i=t.getSenders().find((function(t){return t.track===e}));i&&t.removeTrack(i)}))},s.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},s.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},s.prototype._createIceGatherer=function(t,i){var n=this;if(i&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var s=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(s,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var i=!e.candidate||0===Object.keys(e.candidate).length;s.state=i?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},s.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),s},s.prototype._gather=function(t,i){var n=this,s=this.transceivers[i].iceGatherer;if(!s.onlocalcandidate){var r=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),s.onlocalcandidate=function(e){if(!(n.usingBundle&&i>0)){var r=new Event("icecandidate");r.candidate={sdpMid:t,sdpMLineIndex:i};var o=e.candidate,a=!o||0===Object.keys(o).length;if(a)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else{"new"===s.state&&(s.state="gathering"),o.component=1,o.ufrag=s.getLocalParameters().usernameFragment;var c=C.writeCandidate(o);r.candidate=Object.assign(r.candidate,C.parseCandidate(c)),r.candidate.candidate=c,r.candidate.toJSON=function(){return{candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex,usernameFragment:r.candidate.usernameFragment}}}var d=C.getMediaSections(n._localDescription.sdp);d[r.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+r.candidate.candidate+"\r\n",n._localDescription.sdp=C.getDescription(n._localDescription.sdp)+d.join("");var l=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),a||n._dispatchEvent("icecandidate",r),l&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},e.setTimeout((function(){r.forEach((function(e){s.onlocalcandidate(e)}))}),0)}},s.prototype._createIceAndDtlsTransports=function(){var t=this,i=new e.RTCIceTransport(null);i.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(i);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:i,dtlsTransport:n}},s.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var i=this.transceivers[e].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},s.prototype._transceive=function(e,i,n){var s=k(e.localCapabilities,e.remoteCapabilities);i&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:C.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},s.prototype.setLocalDescription=function(e){var t,i,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(P("TypeError",'Unsupported type "'+e.type+'"'));if(!A("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(P("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=C.splitSections(e.sdp),i=t.shift(),t.forEach((function(e,t){var i=C.parseRtpParameters(e);n.transceivers[t].localCapabilities=i})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t)}));else if("answer"===e.type){t=C.splitSections(n._remoteDescription.sdp),i=t.shift();var s=C.matchPrefix(i,"a=ice-lite").length>0;t.forEach((function(e,t){var r=n.transceivers[t],o=r.iceGatherer,a=r.iceTransport,c=r.dtlsTransport,d=r.localCapabilities,l=r.remoteCapabilities;if(!(C.isRejected(e)&&0===C.matchPrefix(e,"a=bundle-only").length)&&!r.rejected){var h=C.getIceParameters(e,i),u=C.getDtlsParameters(e,i);s&&(u.role="server"),n.usingBundle&&0!==t||(n._gather(r.mid,t),"new"===a.state&&a.start(o,h,s?"controlling":"controlled"),"new"===c.state&&c.start(u));var p=k(d,l);n._transceive(r,p.codecs.length>0,!1)}}))}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},s.prototype.setRemoteDescription=function(s){var r=this;if(-1===["offer","answer"].indexOf(s.type))return Promise.reject(P("TypeError",'Unsupported type "'+s.type+'"'));if(!A("setRemoteDescription",s.type,r.signalingState)||r._isClosed)return Promise.reject(P("InvalidStateError","Can not set remote "+s.type+" in state "+r.signalingState));var o={};r.remoteStreams.forEach((function(e){o[e.id]=e}));var a=[],c=C.splitSections(s.sdp),d=c.shift(),l=C.matchPrefix(d,"a=ice-lite").length>0,h=C.matchPrefix(d,"a=group:BUNDLE ").length>0;r.usingBundle=h;var u=C.matchPrefix(d,"a=ice-options:")[0];return r.canTrickleIceCandidates=!!u&&u.substr(14).split(" ").indexOf("trickle")>=0,c.forEach((function(n,c){var u=C.splitLines(n),p=C.getKind(n),_=C.isRejected(n)&&0===C.matchPrefix(n,"a=bundle-only").length,m=u[0].substr(2).split(" ")[2],g=C.getDirection(n,d),f=C.parseMsid(n),v=C.getMid(n)||C.generateIdentifier();if(_||"application"===p&&("DTLS/SCTP"===m||"UDP/DTLS/SCTP"===m))r.transceivers[c]={mid:v,kind:p,protocol:m,rejected:!0};else{var S,y,I,T,E,b,R,w,A;!_&&r.transceivers[c]&&r.transceivers[c].rejected&&(r.transceivers[c]=r._createTransceiver(p,!0));var P,N,M=C.parseRtpParameters(n);_||(P=C.getIceParameters(n,d),(N=C.getDtlsParameters(n,d)).role="client"),R=C.parseRtpEncodingParameters(n);var L=C.parseRtcpParameters(n),O=C.matchPrefix(n,"a=end-of-candidates",d).length>0,x=C.matchPrefix(n,"a=candidate:").map((function(e){return C.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===s.type||"answer"===s.type)&&!_&&h&&c>0&&r.transceivers[c]&&(r._disposeIceAndDtlsTransports(c),r.transceivers[c].iceGatherer=r.transceivers[0].iceGatherer,r.transceivers[c].iceTransport=r.transceivers[0].iceTransport,r.transceivers[c].dtlsTransport=r.transceivers[0].dtlsTransport,r.transceivers[c].rtpSender&&r.transceivers[c].rtpSender.setTransport(r.transceivers[0].dtlsTransport),r.transceivers[c].rtpReceiver&&r.transceivers[c].rtpReceiver.setTransport(r.transceivers[0].dtlsTransport)),"offer"!==s.type||_){if("answer"===s.type&&!_){y=(S=r.transceivers[c]).iceGatherer,I=S.iceTransport,T=S.dtlsTransport,E=S.rtpReceiver,b=S.sendEncodingParameters,w=S.localCapabilities,r.transceivers[c].recvEncodingParameters=R,r.transceivers[c].remoteCapabilities=M,r.transceivers[c].rtcpParameters=L,x.length&&"new"===I.state&&(!l&&!O||h&&0!==c?x.forEach((function(e){D(S.iceTransport,e)})):I.setRemoteCandidates(x)),h&&0!==c||("new"===I.state&&I.start(y,P,"controlling"),"new"===T.state&&T.start(N)),!k(S.localCapabilities,S.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&S.sendEncodingParameters[0].rtx&&delete S.sendEncodingParameters[0].rtx,r._transceive(S,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!E||"sendrecv"!==g&&"sendonly"!==g?delete S.rtpReceiver:(A=E.track,f?(o[f.stream]||(o[f.stream]=new e.MediaStream),i(A,o[f.stream]),a.push([A,E,o[f.stream]])):(o.default||(o.default=new e.MediaStream),i(A,o.default),a.push([A,E,o.default])))}}else{(S=r.transceivers[c]||r._createTransceiver(p)).mid=v,S.iceGatherer||(S.iceGatherer=r._createIceGatherer(c,h)),x.length&&"new"===S.iceTransport.state&&(!O||h&&0!==c?x.forEach((function(e){D(S.iceTransport,e)})):S.iceTransport.setRemoteCandidates(x)),w=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(w.codecs=w.codecs.filter((function(e){return"rtx"!==e.name}))),b=S.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var U,V=!1;if("sendrecv"===g||"sendonly"===g){if(V=!S.rtpReceiver,E=S.rtpReceiver||new e.RTCRtpReceiver(S.dtlsTransport,p),V)A=E.track,f&&"-"===f.stream||(f?(o[f.stream]||(o[f.stream]=new e.MediaStream,Object.defineProperty(o[f.stream],"id",{get:function(){return f.stream}})),Object.defineProperty(A,"id",{get:function(){return f.track}}),U=o[f.stream]):(o.default||(o.default=new e.MediaStream),U=o.default)),U&&(i(A,U),S.associatedRemoteMediaStreams.push(U)),a.push([A,E,U])}else S.rtpReceiver&&S.rtpReceiver.track&&(S.associatedRemoteMediaStreams.forEach((function(t){var i=t.getTracks().find((function(e){return e.id===S.rtpReceiver.track.id}));i&&function(t,i){i.removeTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(i,t)})),S.associatedRemoteMediaStreams=[]);S.localCapabilities=w,S.remoteCapabilities=M,S.rtpReceiver=E,S.rtcpParameters=L,S.sendEncodingParameters=b,S.recvEncodingParameters=R,r._transceive(r.transceivers[c],!1,V)}}})),void 0===r._dtlsRole&&(r._dtlsRole="offer"===s.type?"active":"passive"),r._remoteDescription={type:s.type,sdp:s.sdp},"offer"===s.type?r._updateSignalingState("have-remote-offer"):r._updateSignalingState("stable"),Object.keys(o).forEach((function(t){var i=o[t];if(i.getTracks().length){if(-1===r.remoteStreams.indexOf(i)){r.remoteStreams.push(i);var s=new Event("addstream");s.stream=i,e.setTimeout((function(){r._dispatchEvent("addstream",s)}))}a.forEach((function(e){var t=e[0],s=e[1];i.id===e[2].id&&n(r,t,s,[i])}))}})),a.forEach((function(e){e[2]||n(r,e[0],e[1],[])})),e.setTimeout((function(){r&&r.transceivers&&r.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},s.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},s.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},s.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},s.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},s.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},s.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(P("InvalidStateError","Can not call createOffer after close"));var n=i.transceivers.filter((function(e){return"audio"===e.kind})).length,s=i.transceivers.filter((function(e){return"video"===e.kind})).length,r=arguments[0];if(r){if(r.mandatory||r.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==r.offerToReceiveAudio&&(n=!0===r.offerToReceiveAudio?1:!1===r.offerToReceiveAudio?0:r.offerToReceiveAudio),void 0!==r.offerToReceiveVideo&&(s=!0===r.offerToReceiveVideo?1:!1===r.offerToReceiveVideo?0:r.offerToReceiveVideo)}for(i.transceivers.forEach((function(e){"audio"===e.kind?--n<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)}));n>0||s>0;)n>0&&(i._createTransceiver("audio"),n--),s>0&&(i._createTransceiver("video"),s--);var o=C.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach((function(n,s){var r=n.track,o=n.kind,a=n.mid||C.generateIdentifier();n.mid=a,n.iceGatherer||(n.iceGatherer=i._createIceGatherer(s,i.usingBundle));var c=e.RTCRtpSender.getCapabilities(o);t<15019&&(c.codecs=c.codecs.filter((function(e){return"rtx"!==e.name}))),c.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),c.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var d=n.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];r&&t>=15019&&"video"===o&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=c,n.sendEncodingParameters=d})),"max-compat"!==i._config.bundlePolicy&&(o+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n",i.transceivers.forEach((function(e,t){o+=w(e,e.localCapabilities,"offer",e.stream,i._dtlsRole),o+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,o+="a="+C.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(o+="a=end-of-candidates\r\n"))}));var a=new e.RTCSessionDescription({type:"offer",sdp:o});return Promise.resolve(a)},s.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(P("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(P("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var n=C.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(n+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),n+="a=ice-options:trickle\r\n";var s=C.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach((function(e,r){if(!(r+1>s)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?n+="m=application 0 DTLS/SCTP 5000\r\n":n+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?n+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(n+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(n+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var o;if(e.stream)"audio"===e.kind?o=e.stream.getAudioTracks()[0]:"video"===e.kind&&(o=e.stream.getVideoTracks()[0]),o&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var a=k(e.localCapabilities,e.remoteCapabilities);!a.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,n+=w(e,a,"answer",e.stream,i._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(n+="a=rtcp-rsize\r\n")}}));var r=new e.RTCSessionDescription({type:"answer",sdp:n});return Promise.resolve(r)},s.prototype.addIceCandidate=function(e){var t,i=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,s){if(!i._remoteDescription)return s(P("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var r=e.sdpMLineIndex;if(e.sdpMid)for(var o=0;o<i.transceivers.length;o++)if(i.transceivers[o].mid===e.sdpMid){r=o;break}var a=i.transceivers[r];if(!a)return s(P("OperationError","Can not add ICE candidate"));if(a.rejected)return n();var c=Object.keys(e.candidate).length>0?C.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return n();if(c.component&&1!==c.component)return n();if((0===r||r>0&&a.iceTransport!==i.transceivers[0].iceTransport)&&!D(a.iceTransport,c))return s(P("OperationError","Can not add ICE candidate"));var d=e.candidate.trim();0===d.indexOf("a=")&&(d=d.substr(2)),(t=C.getMediaSections(i._remoteDescription.sdp))[r]+="a="+(c.type?d:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=C.getDescription(i._remoteDescription.sdp)+t.join("")}else for(var l=0;l<i.transceivers.length&&(i.transceivers[l].rejected||(i.transceivers[l].iceTransport.addRemoteCandidate({}),(t=C.getMediaSections(i._remoteDescription.sdp))[l]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=C.getDescription(i._remoteDescription.sdp)+t.join(""),!i.usingBundle));l++);n()}))},s.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var i=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?i=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(i=e.rtpReceiver)})),!i)throw P("InvalidAccessError","Invalid selector.");return i.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats())}))})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var i=e[t];if(i&&i.prototype&&i.prototype.getStats){var n=i.prototype.getStats;i.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(i){var n;e[i].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[i]).type]||n.type,t.set(i,e[i])})),t}))}}}));var r=["createOffer","createAnswer"];return r.forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(r=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),s};function M(e){const t=e&&e.navigator,i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function L(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function O(e,t){if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const i=new Event("enabled");i.enabled=e,this.dispatchEvent(i)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const i=N(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let i=!1;return(e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&c("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter(e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!i?(i=!0,!0):t&&!i}),delete e.url,e.urls=n?t[0]:t,!!t.length}})}(e.iceServers,t.version),a("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype}function x(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}var U=Object.freeze({__proto__:null,shimPeerConnection:O,shimReplaceTrack:x,shimGetUserMedia:M,shimGetDisplayMedia:L});function V(e,t){const i=e&&e.navigator,n=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,n){c("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function F(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function $(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,s,r]=arguments;return n.apply(this,[e||null]).then(e=>{if(t.version<53&&!s)try{e.forEach(e=>{e.type=i[e.type]||e.type})}catch(n){if("TypeError"!==n.name)throw n;e.forEach((t,n)=>{e.set(n,Object.assign({},t,{type:i[t.type]||t.type}))})}return e}).then(s,r)}}function B(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function j(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),s(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function H(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){c("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function G(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function J(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],i=e&&"sendEncodings"in e;i&&e.sendEncodings.forEach(e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const n=t.apply(this,arguments);if(i){const{sender:t}=n,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(i).then(()=>{delete t.sendEncodings}).catch(()=>{delete t.sendEncodings})))}return n})}function z(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function W(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var K=Object.freeze({__proto__:null,shimOnTrack:F,shimPeerConnection:$,shimSenderGetStats:B,shimReceiverGetStats:j,shimRemoveStream:H,shimRTCDataChannel:G,shimAddTransceiver:J,shimGetParameters:z,shimCreateOffer:W,shimCreateAnswer:q,shimGetUserMedia:V,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}});function Q(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(i=>t.call(this,i,e)),e.getVideoTracks().forEach(i=>t.call(this,i,e))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach(e=>{i.includes(e.track)&&this.removeTrack(e)})})}}function X(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)})}),t.apply(e,arguments)}}}function Y(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,n=t.createAnswer,s=t.setLocalDescription,r=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],s=i.apply(this,[n]);return t?(s.then(e,t),Promise.resolve()):s},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],s=n.apply(this,[i]);return t?(s.then(e,t),Promise.resolve()):s};let a=function(e,t,i){const n=s.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,i){const n=r.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,i){const n=o.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.addIceCandidate=a}function Z(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(ee(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,n){t.mediaDevices.getUserMedia(e).then(i,n)}.bind(t))}function ee(e){return e&&void 0!==e.video?Object.assign({},e,{video:l(e.video)}):e}function te(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let n=e.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(c("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function ie(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ne(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}}function se(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var re=Object.freeze({__proto__:null,shimLocalStreamsAPI:Q,shimRemoteStreamsAPI:X,shimCallbacksAPI:Y,shimGetUserMedia:Z,shimConstraints:ee,shimRTCIceServerUrls:te,shimTrackEventTransceiver:ie,shimCreateOfferLegacy:ne,shimAudioContext:se});function oe(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),n=C.parseCandidate(e.candidate),s=Object.assign(i,n);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,s(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function ae(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return!1;const t=C.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=C.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i},s=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},r=function(e,i){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const s=C.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?n=parseInt(s[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const e=n(arguments[0]),t=s(e),i=r(arguments[0],e);let o;o=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a}return o.apply(this,arguments)}}function ce(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const n=arguments[0],s=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&s>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},s(e,"datachannel",e=>(t(e.channel,e.target),e))}function de(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function le(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function he(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}var ue=Object.freeze({__proto__:null,shimRTCIceCandidate:oe,shimMaxMessageSize:ae,shimSendThrowTypeError:ce,shimConnectionState:de,removeExtmapAllowMixed:le,shimAddIceCandidateNullOrEmpty:he});!function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const i=a,s=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=n(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=n(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(i.mediaDevices&&i.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=n(i.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=n(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),c={browserDetails:s,commonShim:ue,extractVersion:n,disableLog:r,disableWarnings:o};switch(s.browser){case"chrome":if(!E||!I||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),c;if(null===s.version)return i("Chrome shim can not determine version, not shimming."),c;i("adapter.js shimming chrome."),c.browserShim=E,he(e,s),p(e,s),_(e),I(e,s),m(e),y(e,s),g(e),f(e),v(e),T(e,s),oe(e),de(e),ae(e,s),ce(e),le(e,s);break;case"firefox":if(!K||!$||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),c;i("adapter.js shimming firefox."),c.browserShim=K,he(e,s),V(e,s),$(e,s),F(e),H(e),B(e),j(e),G(e),J(e),z(e),W(e),q(e),oe(e),de(e),ae(e,s),ce(e);break;case"edge":if(!U||!O||!t.shimEdge)return i("MS edge shim is not included in this adapter release."),c;i("adapter.js shimming edge."),c.browserShim=U,M(e),L(e),O(e,s),x(e),ae(e,s),ce(e);break;case"safari":if(!re||!t.shimSafari)return i("Safari shim is not included in this adapter release."),c;i("adapter.js shimming safari."),c.browserShim=re,he(e,s),te(e),ne(e),Y(e),Q(e),X(e),ie(e),Z(e),se(e),oe(e),ae(e,s),ce(e),le(e,s);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});let pe=(new Date).getTime(),_e=0;const me=function(){return(new Date).getTime()+_e},ge=function(){const e=new Date;return e.setTime(me()),e.toLocaleString()},fe=window.navigator&&window.navigator.userAgent||"",ve=/AppleWebKit\/([\d.]+)/i.exec(fe),Se=(ve&&parseFloat(ve.pop()),/iPad/i.test(fe)),ye=navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/Macintosh/.test(fe),Ie=/iPhone/i.test(fe)&&!Se,Te=/iPod/i.test(fe),Ee=Ie||Se||Te||ye,be=/Android/i.test(fe),Re=be&&function(){const e=fe.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;const t=e[1]&&parseFloat(e[1]),i=e[2]&&parseFloat(e[2]);return t&&i?parseFloat(e[1]+"."+e[2]):t||null}(),Ce=(be&&/webkit/i.test(fe),/Firefox/i.test(fe)),we=Ce&&function(){const e=fe.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),ke=/Edge\//i.test(fe),Ae=ke&&function(){var e=fe.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),De=/Edg\//i.test(fe),Pe=De&&function(){const e=fe.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),Ne=/SogouMobileBrowser\//i.test(fe),Me=Ne&&function(){const e=fe.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),Le=/MetaSr\s/i.test(fe),Oe=Le&&function(){const e=fe.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),xe=/TBS\/\d+/i.test(fe),Ue=xe&&function(){var e=fe.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),Ve=/XWEB\/\d+/i.test(fe),Fe=Ve&&function(){var e=fe.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}(),$e=(/MSIE\s8\.0/.test(fe),/MSIE\/\d+/i.test(fe)&&function(){const e=/MSIE\s(\d+)\.\d/.exec(fe);let t=e&&parseFloat(e[1]);!t&&/Trident\/7.0/i.test(fe)&&/rv:11.0/.test(fe)&&(t=11)}(),/(micromessenger|webbrowser)/i.test(fe)),Be=$e&&function(){var e=fe.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return e[1]}(),je=!xe&&/MQQBrowser\/\d+/i.test(fe)&&/COVC\/\d+/i.test(fe),He=!xe&&/MQQBrowser\/\d+/i.test(fe)&&!/COVC\/\d+/i.test(fe),Ge=(He||je)&&function(){const e=fe.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Je=!xe&&/ QQBrowser\/\d+/i.test(fe),ze=Je&&function(){const e=fe.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),We=!xe&&/QQBrowserLite\/\d+/i.test(fe),qe=We&&function(){const e=fe.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Ke=!xe&&/MQBHD\/\d+/i.test(fe),Qe=Ke&&function(){const e=fe.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),Xe=/Windows/i.test(fe),Ye=!Ee&&/MAC OS X/i.test(fe),Ze=!be&&/Linux/i.test(fe),et=(/MicroMessenger/i.test(fe),/UCBrowser/i.test(fe)),tt=(/Electron/i.test(fe),/MiuiBrowser/i.test(fe)),it=tt&&function(){const e=fe.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),nt=/HuaweiBrowser/i.test(fe),st=/Huawei/i.test(fe),rt=nt&&function(){const e=fe.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),ot=/SamsungBrowser/i.test(fe),at=ot&&function(){const e=fe.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),ct=/HeyTapBrowser/i.test(fe),dt=ct&&function(){const e=fe.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),lt=/VivoBrowser/i.test(fe),ht=lt&&function(){const e=fe.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),ut=()=>{const e=fe.match(/Chrome\/(\d+)/);return e&&e[1]?Number(e[1]):null},pt=/Chrome/i.test(fe),_t=!ke&&!Le&&!Ne&&!xe&&!Ve&&!De&&!Je&&!tt&&!nt&&!ot&&!ct&&!lt&&/Chrome/i.test(fe),mt=_t&&ut(),gt=_t&&function(){const e=fe.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),ft=!pt&&!He&&!je&&!We&&!Ke&&/Safari/i.test(fe),vt=function(){if(ft){const e=fe.match(/Version\/([\d.]+)/);if(e&&e[1])return e[1]}return""}(),St=/Android.*(wv|.0.0.0)/.test(fe),yt=(()=>{if(ye)return vt;if(Ee){const e=fe.match(/OS (\d+)_(\d+)/i);if(e&&e[1]){let t=e[1];return e[2]&&(t+="."+e[2]),t}}return""})(),It="15.1"===vt,Tt="15.1"===yt,Et=(()=>{const e=Number(yt.split(".")[0]);return 14===e||13===e})(),bt="file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname,Rt=(()=>{let e;return()=>{if(qr(e))try{e=window.localStorage}catch(t){vc.warn(t),e=!1}return e}})(),Ct=new Map([[Ce,["Firefox",we]],[De,["Edg",Pe]],[_t,["Chrome",gt]],[ft,["Safari",vt]],[xe,["TBS",Ue]],[Ve,["XWEB",Fe]],[$e&&Ie,["WeChat",Be]],[Je,["QQ(Win)",ze]],[He,["QQ(Mobile)",Ge]],[je,["QQ(Mobile X5)",Ge]],[We,["QQ(Mac)",qe]],[Ke,["QQ(iPad)",Qe]],[tt,["MI",it]],[nt,["HW",rt]],[ot,["Samsung",at]],[ct,["OPPO",dt]],[lt,["VIVO",ht]],[ke,["EDGE",Ae]],[Ne,["SogouMobile",Me]],[Le,["Sogou",Oe]]]);function wt(){let e="unknown",t="unknown";return Ct.get(!0)&&(e=Ct.get(!0)[0],t=Ct.get(!0)[1]),{name:e,version:t}}const kt="canvas",At="audio",Dt="video",Pt="auxiliary",Nt="smallVideo",Mt="user",Lt="environment",Ot="mute",xt="unmute",Ut="ended",Vt="playing",Ft="pause",$t="error",Bt="loadeddata",jt="audioinput",Ht="videoinput",Gt="detail",Jt="text",zt="main",Wt="backup",qt="banned",Kt="kick",Qt="user_time_out",Xt="room_disband",Yt="sei-message",Zt="wss://trtc.rtc.qq.com",ei="wss://webrtc.qq.com",ti="qcloud",ii="trtc",ni="webrtc";let si="";const ri="jssdk_log",oi="jssdk_event",ai="jssdk_new_endreport",ci=e=>si=e,di=1,li=2,hi=20,ui=21,pi="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",_i="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",mi=2,gi=zt,fi=Pt,vi="DISCONNECTED",Si="CONNECTING",yi="RECONNECTING",Ii="CONNECTED",Ti="new",Ei="connecting",bi="failed",Ri="closed",Ci="disconnected",wi="connected",ki="completed",Ai="join",Di="delta-join",Pi="rejoin",Ni="leave",Mi="delta-leave",Li="publish",Oi="delta-publish",xi="unpublish",Ui="subscribe",Vi="unsubscribe",Fi="uplink-connection",$i="uplink-reconnection",Bi="downlink-connection",ji="downlink-reconnection",Hi="setLocalDescription",Gi="setRemoteDescription",Ji="iceConnectionState",zi="stream-initialize",Wi="websocketConnectionState",qi="websocketReconnectionState",Ki="update-stream",Qi="recover-subscription",Xi="start-mix-transcode",Yi="stop-mix-transcode",Zi="player-error",en="schedule",tn="load-worklet",nn="unsubscribe",sn="subscribe_change",rn={MANUAL:"manual",PRESET_LAYOUT:"preset-layout"},on={REMOTE:"$PLACE_HOLDER_REMOTE$"},an={IT_AUDIO_VIDEO:0,IT_PICTURE:2,IT_CANVAS:3,IT_PURE_AUDIO:4,IT_PURE_VIDEO:5},cn="string",dn="number",ln="boolean",hn="array",un="object",pn="add",_n="remove",mn={unknown:0,wifi:1,"4g":2,"3g":3,"2g":4,wired:5},gn=-1,fn=0,vn=1,Sn="schedule.rtc.qq.com",yn="schedule.rtc.qcloud.com",In="intl-schedule.rtc.qq.com",Tn="intl-schedule.rtc.qcloud.com",En="TRTC",bn="Client",Rn="LocalStream",Cn="RemoteStream",wn="Stream",kn="web.sdk.qcloud.com",An="web.sdk.tencent.cn",Dn="web.sdk.cloud.tencent.cn",Pn=`https://${kn}/trtc/webrtc/doc`,Nn=Pn+"/zh-cn/",Mn={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5},Ln=Object.keys(Mn),On=["normal leave","timeout leave","kick","role change"],xn="AVOID_REPEATED_CALL",Un="INVALID_PARAMETER_REQUIRED",Vn="INVALID_PARAMETER_TYPE",Fn="INVALID_PARAMETER_EMPTY",$n="INVALID_PARAMETER_INSTANCE",Bn="INVALID_PARAMETER_RANGE",jn="API_CALL_TIMEOUT",Hn="SIGNAL_CHANNEL_RECONNECTION_FAILED",Gn="SIGNAL_CHANNEL_SETUP_FAILED",Jn="ERROR_MESSAGE",zn="EXCHANGE_SDP_TIMEOUT",Wn="DOWNLINK_RECONNECTION_FAILED",qn="EXCHANGE_SDP_FAILED",Kn="UPLINK_RECONNECTION_FAILED",Qn="AUDIO",Xn="VIDEO",Yn="INVALID_PURE_AUDIO",Zn="INVALID_STREAMID",es="INVALID_USER_DEFINE_RECORDID",ts="INVALID_USER_DEFINE_PUSH_ARGS",is="INVALID_PROXY",ns="INVALID_JOIN",ss="INVALID_ROOMID_STRING",rs="INVALID_ROOMID_INTEGER",os="JOIN_ROOM_TIMEOUT",as="JOIN_ROOM_FAILED",cs="REJOIN_ROOM_FAILED",ds="INVALID_DESTROY",ls="INVALID_PUBLISH",hs="INVALID_UNPUBLISH",us="INVALID_AUDIENCE",ps="INVALID_INITIALIZE",_s="INVALID_DUPLICATE_PUBLISHING",ms="INVALID_REMOTE_STREAM",gs="SUBSCRIBE_FAILED",fs="INVALID_ROLE",vs="INVALID_OPERATION_SWITCH_ROLE",Ss="SWITCH_ROLE_TIMEOUT",ys="SWITCH_ROLE_FAILED",Is="CLIENT_BANNED",Ts="INVALID_OPERATION_START_PUBLISH_CDN",Es="INVALID_OPERATION_STOP_PUBLISH_CDN",bs="INVALID_STREAM_ID",Rs="START_PUBLISH_CDN_FAILED",Cs="STOP_PUBLISH_CDN_FAILED",ws="START_MIX_TRANSCODE",ks="STOP_MIX_TRANSCODE",As="INVALID_AUDIO_VOLUME",Ds="ENABLE_SMALL_STREAM_PUBLISHED",Ps="DISABLE_SMALL_STREAM_PUBLISHED",Ns="NOT_SUPPORTED_SMALL_STREAM",Ms="INVALID_SMALL_STREAM_PROFILE",Ls="INVALID_PARAMETER_REMOTE_STREAM",Os="INVALID_SWITCH_DEVICE",xs="INVALID_SWITCH_DEVICE_PUBLISHING",Us="INVALID_REPLACE_TRACK",Vs="INVALID_INITIALIZE_LOCAL_STREAM",Fs="INVALID_ADD_TRACK_REPETITIVE",$s="INVALID_ADD_TRACK_REMOVING",Bs="INVALID_ADD_TRACK_PUBLISHING",js="INVALID_STREAM_INITIALIZED",Hs="INVALID_ADD_TRACK_NUMBER",Gs="INVALID_REMOVE_AUDIO_TRACK",Js="INVALID_REMOVE_AUDIO_ADDING",zs="INVALID_REMOVE_AUDIO_ON",Ws="INVALID_REMOVE_TRACK_PUBLISHING",qs="INVALID_REMOVE_TRACK_NOT_PUBLISHING",Ks="INVALID_REMOVE_TRACK_NUMBER",Qs="INVALID_REMOVE_TRACK_NOT_PUBLISHED",Xs="REPEAT_JOIN",Ys="CLIENT_DESTROYED",Zs="START_MIX_TRANSCODE_FAILED",er="STOP_MIX_TRANSCODE_FAILED",tr="MIX_TRANSCODE_NOT_STARTED",ir="CANNOT_LESS_THAN_ZERO",nr="MIX_PARAMS_VIDEO_FRAMERATE",sr="MIX_PARAMS_VIDEO_GOP",rr="MIX_PARAMS_AUDIO_BITRATE",or="MIX_PARAMS_USER_Z_ORDER",ar="MIX_PARAMS_NOT_SELF",cr="MIX_PARAMS_USER_STREAM",dr="INVALID_ELEMENT_ID",lr="INVALID_ELEMENT_ID_TYPE",hr="INVALID_CREATE_STREAM_SOURCE",ur="INVALID_CREATE_STREAM_SCREEN",pr="INVALID_CREATE_STREAM_AUDIO",_r="INVALID_CREATE_STREAM_SCREEN_AUDIO",mr="NOT_SUPPORTED_HTTP",gr="NOT_SUPPORTED_WEBRTC",fr="NOT_SUPPORTED_PROFILE",vr="NOT_SUPPORTED_H264ENCODE",Sr="NOT_SUPPORTED_H264DECODE",yr="NOT_SUPPORTED_REPLACE_TRACK",Ir="NOT_SUPPORTED_CAPTURE",Tr="MICROPHONE_NOT_FOUND",Er="CAMERA_NOT_FOUND",br="SIGNAL_RESPONSE_FAILED",Rr="CATCH_HANDLER_ERROR",Cr="API_NOT_EXIST",wr="STREAM_UNSUBSCRIBED",kr="SUBSCRIBE_ALL_FALSE",Ar="SEI_NOT_SUPPORT",Dr="SEI_DISABLED",Pr="SEI_EMPTY",Nr="SEI_OVERSIZE",Mr="SEI_BEFORE_PUBLISH",Lr="SEI_NOT_VIDEO",Or="CALL_FREQUENCY_LIMIT",xr={AVOID_REPEATED_CALL:e=>`previous ${e.name}() is ongoing, please avoid repeated calls.`,INVALID_PARAMETER_REQUIRED:({key:e,rule:t,fnName:i,value:n})=>`'${e||t.name}' is a required param when calling ${i}(), received: ${n}.`,INVALID_PARAMETER_TYPE({key:e,rule:t,fnName:i,value:n}){const s=""+(e||t.name);let r="";return r=Array.isArray(t.type)?t.type.join("|"):t.type,`'${s}' must be type of ${r} when calling ${i}(), received type: ${eo(n)}.`},INVALID_PARAMETER_EMPTY:({key:e,rule:t,fnName:i,value:n})=>`'${e||t.name}' cannot be '${n}' when calling ${i}().`,INVALID_PARAMETER_INSTANCE:({key:e,rule:t,fnName:i,value:n})=>`'${""+(e||t.name)}' must be instanceof ${""+(t.instanceOf.name||t.instanceOf)} when calling ${i}(), received type: ${eo(n)}.`,INVALID_PARAMETER_RANGE:({key:e,rule:t,fnName:i,value:n})=>`'${e||t.name}' must be one of ${t.values.join("|")} when calling ${i}(), received: ${n}.`,API_CALL_TIMEOUT:e=>(e.commandDesc||e.command)+" timeout observed.",SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED:e=>`SignalChannel setup failure: (errorCode: ${e.errorCode}, errorMsg: ${e.errorMsg} }).`,ERROR_MESSAGE:function(e){let t=e.type+" failed";return e.message&&(t=`${t}: ${e.message}.`),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED:function(e){return`exchange sdp failed ${e.errMsg}.`},UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",AUDIO:function(e){return e.error.toString()+" <audio>"},VIDEO:function(e){return e.error.toString()+" <video>"},INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING:function(e){return`'${e}' must be validate string when useStringRoomId is true.`},INVALID_ROOMID_INTEGER:function(e){return`'${e}' must be an integer between [1, 4294967294] when useStringRoomId is false.`},INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED:function({error:e,code:t}){return`Failed to join room - ${e} code: ${t}`},REJOIN_ROOM_FAILED:function(e){return`reJoin room: ${e.roomId} failed, please check your network.`},INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:'no permission to publish() under live/audience, please call switchRole("anchor") firstly before publish().',INVALID_INITIALIZE:"cannot publish stream because stream is not initialized or is switching device.",INVALID_DUPLICATE_PUBLISHING:"duplicate publishing, please unpublish and then re-publish.",INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED:function({message:e,stream:t}){return`failed to subscribe ${t.getUserId()} ${t.getType()} stream, reason: ${e}.`},INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:"role could only be set to a value as anchor or audience.",INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED:function(e){return`switchRole failed, errCode: ${e.code} errMsg: ${e.message}.`},CLIENT_BANNED:function(e){return"client was banned because of "+e.message+"."},INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() after join room and publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED:function(e){return`startPublishCDNStream failed, errMsg: ${e.message}.`},STOP_PUBLISH_CDN_FAILED:function(e){return`stopPublishCDNStream failed, errMsg: ${e.message}.`},INVALID_STREAM_ID:function(e){return`'${e}' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.`},START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"the track to be removed is not being publishing.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REMOVE_TRACK_NOT_PUBLISHED:function(e){return`try to replace ${e.kind} track but there's no previous ${e.kind} being published.`},START_MIX_TRANSCODE_FAILED:function(e){return`startMixTranscode failed, errMsg: ${e.message}.`},STOP_MIX_TRANSCODE_FAILED:function(e){return`stopMixTranscode failed, errMsg: ${e.message}.`},MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO:function({key:e,rule:t,fnName:i,value:n}){return`'${e||t.name}' cannot be less than 0 when calling ${i}().`},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER:function(e){return`'${e}' is required and must be between 1 and 15.`},MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:({key:e,fnName:t})=>`'${e}' is not found in the document object when calling ${t}().`,INVALID_ELEMENT_ID_TYPE:({key:e,fnName:t,type:i})=>`the element corresponding to '${e}' must be instanceof HTMLDivElement when calling ${t}(), received: ${i}.`,INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture and publish streams, please use the https protocol.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_REPLACE_TRACK:"replaceTrack is not supported in this browser, please use switchDevice or addTrack instead.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone and the configuration on TRTC.createStream.",CAMERA_NOT_FOUND:"no camera detected, please check your camera and the configuration on TRTC.createStream.",SIGNAL_RESPONSE_FAILED:function(e){return`${e.signalResponse} failed, response code is ${e.code} , errMsg: ${e.message}.`},CATCH_HANDLER_ERROR:function({name:e,event:t}){return`an error was caught on ${e}.on('${t}', handler), please check your code on 'handler'.`},API_NOT_EXIST:function({name:e}){return`experimental api ${e} does not exist.`},REPEAT_JOIN:e=>`[${e}] is calling client.join api or has already joined room, please avoid repeated join.`,STREAM_UNSUBSCRIBED:"stream has been unsubscribed, please call client.unsubscribe after last client.subscribe finished.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED:function({funName:e}){return`failed to call ${e}() because client was destroyed.`},SEI_NOT_SUPPORT:e=>"not support to sendSEIMessage"+(!1===e?" without using h264 codec":""),SEI_DISABLED:"SEI is disabled, to enable SEI: TRTC.createClient({ enableSEI: true })",SEI_EMPTY:"buffer cannot be empty",SEI_OVERSIZE:e=>`buffer size(${e}) is over 1000 Bytes`,SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:({isSize:e,name:t,timesInSecond:i,maxSizeInSecond:n})=>`api ${t} call ${e?"size":"times"} is over ${e?n+" bytes":i} in a second.`},Ur=(e,t)=>t?Pn+"/"+e+"/"+t:Pn+"/"+e+"/index.html",Vr=()=>{if(!Rt())return!1;const e=localStorage.getItem("trtc_error_assistance");e&&!(e=>{const t=e.saveTime&&(new Date).getTime()-e.saveTime>=6048e5,i=!e.saveVersion||"4.14.0"!==e.saveVersion;return t||i})(JSON.parse(e))||(vc.info("init debug info"),(()=>{const e=new XMLHttpRequest;if(e.open("GET","https://web.sdk.qcloud.com/trtc/webrtc/download/error-message/0.0.2/script.js",!1),e.send(null),4===e.readyState&&200===e.status){const t=document.createElement("script");t.type="text/javascript",t.text=e.responseText,document.body.appendChild(t),localStorage.setItem("trtc_error_assistance",JSON.stringify({message:e.responseText,saveTime:(new Date).getTime(),saveVersion:"4.14.0"})),document.body.removeChild(t)}})())};function Fr(e){const{key:t,data:i,link:n,addDocLink:s=!0}=e;let r="",o="",a="";Wr(xr[t])?r=xr[t](i):Kr(xr[t])&&(r=xr[t]);const{TRTC_ERROR_INFO:c,TRTC_ERROR_LINK:d}=(()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};{let e=localStorage.getItem("trtc_error_assistance");if(e){e=JSON.parse(e);const t=document.createElement("script");t.type="text/javascript",t.text=e.message,document.body.appendChild(t);const i=window.TRTC_ERROR_INFO,n=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:i,TRTC_ERROR_LINK:n}}}return{}})();n?a=`${n.className}.html#${n.fnName}`:d&&d[t]&&(a=d[t]);let l=r;return so()&&(c&&c[t]&&(Wr(c[t])?o=c[t](i):Kr(c[t])&&(o=c[t])),o&&(l=s?o+"\n: "+Ur("zh-cn",a)+"\n\n":o+"\n\n",l+=r)),s&&(l+=" \nRefer to: "+Ur("en",a)+"\n"),l}const $r=function(){return function(e){const t=window.location.search.match(new RegExp("(\\?|&)"+e+"=([^&]*)(&|$)"));return t?decodeURIComponent(t[2]):""}("trtc_env")},Br=e=>(e=Number(e))>0&&e<14e8,jr=function(e,t){let i;i=si||(Br(e)?"https://videoapi-sgp.im.qcloud.com":"https://yun.tim.qq.com");return`${i}/v5/AVQualityReportSvc/C2S?random=${Math.floor(Math.random()*2**31)}&sdkappid=${e}&cmdtype=${t}`};function Hr(){const e=navigator.userAgent,t=navigator.connection;let i=e.match(/NetType\/\w+/)?e.match(/NetType\/\w+/)[0]:"";i=i.toLowerCase().replace("nettype/",""),"3gnet"===i&&(i="3g");const n=t&&t.type&&t.type.toLowerCase();let s=t&&t.effectiveType&&t.effectiveType.toLowerCase();"slow-2"===s&&(s="2g");let r=i||"unknown";if(n)switch(n){case"cellular":case"wimax":r=s||"unknown";break;case"wifi":r="wifi";break;case"ethernet":r="wired";break;case"none":case"other":case"unknown":r="unknown"}return r}const Gr=function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)};function Jr(e,t=1,i=1){return e<=1?i:Jr(e-1,i,t+i)}function zr(e){const t=Math.round(e/2)+1;return t>6?13e3:1e3*Jr(t)}const Wr=e=>"function"==typeof e,qr=e=>void 0===e,Kr=e=>"string"==typeof e,Qr=e=>"number"==typeof e,Xr=e=>"boolean"==typeof e,Yr=e=>"array"===eo(e),Zr=e=>eo(e)==="MediaStreamTrack".toLowerCase();function eo(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}function to(e){const t={};return t.urls="turn:"+e.url,qr(e.username)||qr(e.credential)||(t.username=e.username,t.credential=e.credential,t.credentialType="password",qr(e.credentialType)||(t.credentialType=e.credentialType)),t}function io(){return performance&&performance.now?Math.floor(performance.now()):Date.now()}function no(e,t="big"){if(!Kr(e))return 0;const i=e.split(".");return"big"===t?(Number(i[0])<<24|Number(i[1])<<16|Number(i[2])<<8|Number(i[3]))>>>0:(Number(i[3])<<24|Number(i[2])<<16|Number(i[1])<<8|Number(i[0]))>>>0}const so=()=>{let e=navigator.language||navigator.userLanguage;return e=e.substr(0,2),"zh"===e},ro=(()=>{let e=!1,t=document.visibilityState;return()=>{document.visibilityState!==t&&vc.info("visibility change: "+document.visibilityState),e||(document.addEventListener("visibilitychange",()=>{vc.info("visibility change: "+document.visibilityState),t=document.visibilityState}),e=!0)}})();window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;const oo=(()=>{let e;return()=>{if(e)return e;e=new window.AudioContext;return e.onstatechange=()=>{vc.info("gain context state: "+e.state),"suspended"===e.state?(e.resume(),document.addEventListener("click",e.resume)):"interrupted"===e.state?e.resume():document.removeEventListener("click",e.resume)},e}})(),ao=!!window.AudioWorkletNode,co=(e,t)=>{const i=e.emit;return e.emit=(...n)=>{try{i.apply(e,n)}catch(s){const e=Fr({key:Rr,data:{name:t,event:n[0]},addDocLink:!1});vc.warn(e+"\n\n"+s.stack)}},e},lo=e=>+e<10?"0"+e:e,ho=e=>{const t=e.match(/^\d+\.\d+\.\d+/)[0];if(!t)return e;const i=t.split("."),n=lo(i[1])+lo(i[2]);i[1]-15>0&&(i[1]="15"),i[2]-15>0&&(i[2]="15");return i.join(".")+"."+n};var uo=function(e,t){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return e.apply(t,i)}},po=Object.prototype.toString;function _o(e){return"[object Array]"===po.call(e)}function mo(e){return void 0===e}function go(e){return null!==e&&"object"==typeof e}function fo(e){return"[object Function]"===po.call(e)}function vo(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),_o(e))for(var i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.call(null,e[s],s,e)}var So={isArray:_o,isArrayBuffer:function(e){return"[object ArrayBuffer]"===po.call(e)},isBuffer:function(e){return null!==e&&!mo(e)&&null!==e.constructor&&!mo(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:go,isUndefined:mo,isDate:function(e){return"[object Date]"===po.call(e)},isFile:function(e){return"[object File]"===po.call(e)},isBlob:function(e){return"[object Blob]"===po.call(e)},isFunction:fo,isStream:function(e){return go(e)&&fo(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:vo,merge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]=i}for(var n=0,s=arguments.length;n<s;n++)vo(arguments[n],i);return t},deepMerge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]="object"==typeof i?e({},i):i}for(var n=0,s=arguments.length;n<s;n++)vo(arguments[n],i);return t},extend:function(e,t,i){return vo(t,(function(t,n){e[n]=i&&"function"==typeof t?uo(t,i):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}};function yo(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Io=function(e,t,i){if(!t)return e;var n;if(i)n=i(t);else if(So.isURLSearchParams(t))n=t.toString();else{var s=[];So.forEach(t,(function(e,t){null!=e&&(So.isArray(e)?t+="[]":e=[e],So.forEach(e,(function(e){So.isDate(e)?e=e.toISOString():So.isObject(e)&&(e=JSON.stringify(e)),s.push(yo(t)+"="+yo(e))})))})),n=s.join("&")}if(n){var r=e.indexOf("#");-1!==r&&(e=e.slice(0,r)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e};function To(){this.handlers=[]}To.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},To.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},To.prototype.forEach=function(e){So.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var Eo=To,bo=function(e,t,i){return So.forEach(i,(function(i){e=i(e,t)})),e},Ro=function(e){return!(!e||!e.__CANCEL__)},Co="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function wo(){throw new Error("setTimeout has not been defined")}function ko(){throw new Error("clearTimeout has not been defined")}var Ao=wo,Do=ko;function Po(e){if(Ao===setTimeout)return setTimeout(e,0);if((Ao===wo||!Ao)&&setTimeout)return Ao=setTimeout,setTimeout(e,0);try{return Ao(e,0)}catch(t){try{return Ao.call(null,e,0)}catch(t){return Ao.call(this,e,0)}}}"function"==typeof Co.setTimeout&&(Ao=setTimeout),"function"==typeof Co.clearTimeout&&(Do=clearTimeout);var No,Mo=[],Lo=!1,Oo=-1;function xo(){Lo&&No&&(Lo=!1,No.length?Mo=No.concat(Mo):Oo=-1,Mo.length&&Uo())}function Uo(){if(!Lo){var e=Po(xo);Lo=!0;for(var t=Mo.length;t;){for(No=Mo,Mo=[];++Oo<t;)No&&No[Oo].run();Oo=-1,t=Mo.length}No=null,Lo=!1,function(e){if(Do===clearTimeout)return clearTimeout(e);if((Do===ko||!Do)&&clearTimeout)return Do=clearTimeout,clearTimeout(e);try{Do(e)}catch(t){try{return Do.call(null,e)}catch(t){return Do.call(this,e)}}}(e)}}function Vo(e,t){this.fun=e,this.array=t}Vo.prototype.run=function(){this.fun.apply(null,this.array)};function Fo(){}var $o=Fo,Bo=Fo,jo=Fo,Ho=Fo,Go=Fo,Jo=Fo,zo=Fo;var Wo=Co.performance||{},qo=Wo.now||Wo.mozNow||Wo.msNow||Wo.oNow||Wo.webkitNow||function(){return(new Date).getTime()};var Ko=new Date;var Qo={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];Mo.push(new Vo(e,t)),1!==Mo.length||Lo||Po(Uo)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:$o,addListener:Bo,once:jo,off:Ho,removeListener:Go,removeAllListeners:Jo,emit:zo,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*qo.call(Wo),i=Math.floor(t),n=Math.floor(t%1*1e9);return e&&(i-=e[0],(n-=e[1])<0&&(i--,n+=1e9)),[i,n]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-Ko)/1e3}},Xo=function(e,t){So.forEach(e,(function(i,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[n])}))},Yo=function(e,t,i,n,s){return function(e,t,i,n,s){return e.config=t,i&&(e.code=i),e.request=n,e.response=s,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,i,n,s)},Zo=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],ea=So.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function n(e){var n=e;return t&&(i.setAttribute("href",n),n=i.href),i.setAttribute("href",n),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return e=n(window.location.href),function(t){var i=So.isString(t)?n(t):t;return i.protocol===e.protocol&&i.host===e.host}}():function(){return!0},ta=So.isStandardBrowserEnv()?{write:function(e,t,i,n,s,r){var o=[];o.push(e+"="+encodeURIComponent(t)),So.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),So.isString(n)&&o.push("path="+n),So.isString(s)&&o.push("domain="+s),!0===r&&o.push("secure"),document.cookie=o.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},ia=function(e){return new Promise((function(t,i){var n=e.data,s=e.headers;So.isFormData(n)&&delete s["Content-Type"];var r=new XMLHttpRequest;if(e.auth){var o=e.auth.username||"",a=e.auth.password||"";s.Authorization="Basic "+btoa(o+":"+a)}var c,d,l=(c=e.baseURL,d=e.url,c&&!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(d)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(c,d):d);if(r.open(e.method.toUpperCase(),Io(l,e.params,e.paramsSerializer),!0),r.timeout=e.timeout,r.onreadystatechange=function(){if(r&&4===r.readyState&&(0!==r.status||r.responseURL&&0===r.responseURL.indexOf("file:"))){var n,s,o,a,c,d="getAllResponseHeaders"in r?(n=r.getAllResponseHeaders(),c={},n?(So.forEach(n.split("\n"),(function(e){if(a=e.indexOf(":"),s=So.trim(e.substr(0,a)).toLowerCase(),o=So.trim(e.substr(a+1)),s){if(c[s]&&Zo.indexOf(s)>=0)return;c[s]="set-cookie"===s?(c[s]?c[s]:[]).concat([o]):c[s]?c[s]+", "+o:o}})),c):c):null,l={data:e.responseType&&"text"!==e.responseType?r.response:r.responseText,status:r.status,statusText:r.statusText,headers:d,config:e,request:r};!function(e,t,i){var n=i.config.validateStatus;!n||n(i.status)?e(i):t(Yo("Request failed with status code "+i.status,i.config,null,i.request,i))}(t,i,l),r=null}},r.onabort=function(){r&&(i(Yo("Request aborted",e,"ECONNABORTED",r)),r=null)},r.onerror=function(){i(Yo("Network Error",e,null,r)),r=null},r.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(Yo(t,e,"ECONNABORTED",r)),r=null},So.isStandardBrowserEnv()){var h=ta,u=(e.withCredentials||ea(l))&&e.xsrfCookieName?h.read(e.xsrfCookieName):void 0;u&&(s[e.xsrfHeaderName]=u)}if("setRequestHeader"in r&&So.forEach(s,(function(e,t){void 0===n&&"content-type"===t.toLowerCase()?delete s[t]:r.setRequestHeader(t,e)})),So.isUndefined(e.withCredentials)||(r.withCredentials=!!e.withCredentials),e.responseType)try{r.responseType=e.responseType}catch(p){if("json"!==e.responseType)throw p}"function"==typeof e.onDownloadProgress&&r.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&r.upload&&r.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){r&&(r.abort(),i(e),r=null)})),void 0===n&&(n=null),r.send(n)}))},na={"Content-Type":"application/x-www-form-urlencoded"};function sa(e,t){!So.isUndefined(e)&&So.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var ra={adapter:function(){var e;return("undefined"!=typeof XMLHttpRequest||void 0!==Qo&&"[object process]"===Object.prototype.toString.call(Qo))&&(e=ia),e}(),transformRequest:[function(e,t){return Xo(t,"Accept"),Xo(t,"Content-Type"),So.isFormData(e)||So.isArrayBuffer(e)||So.isBuffer(e)||So.isStream(e)||So.isFile(e)||So.isBlob(e)?e:So.isArrayBufferView(e)?e.buffer:So.isURLSearchParams(e)?(sa(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):So.isObject(e)?(sa(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};So.forEach(["delete","get","head"],(function(e){ra.headers[e]={}})),So.forEach(["post","put","patch"],(function(e){ra.headers[e]=So.merge(na)}));var oa=ra;function aa(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var ca=function(e){return aa(e),e.headers=e.headers||{},e.data=bo(e.data,e.headers,e.transformRequest),e.headers=So.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),So.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||oa.adapter)(e).then((function(t){return aa(e),t.data=bo(t.data,t.headers,e.transformResponse),t}),(function(t){return Ro(t)||(aa(e),t&&t.response&&(t.response.data=bo(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},da=function(e,t){t=t||{};var i={},n=["url","method","params","data"],s=["headers","auth","proxy"],r=["baseURL","url","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"];So.forEach(n,(function(e){void 0!==t[e]&&(i[e]=t[e])})),So.forEach(s,(function(n){So.isObject(t[n])?i[n]=So.deepMerge(e[n],t[n]):void 0!==t[n]?i[n]=t[n]:So.isObject(e[n])?i[n]=So.deepMerge(e[n]):void 0!==e[n]&&(i[n]=e[n])})),So.forEach(r,(function(n){void 0!==t[n]?i[n]=t[n]:void 0!==e[n]&&(i[n]=e[n])}));var o=n.concat(s).concat(r),a=Object.keys(t).filter((function(e){return-1===o.indexOf(e)}));return So.forEach(a,(function(n){void 0!==t[n]?i[n]=t[n]:void 0!==e[n]&&(i[n]=e[n])})),i};function la(e){this.defaults=e,this.interceptors={request:new Eo,response:new Eo}}la.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=da(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[ca,void 0],i=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)i=i.then(t.shift(),t.shift());return i},la.prototype.getUri=function(e){return e=da(this.defaults,e),Io(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},So.forEach(["delete","get","head","options"],(function(e){la.prototype[e]=function(t,i){return this.request(So.merge(i||{},{method:e,url:t}))}})),So.forEach(["post","put","patch"],(function(e){la.prototype[e]=function(t,i,n){return this.request(So.merge(n||{},{method:e,url:t,data:i}))}}));var ha=la;function ua(e){this.message=e}ua.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},ua.prototype.__CANCEL__=!0;var pa=ua;function _a(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var i=this;e((function(e){i.reason||(i.reason=new pa(e),t(i.reason))}))}_a.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},_a.source=function(){var e;return{token:new _a((function(t){e=t})),cancel:e}};var ma=_a;function ga(e){var t=new ha(e),i=uo(ha.prototype.request,t);return So.extend(i,ha.prototype,t),So.extend(i,t),i}var fa=ga(oa);fa.Axios=ha,fa.create=function(e){return ga(da(fa.defaults,e))},fa.Cancel=pa,fa.CancelToken=ma,fa.isCancel=Ro,fa.all=function(e){return Promise.all(e)},fa.spread=function(e){return function(t){return e.apply(null,t)}};var va=fa,Sa=fa;va.default=Sa;var ya=va,Ia=R((function(e){var t=Object.prototype.hasOwnProperty,i="~";function n(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function r(e,t,n,r,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new s(n,r||e,o),c=i?i+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,n,s=[];if(0===this._eventsCount)return s;for(n in e=this._events)t.call(e,n)&&s.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,r=n.length,o=new Array(r);s<r;s++)o[s]=n[s].fn;return o},a.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,s,r,o){var a=i?i+e:e;if(!this._events[a])return!1;var c,d,l=this._events[a],h=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),h){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,n),!0;case 4:return l.fn.call(l.context,t,n,s),!0;case 5:return l.fn.call(l.context,t,n,s,r),!0;case 6:return l.fn.call(l.context,t,n,s,r,o),!0}for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var u,p=l.length;for(d=0;d<p;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),h){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,n);break;case 4:l[d].fn.call(l[d].context,t,n,s);break;default:if(!c)for(u=1,c=new Array(h-1);u<h;u++)c[u-1]=arguments[u];l[d].fn.apply(l[d].context,c)}}return!0},a.prototype.on=function(e,t,i){return r(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return r(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,n,s){var r=i?i+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var a=this._events[r];if(a.fn)a.fn!==t||s&&!a.once||n&&a.context!==n||o(this,r);else{for(var c=0,d=[],l=a.length;c<l;c++)(a[c].fn!==t||s&&!a[c].once||n&&a[c].context!==n)&&d.push(a[c]);d.length?this._events[r]=1===d.length?d[0]:d:o(this,r)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a}));const Ta=new Ia,Ea=1,ba=2,Ra=3,Ca=4,wa=5,ka=20,Aa=21,Da=22,Pa=23,Na=24,Ma=27,La=28,Oa=29,xa=30,Ua=33,Va=31,Fa=32,$a=100,Ba=101,ja=102,Ha=103,Ga=110,Ja=111,za=112,Wa=113,qa=114,Ka=115,Qa=116,Xa=120,Ya=121,Za=122,ec=123,tc=130,ic=131,nc=132,sc=133,rc=134,oc=135,ac=136,cc=137,dc=200,lc=201,hc=300,uc=301,pc=302,_c=303;function mc({retryFunction:e,settings:t,onError:i,onRetrying:n,context:s}){return function(...r){const o=t.retries||5;let a=0,c=-1,d=0;const l=async(h,u)=>{try{const t=s||this,i=await e.apply(t,r);a=0,h(i)}catch(p){const e=()=>{clearTimeout(c),a=0,d=2,u(p)},s=()=>{2!==d&&a<o?(a++,d=1,Wr(n)&&n(a,e),c=setTimeout(()=>{c=-1,l(h,u)},qr(t.timeout)?1e3:t.timeout)):e()};Wr(i)?i(p,s,u):s()}};return new Promise(l)}}class gc{constructor(e){this.log=e.log,this.level=e.level,this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.forAllJoinedClients=e.forAllJoinedClients,this.uploaded=!1}}class fc{constructor(e){this.id_=e.id,this.userId_=e.userId,this.sdkAppId_=e.sdkAppId,this.type_=e.type,this.isLocal_=!Xr(e.isLocal)||e.isLocal}setUserId(e){this.userId_=e}setSdkAppId(e){this.sdkAppId_=e}log(e,t){vc.log({log:`[${this.isLocal_?"":"*"}${this.id_}] ${this.type_?this.type_+" ":""}${t}`,level:e,forAllJoinedClients:qr(this.userId_),userId:this.userId_,sdkAppId:this.sdkAppId_})}info(e){this.log(Mn.INFO,e)}debug(e){this.log(Mn.DEBUG,e)}warn(e){this.log(Mn.WARN,e)}error(e){this.log(Mn.ERROR,e)}}var vc=new class{constructor(){this.clients_=new Set,this.queue_=[],this.timeoutId_=-1,this.logLevel_=Mn.DEBUG,this.logLevelToUpload_=Mn.INFO,this.enableUploadLog_=!0,this.isAbleToUpload_=!1,this.startUpload(),this.checkURLParam(),Ta.on(xa,({client:e})=>this.clients_.add(e)),Ta.on(Ua,({client:e})=>this.clients_.delete(e)),Ta.on(Va,e=>{e&&Gr(e.config)&&Ln[e.config.logLevelToUpload]&&(this.logLevelToUpload_=e.config.logLevelToUpload)}),Ta.on(Ca,this.setIsAbleToUpload,this),Ta.on(wa,this.setIsAbleToUpload,this)}getIsAbleToUpload(){return this.isAbleToUpload_}setIsAbleToUpload(){this.isAbleToUpload_=!0,Ta.off(Ca,this.setIsAbleToUpload,this),Ta.off(wa,this.setIsAbleToUpload,this)}async startUpload(){try{await this.upload()}catch(e){}this.timeoutId_=setTimeout(()=>this.startUpload(),2e3)}stopUpload(){-1!==this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=-1)}getLogsToUpload(){const e={map:new Map,splicedQueue:[]};if(this.queue_[0].forAllJoinedClients&&0===this.clients_.size)return e;let t=0;for(;t<this.queue_.length&&50!==t;t++){const i=this.queue_[t];if(i.forAllJoinedClients)this.clients_.forEach(t=>{if(!t.getIsJoined())return;const n=t.getUserId(),s=t.getSDKAppId();if(e.map.has(n)){const{logs:t}=e.map.get(n);t.push(i)}else e.map.set(n,{userId:n,sdkAppId:s,logs:[i]})});else if(e.map.has(i.userId)){const{logs:t}=e.map.get(i.userId);t.push(i)}else e.map.set(i.userId,{userId:i.userId,sdkAppId:i.sdkAppId,logs:[i]})}return e.map.size>0&&(e.splicedQueue=this.queue_.splice(0,t)),e}async upload(){if(0===this.queue_.length||!this.isAbleToUpload_)return;const{map:e,splicedQueue:t}=this.getLogsToUpload();if(0===e.size)return;try{const t=[...e.values()];for(let e=0;e<t.length;e++){const{userId:i,sdkAppId:n,logs:s}=t[e];await this.uploadLogWithRetry(JSON.stringify({timestamp:ge(),sdkAppId:String(n),userId:i,version:"4.14.0",log:s.map(e=>e.log).join("\n")}),n),s.forEach(e=>e.uploaded=!0)}}catch(n){}const i=t.filter(e=>!e.uploaded);i.length>0&&(this.queue_=i.concat(this.queue_))}uploadLogWithRetry(e,t){return mc({retryFunction:()=>ya.post(jr(t,ri),e,{timeout:5e3}),settings:{retries:3,timeout:1e3},onError:(e,t)=>{t()}})()}getPrefix(e){const t=new Date;return t.setTime(me()),`[${t.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")}:${t.getMilliseconds()}] <${Ln[e]}>`}getLogLevel(){return this.logLevel_}setLogLevel(e){qr(Ln[e])||(this.logLevel_!==e&&this.info("setLogLevel "+e),this.logLevel_=e)}enableUploadLog(){this.enableUploadLog_=!0}disableUploadLog(){this.enableUploadLog_=!1}log({log:e,level:t,forAllJoinedClients:i=!0,userId:n,sdkAppId:s}){if(e=`${this.getPrefix(t)} ${e}`,this.enableUploadLog_&&t>=this.logLevelToUpload_&&this.queue_.push(new gc({log:e,level:t,userId:n,sdkAppId:s,forAllJoinedClients:i})),t<this.logLevel_)return;let r=Ln[t]?Ln[t].toLowerCase():"info";console[r]("%cTRTC:%c%s","padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;","display: inline",e)}debug(e){this.log({log:e,level:Mn.DEBUG})}info(e){this.log({log:e,level:Mn.INFO})}warn(e){this.log({log:e,level:Mn.WARN})}error(e){this.log({log:e,level:Mn.ERROR})}createLogger(e){return new fc(e)}checkURLParam(){const e=new URLSearchParams(location.search).get("logLevelToUpload");Ln[e]&&(this.logLevelToUpload_=e)}};let Sc=!0;const yc=1,Ic=5,Tc=2,Ec=3,bc=4,Rc="DISCONNECTED",Cc="CONNECTING",wc="RECONNECTING",kc="CONNECTED",Ac={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772},Dc=[Ac.UPDATE_REMOTE_MUTE_STAT,Ac.UPLINK_NETWORK_STATS,Ac.USER_LIST_RES,Ac.MUTE_RESULT],Pc={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res"},Nc="publish_change",Mc="join",Lc="leave",Oc="quality_report",xc="mute_uplink",Uc="publish",Vc="unpublish",Fc="subscribe",$c="unsubscribe",Bc="subscribe_change",jc="start_publishing",Hc="stop_publishing",Gc="start_push_user_cdn",Jc="stop_push_user_cdn",zc="start_mcu_mix",Wc="stop_mcu_mix",qc="get_user_list",Kc="change_role",Qc="update_constraint_config",Xc={INVALID_PARAMETER:4096,INVALID_OPERATION:4097,NOT_SUPPORTED:4098,DEVICE_NOT_FOUND:4099,INITIALIZE_FAILED:4100,SIGNAL_CHANNEL_SETUP_FAILED:16385,SIGNAL_CHANNEL_ERROR:16386,ICE_TRANSPORT_ERROR:16387,JOIN_ROOM_FAILED:16388,CREATE_OFFER_FAILED:16389,SIGNAL_CHANNEL_RECONNECTION_FAILED:16390,UPLINK_RECONNECTION_FAILED:16391,DOWNLINK_RECONNECTION_FAILED:16392,REMOTE_STREAM_NOT_EXIST:16400,CLIENT_BANNED:16448,SERVER_TIMEOUT:16449,SUBSCRIPTION_TIMEOUT:16450,PLAY_NOT_ALLOWED:16451,DEVICE_AUTO_RECOVER_FAILED:16452,START_PUBLISH_CDN_FAILED:16453,STOP_PUBLISH_CDN_FAILED:16454,START_MIX_TRANSCODE_FAILED:16455,STOP_MIX_TRANSCODE_FAILED:16456,NOT_SUPPORTED_H264:16457,SWITCH_ROLE_FAILED:16458,API_CALL_TIMEOUT:16459,SCHEDULE_FAILED:16460,UNKNOWN:65535};class Yc extends Error{constructor({name:e="RtcError",message:t,code:i=Xc.UNKNOWN,extraCode:n=0,constraint:s}){const r=`<${function(e){for(let t in Xc)if(Xc[t]===e)return t;return"UNKNOWN"}(i)} 0x${i.toString(16)}>`;super(t+""+(s?" constraint: "+s:"")+(t.includes(r)?"":" "+r)),this.code_=i,this.extraCode_=n,this.name=e,this.message_=t,s&&(this.constraint=s)}getCode(){return this.code_}getExtraCode(){return this.extraCode_}}const Zc=32768,ed=32769,td=32770,id=32771,nd=32772,sd=32773,rd=32774,od=32775,ad=32777,cd=32778,dd=32779,ld=32780,hd=32781,ud=32782,pd=32783,_d=32784,md=32785,gd=32786,fd=32787,vd=32788,Sd=32789,yd=32790,Id=32791,Td=32792,Ed=32793,bd=32794,Rd=32795,Cd=32796,wd=32797,kd=32798,Ad=32799,Dd=32800,Pd=32801,Nd=32802,Md=32803,Ld=32804,Od=new Map,xd=function(e,t){let i=Od.get(e);i||(Od.set(e,[]),i=Od.get(e)),i.push(t)};var Ud=Object.prototype.hasOwnProperty;function Vd(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(Gr(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(var t in e)if(Ud.call(e,t))return!1;return!0}return!1}var Fd=new class{constructor(){const{name:e,version:t}=wt();this.roomIdMap_=new Map,this.configs_={sdkAppId:"",userId:"",version:"4.14.0",env:ti,browserVersion:e+t,ua:navigator.userAgent}}setConfig({sdkAppId:e,env:t,userId:i,roomId:n}){e!==this.configs_.sdkAppId&&(this.configs_.sdkAppId=String(e)),this.configs_.env=t,this.configs_.userId=i,this.roomIdMap_.set(i,String(n))}logEvent(e){if(bt)return;const t={...e,...this.configs_,userId:e.userId||this.configs_.userId};qr(t.code)&&(t.code="failed"===t.result?Xc.UNKNOWN:0),this.sendRequest(jr(this.configs_.sdkAppId,oi),t)}logSuccessEvent(e){bt||(this.logEvent({...e,result:"success",roomId:this.roomIdMap_.get(e.userId)}),this.configs_.env===ti&&this.uploadEventToKibana({...e,result:"success"}))}logFailedEvent(e){if(bt)return;const{eventType:t,code:i,error:n,userId:s}=e,r={roomId:this.roomIdMap_.get(s),userId:s,eventType:t,result:"failed",code:i||(n instanceof Yc?n.getExtraCode()||n.getCode():Xc.UNKNOWN)};this.logEvent(r),this.configs_.env===ti&&this.uploadEventToKibana({...r,error:n})}uploadEventToKibana(e){let t=`stat-${e.eventType}-${e.result}`;"delta-join"!==e.eventType&&"delta-leave"!==e.eventType&&"delta-publish"!==e.eventType||(t=`${e.eventType}:${e.delta}`),this.uploadEvent({log:t,userId:e.userId}),"failed"===e.result&&(t=`stat-${e.eventType}-${e.result}-${e.code}`,this.uploadEvent({log:t,userId:e.userId,error:e.error}))}uploadEvent({log:e,userId:t,error:i}){const n={timestamp:ge(),sdkAppId:this.configs_.sdkAppId,userId:t||this.configs_.userId,version:this.configs_.version,log:e};i&&(n.errorInfo=i.message),this.sendRequest(jr(this.configs_.sdkAppId,ri),n)}sendRequest(e,t){vc.getIsAbleToUpload()?ya.post(e,JSON.stringify(t)).catch(()=>{}):setTimeout(()=>{this.sendRequest(e,t)},1e3)}};class $d{constructor(e){this.client_=e.client,this.sdkAppId_=e.sdkAppId,this.userId_=e.userId,this.userSig_=e.userSig,this.url_=e.url,this.backupUrl_=e.backupUrl;const t=`?sdkAppId=${encodeURIComponent(this.sdkAppId_)}&userId=${encodeURIComponent(this.userId_)}&userSig=${encodeURIComponent(this.userSig_)}`;this.urlWithParam_=`${this.url_}${t}`,this.backupUrlWithParam_=`${this.backupUrl_}${t}`,this.isConnected_=!1,this.isConnecting_=!1,this.socketInUse_=null,this.socket_=null,this.backupSocket_=null,this.backupTimer_=-1,this.signalInfo_={},this.currentState_=Rc,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.seq_=0,this.log_=vc.createLogger({id:"ws|"+this.userId_,userId:this.userId_,sdkAppId:this.sdkAppId_}),this.emitter_=new Ia}connect(){return new Promise((e,t)=>{this.log_.info("connect to url: "+this.urlWithParam_),this.emitConnectionStateChanged(Cc),this.socket_=new WebSocket(this.urlWithParam_),this.bindSocket(this.socket_),this.backupTimer_=setTimeout(()=>{this.isConnected_||(this.log_.info("trying to connect to backupUrl"),this.tryConnectBackup())},5e3),this.once(Ec,e),this.once(bc,t)})}tryConnectBackup(){this.backupSocket_||(this.unbindAndCloseSocket(zt),this.log_.debug("try to connect to url: "+this.backupUrlWithParam_),this.backupSocket_=new WebSocket(this.backupUrlWithParam_),this.bindSocket(this.backupSocket_))}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}unbindSocket(e){e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{}}unbindAndCloseSocket(e){if(e===zt){if(this.socket_){this.unbindSocket(this.socket_);try{this.socket_.close(1e3)}catch(t){}this.socket_=null}}else if(this.backupSocket_){this.unbindSocket(this.backupSocket_);try{this.backupSocket_.close(1e3)}catch(t){}this.backupSocket_=null}}clearBackupTimer(){-1!==this.backupTimer_&&(clearTimeout(this.backupTimer_),this.backupTimer_=-1)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}onopen(e){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1,this.clearBackupTimer(),e.target===this.socket_?(this.unbindAndCloseSocket(Wt),this.socketInUse_=this.socket_):(this.unbindAndCloseSocket(zt),this.socketInUse_=this.backupSocket_);const t=e.target.url;this.log_.info(`websocket[${t}] is connected`),this.currentState_===Cc?this.addSignalEvent(Id,"signal channel is connected"):this.currentState_===wc&&this.addSignalEvent(Rd,"signal channel reconnect success"),this.emitConnectionStateChanged(kc),this.emitter_.emit(Ec)}onclose(e){const t=e.target.url,i=e.target===this.socketInUse_;this.log_.info(`websocket[${t} InUse: ${i}] is closed with code: ${e.code}`),e.target===this.socketInUse_&&(this.isConnected_=!1,this.emitConnectionStateChanged(Rc),this.addSignalEvent(yd,"signal channel is disconnected"),e.wasClean&&1e3===e.code||(this.log_.warn(`onclose code:${e.code} reason:${e.reason}`),this.log_.warn("close current websocket and schedule a reconnect timeout"),this.socketInUse_.onclose=()=>{},this.socketInUse_.close(4011),this.socket_=this.backupSocket_=this.socketInUse_=null,this.reconnect(zt)))}onerror(e){const t=e.target.url;this.log_.error(`websocket[${t}] error observed`),this.isConnected_?e.target===this.socketInUse_&&(this.isConnected_=!1,this.unbindAndCloseSocket(zt),this.unbindAndCloseSocket(Wt),this.socketInUse_=null,this.reconnect(zt)):(this.isReconnecting_||Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Wi,code:Xc.UNKNOWN}),e.target==this.socket_?(this.unbindAndCloseSocket(zt),this.reconnect(Wt)):(this.unbindAndCloseSocket(Wt),this.reconnect(zt))),this.isConnecting_=!1,this.isConnected_=!1}onmessage(e){if(!this.isConnected_)return;const t=JSON.parse(e.data),{cmd:i,data:n}=t,s=Object.values(Ac),r=Object.keys(Ac)[s.indexOf(i)],o=Pc[r];if(!Dc.includes(i)){const t=e.target==this.socket_?this.url_:this.backupUrl_;this.log_.debug(`websocket[${t}] received message: ${e.data}`),this.log_.info(`Received event: [ ${o||"unknown cmd: "+i} ]`)}switch(i){case Ac.CHANNEL_SETUP_RESULT:if(0===t.code)this.signalInfo_.clientIp=n.clientIp,this.signalInfo_.signalIp=n.signalInnerIp,this.signalInfo_.tinyId=t.tinyId,n.svrTime&&function(e){pe=e,_e=pe-(new Date).getTime();const t=new Date;t.setTime(e),vc.info("baseTime from server: "+t+" offset: "+_e)}(n.svrTime),this.log_.info("ChannelSetup Success"),Fd.logSuccessEvent({userId:this.userId_,eventType:Wi}),this.emitter_.emit(yc,{signalInfo:this.signalInfo_});else{const e=new Yc({code:Xc.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:t.code,message:Fr({key:Gn,data:{errorCode:t.code,errorMsg:t.message}})});this.log_.error(`${t.code}, ${t.message}`),this.close(),Fd.logFailedEvent({userId:this.userId_,eventType:Wi,error:e}),this.emitter_.emit(Ic,e)}break;case Ac.JOIN_ROOM_RESULT:0===t.code&&(this.signalInfo_.relayIp=n.relayOuterIp,this.signalInfo_.relayInnerIp=n.relayInnerIp,this.signalInfo_.relayPort=n.relayPort,this.log_.info(`signalIp:${this.signalInfo_.signalIp} clientIp:${this.signalInfo_.clientIp} relayIp: ${this.signalInfo_.relayIp}`)),this.emitter_.emit(o,{data:t});break;case Ac.CHANNEL_RECONNECT_RESULT:0===t.code?(this.log_.warn("reconnect success"),this.stopReconnection(),Fd.logSuccessEvent({userId:this.userId_,eventType:qi}),this.client_.syncUserList(),this.client_.checkConnectionsToReconnect()):(this.log_.warn(`reconnect failed, ${t.code} ${t.message}`),this.client_.reJoin());break;default:this.emitter_.emit(o,{data:t})}}addSignalEvent(e,t){xd(this.userId_,{eventId:e,eventDesc:t,timestamp:me(),userId:this.userId_,tinyId:this.signalInfo_.tinyId})}reconnect(e=zt){if(this.isConnecting_||-1!==this.reconnectionTimer_)return void this.log_.info("signal channel is reconnecting, ignoring current reconnection");if(this.reconnectionCount_>=30){this.log_.warn("SDK has tried reconnect signal channel for 30 times, but all failed. please check your network");const e=new Yc({code:Xc.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:Fr({key:Hn})});return Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:qi,error:e}),this.addSignalEvent(Cd,"signal channel reconnect fail"),void this.emitter_.emit(bc,e)}this.isConnecting_=!0,this.reconnectionCount_++,this.currentState_!==wc&&(this.emitConnectionStateChanged(wc),this.addSignalEvent(bd,"signal channel is reconnecting")),this.log_.warn(`reconnecting to ${e} signal channel [${this.reconnectionCount_}/30]`);const t=this.getReconnectionUrl(e);e===zt?(this.socket_=new WebSocket(t),this.bindSocket(this.socket_)):(this.backupSocket_=new WebSocket(t),this.bindSocket(this.backupSocket_));const i=zr(this.reconnectionCount_);this.reconnectionTimer_=setTimeout(()=>{this.log_.warn(`reconnect ${e} signal channel timeout(${i/1e3}s), close and try again`),this.isConnecting_=!1,this.clearReconnectionTimer(),this.unbindAndCloseSocket(e),this.reconnect(e===zt?Wt:zt)},i)}isConnected(){return this.isConnected_}get isReconnecting_(){return-1!==this.reconnectionTimer_}getReconnectionUrl(e){let t=e===zt?this.urlWithParam_:this.backupUrlWithParam_;if(!Vd(this.signalInfo_)&&-1===t.indexOf("&rc=1")){const e=this.client_.getRoomId(),i=this.client_.getUseStringRoomId();t+=`&rc=1&relayInnerIp=${this.signalInfo_.relayInnerIp}&relayOuterIp=${this.signalInfo_.relayIp}&relayPort=${this.signalInfo_.relayPort}&roomId=${e}&useStringRoomId=${i}`}return t}send(e,t={}){if(this.isConnected_){const i={cmd:e,data:t,userId:this.userId_,tinyId:this.signalInfo_.tinyId,seq:++this.seq_};return this.socketInUse_.send(JSON.stringify(i)),i.seq}}sendWaitForResponse({command:e,data:t,timeout:i=5e3,responseCommand:n,commandDesc:s,enableLog:r=!0}){return new Promise((o,a)=>{const c=setTimeout(()=>{this.off(n,d);const t=new Yc({code:Xc.API_CALL_TIMEOUT,message:Fr({key:jn,data:{commandDesc:s,command:e}})});r&&this.log_.warn(t),a(t)},i),d=e=>{e.data.seq===l&&(clearTimeout(c),this.off(n,d),o(e))};this.on(n,d);const l=this.send(e,t)})}sendWaitForResponseWithRetry(...e){const{commandDesc:t,retries:i=0,retryTimeout:n=0}=e[0];return mc({retryFunction:this.sendWaitForResponse,onRetrying:e=>{this.log_.warn(`${t} timeout observed, retrying [${e}/${i}]`)},settings:{retries:i,timeout:n},context:this})(...e)}getCurrentState(){return this.currentState_}getSignalInfo(){return this.signalInfo_}stopReconnection(){this.isReconnecting_&&(this.reconnectionCount_=0,this.clearReconnectionTimer())}close(){this.log_.info("close SignalChannel"),this.clearBackupTimer(),this.stopReconnection(),this.isConnecting_=!1,this.isConnected_=!1,this.socketInUse_=null,this.unbindAndCloseSocket(zt),this.unbindAndCloseSocket(Wt),this.emitConnectionStateChanged(Rc)}on(e,t,i){this.emitter_.on(e,t,i)}removeListener(e,t,i){this.emitter_.removeListener(e,t,i)}once(e,t,i){this.emitter_.once(e,t,i)}off(e,t,i){this.emitter_.off(e,t,i)}emitConnectionStateChanged(e){e!==this.currentState_&&(this.emitter_.emit(Tc,{prevState:this.currentState_,state:e}),this.currentState_=e)}}var Bd=R((function(e){var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))})),jd=(Bd.v,Bd.o,Bd.s,Bd.i,Bd.u,Bd.e,Bd.p,Bd.z,Bd.r,Bd.t,Bd.c,Bd.b,Bd.m,Bd.a,R((function(e,t){var i=function(e){return String(Number(e))===e?Number(e):e},n=function(e,t,n){var s=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:s&&!t[e.name]&&(t[e.name]={});var r=e.push?{}:s?t[e.name]:t;!function(e,t,n,s){if(s&&!n)t[s]=i(e[1]);else for(var r=0;r<n.length;r+=1)null!=e[r+1]&&(t[n[r]]=i(e[r+1]))}(n.match(e.reg),r,e.names,e.name),e.push&&t[e.push].push(r)},s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach((function(e){var t=e[0],s=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),r=i[i.length-1]);for(var o=0;o<(Bd[t]||[]).length;o+=1){var a=Bd[t][o];if(a.reg.test(s))return n(a,r,s)}})),t.media=i,t};var r=function(e,t){var n=t.split(/=(.+)/,2);return 2===n.length?e[n[0]]=i(n[1]):1===n.length&&t.length>1&&(e[n[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(r,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],n=e.split(" ").map(i),s=0;s<n.length;s+=3)t.push({component:n[s],ip:n[s+1],port:n[s+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(r,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,n=!1;return"~"!==e[0]?t=i(e):(t=i(e.substring(1,e.length)),n=!0),{scid:t,paused:n}}))}))}}))),Hd=(jd.parse,jd.parseParams,jd.parseFmtpConfig,jd.parsePayloads,jd.parseRemoteCandidates,jd.parseImageAttributes,jd.parseSimulcastStreamList,/%[sdv%]/g),Gd=function(e){var t=1,i=arguments,n=i.length;return e.replace(Hd,(function(e){if(t>=n)return e;var s=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}}))},Jd=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var r=t.names[s];t.name?n.push(i[t.name][r]):n.push(i[t.names[s]])}else n.push(i[t.name]);return Gd.apply(null,n)},zd=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Wd=["i","c","b","a"],qd={write:function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||zd,n=t.innerOrder||Wd,s=[];return i.forEach((function(t){Bd[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(Jd(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(Jd(t,i,e))}))}))})),e.media.forEach((function(e){s.push(Jd("m",Bd.m[0],e)),n.forEach((function(t){Bd[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(Jd(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(Jd(t,i,e))}))}))}))})),s.join("\r\n")+"\r\n"},parse:jd.parse,parseParams:jd.parseParams,parseFmtpConfig:jd.parseFmtpConfig,parsePayloads:jd.parsePayloads,parseRemoteCandidates:jd.parseRemoteCandidates,parseImageAttributes:jd.parseImageAttributes,parseSimulcastStreamList:jd.parseSimulcastStreamList};const Kd=function(e){return qd.parse(e)},Qd=function(e){return qd.write(e)};const Xd=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))};const Yd=new class{constructor(){this.intervalMap_=new Map}setInterval(e,t,i=!0){if(!window||!window.requestAnimationFrame)return setInterval(e,t);const n=Xd();let s=io(),r=s;this.intervalMap_.set(n,{rafId:null,timeoutId:null,onVisibilityChange:null});const o=()=>{if(i&&document.hidden){if(e(),!this.intervalMap_.has(n))return;const i=setTimeout(o,t);this.setTimeoutId(n,i),s=io(),r=s}else{if(r=io(),r-s>=t&&(s=r,e(),!this.intervalMap_.has(n)))return;const i=requestAnimationFrame(o);this.setRafId(n,i)}},a=requestAnimationFrame(o);if(this.setRafId(n,a),i){const e=()=>{if(document.hidden){const e=io()-s;if(e>=t)o();else{const i=setTimeout(o,t-e);this.setTimeoutId(n,i)}}};document.addEventListener("visibilitychange",e),this.setOnVisibilityChange(n,e),document.hidden&&e()}return n}clearInterval(e){if(this.intervalMap_.has(e)){const{rafId:t,timeoutId:i,onVisibilityChange:n}=this.intervalMap_.get(e);cancelAnimationFrame(t),clearTimeout(i),document.removeEventListener("visibilitychange",n),this.intervalMap_.delete(e)}}setTimeoutId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=t}}setRafId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.rafId&&cancelAnimationFrame(i.rafId),i.rafId=t}}setOnVisibilityChange(e,t){if(this.intervalMap_.has(e)){this.intervalMap_.get(e).onVisibilityChange=t}}};var Zd=new class{constructor(){this.prefix_="TRTC",this.queue_=new Map,this.intervalId_=Yd.setInterval(this.doFlush.bind(this),2e4),this.checkStorage()}getRealKey(e){return`${this.prefix_}_${e}`}checkStorage(){if(!Rt())return;Object.keys(localStorage).filter(e=>{if(e.startsWith(this.prefix_)){const t=JSON.parse(localStorage.getItem(e));if(t&&t.expiresIn<Date.now())return!0}return!1}).forEach(e=>localStorage.removeItem(e))}doFlush(){if(Rt())try{for(const[e,t]of this.queue_)localStorage.setItem(e,JSON.stringify(t))}catch(e){vc.warn(e)}}getItem(e){if(!Rt())return null;try{const t=JSON.parse(localStorage.getItem(this.getRealKey(e)));return t&&t.expiresIn>=Date.now()?t.value:null}catch(t){vc.warn(t)}}setItem(e,t){if(Rt())try{const i={expiresIn:Date.now()+6048e5,value:t};this.queue_.set(this.getRealKey(e),i)}catch(i){vc.warn(i)}}deleteItem(e){if(!Rt())return!1;try{return e=this.getRealKey(e),this.queue_.delete(e),localStorage.removeItem(e),!0}catch(t){return vc.warn(t),!1}}clear(){if(Rt())try{localStorage.clear()}catch(e){vc.warn(e)}}};let el={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isMediaDevicesSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}};const tl=function(){return!et&&!ke&&(!(De&&Pe<80)&&!(Ce&&we<56))},il=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter(e=>e in window).length>0};const nl=async function(){if(el.detail.isH264DecodeSupported||el.detail.isVp8DecodeSupported)return{isH264DecodeSupported:el.detail.isH264DecodeSupported,isVp8DecodeSupported:el.detail.isVp8DecodeSupported};let e="",t=!1,i=!1;try{const n=new RTCPeerConnection;return e=await n.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),n.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:i}}catch(n){return{isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}},sl=((e,t)=>{let i=null;return function(...n){return i||(i=e.apply(t||this,n),i.then(e=>(i=null,e)).catch(e=>{throw i=null,e}),i)}})((async function(){if(el.result)return el;const e=tl(),t=il(),i=function(){if(!navigator.mediaDevices)return!1;const e=["getUserMedia","enumerateDevices"];return e.filter(e=>e in navigator.mediaDevices).length===e.length}();let{isH264EncodeSupported:n,isVp8EncodeSupported:s}=await async function(){if(el.detail.isH264EncodeSupported||el.detail.isVp8EncodeSupported)return{isH264EncodeSupported:el.detail.isH264EncodeSupported,isVp8EncodeSupported:el.detail.isVp8EncodeSupported};let e="",t=!1,i=!1;try{const n=new RTCPeerConnection,s=document.createElement("canvas");s.getContext("2d");const r=s.captureStream(0);return n.addTrack(r.getVideoTracks()[0],r),e=await n.createOffer(),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),n.close(),el.detail.isH264EncodeSupported=t,el.detail.isVp8EncodeSupported=i,{isH264EncodeSupported:el.detail.isH264EncodeSupported,isVp8EncodeSupported:el.detail.isVp8EncodeSupported}}catch(n){return{isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}}(),{isH264DecodeSupported:r,isVp8DecodeSupported:o}=await nl();if(n&&r&&(ct||lt||St)&&!xe&&ut()<79){const{encode:e,decode:t}=await async function(){return new Promise(async e=>{const t={encode:!1,decode:!1};let i=null;try{const n=document.createElement("canvas"),s=n.getContext("2d");n.width=640,n.height=480;const r=setInterval(()=>{s.fillText("test",Math.floor(640*Math.random()),Math.floor(480*Math.random()))},33);let o=-1,a=-1;i=()=>{clearInterval(o),clearInterval(r),clearTimeout(a),d.close(),l.close(),c.getTracks().forEach(e=>e.stop())},a=setTimeout(()=>{i(),e(t)},3e3);const c=n.captureStream(),d=new RTCPeerConnection({}),l=new RTCPeerConnection({offerToReceiveAudio:!0,offerToReceiveVideo:!0});d.addEventListener("icecandidate",e=>l.addIceCandidate(e.candidate)),l.addEventListener("icecandidate",e=>d.addIceCandidate(e.candidate)),d.addTrack(c.getVideoTracks()[0],c);const h=await d.createOffer();await d.setLocalDescription(h),await l.setRemoteDescription(h);const u=await l.createAnswer(),p=Kd(u.sdp),_=p.media[0].rtp.findIndex(e=>"H264"===e.codec);p.media[0].rtp=[p.media[0].rtp[_]],p.media[0].fmtp=p.media[0].fmtp.filter(e=>e.payload===p.media[0].rtp[0].payload),p.media[0].rtcpFb=p.media[0].rtcpFb.filter(e=>e.payload===p.media[0].rtp[0].payload),u.sdp=Qd(p),await l.setLocalDescription(u),await d.setRemoteDescription(u),o=setInterval(async()=>{t.encode&&t.decode&&(i(),e(t));const n=await d.getStats(),s=await l.getStats();t.encode||n.forEach(e=>{"outbound-rtp"===e.type&&e.mediaType===Dt&&e.framesEncoded>0&&(t.encode=!0)}),t.decode||s.forEach(e=>{"inbound-rtp"===e.type&&e.mediaType===Dt&&e.framesDecoded>0&&(t.decode=!0)})},500)}catch(n){i(),vc.warn(n),e(t)}})}();n=e,r=t}return el.result=e&&t&&i&&(n||s)&&(r||o),el.detail.isBrowserSupported=e,el.detail.isWebRTCSupported=t,el.detail.isMediaDevicesSupported=i,el.detail.isH264EncodeSupported=n,el.detail.isVp8EncodeSupported=s,el.detail.isH264DecodeSupported=r,el.detail.isVp8DecodeSupported=o,Object.keys(el.detail).findIndex(e=>!el.detail[e])>=0&&(vc.warn(Fr({key:gr})),vc.info(`${navigator.userAgent} ${JSON.stringify(el.detail)}`)),Zd.setItem("checkResult",{ua:navigator.userAgent,checkResult:el}),el}));const rl=function(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)},ol=function(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype},al=function(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype},cl=function(){return"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype},dl=function(){return"RTCRtpTransceiver"in window&&"stop"in window.RTCRtpTransceiver.prototype},ll=()=>"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype,hl=function(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&al()},ul=function(){return!!qr(navigator.mediaDevices)&&(vc.error(xr.NOT_SUPPORTED_MEDIA),!0)},pl=function(){return"http:"===location.protocol&&!bt&&(vc.warn(Fr({key:mr})),!0)},_l="RTCRtpSender"in window&&"createEncodedStreams"in window.RTCRtpSender.prototype&&ut()>=86,ml=function(e){return!("candidate-pair"!==e.type||!e.nominated||"in-progress"!==e.state&&"succeeded"!==e.state)&&!(Xr(e.selected)&&!e.selected)};let gl=new Map([[be,"Android"],[Ee,"iOS"],[Xe,"Windows"],[Ye,"MacOS"],[Ze,"Linux"]]);const fl=function(){let e="unknown";return gl.get(!0)&&(e=gl.get(!0)),e};function vl(){let e="";if(screen.width){e+=(screen.width?screen.width*window.devicePixelRatio:"")+" * "+(screen.height?screen.height*window.devicePixelRatio:"")}return e}function Sl(){let e=!1;return(navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(e=!0),e}function yl(){let e={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let i=0;i<t.length;i++)if(t[i]in window){e.isSupported=!0;break}return e.isSupported}function Il(){return!$e&&!Ee&&!(!tl()||!("captureStream"in HTMLCanvasElement.prototype))}const Tl=()=>{const e={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return qr(window.AudioDecoder)||(e.AudioDecoder=!0),qr(window.AudioEncoder)||(e.AudioEncoder=!0),qr(window.VideoDecoder)||(e.VideoDecoder=!0),qr(window.VideoEncoder)||(e.VideoEncoder=!0),qr(window.ImageDecoder)||(e.ImageDecoder=!0),e},El=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,bl=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype;!function(){pl();const e=Zd.getItem("checkResult");e&&e.ua===navigator.userAgent&&(el=e.checkResult),sl()}();const Rl={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_PUBLISHED:"stream-published",STREAM_SUBSCRIBED:"stream-subscribed",STREAM_UNSUBSCRIBED:"stream-unsubscribed",STATE_CHANGED:"state-changed",ERROR:"error",CONNECTION_STATE_CHANGED:"connection-state-changed",SEI_MESSAGE:Yt},Cl={STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",STREAM_UPDATED:"stream-updated",STREAM_SUBSCRIBED:"stream-subscribed",CONNECTION_STATE_CHANGED:"connection-state-changed",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",MUTE_AUDIO:"mute-audio",MUTE_VIDEO:"mute-video",UNMUTE_AUDIO:"unmute-audio",UNMUTE_VIDEO:"unmute-video",CLIENT_BANNED:"client-banned",NETWORK_QUALITY:"network-quality",AUDIO_VOLUME:"audio-volume",SEI_MESSAGE:Yt,ERROR:"error"},wl="player-state-changed",kl="screen-sharing-stopped",Al="connection-state-changed",Dl="device-auto-recovered",Pl="error",Nl="player-state-changed";class Ml{constructor(e){const t=e.getUserId();this.log_=vc.createLogger({id:t,userId:t,sdkAppId:e.getSDKAppId()}),this.prevReport_={},this.prevEncoderImplementation_="",this.prevQualityLimitationReason_="",this.prevDecoderImplementationMap_=new Map}async getSenderStats(e){const t={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0,smallFramesEncoded:0,smallFPSCapture:0,smallFramesSent:0},rtt:0},i=e.getPeerConnection(),n=e.getSSRC();if(i)try{(await i.getStats()).forEach(i=>{if("outbound-rtp"===i.type)if(i.mediaType===Dt){if(!Ce&&qr(i.trackId))return;i.ssrc!==n.video||qr(i.encoderImplementation)||this.prevEncoderImplementation_===i.encoderImplementation||(this.log_.info("encoderImplementation change to "+i.encoderImplementation),this.prevEncoderImplementation_=i.encoderImplementation),i.ssrc!==n.video||qr(i.qualityLimitationReason)||this.prevQualityLimitationReason_===i.qualityLimitationReason||(this.log_.info("qualityLimitationReason change to "+i.qualityLimitationReason),this.prevQualityLimitationReason_=i.qualityLimitationReason);const s=e.getSSRC();i.ssrc===s.video?(t.video.bytesSent=i.bytesSent,t.video.packetsSent=i.packetsSent,t.video.framesEncoded=i.framesEncoded):(t.video.smallBytesSent=i.bytesSent,t.video.smallFramesEncoded=i.framesEncoded)}else i.mediaType===At&&(t.audio.bytesSent=i.bytesSent,t.audio.packetsSent=i.packetsSent);else if("candidate-pair"===i.type)ml(i)&&Qr(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime));else if("track"===i.type)if(qr(i.frameWidth)||(i.trackIdentifier===e.getLocalStreamVideoTrackId()?(t.video.frameWidth=i.frameWidth,t.video.frameHeight=i.frameHeight,t.video.framesSent=i.framesSent):(t.video.smallFrameWidth=i.frameWidth,t.video.smallFrameHeight=i.frameHeight,t.video.smallFramesSent=i.framesSent)),qr(i.audioLevel)){if(ft){var s;t.audio.audioLevel=(null===(s=e.getLocalStream())||void 0===s?void 0:s.getInternalAudioLevel())||0}}else t.audio.audioLevel=i.audioLevel||0;else"media-source"===i.type&&(i.kind===At?(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0):i.kind===Dt&&(i.trackIdentifier===e.getLocalStreamVideoTrackId()?t.video.fpsCapture=i.framesPerSecond:t.video.smallFPSCapture=i.framesPerSecond))})}catch(s){this.log_.warn("failed to getStats on sender connection")}return t}async getReceiverStats(e){const t={tinyId:e.getTinyId(),userId:e.getUserId(),rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0}},i=e.getPeerConnection();if(i)try{(await i.getStats()).forEach(i=>{if("inbound-rtp"===i.type){if(i.mediaType===At)t.audio.packetsReceived=i.packetsReceived,t.audio.bytesReceived=i.bytesReceived,t.audio.packetsLost=i.packetsLost,t.audio.jitter=i.jitter,t.hasAudio=!0;else if(i.mediaType===Dt){if(Ce&&0===i.bytesReceived)return;const n=e.getSSRC();i.ssrc===n.video&&(t.video.packetsReceived=i.packetsReceived,t.video.bytesReceived=i.bytesReceived,t.video.packetsLost=i.packetsLost,t.video.framesReceived=i.framesReceived,t.video.framesDecoded=i.framesDecoded,t.video.fpsDecoded=i.framesPerSecond,t.hasVideo=!0,!i.decoderImplementation||this.prevDecoderImplementationMap_.has(t.userId)&&this.prevDecoderImplementationMap_.get(t.userId)===i.decoderImplementation||(vc.info(`[${t.userId}] decoderImplementation change to ${i.decoderImplementation}`),this.prevDecoderImplementationMap_.set(t.userId,i.decoderImplementation))),i.ssrc===n.auxiliary&&(t.auxiliary.packetsReceived=i.packetsReceived,t.auxiliary.bytesReceived=i.bytesReceived,t.auxiliary.packetsLost=i.packetsLost,t.auxiliary.framesReceived=i.framesReceived,t.auxiliary.framesDecoded=i.framesDecoded,t.auxiliary.fpsDecoded=i.framesPerSecond,t.hasAuxiliary=!0)}}else"track"===i.type?(qr(i.frameWidth)||(i.trackIdentifier===e.getMainStreamVideoTrackId()&&(t.video.frameWidth=i.frameWidth,t.video.frameHeight=i.frameHeight),i.trackIdentifier===e.getAuxStreamVideoTrackId()&&(t.auxiliary.frameWidth=i.frameWidth,t.auxiliary.frameHeight=i.frameHeight)),qr(i.audioLevel)||(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0)):"candidate-pair"===i.type&&ml(i)&&Qr(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime))})}catch(n){this.log_.warn("failed to getStats on receiver connection")}return t}async getStats(e,t){let i={};e&&(i=await this.getSenderStats(e));const n=[];for(let[s,r]of t){const e=await this.getReceiverStats(r);n.push(e)}return{senderStats:i,receiverStats:n}}getDifferenceValue(e,t){if(Vd(e))return t;const i=t-e;return i<0?0:i}prepareReport({stats:e,report:t,freezeMap:i}){if(!Vd(e.senderStats)){let i={uint32_audio_level:1e8*e.senderStats.audio.audioLevel,uint32_audio_energy:1e6*e.senderStats.audio.totalAudioEnergy,uint32_audio_codec_bitrate:e.senderStats.audio.bytesSent,audioLevel:e.senderStats.audio.audioLevel},n=[],s={uint32_video_stream_type:2,uint32_video_codec_fps:e.senderStats.video.framesSent,uint32_video_capture_fps:e.senderStats.video.fpsCapture,uint32_video_width:e.senderStats.video.frameWidth,uint32_video_height:e.senderStats.video.frameHeight,uint32_video_codec_bitrate:e.senderStats.video.bytesSent,uint32_video_enc_fps:e.senderStats.video.framesEncoded};if(n.push(s),e.senderStats.video.smallBytesSent){let t={uint32_video_stream_type:3,uint32_video_codec_fps:e.senderStats.video.smallFramesSent||0,uint32_video_capture_fps:e.senderStats.video.smallFPSCapture||0,uint32_video_width:e.senderStats.video.smallFrameWidth||0,uint32_video_height:e.senderStats.video.smallFrameHeight||0,uint32_video_codec_bitrate:e.senderStats.video.smallBytesSent,uint32_video_enc_fps:e.senderStats.video.smallFramesEncoded||0};n.push(t)}let r={uint32_bitrate:"",uint32_rtt:e.senderStats.rtt};t.msg_up_stream_info={msg_audio_status:i,msg_video_status:n,msg_network_status:r}}t.msg_down_stream_info=[],e.receiverStats.forEach(e=>{const n={};if(n.msg_user_info={str_identifier:e.userId,uint64_tinyid:e.tinyId},n.msg_network_status={uint32_rtt:e.rtt},n.msg_video_status={},e.hasAudio){const t={uint32_audio_codec_bitrate:e.audio.bytesReceived,uint32_audio_total_bitrate:e.audio.bytesReceived,uint32_audio_level:1e8*e.audio.audioLevel,uint32_audio_energy:1e6*e.audio.totalAudioEnergy,uint32_audio_receive:e.audio.packetsReceived,uint32_audio_origin_lost:e.audio.packetsLost,audioLevel:e.audio.audioLevel};n.msg_audio_status=t}if(n.msg_video_status=[],e.hasVideo){const t=i.get(e.userId+"_"+gi),s=t?t.duration:0,r={uint32_video_stream_type:2,uint32_video_receive_fps:e.video.framesReceived,uint32_video_width:e.video.frameWidth,uint32_video_height:e.video.frameHeight,uint32_video_codec_bitrate:e.video.bytesReceived,uint32_video_receive:e.video.packetsReceived,uint32_video_origin_lost:e.video.packetsLost,uint32_video_block_time:s,uint32_video_dec_fps:e.video.fpsDecoded};n.msg_video_status.push(r)}if(e.hasAuxiliary){const t=i.get(e.userId+"_"+fi),s=t?t.duration:0,r={uint32_video_stream_type:7,uint32_video_receive_fps:e.auxiliary.framesReceived,uint32_video_width:e.auxiliary.frameWidth,uint32_video_height:e.auxiliary.frameHeight,uint32_video_codec_bitrate:e.auxiliary.bytesReceived,uint32_video_receive:e.auxiliary.packetsReceived+e.auxiliary.packetsLost,uint32_video_origin_lost:e.auxiliary.packetsLost,uint32_video_block_time:s,uint32_video_dec_fps:e.auxiliary.fpsDecoded};n.msg_video_status.push(r)}t.msg_down_stream_info.push(n)});const n=this.prevReport_;this.prevReport_=JSON.parse(JSON.stringify(t));const s=n.msg_up_stream_info.msg_audio_status,r=t.msg_up_stream_info.msg_audio_status,o=this.getDifferenceValue(s.uint32_audio_codec_bitrate,r.uint32_audio_codec_bitrate);r.uint32_audio_codec_bitrate=8*o/2;const a=n.msg_up_stream_info.msg_video_status;t.msg_up_stream_info.msg_video_status.forEach((e,t)=>{const i=a[t];let n=0,s=0,r=0;i&&(n=i.uint32_video_codec_bitrate,s=i.uint32_video_enc_fps,r=i.uint32_video_codec_fps);const o=this.getDifferenceValue(n,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=8*o/2,e.uint32_video_enc_fps=this.getDifferenceValue(s,e.uint32_video_enc_fps)/2,e.uint32_video_codec_fps=this.getDifferenceValue(r,e.uint32_video_codec_fps)/2});const c=t.msg_down_stream_info,d=n.msg_down_stream_info;return c.forEach(e=>{const t=d.find(t=>t.msg_user_info.uint64_tinyid===e.msg_user_info.uint64_tinyid);if(t){if(e.msg_audio_status&&t.msg_audio_status){const i=e.msg_audio_status,n=t.msg_audio_status;i.uint32_audio_origin_lost=this.getDifferenceValue(n.uint32_audio_origin_lost,i.uint32_audio_origin_lost),i.uint32_audio_receive=this.getDifferenceValue(n.uint32_audio_receive,i.uint32_audio_receive),i.uint32_audio_receive+=i.uint32_audio_origin_lost;const s=this.getDifferenceValue(n.uint32_audio_codec_bitrate,i.uint32_audio_codec_bitrate);i.uint32_audio_codec_bitrate=8*s/2,i.uint32_audio_total_bitrate=8*s/2}if(e.msg_video_status&&t.msg_video_status){const i=e.msg_video_status,n=t.msg_video_status;i.forEach((e,t)=>{const i=n[t];let s=0,r=0,o=0,a=0;i&&(s=i.uint32_video_receive,r=i.uint32_video_origin_lost,o=i.uint32_video_codec_bitrate,a=i.uint32_video_receive_fps),e.uint32_video_origin_lost=this.getDifferenceValue(r,e.uint32_video_origin_lost),e.uint32_video_receive=this.getDifferenceValue(s,e.uint32_video_receive)+e.uint32_video_origin_lost;const c=this.getDifferenceValue(o,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=8*c/2;const d=this.getDifferenceValue(a,e.uint32_video_receive_fps);e.uint32_video_receive_fps=d/2})}}}),t.msg_up_stream_info.msg_network_status.uint32_bitrate=t.msg_up_stream_info.msg_audio_status.uint32_audio_codec_bitrate+t.msg_up_stream_info.msg_video_status[0].uint32_video_codec_bitrate,t}async getStatsReport({uplinkConnection:e,downlinkConnections:t,freezeMap:i}){const n={msg_up_stream_info:{msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0,audioLevel:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_codec_fps:0,uint32_video_capture_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_final_lost:0,uint32_video_enc_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0},msg_qos:[{uint32_video_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_bitrate:0,uint32_audio_bitrate:0,uint32_video_stream_type:0}]},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:""},msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0,audioLevel:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0,uint32_jitter:0},msg_qos:[{uint32_video_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_bitrate:0,uint32_audio_bitrate:0,uint32_video_stream_type:0}]}]};"{}"===JSON.stringify(this.prevReport_)&&(this.prevReport_=JSON.parse(JSON.stringify(n)));const s=await this.getStats(e,t);return this.prepareReport({stats:s,report:n,freezeMap:i}),n}}class Ll{constructor({signalChannel:e,connections:t,client:i}){this.client_=i,this.signalChannel_=e,this.connections_=t,this.client_=i,this.log_=vc.createLogger({id:"q|"+this.client_.getUserId(),userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId()}),this.uplinkConnection_=null,this.uplinkNetworkQuality_=0,this.uplinkRTT_=0,this.uplinkLoss_=0,this.downlinkNetworkQuality_=0,this.downlinkRTT_=0,this.downlinkLoss_=0,this.downlinkPrevStatMap_=new Map,this.downlinkLossAndRTTMap_=new Map,this.interval_=-1,this.emitter_=new Ia,this.initialize()}get uplinkNetworkQuality(){return this.uplinkNetworkQuality_}set uplinkNetworkQuality(e){e!==this.uplinkNetworkQuality_&&this.log_.info(`uplink network quality change ${this.uplinkNetworkQuality} -> ${e}, rtt: ${this.uplinkRTT_}, loss: ${this.uplinkLoss_}`),this.uplinkNetworkQuality_=e}get downlinkNetworkQuality(){return this.downlinkNetworkQuality_}set downlinkNetworkQuality(e){if(e!==this.downlinkNetworkQuality_){const{rtt:t,loss:i}=this.getAverageLossAndRTT([...this.downlinkLossAndRTTMap_.values()]);this.log_.info(`downlink network quality change ${this.downlinkNetworkQuality} -> ${e}, rtt: ${t}, loss: ${i}`)}this.downlinkNetworkQuality_=e}initialize(){this.signalChannel_.on(Pc.UPLINK_NETWORK_STATS,e=>{this.handleUplinkNetworkQuality(e)}),this.signalChannel_.on(Tc,this.handleSignalConnectionStateChange.bind(this)),this.start()}handleUplinkNetworkQuality(e){if(!this.uplinkConnection_)return this.uplinkNetworkQuality=0,this.uplinkLoss_=0,void(this.uplinkRTT_=0);const t=this.uplinkConnection_.getPeerConnection();if(t&&this.isPeerConnectionDisconnected(t))return this.uplinkNetworkQuality=6,this.uplinkLoss_=0,void(this.uplinkRTT_=0);if(0===e.data.code){const t=e.data.data,i=t.expectAudPkg+t.expectVidPkg,n=t.recvAudPkg+t.recvVidPkg,s=i-n,r=t.delay;if(r&&this.updateDelay(r),0===i&&0===n)return;this.uplinkLoss_=s<=0?0:Math.round(s/i*100),this.uplinkRTT_=t.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this.uplinkLoss_,this.uplinkRTT_)}}async handleDownlinkNetworkQuality(){if(!this.connections_||0===this.connections_.size)return void(this.downlinkNetworkQuality=0);const e=[...this.connections_.values()],t=e.filter(e=>e.getPeerConnection()&&e.getPeerConnection().connectionState===wi);if(e.filter(e=>e.getPeerConnection()&&this.isPeerConnectionDisconnected(e.getPeerConnection())).length===e.length)return void(this.downlinkNetworkQuality=6);for(let s=0;s<t.length;s++){const e=t[s].getPeerConnection(),{rtt:i,totalPacketsLost:n,totalPacketsReceived:r}=await this.getStat(e);if(!this.downlinkPrevStatMap_.has(e)){this.downlinkPrevStatMap_.set(e,{totalPacketsLost:n,totalPacketsReceived:r});continue}let o=0;const a=this.downlinkPrevStatMap_.get(e),c=n-a.totalPacketsLost,d=r-a.totalPacketsReceived;o=c<=0||d<0?0:Math.round(c/(c+d)*100),this.downlinkPrevStatMap_.set(e,{totalPacketsLost:n,totalPacketsReceived:r}),this.downlinkLossAndRTTMap_.set(e,{rtt:i,loss:o,userId:t[s].getUserId()})}if([...this.downlinkPrevStatMap_.keys()].forEach(e=>{this.isPeerConnectionDisconnected(e)&&(this.downlinkPrevStatMap_.delete(e),this.downlinkLossAndRTTMap_.delete(e))}),0===this.downlinkLossAndRTTMap_.size)return;const{rtt:i,loss:n}=this.getAverageLossAndRTT([...this.downlinkLossAndRTTMap_.values()]);this.downlinkRTT_=i,this.downlinkLoss_=n,this.downlinkNetworkQuality=this.getNetworkQuality(n,i)}async getStat(e){const t={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!ol())return t;const i=e.getReceivers();try{for(let e=0;e<i.length;e++){const n=i[e];(await n.getStats()).forEach(e=>{"candidate-pair"===e.type&&Qr(e.currentRoundTripTime)&&(t.rtt=Math.round(1e3*e.currentRoundTripTime)),"inbound-rtp"!==e.type||e.mediaType!==At&&e.mediaType!==Dt||(t.totalPacketsLost+=e.packetsLost,t.totalPacketsReceived+=e.packetsReceived)})}return t}catch(n){return t}}getAverageLossAndRTT(e){const t={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach(e=>{t.rtt+=e.rtt,t.loss+=e.loss}),Object.keys(t).forEach(i=>{t[i]=Math.round(t[i]/e.length)})),t}getNetworkQuality(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}handleSignalConnectionStateChange(e){e.state===Rc?(this.uplinkRTT_=0,this.uplinkLoss_=0,this.uplinkNetworkQuality=6):e.state===kc&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}handleUplinkConnectionStateChange({state:e}){e===vi?(this.uplinkLoss_=0,this.uplinkRTT_=0,this.uplinkNetworkQuality=6):e===Ii&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}isPeerConnectionDisconnected(e){return!(!e||e.connectionState!==Ci&&e.connectionState!==bi&&e.connectionState!==Ri)}setUplinkConnection(e){this.uplinkConnection_=e,this.uplinkConnection_?this.uplinkConnection_.on(Rl.CONNECTION_STATE_CHANGED,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this.uplinkRTT_=0,this.uplinkLoss_=0)}start(){-1===this.interval_?(this.log_.info("start network quality calculating"),this.interval_=Yd.setInterval(()=>{this.handleDownlinkNetworkQuality(),Ta.emit(hc,{client:this.client_,uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this.uplinkRTT_,uplinkLoss:this.uplinkLoss_,downlinkRTT:this.downlinkRTT_,downlinkLoss:this.downlinkLoss_,downlinkLossAndRTTMap:this.downlinkLossAndRTTMap_}),this.emitter_.emit(Cl.NETWORK_QUALITY,{uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this.uplinkRTT_,uplinkLoss:this.uplinkLoss_,downlinkRTT:this.downlinkRTT_,downlinkLoss:this.downlinkLoss_})},2e3)):this.log_.info("network quality calculating is already started")}stop(){this.log_.info("stop network quality calculating"),-1!==this.interval_&&(Yd.clearInterval(this.interval_),this.interval_=-1)}on(e,t){this.emitter_.on(e,t)}updateDelay(e){e.forEach(({srcTinyId:e,videoDelay:t,audioDelay:i})=>{const n=this.connections_.get(e);n&&n.setDelay({videoDelay:t,audioDelay:i})})}}class Ol{constructor(e){this.log_=vc.createLogger({id:e.client.getUserId(),userId:e.client.getUserId(),sdkAppId:e.client.getSDKAppId()}),this.localStream_=null,this.prevDevices_=[],this.initialize()}async initialize(){navigator.mediaDevices&&(this.onDeviceChange=this.onDeviceChange.bind(this),navigator.mediaDevices.addEventListener("devicechange",this.onDeviceChange))}destroy(){navigator.mediaDevices&&navigator.mediaDevices.removeEventListener("devicechange",this.onDeviceChange)}async onDeviceChange(){if(!this.localStream_||!this.localStream_.getMediaStream()||this.localStream_.getScreen())return;const e=await mu.getDevices(),t=e.filter(e=>this.prevDevices_.findIndex(({deviceId:t})=>e.deviceId===t)<0),i=this.prevDevices_.filter(t=>e.findIndex(({deviceId:e})=>t.deviceId===e)<0);t.length>0&&this.handleDeviceAdded(this.prevDevices_,t),i.length>0&&this.handleDeviceRemoved(e,i),this.prevDevices_=e}async setLocalStream(e){e&&(this.prevDevices_=await mu.getDevices()),this.localStream_=e}handleDeviceAdded(e,t){this.log_.warn("devicesAdded: "+JSON.stringify(t)),this.localStream_.updateDeviceIdInUse();const i=t.filter(({kind:e})=>e===Ht),n=t.filter(({kind:e})=>e===jt),s=e.filter(({kind:e})=>e===Ht),r=e.filter(({kind:e})=>e===jt),o=i.length>0&&0===s.length&&this.localStream_.getVideo(),a=n.length>0&&0===r.length&&this.localStream_.getAudio();if(a&&o)return this.log_.info("new microphone and camera detected, but there was no device before."),void this.localStream_.updateStream({audio:!0,video:!0,cameraId:i[0].deviceId,microphoneId:n[0].deviceId});o&&(this.log_.info("new camera detected, but there was no camera before."),this.localStream_.updateStream({audio:!1,video:!0,cameraId:i[0].deviceId})),a&&(this.log_.info("new microphone detected, but there was no microphone before."),this.localStream_.updateStream({audio:!0,video:!1,microphoneId:n[0].deviceId}))}handleDeviceRemoved(e,t){this.log_.warn("devicesRemoved: "+JSON.stringify(t)),this.localStream_.updateDeviceIdInUse();let i=!1,n=!1;const s=this.localStream_.getCameraId(),r=this.localStream_.getMicrophoneId();if("default"===r){const t=this.localStream_.getMicrophoneGroupId(),i=e.filter(e=>"default"===e.deviceId&&e.kind===jt)[0];i&&i.groupId!==t&&(n=!0)}if(t.forEach(({deviceId:e})=>{s.length>0&&e===s?i=!0:r.length>0&&e===r&&(n=!0)}),i&&n)return this.log_.warn(`current camera and microphone in use is lost, cameraId: ${s}, microphoneId: ${r}`),void((this.localStream_.getAudio()||this.localStream_.getVideo())&&this.localStream_.updateStream({video:!0,audio:!0}));i&&(this.log_.warn("current camera in use is lost, deviceId: "+s),this.localStream_.getVideo()&&this.localStream_.updateStream({video:!0,audio:!1})),n&&(this.log_.warn("current microphone in use is lost, deviceId: "+r),this.localStream_.getAudio()&&this.localStream_.updateStream({video:!1,audio:!0}))}}let xl,Ul,Vl=new Blob(["class VolumeMeter extends AudioWorkletProcessor{constructor(){super();this.volume=0;this.intervalTime=200;this.tick=this.intervalTime;this.isStop=false;this.port.onmessage=event=>{const{data}=event;switch(data.name){case'setIntervalTime':this.intervalTime=data.intervalTime;break;case'stop':this.isStop=true;break}}}process(inputs){const input=inputs[0];if(this.isStop){return false}if(input.length>0){const firstChannel=input[0];let sum=0;let rms;for(let i=0;i<firstChannel.length;++i){sum+=firstChannel[i]*firstChannel[i]}rms=Math.sqrt(sum/firstChannel.length);this.volume=Math.max(rms,this.volume*0.95);this.tick-=firstChannel.length;if(this.tick<0){this.tick+=(this.intervalTime/1000)*sampleRate;this.port.postMessage({volume:this.volume})}}return true}}registerProcessor('volume-meter',VolumeMeter);"],{type:"application/javascript"}),Fl=!1;class $l{constructor(e){this.context_=e.context,this.addModuleToContext()}async addModuleToContext(){try{await this.context_.audioWorklet.addModule(URL.createObjectURL(Vl)),vc.info("worklet addModule success"),Ta.emit(pc),Fl=!0}catch(e){vc.info("worklet addModule catch error. "+e.message),Ta.emit(_c)}}get initWorkletSuccess(){return Fl}}class Bl{constructor(e){const{track:t,log:i,stream:n}=e;this.volume_=0,this.log_=i,this.track_=t,this.stream_=n,xl||(xl=new window.AudioContext),this.audioCtx_=xl,this.destination_=this.audioCtx_.destination;const s=new MediaStream;s.addTrack(this.track_),this.streamSource_=this.audioCtx_.createMediaStreamSource(s),this.audioWorkletNode_=null,this.scriptProcessorNode_=null,this.interval_=200,Ta.on(uc,this.resume,this),Ta.on(Fa,this.handleAudioLevelInterval,this),ao?(Ta.on(pc,this.initAudioWorklet,this),Ta.on(_c,this.initScriptProcessor,this),this.preload()):this.initScriptProcessor()}preload(){Ul?Ul.initWorkletSuccess&&this.initAudioWorklet():Ul=new $l({context:xl})}initAudioWorklet(){if(!this.audioWorkletNode_)try{this.audioWorkletNode_=new AudioWorkletNode(this.audioCtx_,"volume-meter"),this.audioWorkletNode_.port.onmessage=e=>{this.volume_=e.data.volume||0},this.streamSource_.connect(this.audioWorkletNode_).connect(this.destination_),this.handleAudioLevelInterval({interval:this.interval_}),Fd.logSuccessEvent({userId:this.stream_.getUserId(),eventType:tn})}catch(e){Fd.logFailedEvent({userId:this.stream_.getUserId(),eventType:tn}),this.initScriptProcessor()}}initScriptProcessor(){if(!this.scriptProcessorNode_)try{this.scriptProcessorNode_=this.audioCtx_.createScriptProcessor(2048,1,1),this.scriptProcessorNode_.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);let i=0;for(let n=0;n<t.length;++n)i+=t[n]*t[n];this.volume_=Math.sqrt(i/t.length)||0},this.streamSource_.connect(this.scriptProcessorNode_),this.scriptProcessorNode_.connect(this.destination_)}catch(e){this.log_.error("volumeMeter init script processor error: "+e)}}destroy(){this.streamSource_&&this.streamSource_.disconnect(),this.scriptProcessorNode_&&(this.scriptProcessorNode_.onaudioprocess=null,this.scriptProcessorNode_.disconnect()),this.audioWorkletNode_&&(this.audioWorkletNode_.port.postMessage({name:"stop"}),this.audioWorkletNode_.port.onmessage=null,this.audioWorkletNode_.disconnect()),this.audioWorkletNode_=null,this.scriptProcessorNode_=null,this.audioCtx_=null,Ta.off(uc,this.resume,this),Ta.off(Fa,this.handleAudioLevelInterval,this),Ta.off(pc,this.initAudioWorklet,this),Ta.off(_c,this.initScriptProcessor,this)}resume(){this.audioCtx_&&this.audioCtx_.resume()}getInternalAudioLevel(){return this.volume_}getCalculatedVolume(){return this.volume_.toFixed(2)}handleAudioLevelInterval({interval:e}){this.interval_=e,this.audioWorkletNode_&&this.audioWorkletNode_.port.postMessage({name:"setIntervalTime",intervalTime:e})}}class jl{constructor(e){this.stream_=e.stream,this.userId_=e.stream.getUserId(),this.log_=this.stream_.getLogger(),this.track_=e.track,e.gainedTrack&&(this.gainedTrack_=e.gainedTrack),this.div_=e.div,this.muted_=e.muted,this.outputDeviceId_=e.outputDeviceId,this.volume_=e.volume,this.pausedRetryCount_=5,this.emitter_=new Ia,this.initializeElement(),this.state_="NONE",this.volumeMeter_=new Bl({stream:this.stream_,track:this.gainedTrack_||this.track_,log:this.log_})}get isPlaying(){return"PLAYING"===this.state_}initializeElement(){if(this.isAudioElementInit()){const e=new MediaStream;e.addTrack(this.gainedTrack_||this.track_);const t=document.createElement(At);t.srcObject=e,t.muted=this.muted_,t.setAttribute("id","audio_"+this.stream_.getId()),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div_.appendChild(t),this.element_=t}this.handleEvents()}setMuted(e){this.element_&&(this.element_.muted=e,this.muted_=e)}async play(){this.outputDeviceId_&&this.element_&&await this.element_.setSinkId(this.outputDeviceId_),this.setVolume(this.volume_);try{this.element_&&await this.element_.play()}catch(e){this.log_.warn("<audio> play() error: "+e);const t=e.toString()+" <audio>";if(t.startsWith("NotAllowedError"))throw new Yc({code:Xc.PLAY_NOT_ALLOWED,message:t})}}handleEvents(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_&&(this.element_.addEventListener(Vt,this.handleElementEvent),this.element_.addEventListener(Ut,this.handleElementEvent),this.element_.addEventListener(Ft,this.handleElementEvent),this.element_.addEventListener($t,this.handleElementEvent)),this.track_.addEventListener(Ut,this.handleTrackEvent),this.track_.addEventListener(Ot,this.handleTrackEvent),this.track_.addEventListener(xt,this.handleTrackEvent),this.track_.readyState===Ut&&this.handleTrackEvent({type:Ut}),this.track_.muted&&this.handleTrackEvent({type:Ot})}async handleElementEvent(e){switch(e.type){case Vt:this.log_.info("stream - audio player is starting playing"),this.state_="PLAYING",Ta.emit(Ha,{stream:this.stream_}),this.emitter_.emit(Nl,{state:this.state_,reason:Vt});break;case Ut:this.log_.info("stream - audio player is ended"),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(Nl,{state:this.state_,reason:Ut}));break;case Ft:{this.log_.info("stream - audio player is paused"),this.state_="PAUSED",this.emitter_.emit(Nl,{state:this.state_,reason:Ft});const e=this.div_&&document.getElementById(this.div_.id);e||this.log_.warn("audio container is not in DOM");const t=ut();this.pausedRetryCount_>0&&(Qr(t)&&t<=70||!e)&&(this.resume(),this.pausedRetryCount_--);break}case $t:if(this.element_&&this.element_.error){const e=`${fl()}/${wt().name}/${wt().version}`,t=await mu.getSpeakers();let i=t[0].label;const n=t.find(e=>e.deviceId===this.outputDeviceId_);n&&(i=n.label),this.log_.error(`stream - audio player error observed. code: ${this.element_.error.code} message: ${this.element_.error.message} deviceInfo: ${e} speaker: ${i}`),Fd.uploadEvent(`stat-${this.stream_.getType()}-audio-${Zi}-${this.element_.error.code}-${e}-${i}`,this.element_.error)}}}handleTrackEvent(e){const t=e.type;switch(t){case Ut:this.log_.info("stream - audio player track is ended"),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(Nl,{state:this.state_,reason:Ut})),Ta.emit(cc,{stream:this.stream_,type:t});break;case Ot:this.log_.info("stream - audio track is unable to provide media output"),this.stream_.isRemote()||ro(),"PAUSED"!==this.state_&&(this.state_="PAUSED",this.emitter_.emit(Nl,{state:this.state_,reason:Ot})),Ta.emit(ac,{stream:this.stream_,type:t});break;case xt:this.log_.info("stream - audio track is able to provide media output"),"PAUSED"===this.state_&&(this.state_="PLAYING",this.emitter_.emit(Nl,{state:this.state_,reason:xt}))}}unbindEvents(){this.element_&&(this.element_.removeEventListener(Vt,this.handleElementEvent),this.element_.removeEventListener(Ut,this.handleElementEvent),this.element_.removeEventListener(Ft,this.handleElementEvent),this.element_.removeEventListener($t,this.handleElementEvent)),this.track_&&(this.track_.removeEventListener(Ut,this.handleTrackEvent),this.track_.removeEventListener(Ot,this.handleTrackEvent),this.track_.removeEventListener(xt,this.handleTrackEvent))}async setSinkId(e){this.outputDeviceId_!==e&&(this.element_&&await this.element_.setSinkId(e),this.outputDeviceId_=e)}setVolume(e){this.element_&&(this.log_.info("stream - audioElement setVolume to : "+e),this.element_.volume=e)}getAudioLevel(){return this.volumeMeter_.getCalculatedVolume()}getInternalAudioLevel(){return this.volumeMeter_.getInternalAudioLevel()}stop(){this.unbindEvents(),this.element_&&(this.div_.removeChild(this.element_),this.element_.srcObject=null,this.element_=null),this.volumeMeter_&&(this.volumeMeter_.destroy(),this.volumeMeter_=null)}async resume(){try{this.volumeMeter_&&this.volumeMeter_.resume(),this.element_&&await this.element_.play()}catch(e){this.log_.warn("<audio> play() error: "+e);const t=Fr({key:Qn,data:{error:e}});if(t.startsWith("NotAllowedError"))throw new Yc({code:Xc.PLAY_NOT_ALLOWED,message:t})}}on(e,t){this.emitter_.on(e,t)}isAudioElementInit(){return!("15.2"===yt||"15.3"===yt||"15.4"===yt)||"local"!==this.stream_.getType()||!this.muted_||(this.log_.info("audioElement is muted."),!1)}}const Hl="trtc_autoplay_wrapper";let Gl=!1;const Jl=()=>!!document.querySelector("."+Hl),zl=`${Pn}/${so()?"zh-cn":"en"}/tutorial-21-advanced-auto-play-policy.html`,Wl=`<br><a href='${zl}' target='_blank'>${so()?"":"Any other solution?"}</a>`,ql=""+(so()?""+Wl:"Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. "+Wl);class Kl{constructor(){if(this.dialogNode_=null,this.bodyPosition_="",this.content="",so()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!Gl){const e=document.createElement("style");e.innerHTML=`.trtc_autoplay_mask{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.trtc_autoplay_mask div:not(.trtc_autoplay_action_wrapper){display:block !important;}.${Hl}{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.${Hl} a{color:#2473E8;}.trtc_autoplay_header{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.trtc_autoplay_content{margin:8px 0;}.trtc_autoplay_action_wrapper{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.trtc_autoplay_collapse{margin-right:auto;cursor:pointer}.trtc_autoplay_question{height:100%;line-height:16px;cursor:pointer;}.trtc_autoplay_action_confirm{margin-left:8px;color:#fff;background:#2473E8;padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.trtc_autoplay_action_confirm:hover{opacity:0.9;}.trtc_autoplay_collapse,.trtc_autoplay_action_confirm,.trtc_autoplay_content,.trtc_autoplay_question{font-size:14px;}@media screen and (max-width:750px){.${Hl}{width:80vw;}}`,document.head.appendChild(e),Gl=!0}this.showDetail_=!1,this.isCollapseClicked_=!1,this.isQuestionClicked_=!1,this.addDiaLog()}createDiaLog(){const e=document.createElement("template");e.innerHTML=`<div class="trtc_autoplay_mask"><div class='${Hl}'><div class='trtc_autoplay_header'>${location.host}</div><div class='trtc_autoplay_content'>${this.content}</div><div class='trtc_autoplay_detail' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">${ql}</div><div class='trtc_autoplay_action_wrapper'></div></div></div>`.trim();const t=document.createElement("button");t.className="trtc_autoplay_action_confirm",t.innerText=so()?"":"Resume",t.onclick=this.onConfirm.bind(this);const i=document.createElement("div");i.className="trtc_autoplay_question",i.innerHTML='<?xml version="1.0" encoding="UTF-8"?>\n    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">\n    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>\n    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>\n    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>\n    </svg>\n    ',i.onclick=this.onQuestionClick.bind(this);const n=document.createElement("div");n.className="trtc_autoplay_collapse",n.innerText=""+(so()?" >":"Detail >"),n.onclick=this.onCollapseClick.bind(this);const s=e.content.firstChild,r=s.querySelector(".trtc_autoplay_action_wrapper");return r.appendChild(n),r.appendChild(i),r.appendChild(t),s}addDiaLog(){Jl()||(this.dialogNode_=this.createDiaLog(),document.body.appendChild(this.dialogNode_),this.dialogNode_.onclick=this.onConfirm.bind(this),this.dialogNode_.querySelector("."+Hl).onclick=e=>e.stopPropagation(),this.bodyPosition_=document.body.style.position,document.body.style.position="fixed",vc.warn("show autoplay dialog"),Fd.uploadEvent({log:"dialog-show"}))}deleteDiaLog(){this.dialogNode_&&(document.body.removeChild(this.dialogNode_),document.body.style.position=this.bodyPosition_,this.dialogNode_=null)}onConfirm(){vc.warn("confirm clicked, try resume stream"),Ta.emit(uc),this.deleteDiaLog()}onCollapseClick(){const e=this.dialogNode_.querySelector(".trtc_autoplay_detail");e.style.visibility=""+(this.showDetail_?"hidden":"visible"),e.style.height=""+(this.showDetail_?0:"fit-content"),this.showDetail_=!this.showDetail_,this.isCollapseClicked_||Fd.uploadEvent({log:"dialog-1"}),this.isCollapseClicked_=!0}onQuestionClick(){window.open(zl,"_blank"),this.isQuestionClicked_||Fd.uploadEvent({log:"dialog-2"}),this.isQuestionClicked_=!0}}class Ql{constructor(e){this.stream_=e.stream,this.userId_=e.stream.getUserId(),this.log_=this.stream_.getLogger(),this.track_=e.track,this.div_=e.div,this.muted_=e.muted,this.objectFit_=e.objectFit,this.mirror_=e.mirror,this.emitter_=new Ia,this.initializeElement(),this.state_="NONE",this.pausedRetryCount_=5}get isPlaying(){return"PLAYING"===this.state_}initializeElement(){const e=new MediaStream;e.addTrack(this.track_);const t=document.createElement(Dt);t.srcObject=e,t.muted=!0;let i=`width: 100%; height: 100%; object-fit: ${this.objectFit_};`;this.mirror_&&(i+="transform: scaleX(-1);"),t.setAttribute("id","video_"+this.stream_.getId()),t.setAttribute("style",i),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div_&&this.div_.appendChild(t),this.element_=t,this.handleEvents()}setRect({width:e,height:t}){this.element_&&(this.element_.style.width=e+"px",this.element_.style.height=t+"px")}setMirror(e){this.element_&&(this.element_.style.transform=e?"scaleX(-1)":"",this.mirror_=e)}setObjectFit(e){this.element_&&(this.element_.style.objectFit=""+e,this.objectFit_=e)}async play(){try{await this.element_.play()}catch(e){this.log_.warn("<video> play() error: "+e);const t=e.toString()+" <video>";if(t.startsWith("NotAllowedError"))throw new Yc({code:Xc.PLAY_NOT_ALLOWED,message:t})}}handleEvents(){this.handleElementEvent=this.handleElementEvent.bind(this),this.handleTrackEvent=this.handleTrackEvent.bind(this),this.element_.addEventListener(Vt,this.handleElementEvent),this.element_.addEventListener(Ut,this.handleElementEvent),this.element_.addEventListener(Ft,this.handleElementEvent),this.element_.addEventListener($t,this.handleElementEvent),this.element_.addEventListener(Bt,this.handleElementEvent),this.track_.addEventListener(Ut,this.handleTrackEvent),this.track_.addEventListener(Ot,this.handleTrackEvent),this.track_.addEventListener(xt,this.handleTrackEvent),this.track_.readyState===Ut&&this.handleTrackEvent({type:Ut}),this.track_.muted&&this.handleTrackEvent({type:Ot})}handleElementEvent(e){switch(e.type){case Vt:this.log_.info("stream - video player is starting playing"),this.state_="PLAYING",Ta.emit(ja,{stream:this.stream_}),this.emitter_.emit(Nl,{state:this.state_,reason:Vt});break;case Ut:this.log_.info("stream - video player is ended"),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(Nl,{state:this.state_,reason:Ut}));break;case Ft:this.log_.info("stream - video player is paused"),this.div_&&!document.getElementById(this.div_.id)&&this.log_.warn("video container is not in DOM"),this.state_="PAUSED",this.emitter_.emit(Nl,{state:this.state_,reason:Ft}),this.pausedRetryCount_>0&&!Jl()&&(this.log_.info("auto resume when video paused"),this.resume(),this.pausedRetryCount_--);break;case $t:if(this.element_&&this.element_.error){const e=`${fl()}/${wt().name}/${wt().version}`;this.log_.error(`stream - video player error observed. code: ${this.element_.error.code} message: ${this.element_.error.message} deviceInfo: ${e}`),Fd.uploadEvent(`stat-${this.stream_.getType()}-video-${Zi}-${this.element_.error.code}-${e}`,this.element_.error)}break;case Bt:Ta.emit(sc,{stream:this.stream_})}}handleTrackEvent(e){const t=e.type;switch(t){case Ut:this.log_.info("stream - video player track is ended"),Ta.emit(oc,{stream:this.stream_,type:t}),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.emitter_.emit(Nl,{state:this.state_,reason:Ut}));break;case Ot:this.log_.info("stream - video track is unable to provide media output"),this.stream_.isRemote()||ro(),Ta.emit(tc,{stream:this.stream_,type:t}),"PAUSED"!==this.state_&&(this.state_="PAUSED",this.emitter_.emit(Nl,{state:this.state_,reason:Ot}));break;case xt:this.log_.info("stream - video track is able to provide media output"),Ta.emit(ic,{stream:this.stream_}),"PAUSED"===this.state_&&(this.state_="PLAYING",this.emitter_.emit(Nl,{state:this.state_,reason:xt}))}}unbindEvents(){this.element_&&(this.element_.removeEventListener(Vt,this.handleElementEvent),this.element_.removeEventListener(Ut,this.handleElementEvent),this.element_.removeEventListener(Ft,this.handleElementEvent),this.element_.removeEventListener($t,this.handleElementEvent),this.element_.removeEventListener(Bt,this.handleElementEvent)),this.track_&&(this.track_.removeEventListener(Ut,this.handleTrackEvent),this.track_.removeEventListener(Ot,this.handleTrackEvent),this.track_.removeEventListener(xt,this.handleTrackEvent))}stop(){this.unbindEvents(),this.div_&&this.div_.removeChild(this.element_),this.element_.srcObject=null,this.element_=null}async resume(){try{await this.element_.play()}catch(e){this.log_.warn("<video> play() error: "+e);const t=Fr({key:Xn,data:{error:e}});if(t.startsWith("NotAllowedError"))throw new Yc({code:Xc.PLAY_NOT_ALLOWED,message:t})}}getVideoFrame(){const e=document.createElement("canvas");e.width=this.element_.videoWidth,e.height=this.element_.videoHeight;return e.getContext("2d").drawImage(this.element_,0,0),e.toDataURL("image/png")}on(e,t){this.emitter_.on(e,t)}getElement(){return this.element_?this.element_:null}}class Xl{constructor(e,t){this.connection_=e,this.log_=t,this.seiMessageList_=[],this.abortController_=null,this.seiPayloadType_=243,this.senderOrReceiver_=null,this.onSEIMessage=null}get isRunning(){return!!this.abortController_}start(e,t){if(this.senderOrReceiver_===e)return;this.senderOrReceiver_=e;const i=e.createEncodedStreams(),n=i.readable,s=i.writable,r=new TransformStream({transform:t?this.encodeVideoFrame.bind(this):this.decodeVideoFrame.bind(this)});this.abortController_=new AbortController,n.pipeThrough(r).pipeTo(s,{signal:this.abortController_.signal}).catch(()=>{})}restart(e,t){this.stop(),this.start(e,t)}stop(){var e;null===(e=this.abortController_)||void 0===e||e.abort(),this.abortController_=null}destory(){this.stop(),this.log_=null,this.onSEIMessage=null,this.senderOrReceiver_=null,this.connection_=null}push(e,t){t&&t.seiPayloadType&&(this.seiPayloadType_=t.seiPayloadType),this.seiMessageList_.push(e)}hasSEI(e){const t=new DataView(e);return 1===t.getInt32(0)&&6===t.getInt8(4)}isEmptyFrame(e){return"empty"===e.type||0===e.data.byteLength}getNaluCount(e){let t=0,i=0;const n=new DataView(e);for(let s=0;s<e.byteLength;s++)switch(n.getUint8(s)){case 0:t++;break;case 1:2!==t&&3!==t||i++,t=0;break;default:t=0}return i}encodeVideoFrame(e,t){try{if(this.connection_.isH264&&this.seiMessageList_.length>0&&!this.isEmptyFrame(e)){const t=9-this.getNaluCount(e.data);if(t<=0)return;const i=this.seiMessageList_.splice(0,t).reverse().map(this.encodeSEINalu.bind(this)),n=i.reduce((e,t)=>e+t.dataView.byteLength,0),s=new ArrayBuffer(n+e.data.byteLength),r=new DataView(s),o=new DataView(e.data);let a=0;for(let e=0;e<i.length;e++)for(let t=0;t<i[e].dataView.byteLength;t++)r.setInt8(a++,i[e].dataView.getInt8(t));for(let c=0;c<e.data.byteLength;c++)r.setInt8(a++,o.getInt8(c));e.data=s,this.log_.debug(i.length+" sei sent")}}catch(i){this.log_.warn(i)}t.enqueue(e)}decodeVideoFrame(e,t){try{if(this.connection_.isH264&&!this.isEmptyFrame(e)&&this.hasSEI(e.data)){const t=[],i=new DataView(e.data);let n=0,s=-1,r=-1;for(let o=0;o<e.data.byteLength;o++){const a=i.getUint8(o);if(0===a)n++;else if(1===a){if(2===n||3===n){const a=o-n;-1===s?s=a:-1===r&&(r=a,t.push(new Yl(new DataView(i.buffer.slice(s,r)))),s=a,r=-1);if(!(6===i.getUint8(o+1))){e.data=new DataView(i.buffer.slice(a)).buffer;break}}n=0}else n=0}this.log_.debug(t.length+" sei received"),Wr(this.onSEIMessage)&&t.reverse().forEach(e=>{this.onSEIMessage({seiPayloadType:e.seiPayloadType,data:e.seiPayload.buffer})})}}catch(i){this.log_.warn(i)}t.enqueue(e)}encodeSEINalu(e){const t=e.byteLength,i=parseInt(t/255),n=t%255,s=[];s.push(0,0,0,1,6,this.seiPayloadType_);for(let o=0;o<i;o++)s.push(255);s.push(n);const r=new DataView(e);return s.push(...new Uint8Array(r.buffer)),s.push(128),new Yl(new DataView(new Uint8Array(s).buffer),!0)}}class Yl{constructor(e,t=!1){this.dataView=e,this.isSEI&&(t?this.addPreventionByte():this.removePreventionByte())}addPreventionByte(){const e=this.seiPayloadStartIndex,t=this.dataView.byteLength-2,i=[];let n=0;for(let r=e;r<=t;r++){const e=this.dataView.getInt8(r);switch(e){case 0:case 1:case 2:case 3:2===n&&(i.push(3),n=0),0==e?n++:n=0,i.push(e);break;default:n=0,i.push(e)}}i.push(this.dataView.getInt8(this.dataView.byteLength-1));const s=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=s}removePreventionByte(){const e=this.seiPayloadStartIndex,t=this.dataView.byteLength-1,i=[];let n=0;for(let r=e;r<=t;r++)switch(this.dataView.getInt8(r)){case 0:n++,i.push(this.dataView.getInt8(r));break;case 3:2!==n&&i.push(this.dataView.getInt8(r)),n=0;break;default:i.push(this.dataView.getInt8(r)),n=0}const s=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=s}get isSEI(){return 6===this.dataView.getUint8(4)}get seiPayloadStartIndex(){let e=6;for(let t=6;t<this.dataView.buffer.byteLength&&(e++,255===this.dataView.getUint8(t));t++);return e}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let e=0,t=6;for(let s=6;s<this.dataView.buffer.byteLength;s++){const i=this.dataView.getUint8(s);if(t++,255!==i){e+=i;break}e+=255}const i=new ArrayBuffer(e),n=new DataView(i);for(let s=0;s<i.byteLength;s++,t++)n.setInt8(s,this.dataView.getInt8(t));return n}}class Zl{constructor(e){this.userId_=e.userId,this.tinyId_=e.tinyId,this.client_=e.client,this.sdpSemantics_=e.client.getSdpSemantics(),this.isUplink_=e.isUplink,this.log_=vc.createLogger({id:"n|"+this.userId_,userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId(),isLocal:this.isUplink_}),this.signalChannel_=e.signalChannel,this.peerConnection_=null,this.connectTimer_=-1,this.isErrorObserved_=!1,this.emitter_=new Ia,this.currentState_=vi,this.waitForPeerConnectionConnectedPromise_=null,this.isReconnecting_=!1,this.reconnectionCount_=0,this.reconnectionTimer_=-1,this.isFirstConnection_=!0,this.delay_={audioDelay:0,videoDelay:0},this.enableSEI_=e.enableSEI,this.enableSEI_&&_l&&(this.sei_=new Xl(this,this.log_))}initialize(){const e={encodedInsertableStreams:this.enableSEI_&&_l,iceServers:this.client_.getIceServers(),iceTransportPolicy:this.client_.getIceTransportPolicy(),sdpSemantics:this.sdpSemantics_,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this.peerConnection_=new RTCPeerConnection(e),this.peerConnection_.onconnectionstatechange=this.onConnectionStateChange.bind(this)}close(){this.log_.info("closing connection"),this.closePeerConnection(),this.sei_&&(this.sei_.destory(),this.sei_=null)}closePeerConnection(e=!1){this.peerConnection_&&(this.peerConnection_.onconnectionstatechange=()=>{},this.peerConnection_.close(),this.peerConnection_=null,e&&this.emitConnectionStateChangedEvent(vi))}getDTLSTransportState(){if(!this.peerConnection_)return"unknown";let e=null;if(this.isUplink_){if(!al()||0===this.peerConnection_.getSenders().length)return"unknown";e=this.peerConnection_.getSenders()[0].transport}else{if(!ol()||0===this.peerConnection_.getReceivers().length)return"unknown";e=this.peerConnection_.getReceivers()[0].transport}return e?e.state:"unknown"}onConnectionStateChange(e){const t=this.peerConnection_.iceConnectionState,i=this.getDTLSTransportState();if(this.log_.info("onConnectionStateChange() connectionState: "+e.target.connectionState),this.log_.info(`ICE Transport state: ${t}, DTLS Transport state: ${i}`),e.target.connectionState===Ei&&this.emitConnectionStateChangedEvent(Si),e.target.connectionState===bi||e.target.connectionState===Ri){const n=`${this.isUplink_?"uplink":"downlink"} ICE/DTLS Transport connection ${e.target.connectionState}. ICE Transport state: ${t}, DTLS Transport state: ${i}`,s=new Yc({message:n,code:Xc.ICE_TRANSPORT_ERROR});Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Ji,error:s}),this.emitConnectionStateChangedEvent(vi),this.isErrorObserved_||this.emitter_.emit(Rl.ERROR,s)}e.target.connectionState!==wi&&e.target.connectionState!==ki||(this.logSelectedCandidate(),Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:Ji}),this.emitConnectionStateChangedEvent(Ii))}emitConnectionStateChangedEvent(e){e!==this.currentState_&&(this.currentState_===yi&&e===Si||(Ta.emit(dc,{client:this.client_,connection:this,prevState:this.currentState_,state:e}),this.emitter_.emit(Rl.CONNECTION_STATE_CHANGED,{prevState:this.currentState_,state:e}),this.currentState_=e))}hitTest(e){return(0===e||"0"===e)&&this.isUplink_||e===this.tinyId_}addEventInternal(e,t){const i=this.client_.getUserId();let n={eventId:e,eventDesc:t,timestamp:me(),userId:i,tinyId:this.client_.getTinyId()};this.isUplink_||(n.remoteUserId=this.userId_,n.remoteTinyId=this.tinyId_),xd(i,n)}getPeerConnection(){return this.peerConnection_}getClient(){return this.client_}getUserId(){return this.userId_}getTinyId(){return this.tinyId_}async logSelectedCandidate(){if(!this.peerConnection_)return;const e=await this.peerConnection_.getStats();for(let[t,i]of e)if(ml(i)){const t=e.get(i.localCandidateId),n=e.get(i.remoteCandidateId);t&&this.log_.info(`local candidate: ${t.candidateType} ${t.protocol}:${t.ip||t.address}:${t.port} ${t.networkType||""} ${"relay"===t.candidateType?"relayProtocol:"+t.relayProtocol:""}`),n&&this.log_.info(`remote candidate: ${n.candidateType} ${n.protocol}:${n.ip||n.address}:${n.port}`);break}}getCurrentState(){return this.currentState_}waitForPeerConnectionConnected(){return this.waitForPeerConnectionConnectedPromise_||(this.waitForPeerConnectionConnectedPromise_=new Promise((e,t)=>{if(this.currentState_===Ii)return e();let i=-1;const n=t=>{t.state===Ii&&(clearTimeout(i),this.emitter_.off(Rl.CONNECTION_STATE_CHANGED,n,this),e())};i=setTimeout(()=>{this.emitter_.off(Rl.CONNECTION_STATE_CHANGED,n,this);let e=new Yc({code:Xc.API_CALL_TIMEOUT,message:"connection timeout"});t(e)},1e4),this.emitter_.on(Rl.CONNECTION_STATE_CHANGED,n,this)}),this.waitForPeerConnectionConnectedPromise_=this.waitForPeerConnectionConnectedPromise_.then(e=>(this.waitForPeerConnectionConnectedPromise_=null,e)).catch(e=>{throw this.waitForPeerConnectionConnectedPromise_=null,e})),this.waitForPeerConnectionConnectedPromise_}getReconnectionCount(){return this.reconnectionCount_}startReconnection(){this.isReconnecting_=!0,this.emitConnectionStateChangedEvent(yi),this.reconnect(),this.addEventInternal(this.isUplink_?wd:Dd,(this.isUplink_?"uplink":"downlink")+"-connection is reconnecting")}stopReconnection(){this.log_.info("stop reconnection"),this.isReconnecting_=!1,this.reconnectionCount_=0,this.clearReconnectionTimer(),this.signalChannel_.off(Ec,this.reconnect,this)}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){this.emitter_.off(e,t,i)}setDelay({audioDelay:e,videoDelay:t}){this.delay_={audioDelay:e,videoDelay:t}}getDelay(){return this.delay_}get isH264(){var e;return!(null===(e=this.peerConnection_)||void 0===e||!e.remoteDescription.sdp.includes("H264"))}}var eh=new class{constructor(){this.set_=new Set,Ta.on(Ea,this.add,this),Ta.on(Ca,this.add,this),Ta.on(wa,this.delete,this),Ta.on(Da,this.delete,this)}add({client:e,roomId:t}){if("rtc"===e.getMode())return;const i=this.getKey(e.getUserId(),t||e.getRoomId(),e.getSDKAppId(),e.getUseStringRoomId());this.set_.add(i)}delete({client:e}){if("rtc"===e.getMode())return;const t=this.getKey(e.getUserId(),e.getRoomId(),e.getSDKAppId(),e.getUseStringRoomId());this.set_.delete(t)}getKey(e,t,i,n){return`${i}_${t}_${e}_${n}`}isJoined({userId:e,roomId:t,sdkAppId:i,client:n}){return"rtc"!==n.getMode()&&this.set_.has(this.getKey(e,t,i,n.getUseStringRoomId()))}};function th(e,t,i,n){if(this.useStringRoomId_){if(!(Kr(e)&&/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(e)))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:ss,data:t,link:{className:n,fnName:i}})})}else{if(!(Qr(e)&&/^[1-9]\d*$/.test(String(e))&&e<4294967295))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:rs,data:t,link:{className:n,fnName:i}})})}}function ih(e,t,i,n){if(!/^[A-Za-z\d_-]*$/.test(e))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:bs,data:t,link:{className:n,fnName:i}})})}var nh,sh,rh={TRTC:{createClient:{name:"clientConfig",required:!0,type:un,properties:{sdkAppId:{required:!0,type:dn,allowEmpty:!1},userId:{required:!0,type:cn,allowEmpty:!1},userSig:{required:!0,type:cn,allowEmpty:!1},mode:{required:!0,type:cn,values:["rtc","live"]},useStringRoomId:{type:ln},autoSubscribe:{type:ln},enableAutoPlayDialog:{type:ln},streamId:{type:cn},userDefineRecordId:{type:cn},pureAudioPushMode:{type:dn,values:[1,2]},enableSEI:{type:ln}}},createStream:{name:"streamConfig",required:!0,type:un,properties:{userId:{type:cn},audio:{type:ln},video:{type:ln},screen:{type:ln},screenAudio:{type:ln},microphoneId:{type:cn},cameraId:{type:cn},facingMode:{type:[cn,un]},audioSource:{instanceOf:window.MediaStreamTrack},videoSource:{instanceOf:window.MediaStreamTrack}},validate:function(e){if(!qr(e.screen)&&e.screen&&qr(e.audio)&&(e.audio=!1),!(qr(e.audio)&&qr(e.video)||qr(e.audioSource)&&qr(e.videoSource)))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:hr})});if(!qr(e.screen)&&!0===e.screen&&!0===e.video)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:ur})});if(e.audio&&e.screenAudio)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:pr})});if(!0!==e.screen&&!0===e.screenAudio)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:_r})});if(!qr(e.screen)&&!0===e.screen&&!this.isScreenShareSupported())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ir})})}}},CLIENT:{join:{name:"options",required:!0,properties:{roomId:{required:!0,type:[dn,cn],allowEmpty:!1,validate:th},role:{type:[cn],values:["anchor","audience"]},privateMapKey:{type:[cn]}},validate:function(e){if(this.isJoined_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ns})});if(this.checkDestroy(),eh.isJoined({userId:this.userId_,roomId:e.roomId,sdkAppId:this.sdkAppId_,client:this}))throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Xs,data:this.userId_})})}},publish:{name:"stream",required:!0,instanceOf:Rn,validate:function(e){if(!this.isJoined_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ls})});if("live"===this.mode_&&"audience"===this.role_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:us})});if(this.localStream_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:_s})});if(!e.getIsReadyToPublish())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ps})});if(this.notPublishWithoutH264Supported_)throw new Yc({code:Xc.NOT_SUPPORTED_H264,message:Fr({key:vr})})}},unpublish:{name:"stream",required:!0,instanceOf:Rn,validate:function(e){if(e!==this.localStream_){if(this.localStream_)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:hs})});this.log_.warn("Client currently has no published stream, please call publish() first.")}}},subscribe:[{name:"stream",required:!0,instanceOf:Cn,validate:function(e){if(!e.getConnection())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ms})});if(this.notSubscribeWithoutH264Supported_)throw new Yc({code:Xc.NOT_SUPPORTED_H264,message:Fr({key:Sr})})}},{name:"options",type:un,properties:{audio:{type:ln},video:{type:ln}},validate:function({audio:e,video:t}){if(!(qr(e)||qr(t)||e||t))throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:kr})})}}],unsubscribe:{name:"stream",required:!0,instanceOf:Cn,validate:function(e){if(!e.getConnection())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ms})})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate:function(){if("live"!==this.mode_)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:fs})});if(!this.isJoined_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:vs})})}},startPublishCDNStream:{name:"options",required:!1,properties:{streamId:{type:cn,validate:ih},appId:{type:dn,allowEmpty:!1},bizId:{type:dn,allowEmpty:!1},url:{type:cn,allowEmpty:!1}},validate:function(){if(this.isDestroyed_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ys,data:{funName:"startPublishCDNStream"}})})}},startMixTranscode:{name:"config",required:!0,type:un,properties:{mode:{type:cn,values:["preset-layout","manual"]},streamId:{type:cn,validate:ih},videoWidth:{type:dn,notLessThanZero:!0},videoHeight:{type:dn,notLessThanZero:!0},videoBitrate:{type:dn,notLessThanZero:!0,allowEmpty:!1},videoFramerate:{type:dn,validate:function(e,t,i,n){if(e<=0||e>30)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:nr,link:{className:n,fnName:i}})})}},videoGop:{type:dn,validate:function(e,t,i,n){if(e<1||e>8)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:sr,link:{className:n,fnName:i}})})}},audioSampleRate:{type:dn,notLessThanZero:!0},audioBitrate:{type:dn,validate:function(e,t,i,n){if(e<32||e>192)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:rr,link:{className:n,fnName:i}})})}},audioChannels:{type:dn,values:[1,2]},backgroundColor:{type:dn},backgroundImage:{type:cn},mixUsers:{required:!0,type:hn,arrayItem:{require:!0,type:un,properties:{userId:{required:!0,type:cn},roomId:{type:[cn,dn],validate:th},pureAudio:{type:ln},width:{type:dn,notLessThanZero:!0},height:{type:dn,notLessThanZero:!0},locationX:{type:dn,notLessThanZero:!0},locationY:{type:dn,notLessThanZero:!0},zOrder:{type:dn},streamType:{type:cn,values:["main","auxiliary"]},renderMode:{type:dn,values:[0,1,2,4]}}}}},validate:function(e,t,i,n,s){let r=0,o=0;const a=e.mixUsers,c=[];if(a.forEach((e,t)=>{if(c.push(e.userId),!e.pureAudio){if(!e.zOrder||e.zOrder<1||e>15)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:or,data:`config.mixUsers[${t}].zOrder`,link:{className:n,fnName:i}})});e.width+e.locationX>r&&(r=e.width+e.locationX),e.height+e.locationY>o&&(o=e.height+e.locationY)}}),c.indexOf(this.getUserId())<0)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:ar,link:{className:n,fnName:i}})});if(e.videoWidth<r||e.videoHeight<o)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:cr,link:{className:n,fnName:i}})})}},sendSEIMessage:[{name:"buffer",required:!0,instanceOf:ArrayBuffer,validate:function(e){if(!_l)throw new Yc({code:Xc.NOT_SUPPORTED,message:Fr({key:Ar})});if(!this.enableSEI_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Dr})});if(e.byteLength>1e3)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Nr,data:e.byteLength})});if(0===e.byteLength)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Pr})});if(!this.uplinkConnection_)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Mr})});if(!this.localStream_.hasVideo())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Lr})});const t=this.uplinkConnection_.isH264;if(!t)throw new Yc({code:Xc.NOT_SUPPORTED,message:Fr({key:Ar,data:t})})}},{name:"options",type:un,properties:{seiPayloadType:{type:dn,values:[5,243]}}}]},LOCAL_STREAM:{switchDevice:[{name:"type",required:!0,type:cn,values:[At,Dt]},{name:"deviceId",required:!0,type:cn,validate:function(){if(this.screen_&&!this.audio_||this.audioSource_||this.videoSource_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Os})});if(this.publishState_===fn)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:xs})})}}],setAudioCaptureVolume:{name:"volume",type:dn}},STREAM:{play:[{name:"elementId",required:!0,type:[cn,"HTMLDivElement"],validate:function(e,t,i){if(Kr(e)){const n=document.getElementById(e);if(!n)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:dr,data:{key:t,fnName:i}})});if(!(n instanceof HTMLDivElement))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:lr,data:{key:t,fnName:i,type:eo(n)}})})}}},{name:"options",type:un,properties:{objectFit:{type:cn,values:["contain","cover","fill"]},muted:{type:ln},mirror:{type:ln}}}]}};function oh(...e){return function(t,i,n){const s=n.value;return n.value=function(...t){return ch.call(this,e,t,i,this.name_),s.apply(this,t)},n}}function ah(...e){return function(t,i,n){const s=n.value;return n.value=async function(...t){return ch.call(this,e,t,i,this.name_),s.apply(this,t)},n}}function ch(e,t,i,n){try{for(let s=0;s<e.length;s++)dh.call(this,{rule:e[s],value:t[s],key:e[s].name,fnName:i,className:n})}catch(s){throw vc.error(s),s}}function dh({rule:e,value:t,key:i,fnName:n,className:s}){if(qr(t)){if(e.required)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Un,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})});return}if(Array.isArray(e.type)){if(!e.type.map(e=>e.toLowerCase()).includes(eo(t)))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Vn,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})})}else if(!qr(e.type)&&eo(t)!==e.type)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Vn,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})});if(!1===e.allowEmpty){const r=Qr(t)&&(0===t||Number.isNaN(t)),o=Kr(t)&&""===t.trim();if(r||o)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Fn,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})})}if(e.notLessThanZero&&Qr(t)&&t<0)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:ir,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})});if(Kr(e.instanceOf)){if(!t||t.name_!==e.instanceOf)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:$n,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})})}else if(Wr(e.instanceOf)&&!(t instanceof e.instanceOf))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:$n,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})});if(e.values&&!e.values.includes(t))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Bn,data:{key:i,rule:e,fnName:n,value:t},link:{className:s,fnName:n}})});const{properties:r}=e;Gr(r)&&"object"===eo(t)&&Object.keys(r).forEach(e=>{dh.call(this,{rule:r[e],value:t&&t[e],key:`${i}.${e}`,fnName:n,className:s})});const{arrayItem:o}=e;Gr(o)&&Yr(t)&&t.forEach((e,t)=>{dh.call(this,{rule:o,value:e,key:`${i}[${t}]`,fnName:n,className:s})}),Wr(e.validate)&&e.validate.call(this,t,i,n,s,this)}let lh=(nh=ah(...rh.STREAM.play),e((sh=class{constructor(e){this.name_=wn,this.userId_=e.userId,this.isRemote_=e.isRemote,this.type_=e.type,this.log_=vc.createLogger({id:`s${e.seq?e.seq:""}|${this.userId_}`,userId:qr(e.client)?void 0:e.client.getUserId(),sdkAppId:qr(e.client)?void 0:e.client.getSDKAppId(),isLocal:!this.isRemote_,type:this.isRemote_?this.type_:""}),this.client_=null,qr(e.client)||(this.client_=e.client),this.mediaStream_=null,this.div_=null,this.isPlaying_=!1,this.connection_=null,this.audioPlayer_=null,this.videoPlayer_=null,this.muted_=!1,this.objectFit_="cover",this.mirror_=!1,this.id_=Xd(),this.audioOutputDeviceId_=0,this.audioVolume_=1,this.emitter_=co(new Ia,this.name_),this.connectionState_=vi,this.installEvents(),qr(e.mirror)||this.log_.warn(`TRTC.createStream "mirror" option was deprecated since v4.12.1please use localStream.play to set up preview mirror. refer to ${Pn}/en/LocalStream.html#play. TRTC.createStream  mirror  v4.12.1  localStream.play ${Pn}/zh-cn/LocalStream.html#play`)}installEvents(){Ta.on(uc,this.restartPlayback,this)}uninstallEvents(){Ta.off(uc,this.restartPlayback,this)}getType(){return this.type_}getLogger(){return this.log_}get isSubscribed(){return this.type_===gi&&this.connection_.isMainStreamSubscribed||this.type_===fi&&this.connection_.isAuxStreamSubscribed}get isMainVideoSubscribed(){const e=this.getSubscribedState();return this.type_===gi&&e&&e.video}get isMainAudioSubscribed(){const e=this.getSubscribedState();return this.type_===gi&&e&&e.audio}get isAuxVideoSubscribed(){const e=this.getSubscribedState();return this.type_===fi&&e&&e.auxiliary}get isSmallVideoSubscribed(){const e=this.getSubscribedState();return this.type_===gi&&e&&e.smallVideo}emitConnectionStateChanged(e){e.state!==this.connectionState_&&(e.state!==vi&&this.isRemote_&&!this.isSubscribed||(this.emitter_.emit(Al,e),this.connectionState_=e.state))}setConnection(e){this.connection_!==e&&(e instanceof Zl?(null!==this.connection_&&this.connection_.off(Rl.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this),e.on(Rl.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this)):null===e&&this.connection_.off(Rl.CONNECTION_STATE_CHANGED,this.emitConnectionStateChanged,this),this.connection_=e)}getConnection(){return this.connection_}async play(e,t){if(this.log_.info(`stream ${this.isPlaying_?"update":"start to"} play with elementId: ${e} and options: ${JSON.stringify(t)}.`),this.isPlaying_){if(t&&!qr(t.muted)&&(this.muted_=t.muted),t&&!qr(t.objectFit)&&(this.objectFit_=t.objectFit),this.isScreenShare()?this.mirror_=!1:t&&!qr(t.mirror)&&(this.mirror_=t.mirror),this.audioPlayer_&&this.audioPlayer_.setMuted(this.muted_),this.videoPlayer_&&(this.videoPlayer_.setObjectFit(this.objectFit_),this.videoPlayer_.setMirror(this.mirror_)),this.elementId_!==e){let t=e;Kr(e)&&(t=document.getElementById(e)),t.appendChild(this.div_),this.elementId_=e}return}this.isPlaying_=!0;const i=document.createElement("div");i.setAttribute("id","player_"+this.id_),i.setAttribute("style","width: 100%; height: 100%; position: relative; background-color: black; overflow: hidden;");let n=e;Kr(e)&&(n=document.getElementById(e)),n.appendChild(i),this.elementId_=e,this.div_=i,this.isRemote_||(this.muted_=!0),t&&!qr(t.muted)&&(this.muted_=t.muted),this.isScreenShare()&&(this.objectFit_="contain"),t&&!qr(t.objectFit)&&(this.objectFit_=t.objectFit),this.isScreenShare()?this.mirror_=!1:(this.isRemote_||(this.mirror_=!0),t&&!qr(t.mirror)&&(this.mirror_=t.mirror)),Ta.emit(nc,{stream:this}),await Promise.all([this.playAudio(),this.playVideo()]),Ta.emit($a,{stream:this})}async playAudio(){if(!this.hasAudio()||this.isRemote_&&!this.isMainAudioSubscribed)return;const e=this.getAudioTrack();if(!this.audioPlayer_&&e){var t;this.log_.info("stream - create AudioPlayer and play"),this.audioPlayer_=new jl({stream:this,track:e,gainedTrack:null===(t=this.gain_)||void 0===t?void 0:t.audioTrack,div:this.div_,muted:this.muted_,outputDeviceId:this.audioOutputDeviceId_,volume:this.audioVolume_}),this.audioPlayer_.on(Nl,e=>{const t={type:At,state:e.state,reason:e.reason};Ta.emit(Ba,{stream:this,...t}),this.emitter_.emit(wl,t)});try{await this.audioPlayer_.play()}catch(i){throw this.client_&&this.client_.getEnableAutoPlayDialog()&&new Kl,this.emitter_.emit(Pl,i),i}}}async playVideo(){if(!this.hasVideo()||this.isRemote_&&!this.isMainVideoSubscribed&&!this.isAuxVideoSubscribed&&!this.isSmallVideoSubscribed)return;const e=this.getVideoTrack();if(!this.videoPlayer_&&e){Ta.emit(rc,{stream:this}),this.log_.info("stream - create VideoPlayer and play"),this.videoPlayer_=new Ql({stream:this,track:e,div:this.div_,muted:this.muted_,objectFit:this.objectFit_,mirror:this.mirror_}),this.videoPlayer_.on(Nl,e=>{const t={type:Dt,state:e.state,reason:e.reason};Ta.emit(Ba,{stream:this,...t}),this.emitter_.emit(wl,t)});try{await this.videoPlayer_.play()}catch(t){throw this.client_&&this.client_.getEnableAutoPlayDialog()&&new Kl,this.emitter_.emit(Pl,t),t}}}stopAudio(){this.audioPlayer_&&(this.log_.info("stream - stop AudioPlayer"),this.audioPlayer_.stop(),this.audioPlayer_=null)}stopVideo(){this.videoPlayer_&&(this.log_.info("stream - stop VideoPlayer"),this.videoPlayer_.stop(),this.videoPlayer_=null)}restartPlayback(){this.audioPlayer_&&!this.audioPlayer_.isPlaying&&this.restartAudio(),this.videoPlayer_&&!this.videoPlayer_.isPlaying&&this.restartVideo()}restartAudio(){this.isPlaying_&&(this.stopAudio(),this.playAudio().catch(e=>{}))}restartVideo(){this.isPlaying_&&(this.stopVideo(),this.playVideo().catch(e=>{}))}stop(){this.isPlaying_&&(this.isPlaying_=!1,this.stopAudio(),this.stopVideo(),this.div_.parentNode.removeChild(this.div_))}async resume(){this.isPlaying_&&(this.log_.info("stream - resume"),this.audioPlayer_&&await this.audioPlayer_.resume(),this.videoPlayer_&&await this.videoPlayer_.resume())}close(){this.isPlaying_&&this.stop(),this.isRemote_||(this.mediaStream_&&(this.mediaStream_.preventEvent=1,this.mediaStream_.getTracks().forEach(e=>{e.stop()}),this.mediaStream_=null),this.uninstallEvents())}muteAudio(){return this.addRemoteEvent(!0,At),this.doEnableTrack(At,!1)}muteVideo(){return this.addRemoteEvent(!0,Dt),this.doEnableTrack(Dt,!1)}unmuteAudio(){return this.addRemoteEvent(!1,At),this.doEnableTrack(At,!0)}unmuteVideo(){return this.addRemoteEvent(!1,Dt),this.doEnableTrack(Dt,!0)}addRemoteEvent(e,t){if(this.isRemote_&&this.client_){const i=this.client_.getUserId();let n,s=`${e?Ot:xt} remote ${t}`;n=t===At?e?md:fd:e?_d:gd,xd(i,{eventId:n,eventDesc:s,timestamp:(new Date).getTime(),userId:i,tinyId:this.client_.getTinyId(),remoteUserId:this.userId_,remoteTinyId:this.connection_.getTinyId()})}}doEnableTrack(e,t){let i=!1;return e===At?this.mediaStream_.getAudioTracks().forEach(e=>{i=!0,e.enabled=t}):this.mediaStream_.getVideoTracks().forEach(e=>{i=!0,e.enabled=t}),i}getId(){return this.id_}getUserId(){return this.userId_}getTinyId(){return this.connection_?this.connection_.getTinyId():""}isPlaying(){return this.isPlaying_}async setAudioOutput(e){this.audioOutputDeviceId_=e,this.audioPlayer_&&await this.audioPlayer_.setSinkId(e)}setAudioVolume(e){this.audioVolume_=e,this.log_.info("setAudioVolume to "+e),this.audioPlayer_&&this.audioPlayer_.setVolume(e)}getAudioLevel(){let e=0;return this.audioPlayer_&&(e=this.audioPlayer_.getAudioLevel()),e}getInternalAudioLevel(){let e=0;return this.audioPlayer_&&(e=this.audioPlayer_.getInternalAudioLevel()),e}hasAudio(){if(this.isRemote_){if(!this.connection_)return!1;const e=this.connection_.getTrackState();return this.type_===gi&&e.audio}return!!this.getAudioTrack()}hasVideo(){if(this.isRemote_){if(!this.connection_)return!1;const e=this.connection_.getTrackState();return this.type_===fi?e.auxiliary:e.video}return!!this.getVideoTrack()}getSubscribedState(){return this.isRemote_&&this.connection_?this.connection_.getSubscribeState():null}getAudioTrack(){let e=null;if(this.mediaStream_){const t=this.mediaStream_.getAudioTracks();t.length>0&&(e=t[0])}return e}getVideoTrack(){let e=null;if(this.mediaStream_){const t=this.mediaStream_.getVideoTracks();t.length>0&&(e=t[0])}return e}getVideoFrame(){return this.videoPlayer_?this.videoPlayer_.getVideoFrame():null}getMediaStream(){return this.mediaStream_}setMediaStream(e){e!==this.mediaStream_&&(this.mediaStream_&&this.mediaStream_.getTracks().forEach(e=>e.stop()),this.mediaStream_=e)}updateVideoPlayingState(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play video"),this.playVideo().catch(e=>{})):(this.log_.info("playing state updated, stop video"),this.stopVideo()))}updateAudioPlayingState(e){this.isPlaying_&&(e?(this.log_.info("playing state updated, play audio"),this.playAudio().catch(e=>{})):(this.log_.info("playing state updated, stop audio"),this.stopAudio()))}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}isRemote(){return this.isRemote_}isScreenShare(){return!this.isRemote_&&this.screen_||this.isRemote_&&this.getType()===Pt}getDiv(){return this.div_}getObjectFit(){return this.objectFit_}getMuted(){return this.muted_}getClient(){return this.client_}}).prototype,"play",[nh],Object.getOwnPropertyDescriptor(sh.prototype,"play"),sh.prototype),sh);class hh extends lh{constructor(e){const t={isRemote:!0,type:e.type};super({...e,...t}),this.name_=Cn,this.isStreamAddedEventEmitted_=!1,this.isAbleToCallSubscription_=!0}installEvents(){super.installEvents(),Ta.on(Wa,this.handleStreamSubscribed,this),Ta.on(qa,this.handleStreamUnsubscribed,this)}uninstallEvents(){super.uninstallEvents(),Ta.off(Wa,this.handleStreamSubscribed,this),Ta.off(qa,this.handleStreamUnsubscribed,this)}handleStreamSubscribed(e){e.client===this.client_&&e.stream===this&&this.connection_.getCurrentState()===Ii&&this.emitConnectionStateChanged({prevState:vi,state:Ii})}handleStreamUnsubscribed(e){e.client===this.client_&&e.stream===this&&this.emitConnectionStateChanged({prevState:Ii,state:vi})}getType(){return super.getType()}getIsAbleToCallSubscription(){return this.isAbleToCallSubscription_}setIsAbleToCallSubscription(e){this.isAbleToCallSubscription_=e}setIsStreamAddedEventEmitted(e){this.isStreamAddedEventEmitted_=e}getIsStreamAddedEventEmitted(){return this.isStreamAddedEventEmitted_}getAudioTrack(){if(!this.connection_)return null;return this.connection_.getTrackState().audio?super.getAudioTrack():null}getVideoTrack(){if(!this.connection_)return null;const e=this.connection_.getTrackState();return(this.type_!==gi||e.video)&&(this.type_!==fi||e.auxiliary)?super.getVideoTrack():null}close(){super.close()}}class uh{constructor(e){this.client_=e.client,this.subscribedStreams_=new Map,this.unsubscribedStreams_=new Map,this.subscriptedOptions_=new Map,this.autoRecoveryFlags_=new Map}get isEnabled(){return"webrtc"!==this.client_.getEnv()}async recover(e){const t=e.getUserId(),i=e.getType();if(!this.hasAutoRecoveryFlag(t,i))return;const n=this.getUnsubscribedStream(t,i)?"unsubscribe":"subscribe";try{vc.warn(`recover() try to recover subscription [${n}][${t}][${i}]`),"subscribe"===n?await this.recoverSubscription(t,e):await this.recoverUnsubscription(t,e),Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:Qi}),vc.warn(`recover() recover successfully [${n}][${t}][${i}]`)}catch(s){vc.error(`recover() recover failed [${n}][${t}][${i}]`,s),Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Qi,error:s})}this.deleteAutoRecoveryFlag(t,i)}async recoverSubscription(e,t){const i=this.getOptions(e,t.getType()),n=this.getSubscribedStream(e,t.getType());if(!i||!n)return;const{isAudioMuted:s,isVideoMuted:r}=this.getStreamMuteState(n);this.mergeStream(n,t),this.recoverPlayingState(n),s&&n.doEnableTrack(At,!1),r&&n.doEnableTrack(Dt,!1)}async recoverUnsubscription(e,t){const i=this.getUnsubscribedStream(e,t.getType());i&&this.mergeStream(i,t)}getStreamMuteState(e){const t={isAudioMuted:!1,isVideoMuted:!1},i=e.getMediaStream();return i&&(t.isAudioMuted=i.getAudioTracks().map(e=>e.enabled).includes(!1),t.isVideoMuted=i.getVideoTracks().map(e=>e.enabled).includes(!1)),t}recoverPlayingState(e){const t=e.isPlaying(),i=e.getDiv();if(t&&i){const t=i.parentNode;e.stop(),e.play(t,{objectFit:e.getObjectFit(),muted:e.getMuted()})}}mergeStream(e,t){const i=t.getConnection(),n=t.getMediaStream();e.setConnection(i),i.setRemoteStream(n.id,e),e.setMediaStream(n),e.updateAudioPlayingState(t.hasAudio()),e.updateVideoPlayingState(t.hasVideo())}addSubscriptionRecord(e,t,i){const n=t.getType();if(this.subscribedStreams_.has(e))this.subscribedStreams_.get(e).set(n,t);else{const i=new Map;i.set(t.getType(),t),this.subscribedStreams_.set(e,i)}if(this.subscriptedOptions_.has(e))this.subscriptedOptions_.get(e).set(n,i);else{const n=new Map;n.set(t.getType(),i),this.subscriptedOptions_.set(e,n)}this.deleteUnsubscriptionRecord(e,n)}addUnsubscriptionRecord(e,t){if(this.unsubscribedStreams_.has(e))this.unsubscribedStreams_.get(e).set(t.getType(),t);else{const i=new Map;i.set(t.getType(),t),this.unsubscribedStreams_.set(e,i)}this.deleteSubscriptionRecord(e,t.getType())}getSubscribedStream(e,t){return this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).has(t)?this.subscribedStreams_.get(e).get(t):null}getOptions(e,t){return this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).has(t)?this.subscriptedOptions_.get(e).get(t):null}getUnsubscribedStream(e,t){return this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).has(t)?this.unsubscribedStreams_.get(e).get(t):null}deleteSubscriptionRecord(e,t){this.subscribedStreams_.has(e)&&this.subscribedStreams_.get(e).delete(t),this.subscriptedOptions_.has(e)&&this.subscriptedOptions_.get(e).delete(t)}deleteUnsubscriptionRecord(e,t){this.unsubscribedStreams_.has(e)&&this.unsubscribedStreams_.get(e).delete(t)}markAllStream(){for(const[e,t]of[...this.subscribedStreams_.entries()])for(const[i]of[...t.entries()])this.setAutoRecoveryFlag(e,i);for(const[e,t]of[...this.unsubscribedStreams_.entries()])for(const[i]of[...t.entries()])this.setAutoRecoveryFlag(e,i)}setAutoRecoveryFlag(e,t){if(vc.info(`setAutoRecoveryFlag() mark [${e}][${t}]`),this.autoRecoveryFlags_.has(e))this.autoRecoveryFlags_.get(e).set(t);else{const i=new Map;i.set(t),this.autoRecoveryFlags_.set(e,i)}}hasAutoRecoveryFlag(e,t){return!!this.isEnabled&&(this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).has(t))}deleteAutoRecoveryFlag(e,t){this.autoRecoveryFlags_.has(e)&&this.autoRecoveryFlags_.get(e).delete(t)}delete(e){this.unsubscribedStreams_.delete(e),this.subscribedStreams_.delete(e),this.subscriptedOptions_.delete(e),this.autoRecoveryFlags_.delete(e)}}class ph{constructor(e){this.player_=e,this.canvas_=document.createElement(kt),this.canvasCtx_=this.canvas_.getContext("2d")}setCanvasRect(e,t){this.canvas_.width=e,this.canvas_.height=t}drawVideoToCanvas(){const e=this.player_.getElement();this.canvasCtx_.drawImage(e,0,0,this.canvas_.width,this.canvas_.height)}generateVideoTrackFromCanvasCapture(e){return this.canvas_.captureStream(e).getVideoTracks()[0]}generateStreamFromTrack(e){const t=new MediaStream;return t.addTrack(e),t}destroy(){this.player_.stop(),this.canvas_=null,this.canvasCtx_=null}get canvas(){return this.canvas_}get canvasCtx(){return this.canvasCtx_}get canDrawVideoToCanvas(){if(this.player_){const e=this.player_.getElement();if(e)return e.readyState===e.HAVE_ENOUGH_DATA}return!1}}let _h=new Blob(["let width,height,offscreen,ctx;onmessage=function(e){const{action,data}=e.data;switch(action){case'render':offscreen=data.canvas;width=offscreen.width;height=offscreen.height;ctx=offscreen.getContext('2d');draw(data.readable,data.writable);break}};function draw(readable,writable){const transformer=new TransformStream({async transform(cameraFrame,controller){ctx.drawImage(cameraFrame,0,0,width,height);const frame=new VideoFrame(offscreen,{timestamp:cameraFrame.timestamp});cameraFrame.close();controller.enqueue(frame)}});readable.pipeThrough(transformer).pipeTo(writable)}"],{type:"application/javascript"});class mh{constructor(e){const{videoTrack:t}=e;this.width=void 0,this.height=void 0,this.canvas=null,this.offscreen=null,this.smallGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.smallWritable=this.smallGenerator.writable,this.bigProcessor=new MediaStreamTrackProcessor({track:t}),this.bigReadable=this.bigProcessor.readable,this.initWorker()}initWorker(){try{this.worker=new Worker(URL.createObjectURL(_h)),vc.info("init worker processor success")}catch(e){vc.warn("init worker processor failed. "+e.error)}}setCanvasRect(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.offscreen=this.canvas.transferControlToOffscreen(),this.worker.postMessage({action:"render",data:{canvas:this.offscreen,readable:this.bigReadable,writable:this.smallWritable}},[this.offscreen,this.bigReadable,this.smallWritable])}generatorVideoTrack(){const e=new MediaStream([this.smallGenerator]);return null==e?void 0:e.getTracks()[0]}destroy(){this.worker.terminate()}}class gh{constructor(e){this.localStream_=e,this.player_=null,this.processor_=null,this.initOffscreenSuccess_=!1}async initialize(){var e,t,i,n;if((null===(t=window)||void 0===t?void 0:t.OffscreenCanvas)&&(null===(i=window)||void 0===i?void 0:i.MediaStreamTrackProcessor)&&(null===(n=window)||void 0===n?void 0:n.MediaStreamTrackGenerator)&&(null===(e=navigator)||void 0===e?void 0:e.hardwareConcurrency)>=6)try{await this.initOffscreen(),this.initOffscreenSuccess_=!0,vc.info("Initialize VideoGenerator successfully!")}catch(s){this.initCanvas()}else this.initCanvas()}generateSmallVideoTrack(e){const t=this.getSmallVideoProfile(e);let i;return this.initOffscreenSuccess_?(this.processor_.setCanvasRect(t.width,t.height),i=this.processor_.generatorVideoTrack()):(this.processor_.setCanvasRect(t.width,t.height),this.player_.setRect({width:t.width,height:t.height}),i=this.processor_.generateVideoTrackFromCanvasCapture(t.frameRate),this.interval_=Yd.setInterval(this.render.bind(this),Math.ceil(1e3/t.frameRate))),i}render(){this.processor_.canDrawVideoToCanvas&&this.processor_.drawVideoToCanvas()}destroy(){Yd.clearInterval(this.interval_),this.processor_&&this.processor_.destroy()}initOffscreen(){this.processor_=new mh({videoTrack:this.localStream_.getVideoTrack()})}initCanvas(){this.player_=new Ql({stream:this.localStream_,track:this.localStream_.getVideoTrack(),muted:!0,objectFit:"cover",mirror:!1}),this.player_.play().then(()=>{vc.info("VideoGenerator: play local video success")}).catch(()=>{vc.error("VideoGenerator: Failed to play local video")}),this.processor_=new ph(this.player_)}getSmallVideoProfile(e){const t=this.localStream_.getVideoTrack(),i=this.localStream_.getVideoProfile();let n,s=t.getSettings(),r=s&&s.width&&s.height?{width:s.width,height:s.height}:i;const o=r.width*r.height,a=e.width*e.height;vc.info(`big stream resolution: ${r.height}*${r.width} small stream resolution: ${e.height}*${e.width} `),o>a?n=o/a:(vc.warn(`Small stream resolution is larger than big stream, which is invalid. big: ${r.width} * ${r.height} small: ${e.width} * ${e.height}`),n=o/19200);return{width:parseInt(r.width/Math.sqrt(n)),height:parseInt(r.height/Math.sqrt(n)),frameRate:e.frameRate}}}const fh={voiceActivityDetection:!1};class vh extends Zl{constructor(e){super(e),this.localStream_=null,this.exchangeSDPTimeout_=-1,this.smallGenerator_=null,this.isSDPExchanging_=!1,this.ssrc_={audio:0,video:0,small:0},this.canvasTrack_=null}initialize(){super.initialize(),this.installEvents()}reset(){this.closePeerConnection(),this.uninstallEvents(),this.clearExchangeSDPTimeout(),this.canvasTrack_=null,this.localStream_&&this.localStream_.clearCanvas()}close(){this.reset(),this.emitConnectionStateChangedEvent(vi),this.smallGenerator_&&(this.smallGenerator_.destroy(),this.smallGenerator_=null)}installEvents(){this.emitter_.on(Rl.ERROR,this.handleError,this),this.emitter_.on(Rl.CONNECTION_STATE_CHANGED,this.handleConnectionStateChange,this)}uninstallEvents(){this.emitter_.off(Rl.ERROR,this.handleError,this),this.emitter_.off(Rl.CONNECTION_STATE_CHANGED,this.handleConnectionStateChange,this)}async publish(e){this.localStream_=e;const t=e.getMediaStream();this.log_.info("is publishing stream: "+e.getId());const i=this.localStream_.getAudioTrack(),n=this.localStream_.getVideoTrack();if(i){const e=this.localStream_.getGainedTrack();this.peerConnection_.addTrack(e||i,t)}if(n&&((Tt||It)&&Zr(n)?(this.canvasTrack_=this.localStream_.genCanvasTrack(n),this.peerConnection_.addTrack(this.canvasTrack_,t)):this.peerConnection_.addTrack(n,t),this.client_.getIsEnableSmallStream())){this.smallGenerator_=new gh(this.localStream_),await this.smallGenerator_.initialize();let e=this.smallGenerator_.generateSmallVideoTrack(this.client_.smallStreamConfig_);this.peerConnection_.addTrack(e,t)}return await this.connect(),e}updateMediaSettings(e){const t=this.getMediaSettings(e);this.signalChannel_.sendWaitForResponse({command:Qc,data:t,responseCommand:Pc.UPDATE_CONSTRAINT_CONFIG_RES}).then(e=>{0!==e.data.code&&this.log_.warn(e.data.message)}).catch(this.log_.warn)}getMediaSettings(e){const{detail:{isH264EncodeSupported:t,isVp8EncodeSupported:i}}=this.client_.getSystemResult();let n="";t?n="H264":i&&(n="VP8");let s={videoCodec:n,videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0};return El?e.getTracks().forEach(e=>{const t=e.getSettings();if(e.kind===At){let e=1;t.channelCount&&(e=t.channelCount),s.audioChannel=e,s.audioBps=1e3*this.localStream_.getAudioBitrate(),s.audioFs=t.sampleRate}else e.kind===Dt&&(this.client_.getIsEnableSmallStream()&&(s.smallVideoWidth=this.client_.smallStreamConfig.width,s.smallVideoHeight=this.client_.smallStreamConfig.height,s.smallVideoFps=this.client_.smallStreamConfig.framerate,s.smallVideoBps=1e3*this.client_.smallStreamConfig.bitrate),s.videoWidth=t.width,s.videoHeight=t.height,s.videoFps=t.frameRate,s.videoBps=1e3*this.localStream_.getVideoBitrate())}):s=this.getMediaSettingsFromProfile(s),this.log_.info("updateMediaSettings: "+JSON.stringify(s)),s}getMediaSettingsFromProfile(e){const t=this.localStream_;if(t){if(t.getAudioTrack()){const i=t.getAudioProfile();e.audioChannel=i.channelCount,e.audioBps=1e3*i.bitrate,e.audioFs=i.sampleRate}if(t.getVideoTrack()){const i=t.getVideoProfile();e.videoWidth=i.width,e.videoHeight=i.height,e.videoFps=i.frameRate,e.videoBps=1e3*i.bitrate}}return e}async addTrack(e){if(this.peerConnection_){e.kind===Dt&&(Tt||It)&&Zr(e)&&(e=this.canvasTrack_=this.localStream_.genCanvasTrack(e)),this.log_.info(`is adding ${e.kind} track to current published local stream`),cl()&&this.peerConnection_.getTransceivers().findIndex(e=>"stopped"===e.direction)>=0&&(this.log_.warn("transceiver is stopping, negotiate sdp first"),await this.updateOffer(_n,e));const t=this.peerConnection_.getSenders().find(t=>t.track&&t.track.kind===e.kind);if(t){this.log_.warn("sender already exists, remove sender first");const e=t.track;this.removeSender(t),await this.updateOffer(_n,e)}const i=this.localStream_.getMediaStream();this.peerConnection_.addTrack(e,i),await this.updateOffer(pn,e),xd(this.userId_,{eventId:e.kind===At?ed:Zc,eventDesc:`add ${e.kind} track to current published stream`,timestamp:me(),userId:this.userId_,tinyId:this.tinyId_})}}isNeedToResetOfferOrder(){if("plan-b"===this.sdpSemantics_||!this.peerConnection_||!this.peerConnection_.localDescription)return!1;const e=this.peerConnection_.localDescription.sdp,t=Kd(e);for(let i=0;i<t.media.length;i++)if(0===t.media[i].mid&&t.media[i].type===Dt)return!0;return!1}removeSender(e){let t=null;cl()&&(t=this.peerConnection_.getTransceivers().find(t=>t.sender&&t.sender.track===e.track)),this.peerConnection_.removeTrack(e),t&&Wr(t.stop)&&(this.log_.info("stop transceiver"),t.stop())}async removeTrack(e){if(this.peerConnection_&&al()){var t;if(e.kind===Dt&&(Tt||It)&&this.canvasTrack_&&(e=this.canvasTrack_,this.localStream_.clearCanvas()),this.log_.info(`is removing ${e.kind} track from current published local stream`),e.kind===Dt&&this.isNeedToResetOfferOrder())return this.reset(),this.initialize(),null===(t=this.localStream_.getMediaStream())||void 0===t||t.removeTrack(e),void(await this.publish(this.localStream_));const i=this.peerConnection_.getSenders().find(t=>t.track===e);i&&this.removeSender(i),await this.updateOffer(_n,e),xd(this.userId_,{eventId:e.kind===At?id:td,eventDesc:`remove ${e.kind} track from current published stream`,timestamp:me(),userId:this.userId_,tinyId:this.tinyId_})}}async replaceTrack(e){if(e.kind===Dt&&(Tt||It)&&this.canvasTrack_)return;if(!ll()||!al())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:yr})});if(!this.peerConnection_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Us})});const t=this.peerConnection_.getSenders();if(0===t.length)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Us})});t.forEach(t=>{t.track&&t.track.kind===e.kind&&(this.log_.info(`is replacing ${e.kind} track to current published local stream`),t.replaceTrack(e))}),xd(this.userId_,{eventId:e.kind===At?pd:ud,eventDesc:`replace ${e.kind} track from current published stream`,timestamp:me(),userId:this.userId_,tinyId:this.tinyId_})}async setBandwidth(e,t,i){if(!this.isUplink_)return i;if(!hl())return t===Dt?this.updateVideoBandwidthRestriction(i,e):this.updateAudioBandwidthRestriction(i,e);const n=this.peerConnection_.getSenders().find(e=>e.track&&e.track.kind===t);if(n){const r=n.getParameters();r.encodings&&0!==r.encodings.length||(r.encodings=[{}]),"unlimited"===e?delete r.encodings[0].maxBitrate:r.encodings[0].maxBitrate=1e3*e;try{return await n.setParameters(r),this.log_.info(t+" bandwidth was set to "+e+" kbps"),i}catch(s){return this.log_.info("failed to set bandwidth by setting maxBitrate: "+s),t===Dt?this.updateVideoBandwidthRestriction(i,e):this.updateAudioBandwidthRestriction(i,e)}}return i}async setSmallStreamBandwidth(e,t){if(!this.isUplink_)return t;if(!hl())return this.updateSmallVideoBandwidthRestriction(t,e);const i=this.peerConnection_.getSenders().filter(e=>e.track&&e.track.kind===Dt)[1];if(i){const s=i.getParameters();s.encodings&&0!==s.encodings.length||(s.encodings=[{}]),"unlimited"===e?delete s.encodings[0].maxBitrate:s.encodings[0].maxBitrate=1e3*e;try{return await i.setParameters(s),this.log_.info("small stream bandwidth was set to "+e+" kbps"),t}catch(n){return this.log_.info("failed to set small stream bandwidth by setting maxBitrate: "+n),this.updateSmallVideoBandwidthRestriction(t,e)}}return t}updateVideoBandwidthRestriction(e,t){let i="AS";return Ce&&(i="TIAS",t*=1e3),e=-1===e.indexOf("b="+i+":")?e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/,"m=video $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n"):e.replace(new RegExp("b="+i+":.*\r\n"),"b="+i+":"+t+"\r\n")}updateAudioBandwidthRestriction(e,t){let i="AS";return Ce&&(i="TIAS",t*=1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,"m=audio $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n")}updateSmallVideoBandwidthRestriction(e,t){let i="AS";Ce&&(i="TIAS",t*=1e3);let n=/m=video (.*)\r\nc=IN (.*)\r\n/g,s=[],r=n.exec(e);for(s.push(r);null!==r;)r=n.exec(e),s.push(r);let o=s[s.length-2],a=e.slice(0,o.index),c=e.slice(o.index);return-1===e.indexOf("b="+i+":")?(c=c.replace(/m=video (.*)\r\nc=IN (.*)\r\n/,"m=video $1\r\nc=IN $2\r\nb="+i+":"+t+"\r\n"),e=a+c):(c=c.replace(new RegExp("b="+i+":.*\r\n"),"b="+i+":"+t+"\r\n"),e=a+c),e}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}async connect(){try{await this.exchangeSDP(),await this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),e}}async exchangeSDP(){try{this.isSDPExchanging_=!0,await this.createOffer(),this.log_.info("createOffer success, sending offer to remote server"),await this.doExchangeSDP(),this.isSDPExchanging_=!1}catch(e){throw this.isSDPExchanging_=!1,e}}async createOffer(){try{const e=await this.peerConnection_.createOffer(fh);await this.peerConnection_.setLocalDescription(e),this.updateSSRC(e.sdp),Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:Hi,kind:"offer"})}catch(e){throw Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Hi,kind:"offer",error:e}),e}}doExchangeSDP(){return new Promise((e,t)=>{this.exchangeSDPTimeout_=setTimeout(()=>{this.signalChannel_.off(Pc.PUBLISH_RESULT,i),this.clearExchangeSDPTimeout();const e=new Yc({code:Xc.API_CALL_TIMEOUT,message:Fr({key:zn})});t(e)},5e3);const i=async i=>{try{this.clearExchangeSDPTimeout();const{code:t,message:n}=i.data;0===t?(await this.acceptAnswer(i.data.data),e()):this.checkPublishResultCode(t,n)}catch(n){t(n)}},n=this.getMediaSettings(this.localStream_.getMediaStream()),s={type:this.peerConnection_.localDescription.type,sdp:this.removeVideoOrientation(this.peerConnection_.localDescription.sdp),screen:this.localStream_.hasScreenTrack(),constraintConfig:n};this.signalChannel_.once(Pc.PUBLISH_RESULT,i),this.log_.debug("sending sdp offer: "+s.sdp),this.signalChannel_.send(Uc,s)})}setSDPDirection(e,t,i="all"){const n=Kd(e);return n.media.forEach(e=>{"all"!==i&&e.type!==i||(e.direction=t)}),Qd(n)}async updateOffer(e,t){try{const i=await this.peerConnection_.createOffer(fh);Ce&&(i.sdp=this.setSDPDirection(i.sdp,"sendrecv")),await this.peerConnection_.setLocalDescription(i);const n=this.getMediaSettings(this.localStream_.getMediaStream()),s={action:e,trackId:t.id,kind:t.kind===Dt?"bigVideo":t.kind,type:"offer",sdp:this.peerConnection_.localDescription.sdp,constraintConfig:n};this.log_.info("createOffer success, sending updated offer to remote server"),this.log_.debug("updatedOffer: "+s.sdp);const r=await this.signalChannel_.sendWaitForResponse({command:Nc,data:s,responseCommand:Pc.UPDATE_OFFER_RESULT,timeout:1e4,commandDesc:"update offer"}),{code:o,message:a}=r.data;0!==o&&this.checkPublishResultCode(o,a),await this.acceptAnswer(r.data.data),this.updateSSRC(i.sdp),Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:Hi,kind:"offer"})}catch(i){throw this.log_.error(i),Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Hi,kind:"offer",error:i}),i}}async acceptAnswer(e){const t=this.localStream_.getVideoBitrate(),i=this.localStream_.getAudioBitrate();try{let n=this.removeVideoOrientation(e.sdp);if(n=await this.setBandwidth(t,Dt,n),n=await this.setBandwidth(i,At,n),this.client_.getIsEnableSmallStream()){const e=this.client_.smallStreamConfig;n=await this.setSmallStreamBandwidth(e.bitrate,n)}const s={type:e.type,sdp:n};if(await this.peerConnection_.setRemoteDescription(s),this.sei_){const e=this.peerConnection_.getSenders().filter(e=>e.track.kind===Dt)[0];e&&(this.sei_.isRunning?this.sei_.restart(e,!0):this.sei_.start(e,!0))}this.log_.debug("accepted answer: "+n),Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:Gi,kind:"answer"})}catch(n){throw Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Gi,kind:"answer",error:n}),this.log_.error("failed to accept remote answer "+n),n}}sendMutedFlag(e){const t={audio:e.audio,bigVideo:e.video,auxVideo:e.auxVideo};this.log_.info("send muted state: "+JSON.stringify(t)),this.signalChannel_.send(xc,t)}getIsReconnecting(){return this.isReconnecting_}async reconnect(){if(-1===this.reconnectionTimer_){if(this.reconnectionCount_>=30){this.log_.warn("SDK has tried reconnect uplink for 30 times, but all failed, please check your network"),this.stopReconnection();const e=new Yc({code:Xc.UPLINK_RECONNECTION_FAILED,message:Fr({key:Kn})});return Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:$i,error:e}),this.addEventInternal(Ad,"uplink-connection reconnect fail"),this.emitConnectionStateChangedEvent(vi),void this.emitter_.emit(Rl.ERROR,e)}if(this.signalChannel_.getCurrentState()!==kc)return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),void this.signalChannel_.once(Ec,this.reconnect,this);this.reconnectionCount_++;try{this.log_.warn(`reconnect() try to reconnect uplink [${this.reconnectionCount_}/30]`);const e=zr(this.reconnectionCount_);if(this.reconnectionTimer_=setTimeout(()=>{this.log_.warn(`reconnect() uplink reconnect timeout(${e/1e3}s), try again`),this.clearReconnectionTimer(),this.reconnect()},e),this.isSDPExchanging_||this.peerConnection_&&this.peerConnection_.connectionState===Ei)return;await this.signalChannel_.sendWaitForResponse({command:Vc,responseCommand:Pc.UNPUBLISH_RESULT,enableLog:!1}),this.reset(),this.initialize(),await this.publish(this.localStream_),Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:$i}),this.log_.warn("reconnect() uplink reconnect successfully"),this.addEventInternal(kd,"uplink-connection reconnect success"),this.stopReconnection(),this.localStream_.syncMuteState()}catch(e){}}else this.log_.warn("reconnect() uplink is reconnecting, ignore current reconnection")}clearExchangeSDPTimeout(){-1!==this.exchangeSDPTimeout_&&(clearTimeout(this.exchangeSDPTimeout_),this.exchangeSDPTimeout_=-1)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}handleError(e){e.getCode()===Xc.ICE_TRANSPORT_ERROR&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Fi,error:e})),this.isReconnecting_||this.startReconnection())}handleConnectionStateChange(e){e.state===Ii&&this.isFirstConnection_&&(this.isFirstConnection_=!1,Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:Fi}),this.addEventInternal(Td,"uplink-connection is connected"))}updateSSRC(e){try{let t=0;Kd(e).media.forEach(e=>{if(e.type===At){const t=e.ssrcs[0];t&&(this.ssrc_.audio=t.id)}else{const i=e.ssrcs[0];switch(t+=1,t){case 1:i&&(this.ssrc_.video=i.id);break;case 2:i&&(this.ssrc_.small=i.id)}}})}catch(t){}}getLocalStreamVideoTrackId(){if(this.peerConnection_){const e=this.peerConnection_.getSenders().filter(e=>e.track&&e.track.kind===Dt);if(e[0])return e[0].track.id}if(this.localStream_){const e=this.localStream_.getVideoTrack();if(e)return e.id}return""}getSSRC(){return this.ssrc_}checkPublishResultCode(e,t){if(0!==e)throw 1028===e?(this.log_.error(xr.NOT_SUPPORTED_H264ENCODE),new Yc({code:Xc.NOT_SUPPORTED_H264,message:Fr({key:vr})})):new Yc({code:Xc.UNKNOWN,message:Fr({key:br,data:{signalResponse:Pc.PUBLISH_RESULT,code:e,message:t}})})}getLocalStream(){return this.localStream_}sendSEI(e,t){this.sei_.push(e,t)}}class Sh extends Zl{constructor(e){super(e),this.remoteStreams_=new Map,this.autoSubscribe=e.autoSubscribe,this.trackState_={audio:e.trackState.audio,video:e.trackState.video,auxiliary:e.trackState.auxiliary,smallVideo:e.trackState.smallVideo},this.ssrc_={audio:0,video:0,auxiliary:0},this.subscribeState_={audio:e.autoSubscribe,video:e.autoSubscribe,auxiliary:e.autoSubscribe,smallVideo:!1},this.isSDPExchanging_=!1,this.installEvents()}get isMainStreamSubscribed(){return(this.subscribeState_.audio||this.subscribeState_.video||this.subscribeState_.smallVideo)&&(this.trackState_.audio||this.trackState_.video||this.trackState_.smallVideo)}get isAuxStreamSubscribed(){return this.subscribeState_.auxiliary&&this.trackState_.auxiliary}get isSmallStreamSubscribed(){return this.subscribeState_.smallVideo&&this.trackState_.smallVideo}get isBigStreamSubscribed(){return this.subscribeState_.video&&this.trackState_.video}isStreamUnpublished(e){return e.getType()===zt?!this.trackState_.audio&&!this.trackState_.video:!this.trackState_.auxiliary}initialize(){super.initialize(),this.peerConnection_.ontrack=this.onTrack.bind(this)}close(){super.close(),this.trackState_.audio=!1,this.trackState_.video=!1,this.trackState_.auxiliary=!1,this.emitConnectionStateChangedEvent(vi),this.remoteStreams_.forEach(e=>{const t=e;t.setConnection(null),t.uninstallEvents(),t.getIsStreamAddedEventEmitted()&&this.emitter_.emit(Rl.STREAM_REMOVED,{stream:t})}),this.remoteStreams_.clear(),this.uninstallEvents()}installEvents(){Ta.on(Ga,this.onRemoteStreamUpdate,this),this.emitter_.on(Rl.ERROR,e=>{e.getCode()===Xc.ICE_TRANSPORT_ERROR&&(this.isFirstConnection_&&(this.isFirstConnection_=!1,Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:Bi,error:e})),this.isReconnecting_||this.startReconnection())}),this.emitter_.on(Rl.CONNECTION_STATE_CHANGED,e=>{e.state===Ii&&this.isFirstConnection_&&(this.isFirstConnection_=!1,Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:Bi}),this.addEventInternal(Ed,"downlink-connection is connected"))})}uninstallEvents(){Ta.removeListener(Ga,this.onRemoteStreamUpdate,this)}onRemoteStreamUpdate(e){if(this.hitTest(e.tinyId)&&e.client===this.client_){this.updateTrackState(e.action,e.kind);const t=e.kind===Pt?_i:pi,i=this.remoteStreams_.get(t);if(!i)return;e.action===pn?this.handleRemoteAddTrack(e.kind,i):this.handleRemoteRemoveTrack(e.kind,i)}}handleRemoteAddTrack(e,t){this.log_.info(`remote add ${e} track`),e===At?t.updateAudioPlayingState(this.subscribeState_.audio):t.updateVideoPlayingState(e===Pt?this.subscribeState_.auxiliary:this.subscribeState_.video||this.subscribeState_.smallVideo),t.getIsStreamAddedEventEmitted()?this.emitter_.emit(Rl.STREAM_UPDATED,{stream:t}):(this.emitter_.emit(Rl.STREAM_ADDED,{stream:t}),this.currentState_===Ii&&t.emitConnectionStateChanged({prevState:vi,state:Ii}))}handleRemoteRemoveTrack(e,t){t.getIsStreamAddedEventEmitted()&&(this.log_.info(`remote remove ${e} track`),e===Pt||!this.trackState_.audio&&!this.trackState_.video?(this.log_.info(`remote stream ${t.getType()} removed`),this.currentState_===Ii&&t.emitConnectionStateChanged({prevState:Ii,state:vi}),this.emitter_.emit(Rl.STREAM_REMOVED,{stream:t})):(e===At?t.updateAudioPlayingState(!1):t.updateVideoPlayingState(!1),this.emitter_.emit(Rl.STREAM_UPDATED,{stream:t})))}updateTrackState(e,t){const i=e===pn;switch(t){case At:this.trackState_.audio=i;break;case Dt:this.trackState_.video=i;break;case Pt:this.trackState_.auxiliary=i;break;case Nt:this.trackState_.smallVideo=i}this.log_.info("trackState updated: "+JSON.stringify(this.trackState_))}onTrack(e){const t=e.streams[0],i=e.track;if(this.log_.info(`ontrack() kind: ${i.kind} id: ${i.id} streamId: ${t.id}`),"unified-plan"===this.sdpSemantics_){const e=function(e){let t=qd.parse(e),i={audio:[],video:[]};return t.media.forEach(e=>{if(e.ssrcs){let t=e.ssrcs[0].id>>16&255;if(e.type===At)i.audio.push(pi);else if(e.type==Dt){const e=t===mi?pi:_i;i.video.push(e)}}}),i}(this.peerConnection_.remoteDescription.sdp);if(i.kind===At){if(0===e.audio.length||t.id!==pi)return void this.log_.debug("skip this invalid audio track")}else if(-1===e.video.indexOf(t.id))return void this.log_.debug(`skip this invalid video track: ${i.id}  msid: ${t.id}`)}Fd.logEvent({eventType:"ontrack",kind:i.kind});let n=!1,s=this.remoteStreams_.get(t.id);const r=t.id===pi?gi:fi;if(qr(s)&&(s=new hh({type:r,userId:this.userId_,client:this.client_}),s.setConnection(this),this.remoteStreams_.set(t.id,s),n=!0),s.setMediaStream(t),i.kind===At?s.updateAudioPlayingState(this.subscribeState_.audio):r===gi?s.updateVideoPlayingState(this.subscribeState_.video||this.subscribeState_.smallVideo):s.updateVideoPlayingState(this.subscribeState_.auxiliary),r===fi&&!this.trackState_.auxiliary)return;if(r===gi&&!this.trackState_.audio&&!this.trackState_.video)return;const o=this.client_.getSubscriptionManager();o&&o.hasAutoRecoveryFlag(this.userId_,r)||(n?this.emitter_.emit(Rl.STREAM_ADDED,{stream:s}):this.emitter_.emit(Rl.STREAM_UPDATED,{stream:s}))}addRRTRLine(e){const t=e.split("\r\n"),i=new Map;t.forEach((e,n)=>{/^a=rtcp-fb:/.test(e)&&t[n+1]&&!/^a=rtcp-fb:/.test(t[n+1])&&i.set(n+1,e.match(/^a=rtcp-fb:\d+/)[0]+" rrtr")});const n=[...i];for(let s=0;s<n.length;s++){let[e,i]=n[s];t.splice(e+s,0,i)}return t.join("\r\n")}addSPSDescription(e){const t=Kd(e);return t.media.forEach(e=>{e.type===Dt&&e.fmtp.forEach(e=>{e.config+=";sps-pps-idr-in-keyframe=1"})}),Qd(t)}removeSDESDescription(e){const t=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],i=Kd(e);return i.media.forEach(e=>{e.ext=e.ext.filter(e=>!t.includes(e.uri))}),Qd(i)}isSubscriptionStateNotChanged(e,t){return e.getType()===gi?(null==t?void 0:t.audio)===this.subscribeState_.audio&&(null==t?void 0:t.video)===this.subscribeState_.video&&this.isSubscribeSmall(t):e.getType()===fi?!qr(t.video)&&this.subscribeState_.auxiliary===t.video:void 0}isSubscribeSmall(e){return qr(e.smallVideo)&&!this.subscribeState_.smallVideo}async subscribe(e,t){try{var i,n;const{emitEvent:s=!0}=t,r=e.getType();if((null===(i=this.peerConnection_)||void 0===i?void 0:i.connectionState)!==Ti&&(null===(n=this.peerConnection_)||void 0===n?void 0:n.connectionState)!==Ei||await this.waitForPeerConnectionConnected(),this.isSubscriptionStateNotChanged(e,t))return this.peerConnection_||(this.initialize(),await this.connect()),s&&qr(t.smallVideo)&&this.emitter_.emit(Rl.STREAM_SUBSCRIBED,{stream:e,result:!0}),e;if(r===zt?(qr(t.audio)||(this.subscribeState_.audio=t.audio),qr(t.video)||(this.subscribeState_.video=t.video),this.subscribeState_.smallVideo=(null==t?void 0:t.smallVideo)||!1,this.addEventInternal(this.subscribeState_.audio?ad:dd,this.subscribeState_.audio?"subscribe audio":"unsubscribe audio"),this.addEventInternal(this.subscribeState_.video?ad:dd,this.subscribeState_.video?"subscribe video":"unsubscribe video"),this.addEventInternal(this.subscribeState_.smallVideo?Md:Ld,this.subscribeState_.smallVideo?"subscribe smallVideo":"unsubscribe smallVideo")):qr(t.video)||(this.subscribeState_.auxiliary=t.video),this.log_.info(`subscribe ${r} stream with options ${JSON.stringify(t)} current state: ${JSON.stringify(this.subscribeState_)}`),this.peerConnection_||this.isSDPExchanging_){let t=sn;this.isMainStreamSubscribed||this.isAuxStreamSubscribed||(t=nn),await this.sendSubscription(t),r===zt?(e.updateAudioPlayingState(this.subscribeState_.audio),e.updateVideoPlayingState(this.subscribeState_.video||this.subscribeState_.smallVideo)):e.updateVideoPlayingState(this.subscribeState_.auxiliary)}else this.initialize(),await this.connect();return s&&qr(t.smallVideo)&&this.emitter_.emit(Rl.STREAM_SUBSCRIBED,{stream:e,result:!0}),e}catch(s){if(this.isStreamUnpublished(e))throw new Yc({code:Xc.REMOTE_STREAM_NOT_EXIST,message:`remote user ${this.userId_} unpublished stream`});throw s}}async unsubscribe(e){const t=e.getType();if(t===zt){if(!this.isMainStreamSubscribed)return this.log_.info("main stream already unsubscribed"),e;this.subscribeState_.audio=!1,this.subscribeState_.video=!1,this.subscribeState_.smallVideo=!1}else{if(!this.isAuxStreamSubscribed)return this.log_.info("auxiliary stream already unsubscribed"),e;this.subscribeState_.auxiliary=!1}let i=nn;if((t===gi&&this.isAuxStreamSubscribed||t===fi&&this.isMainStreamSubscribed)&&(i=sn),this.log_.info(`unsubscribe ${t} stream with ${JSON.stringify(this.subscribeState_)}`),await this.sendSubscription(i),e.updateVideoPlayingState(!1),e.updateAudioPlayingState(!1),i===nn){const t=e.getMediaStream();t&&t.getTracks().forEach(e=>t.removeTrack(e)),this.closePeerConnection(),this.emitConnectionStateChangedEvent(vi)}return this.addEventInternal(dd,"unsubscribe audio"),this.addEventInternal(cd,"unsubscribe video"),e}sendSubscription(e){let t={srcTinyId:this.tinyId_,srcUserId:this.userId_},i=$c,n=Pc.UNSUBSCRIBE_RESULT;return e===sn&&(t={audio:this.subscribeState_.audio,bigVideo:this.subscribeState_.video,auxVideo:this.subscribeState_.auxiliary,smallVideo:this.subscribeState_.smallVideo,srcTinyId:this.tinyId_},i=Bc,n=Pc.SUBSCRIBE_CHANGE_RESULT),this.signalChannel_.sendWaitForResponse({command:i,data:t,responseCommand:n,timeout:1e4}).then(({data:t})=>{if(0!==t.code){const i=new Yc({code:t.code,message:Fr({key:Jn,data:{type:e,message:t.message}})});throw this.log_.error(i),i}})}async connect(){try{if(await this.exchangeSDP(),this.sei_){const e=this.peerConnection_.getReceivers()[1];e&&(this.sei_.isRunning?this.sei_.restart(e,!1):this.sei_.start(e,!1),this.sei_.onSEIMessage=e=>{this.emitter_.emit(Rl.SEI_MESSAGE,{...e,userId:this.userId_})})}await this.waitForPeerConnectionConnected()}catch(e){throw this.closePeerConnection(!0),e}}async exchangeSDP(){try{this.isSDPExchanging_=!0,await this.createOffer(),this.log_.info("createOffer success, sending offer to remote server");const{type:e,sdp:t}=this.peerConnection_.localDescription,i={type:e,sdp:t,srcUserId:this.userId_,srcTinyId:this.tinyId_,audio:this.subscribeState_.audio,bigVideo:this.subscribeState_.video,auxVideo:this.subscribeState_.auxiliary,smallVideo:this.subscribeState_.smallVideo};Ta.emit(lc,{client:this.client_,connection:this,userId:this.userId_,tinyId:this.tinyId_,role:hi,subscribeState:this.subscribeState_,trackState:this.trackState_});const n=await this.signalChannel_.sendWaitForResponse({command:Fc,commandDesc:"exchange sdp",data:i,responseCommand:Pc.SUBSCRIBE_RESULT});if(!this.peerConnection_){const e=new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:wr})});throw this.log_.warn(e),e}await this.onSubscribeResult(n),this.isSDPExchanging_=!1}catch(e){throw this.isSDPExchanging_=!1,e}}async createOffer(){const e={voiceActivityDetection:!1};"RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype&&"unified-plan"===this.sdpSemantics_?(this.peerConnection_.addTransceiver(At,{direction:"recvonly"}),this.peerConnection_.addTransceiver(Dt,{direction:"recvonly"}),this.peerConnection_.addTransceiver(Dt,{direction:"recvonly"})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);const t=await this.peerConnection_.createOffer(e),{isH264DecodeSupported:i}=await nl();i||(this.log_.warn("remove h264 desc from sdp"),t.sdp=function(e){const t=Kd(e);return t.media.forEach(e=>{if(e.type===Dt){const t=new Set;e.rtp.forEach(({payload:e,codec:i})=>"H264"===i&&t.add(e)),e.fmtp.forEach(({payload:e,config:i})=>{const n=i.match(/apt=(\d+)/);n&&n[1]&&t.has(Number(n[1]))&&t.add(e)});const i=({payload:e})=>!t.has(e);e.rtp=e.rtp.filter(i),e.rtcpFb=e.rtcpFb.filter(i),e.fmtp=e.fmtp.filter(i),e.payloads=e.payloads.split(" ").filter(e=>!t.has(Number(e))).join(" ")}}),Qd(t)}(t.sdp)),t.sdp=this.addRRTRLine(t.sdp),t.sdp=this.addSPSDescription(t.sdp),t.sdp=function(e){const t=Kd(e);return t.media.forEach(e=>{e.type===At&&e.fmtp.forEach(e=>{e.config+=";sprop-stereo=1;stereo=1"})}),Qd(t)}(t.sdp),"unified-plan"===this.sdpSemantics_&&(t.sdp=this.removeSDESDescription(t.sdp)),await this.peerConnection_.setLocalDescription(t)}async onSubscribeResult(e){let{code:t,message:i=""}=e&&e.data||{},{type:n,sdp:s}=e&&e.data&&e.data.data||{};if(77393===t)throw this.log_.error(xr.NOT_SUPPORTED_H264DECODE),new Yc({code:Xc.NOT_SUPPORTED_H264,message:Fr({key:Sr})});try{if(0!==t)throw new Yc({code:t,message:Fr({key:qn,data:{errMsg:i}})});this.log_.debug("accept remote answer: "+s),await this.peerConnection_.setRemoteDescription({type:n,sdp:s}),this.updateSSRC(s)}catch(r){throw this.log_.error(r),r}}updateSSRC(e){try{Kd(e).media.forEach(e=>{if(e.type===At){const t=e.ssrcs.find(e=>e.value.includes(pi));t&&(this.ssrc_.audio=t.id)}else{const t=e.ssrcs.find(e=>e.value.includes(pi)),i=e.ssrcs.find(e=>e.value.includes(_i));t&&(this.ssrc_.video=t.id),i&&(this.ssrc_.auxiliary=i.id)}})}catch(t){}}setRemoteStream(e,t){this.remoteStreams_.set(e,t)}getSubscribeState(){return this.subscribeState_}getTrackState(){return this.trackState_}getSSRC(){return this.ssrc_}getMainStream(){return this.remoteStreams_.get(pi)}getAuxStream(){return this.remoteStreams_.get(_i)}getMainStreamVideoTrackId(){const e=this.getMainStream();if(e){const t=e.getVideoTrack();if(t)return t.id}return""}getAuxStreamVideoTrackId(){const e=this.getAuxStream();if(e){const t=e.getVideoTrack();if(t)return t.id}return""}async reconnect(){if(-1!==this.reconnectionTimer_)return void this.log_.warn("reconnect() downlink is reconnecting, ignore current reconnection");if(this.reconnectionCount_>=30){this.log_.warn(`SDK has tried reconnect downlink [${this.userId_}] for 30 times, but all failed, please check your network`),this.stopReconnection();const e=new Yc({code:Xc.DOWNLINK_RECONNECTION_FAILED,message:Fr({key:Wn})});return Fd.logFailedEvent({userId:this.client_.getUserId(),eventType:ji,error:e}),this.addEventInternal(Nd,"downlink-connection reconnect fail"),this.emitConnectionStateChangedEvent(vi),void this.emitter_.emit(Rl.ERROR,e)}if(this.signalChannel_.getCurrentState()!==kc)return this.log_.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),void this.signalChannel_.once(Ec,this.reconnect,this);this.reconnectionCount_++,this.log_.warn(`reconnect() try to reconnect downlink [${this.reconnectionCount_}/30]`);const e=zr(this.reconnectionCount_);if(this.reconnectionTimer_=setTimeout(()=>{this.log_.warn(`reconnect() downlink [${this.userId_}] reconnect timeout(${e/1e3}s), try again`),this.clearReconnectionTimer(),this.reconnect()},e),!(this.isSDPExchanging_||this.peerConnection_&&this.peerConnection_.connectionState===Ei))try{this.closePeerConnection(),this.initialize(),await this.connect(),this.stopReconnection(),this.log_.warn("reconnect() downlink reconnect successfully"),Fd.logSuccessEvent({userId:this.client_.getUserId(),eventType:ji}),this.addEventInternal(Pd,"downlink-connection reconnect success"),this.recoverSubscription()}catch(t){}}recoverSubscription(){const e=this.client_.getSubscriptionManager();e&&[...this.remoteStreams_.values()].forEach(t=>{e.hasAutoRecoveryFlag(this.userId_,t.getType())&&e.recover(t)})}getIsReconnecting(){return this.isReconnecting_}getSubscribedMainStream(){let e=null;return this.isMainStreamSubscribed&&(e=this.remoteStreams_.get(pi)),e}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}startReconnection(){const e=this.client_.getSubscriptionManager();if(e)for(let t of this.remoteStreams_.values()){const i=t.getType();(i===gi&&(this.trackState_.audio||this.trackState_.video)||i===fi&&this.trackState_.auxiliary)&&e.setAutoRecoveryFlag(this.userId_,t.getType())}super.startReconnection()}getCurrentState(){return this.currentState_}hasMainStream(){return this.trackState_.video||this.trackState_.audio||this.trackState_.smallVideo}hasAuxStream(){return this.trackState_.auxiliary}}class yh{constructor(){this.startTime=0,this.endTime=0,this.start()}start(){0===this.startTime&&(this.startTime=io())}stop(){0===this.endTime&&(this.endTime=io())}getDuration(){return 0===this.endTime?io()-this.startTime:this.endTime-this.startTime}}class Ih{constructor(e){this.client_=e.client,this.intervalId_=-1,this.statsCalculator_=e.stats,this.prevStats_=null,this.renderFreezeMap_=new Map,this.remoteStreamMap_=new Map,this.dataFreezeMap_=new Map,this.monitorFreezeData_=new Map}installEvents(){Ta.on(rc,this.handlePlayVideoStart,this),Ta.on(tc,this.onVideoTrackMuted,this),Ta.on(ic,this.onVideoTrackUnmuted,this),Ta.on(Qa,this.handleStreamStopped,this),Ta.on(qa,this.handleStreamStopped,this),Ta.on(ja,this.handleVideoPlaying,this)}uninstallEvents(){Ta.off(rc,this.handlePlayVideoStart,this),Ta.off(tc,this.onVideoTrackMuted,this),Ta.off(ic,this.onVideoTrackUnmuted,this),Ta.off(Qa,this.handleStreamStopped,this),Ta.off(qa,this.handleStreamStopped,this),Ta.off(ja,this.handleVideoPlaying,this)}start(){-1===this.intervalId_&&(this.installEvents(),this.intervalId_=Yd.setInterval(async()=>{try{await this.detectFPS()}catch(e){}},1e3))}stop(){-1!==this.intervalId_&&(this.uninstallEvents(),Yd.clearInterval(this.intervalId_),this.intervalId_=-1,this.renderFreezeMap_.clear(),this.dataFreezeMap_.clear(),this.remoteStreamMap_.clear())}onVideoTrackMuted({stream:e}){if(e.getClient()!==this.client_||!e.isRemote())return;const t=e.userId_,i=e.type_,n=`${t}_${i}`,s=this.dataFreezeMap_.get(n),r=new yh;s?s.durationItemList.push(r):this.dataFreezeMap_.set(n,{userId:t,type:i,durationItemList:[r],isFreezing:function(){const e=this.durationItemList[this.durationItemList.length-1];return e&&0===e.endTime}})}onVideoTrackUnmuted({stream:e}){if(e.getClient()!==this.client_||!e.isRemote())return;const t=e.userId_,i=e.type_,n=`${t}_${i}`;this.stopDataFreeze({key:n,userId:t,type:i})}handleStreamStopped({client:e,stream:t}){if(e!==this.client_)return;const i=t.getUserId(),n=t.getType(),s=`${i}_${n}`;this.stopDataFreeze({key:s,userId:i,type:n})}stopDataFreeze({key:e,userId:t,type:i}){const n=this.dataFreezeMap_.get(e);if(!n||!n.isFreezing())return;const s=n.durationItemList[n.durationItemList.length-1];s.stop();const r=s.getDuration();r>500?(Fd.logEvent({eventType:"videoFrozenCount",delta:r}),this.monitorFreezeData_.set(e,{userId:t,type:i,duration:r})):n.durationItemList.pop()}getTotalDuration(e){return e.reduce((e,t)=>{const i=t.getDuration();return e+Math.min(i,5e3)},0)}async getStats(){const e=this.client_.getConnections(),t={};for(let[i,n]of e){if(!n.getPeerConnection())continue;const e=n.getSubscribeState(),s=n.getTrackState(),r=await this.statsCalculator_.getReceiverStats(n),o={userId:r.userId,tinyId:i,hasVideo:s.video&&e.video,hasAuxiliary:s.auxiliary&&e.auxiliary,video:{framesDecoded:0},auxiliary:{framesDecoded:0}};o.hasVideo&&(o.video.framesDecoded=r.video.framesDecoded),o.hasAuxiliary&&(o.auxiliary.framesDecoded=r.auxiliary.framesDecoded),t[r.userId]=o}return t}async detectFPS(){const e=await this.getStats();if(this.prevStats_){for(let t in e){if(!this.prevStats_[t])continue;const i=e[t].tinyId,n=this.client_.getMutedStates();if(e[t].hasVideo&&this.prevStats_[t].hasVideo&&n.has(i)&&!n.get(i).videoMuted){const i=e[t].video.framesDecoded-this.prevStats_[t].video.framesDecoded;this.handleRenderFreeze({userId:t,type:gi,fps:i})}if(e[t].hasAuxiliary&&this.prevStats_[t].hasAuxiliary){const i=e[t].auxiliary.framesDecoded-this.prevStats_[t].auxiliary.framesDecoded;this.handleRenderFreeze({userId:t,type:fi,fps:i})}}this.prevStats_=e}else this.prevStats_=e}async handleRenderFreeze({userId:e,fps:t,type:i}){const n=`${e}_${i}`;let s=this.renderFreezeMap_.get(n);if(t<=2){const t=io();s&&!s.isFreeze&&(s.freezeTimeline.push({startTime:t,endTime:void 0}),s.isFreeze=!0),s||this.renderFreezeMap_.set(n,{userId:e,type:i,isFreeze:!0,freezeTimeline:[{startTime:t,endTime:void 0}],renderFreezeTotal:0})}else if(s&&s.isFreeze){s.isFreeze=!1;const e=s.freezeTimeline.pop();e.endTime=io();const t=e.endTime-e.startTime;s.freezeTimeline.push(e),s.renderFreezeTotal+=Math.min(5e3,t)}}handlePlayVideoStart({stream:e}){if(e.getClient()!==this.client_||!e.isRemote()||!e.hasVideo())return;const t=`${e.getUserId()}_${e.getType()}`;if(this.remoteStreamMap_.has(t)){this.remoteStreamMap_.get(t).remoteStream=e}else this.remoteStreamMap_.set(t,{isPlayingFired:!1,remoteStream:e})}handleVideoPlaying({stream:e}){if(!e.isRemote()||e.getClient()!==this.client_)return;const t=`${e.getUserId()}_${e.getType()}`;if(this.remoteStreamMap_.has(t)){this.remoteStreamMap_.get(t).isPlayingFired=!0}}getDataFreezeDuration(e){const t={dataFreeze:0,count:0},i=this.dataFreezeMap_.get(e);if(i){if(i.isFreezing()){const e=i.durationItemList[i.durationItemList.length-1];e.stop();e.getDuration()<500&&i.durationItemList.pop()}t.dataFreeze=this.getTotalDuration(i.durationItemList),t.count=i.durationItemList.length}return t}getRenderFreezeDuration(e){const t=this.renderFreezeMap_.get(e);let i=0,n=0;if(t)if(t.isFreeze){const e=io()-t.freezeTimeline[t.freezeTimeline.length-1].startTime;i=t.renderFreezeTotal+Math.min(e,5e3),n=t.freezeTimeline.length}else i=t.renderFreezeTotal;return{renderFreeze:i,count:n}}getMonitorFreeze(){return this.monitorFreezeData_}isBlackStream(e){if(this.remoteStreamMap_.has(e)){return!this.remoteStreamMap_.get(e).isPlayingFired}return!1}resetMonitor(){this.monitorFreezeData_.clear()}}class Th{constructor(e){this.userId=e.userId,this.tinyId=e.tinyId,this.role=e.role===hi?"anchor":"audience"}}var Eh=R((function(e){!function(t){function i(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function n(e,t,n,s,r,o){return i((a=i(i(t,e),i(s,o)))<<(c=r)|a>>>32-c,n);var a,c}function s(e,t,i,s,r,o,a){return n(t&i|~t&s,e,t,r,o,a)}function r(e,t,i,s,r,o,a){return n(t&s|i&~s,e,t,r,o,a)}function o(e,t,i,s,r,o,a){return n(t^i^s,e,t,r,o,a)}function a(e,t,i,s,r,o,a){return n(i^(t|~s),e,t,r,o,a)}function c(e,t){var n,c,d,l,h;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var u=1732584193,p=-271733879,_=-1732584194,m=271733878;for(n=0;n<e.length;n+=16)c=u,d=p,l=_,h=m,u=s(u,p,_,m,e[n],7,-680876936),m=s(m,u,p,_,e[n+1],12,-389564586),_=s(_,m,u,p,e[n+2],17,606105819),p=s(p,_,m,u,e[n+3],22,-1044525330),u=s(u,p,_,m,e[n+4],7,-176418897),m=s(m,u,p,_,e[n+5],12,1200080426),_=s(_,m,u,p,e[n+6],17,-1473231341),p=s(p,_,m,u,e[n+7],22,-45705983),u=s(u,p,_,m,e[n+8],7,1770035416),m=s(m,u,p,_,e[n+9],12,-1958414417),_=s(_,m,u,p,e[n+10],17,-42063),p=s(p,_,m,u,e[n+11],22,-1990404162),u=s(u,p,_,m,e[n+12],7,1804603682),m=s(m,u,p,_,e[n+13],12,-40341101),_=s(_,m,u,p,e[n+14],17,-1502002290),u=r(u,p=s(p,_,m,u,e[n+15],22,1236535329),_,m,e[n+1],5,-165796510),m=r(m,u,p,_,e[n+6],9,-1069501632),_=r(_,m,u,p,e[n+11],14,643717713),p=r(p,_,m,u,e[n],20,-373897302),u=r(u,p,_,m,e[n+5],5,-701558691),m=r(m,u,p,_,e[n+10],9,38016083),_=r(_,m,u,p,e[n+15],14,-660478335),p=r(p,_,m,u,e[n+4],20,-405537848),u=r(u,p,_,m,e[n+9],5,568446438),m=r(m,u,p,_,e[n+14],9,-1019803690),_=r(_,m,u,p,e[n+3],14,-187363961),p=r(p,_,m,u,e[n+8],20,1163531501),u=r(u,p,_,m,e[n+13],5,-1444681467),m=r(m,u,p,_,e[n+2],9,-51403784),_=r(_,m,u,p,e[n+7],14,1735328473),u=o(u,p=r(p,_,m,u,e[n+12],20,-1926607734),_,m,e[n+5],4,-378558),m=o(m,u,p,_,e[n+8],11,-2022574463),_=o(_,m,u,p,e[n+11],16,1839030562),p=o(p,_,m,u,e[n+14],23,-35309556),u=o(u,p,_,m,e[n+1],4,-1530992060),m=o(m,u,p,_,e[n+4],11,1272893353),_=o(_,m,u,p,e[n+7],16,-155497632),p=o(p,_,m,u,e[n+10],23,-1094730640),u=o(u,p,_,m,e[n+13],4,681279174),m=o(m,u,p,_,e[n],11,-358537222),_=o(_,m,u,p,e[n+3],16,-722521979),p=o(p,_,m,u,e[n+6],23,76029189),u=o(u,p,_,m,e[n+9],4,-640364487),m=o(m,u,p,_,e[n+12],11,-421815835),_=o(_,m,u,p,e[n+15],16,530742520),u=a(u,p=o(p,_,m,u,e[n+2],23,-995338651),_,m,e[n],6,-198630844),m=a(m,u,p,_,e[n+7],10,1126891415),_=a(_,m,u,p,e[n+14],15,-1416354905),p=a(p,_,m,u,e[n+5],21,-57434055),u=a(u,p,_,m,e[n+12],6,1700485571),m=a(m,u,p,_,e[n+3],10,-1894986606),_=a(_,m,u,p,e[n+10],15,-1051523),p=a(p,_,m,u,e[n+1],21,-2054922799),u=a(u,p,_,m,e[n+8],6,1873313359),m=a(m,u,p,_,e[n+15],10,-30611744),_=a(_,m,u,p,e[n+6],15,-1560198380),p=a(p,_,m,u,e[n+13],21,1309151649),u=a(u,p,_,m,e[n+4],6,-145523070),m=a(m,u,p,_,e[n+11],10,-1120210379),_=a(_,m,u,p,e[n+2],15,718787259),p=a(p,_,m,u,e[n+9],21,-343485551),u=i(u,c),p=i(p,d),_=i(_,l),m=i(m,h);return[u,p,_,m]}function d(e){var t,i="",n=32*e.length;for(t=0;t<n;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function l(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var n=8*e.length;for(t=0;t<n;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function h(e){var t,i,n="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),n+="0123456789abcdef".charAt(t>>>4&15)+"0123456789abcdef".charAt(15&t);return n}function u(e){return unescape(encodeURIComponent(e))}function p(e){return function(e){return d(c(l(e),8*e.length))}(u(e))}function _(e,t){return function(e,t){var i,n,s=l(e),r=[],o=[];for(r[15]=o[15]=void 0,s.length>16&&(s=c(s,8*e.length)),i=0;i<16;i+=1)r[i]=909522486^s[i],o[i]=1549556828^s[i];return n=c(r.concat(l(t)),512+8*t.length),d(c(o.concat(n),640))}(u(e),u(t))}function m(e,t,i){return t?i?_(t,e):h(_(t,e)):i?p(e):h(p(e))}e.exports?e.exports=m:t.md5=m}(b)}));class bh{constructor(e){this.client_=e.client,this.signalChannel_=e.signalChannel,this.log_=vc.createLogger({id:"mix|"+this.client_.getUserId(),userId:e.client.getUserId(),sdkAppId:e.client.getSDKAppId()}),this.isMixing_=!1,this.config_=null,this.data_=null,this.remoteStreamMap_=new Map,this.installEvents()}get isPresetLayoutMode(){return this.config_&&this.config_.mode===rn.PRESET_LAYOUT}installEvents(){Ta.on(Wa,this.onStreamSubscribed,this),Ta.on(qa,this.onStreamUnsubscribed,this),this.client_.on("stream-removed",this.onStreamRemoved,this)}uninstallEvents(){Ta.off(Wa,this.onStreamSubscribed,this),Ta.off(qa,this.onStreamUnsubscribed,this),this.client_.off("stream-removed",this.onStreamRemoved,this)}reset(){this.uninstallEvents(),this.isMixing_=!1,this.config_=null}onStreamSubscribed({client:e,stream:t}){e===this.client_&&(this.remoteStreamMap_.set(t.getId(),{remoteStream:t,isUsed:!1}),this.isMixing_&&this.hasAvailablePlaceHolder()&&this.startMixTranscode(this.config_))}onStreamUnsubscribed({client:e,stream:t}){e===this.client_&&this.onStreamRemoved({stream:t})}onStreamRemoved({stream:e}){if(this.remoteStreamMap_.has(e.getId())){const{isUsed:t}=this.remoteStreamMap_.get(e.getId());this.remoteStreamMap_.delete(e.getId()),this.isMixing_&&this.isPresetLayoutMode&&t&&this.startMixTranscode(this.config_)}}async startMixTranscode(e){try{this.resetIsUsedFlag(),this.config_=e;const t=this.getInputParam(e,this.remoteStreamMap_),i=this.getOutputParam(e),n=this.getOutputSessionId({config:e,roomId:this.client_.getRoomId(),userId:this.client_.getUserId()});this.isMixing_&&this.data_&&n!==this.data_.outputSessionId&&(this.log_.info("startMixTranscode() streamId changed, stop mixing before start"),await this.doStopMixTranscode()),await this.doStartMixTranscode({outputSessionId:n,inputParam:t,outputParam:i})}catch(t){throw this.resetIsUsedFlag(),t}}async doStartMixTranscode({outputSessionId:e,inputParam:t,outputParam:i}){const n={roomId:String(this.client_.getRoomId()),mcuRequestTime:Date.now(),outputSessionId:e,inputParam:t,outputParam:i};this.data_=n,this.log_.info("startMixTranscode: "+JSON.stringify(n)),this.isMixing_=!0;try{const e=await this.signalChannel_.sendWaitForResponse({command:zc,data:n,timeout:5e3,responseCommand:Pc.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"});let{code:t,message:i}=e.data;if(0!==t)throw-102083===t&&(i=`Please enable relayed-push in https://console.cloud.tencent.com/trtc and try later, refer to ${Nn}tutorial-26-advanced-publish-cdn-stream.html`),this.log_.error(`startMixTranscode failed, errCode: ${t} errMsg: ${i}`),this.isMixing_=!1,new Yc({code:Xc.START_MIX_TRANSCODE_FAILED,message:Fr({key:Zs,data:{message:i},link:{className:"Client",fnName:"startMixTranscode"}})})}catch(s){throw this.isMixing_=!1,s}}reStartMixTranscode(){this.isMixing_&&this.startMixTranscode(this.config_)}async stopMixTranscode(){if(!this.isMixing_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:tr})});await this.doStopMixTranscode(),this.resetIsUsedFlag()}async doStopMixTranscode(){const e={mcuRequestTime:Date.now(),outputSessionId:this.data_.outputSessionId,streamType:this.data_.outputParam.streamType};this.log_.info("stopMixTranscode: "+JSON.stringify(e));const t=await this.signalChannel_.sendWaitForResponse({command:Wc,data:e,timeout:5e3,responseCommand:Pc.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"}),{code:i,message:n}=t.data;if(0!==i)throw this.log_.error(`stopMixTranscode failed, errCode: ${i} errMsg: ${n}`),new Yc({code:Xc.STOP_MIX_TRANSCODE_FAILED,message:Fr({key:er,data:{message:n},link:{className:"Client",fnName:"stopMixTranscode"}})});this.isMixing_=!1}getOutputSessionId({config:e,userId:t,roomId:i}){return Kr(e.streamId)&&e.streamId.length>0?e.streamId:Eh(`${i}_${t}_main`)}getInputParam(e,t){let i=e.mixUsers.map(e=>({userId:e.userId,roomId:String(e.roomId||this.client_.getRoomId()),width:e.width||0,height:e.height||0,locationX:e.locationX||0,locationY:e.locationY||0,zOrder:e.zOrder,streamType:qr(e.streamType)||e.streamType!==fi?0:1,inputType:e.pureAudio?an.IT_PURE_AUDIO:an.IT_AUDIO_VIDEO,renderMode:e.renderMode||0}));return e.mode===rn.PRESET_LAYOUT&&(i.forEach(e=>{if(e.userId===on.REMOTE){const i=[...t.values()].find(({isUsed:e})=>!e);i&&(e.userId=i.remoteStream.getUserId(),e.streamType=i.remoteStream.getType()===fi?1:0,i.isUsed=!0)}}),i=i.filter(e=>e.userId!==on.REMOTE)),i}getOutputParam(e){const t=e.streamId||"";return{streamId:t,streamType:t.length>0?1:0,width:qr(e.videoWidth)?640:e.videoWidth,height:qr(e.videoHeight)?480:e.videoHeight,videoBps:e.videoBitrate||0,fps:e.videoFramerate||15,gop:e.videoGOP||2,audioSampleRate:e.audioSampleRate||48e3,audioBps:e.audioBitrate||64,audioChannels:e.audioChannels||1,backgroundColor:e.backgroundColor||0,backgroundImg:e.backgroundImage||"",extraInfo:"",videoCodec:2,audioCodec:0}}hasAvailablePlaceHolder(){return!!this.isPresetLayoutMode&&this.data_.inputParam.length!==this.config_.mixUsers.length}resetIsUsedFlag(){this.remoteStreamMap_.forEach(e=>e.isUsed=!1)}}class Rh{constructor(e){this.client_=e.client,this.signalChannel_=e.signalChannel,this.isPublishingTencentCDN_=!1,this.publishTencentStreamRetryCount_=0,this.publishTencentStreamId_=void 0,this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}setSignalChannel(e){this.signalChannel_=e.signalChannel}getIsPublishingTencentCDN(){return this.isPublishingTencentCDN_}getIsPublishingGivenCDN(){return this.isPublishingGivenCDN_}generatePublishCDNStreamId(e){if(!e){let e=`${this.client_.getRoomId()}_${this.client_.getUserId()}_main`;return/^[A-Za-z\d_-]*$/.test(e)||(e=Eh(e)),`${this.client_.getSDKAppId()}_${e}`}return e}async startPublishTencentCDN(e){if(this.isPublishingTencentCDN_=!0,this.publishTencentStreamId_=e.streamId,!this.client_.isJoined_)return;const t=this.generatePublishCDNStreamId(e.streamId),i={requestTime:Date.now(),sessionId:Eh(`${this.client_.getRoomId()}_${this.client_.getUserId()}_main`),streamId:t,streamType:0};this.publishTencentStreamRetryCount_=0,await this.doStartPublishTencentCDN(i)}async doStartPublishTencentCDN(e){try{vc.info("startPublishTencentCDN: "+JSON.stringify(e));const t=await this.signalChannel_.sendWaitForResponseWithRetry({command:jc,data:e,timeout:2e3,responseCommand:Pc.START_PUBLISH_TENCENT_CDN_RES,commandDesc:"startPublishCDNStream",retries:2});let{code:i,message:n}=t.data;if(0!==i)throw this.publishTencentStreamId_=void 0,this.isPublishingTencentCDN_=!1,-102083===i&&(n=`Please enable relayed-push in https://console.cloud.tencent.com/trtc and try later, refer to ${Nn}tutorial-26-advanced-publish-cdn-stream.html`),vc.error(`startPublishTencentCDN failed, errCode: ${i}, errMsg: ${n}`),new Yc({code:Xc.START_PUBLISH_CDN_FAILED,message:Fr({key:Rs,data:{message:n},link:{className:"Client",fnName:"startPublishCDNStream"}})})}catch(t){throw this.publishTencentStreamId_=void 0,this.isPublishingTencentCDN_=!1,t}}async stopPublishTencentCDN(){const e={requestTime:Date.now(),sessionId:Eh(`${this.client_.getRoomId()}_${this.client_.getUserId()}_main`)};vc.info("stopPublishTencentCDN: "+JSON.stringify(e));const t=await this.signalChannel_.sendWaitForResponse({command:Hc,data:e,timeout:5e3,responseCommand:Pc.STOP_PUBLISH_TENCENT_CDN_RES,commandDesc:"stopPublishCDNStream"});let{code:i,message:n}=t.data;if(0===i)this.publishTencentStreamId_=void 0,this.isPublishingTencentCDN_=!1;else{if(-102069!==i)throw vc.error(`stopPublishTencentCDN failed, errCode: ${i} errMsg: ${n}`),new Yc({code:Xc.STOP_PUBLISH_CDN_FAILED,message:Fr({key:Cs,data:{message:n},link:{className:"Client",fnName:"stopPublishCDNStream"}})});vc.warn("stopPublishTencentCDN failed, can not stopPublishTencentCDN in auto relayed-push mode"),this.publishTencentStreamId_=void 0,this.isPublishingTencentCDN_=!1}}async startPublishGivenCDN(e){const t={pushRequestTime:Date.now(),pushAppId:e.appId,pushBizId:e.bizId,pushCdnUrl:e.url,pushStreamType:zt,pushStreamId:this.publishTencentStreamId_};if(vc.info("startPublishGivenCDN: "+JSON.stringify(t)),this.publishGivenCDNData_=t,this.isPublishingGivenCDN_=!0,this.client_.isJoined_)try{const e=await this.signalChannel_.sendWaitForResponse({command:Gc,data:t,timeout:5e3,responseCommand:Pc.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDNStream"});let{code:i,message:n}=e.data;if(0!==i)throw vc.error(`startPublishGivenCDN failed, errCode: ${i}, errMsg: ${n}`),this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1,new Yc({code:Xc.START_PUBLISH_CDN_FAILED,message:Fr({key:Rs,data:{message:n},link:{className:"Client",fnName:"startPublishCDNStream"}})})}catch(i){throw this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1,i}}async stopPublishGivenCDN(){let{pushAppId:e,pushBizId:t,pushCdnUrl:i,pushStreamType:n}=this.publishGivenCDNData_;const s={pushRequestTime:Date.now(),pushAppId:e,pushBizId:t,pushCdnUrl:i,pushStreamType:n};vc.info("stopPublishGivenCDN: "+JSON.stringify(s));const r=await this.signalChannel_.sendWaitForResponse({command:Jc,data:s,timeout:5e3,responseCommand:Pc.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDNStream"});let{code:o,message:a}=r.data;if(0!==o)throw vc.error(`stopPublishGivenCDN failed, errCode: ${o} errMsg: ${a}`),new Yc({code:Xc.STOP_PUBLISH_CDN_FAILED,message:Fr({key:Cs,data:{message:a},link:{className:"Client",fnName:"stopPublishCDNStream"}})});this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}handleCDNConfigForJoinData(e){let t,i=e;if(this.isPublishingTencentCDN_){let e={};Kr(i)&&(e=JSON.parse(i)),e.Str_uc_params||(e.Str_uc_params={}),e.Str_uc_params.userdefine_streamid_main=this.generatePublishCDNStreamId(this.publishTencentStreamId_),i=JSON.stringify(e)}if(this.isPublishingGivenCDN_){let{pushAppId:e,pushBizId:i,pushCdnUrl:n,pushStreamType:s,pushStreamId:r}=this.publishGivenCDNData_;t={pushRequestTime:Date.now(),pushAppId:e,pushBizId:i,pushCdnUrl:n,pushStreamType:s,pushStreamId:r}}return{bussinessInfo:i,pushUserCdnInfo:t}}reset(){this.isPublishingTencentCDN_=!1,this.publishTencentStreamRetryCount_=0,this.publishTencentStreamId_=void 0,this.publishGivenCDNData_=null,this.isPublishingGivenCDN_=!1}}class Ch{constructor(e){this.client_=e.client,this.durationMap_=new Map,this.installEvents()}installEvents(){Ta.on(Wa,this.handleSubscribed,this),Ta.on(Ga,this.handleStreamTrackUpdated,this),Ta.on(qa,this.handleStreamStopped,this),Ta.on(Qa,this.handleStreamStopped,this)}uninstallEvents(){Ta.off(Wa,this.handleSubscribed,this),Ta.off(Ga,this.handleStreamTrackUpdated,this),Ta.off(qa,this.handleStreamStopped,this),Ta.off(Qa,this.handleStreamStopped,this)}handleSubscribed({client:e,stream:t}){if(e!==this.client_)return;const i=t.getUserId(),n=t.getType(),s=`${i}_${n}`;if(t.hasAudio())if(t.isMainAudioSubscribed){const e=new yh,t=this.durationMap_.get(s);t?this.isRecording(t.audio)||t.audio.push(e):this.durationMap_.set(s,{userId:i,type:n,audio:[e],video:[]})}else this.stopDurationItem(s,At);if(t.hasVideo())if(n===gi&&t.isMainVideoSubscribed||n===fi&&t.isAuxVideoSubscribed){const e=new yh,t=this.durationMap_.get(s);t?this.isRecording(t.video)||t.video.push(e):this.durationMap_.set(s,{userId:i,type:n,audio:[],video:[e]})}else this.stopDurationItem(s,Dt)}handleStreamStopped({client:e,stream:t}){if(!this.clientHitTest(e))return;const i=`${t.getUserId()}_${t.getType()}`;this.stopDurationItem(i,At),this.stopDurationItem(i,Dt)}handleStreamTrackUpdated({client:e,userId:t,tinyId:i,kind:n,action:s}){if(!this.clientHitTest(e)||!this.client_.getConnections().has(i))return;const r=n===Pt?n:gi,o=`${t}_${r}`;if(s===pn){const e=this.client_.getConnections().get(i).getSubscribeState();if(n===At&&!e.audio||n===Dt&&!e.video||n===Pt&&!e.auxiliary)return;const s=new yh,a=this.durationMap_.get(o);a?(n!==At||this.isRecording(a.audio)||a.audio.push(s),n===At||this.isRecording(a.video)||a.video.push(s)):this.durationMap_.set(o,{userId:t,type:r,audio:n===At?[s]:[],video:n===At?[]:[s]})}else this.stopDurationItem(o,n===At?At:Dt)}isRecording(e){return e.findIndex(e=>0===e.endTime)>=0}stopDurationItem(e,t){if(this.durationMap_.has(e)){const i=this.durationMap_.get(e)[t].find(e=>0===e.endTime);i&&i.stop()}}clientHitTest(e){return this.client_===e}getDuration(e,t){if(this.durationMap_.has(e)){return this.durationMap_.get(e)[t].reduce((e,t)=>e+t.getDuration(),0)}return 0}getDurationMap(){return this.durationMap_}reset(){this.durationMap_.clear()}destroy(){this.client_=null,this.uninstallEvents()}}const wh={msg_user_info:0,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0};class kh{constructor(e){this.str_identifier=String(e.userId),this.uint64_tinyid=Number(e.tinyId),this.uint32_role=e.role}}class Ah{constructor(e){this.frameWorkType_=e.frameWorkType||30,this.client_=e.client,this.keyPrefix_="key_point",this.storageKey_=`${this.keyPrefix_}_${this.client_.getUserId()}`,this.log_=vc.createLogger({id:"kpm|"+this.client_.getUserId(),userId:this.client_.getUserId(),sdkAppId:this.client_.getSDKAppId()}),this.upload=mc({retryFunction:this.upload,settings:{timeout:500,retries:3},onError:(e,t)=>t()}),Object.getOwnPropertyNames(this.__proto__).forEach(e=>{e.startsWith("handle")&&Wr(this[e])&&(this[e]=function({fn:e,context:t}){return async function(...i){try{return await e.apply(t||this,i)}catch(n){vc.error(e.name+"() error observed "+n)}}}({fn:this[e],context:this}))}),this.initData(),this.installEvents(),this.intervalId_=Yd.setInterval(this.setStorage.bind(this),2e4)}initData(){this.firstPublishedUserList_=[],this.networkQuality_={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this.basicInfo={string_sdk_version:"4.14.0",uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:"live"===this.client_.getMode()?1:0,uint32_joining_duration:0,uint32_networkType:mn[Hr()],uint32_framework:this.frameWorkType_},this.pathJoinRoom_={uint64_start_time:0,uint64_init_audio_start_time:0,uint64_init_audio_end_time:0,uint64_init_camera_start_time:0,uint64_init_camera_end_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_init_audio_ret:0,int32_init_camera_ret:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this.pathLeaveRoom_={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this.pathMainVideoMap_=new Map,this.pathMainAudioMap_=new Map,this.pathAuxiliaryMap_=new Map,this.localStreamStats_={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this.remoteStreamStatsMap_=new Map}installEvents(){Ta.on(Ea,this.handleJoinStart,this),Ta.on(La,this.handleWSStart,this),Ta.on(Oa,this.handleWSEnd,this),Ta.on(ba,this.handleJoinSendCMD,this),Ta.on(Ra,this.handleJoinReceivedCMDResponce,this),Ta.on(Ca,this.handleJoinSuccess,this),Ta.on(wa,this.handleJoinFailed,this),Ta.on(Na,this.handleReceivedPublishUserList,this),Ta.on(dc,this.handleConnectionStateChanged,this),Ta.on(ka,this.handleLeaveStart,this),Ta.on(Da,this.handleLeaveSuccess,this),Ta.on(Aa,this.handleLeaveSendCMD,this),Ta.on(lc,this.handleSendSubscribeCMD,this),Ta.on(ja,this.handleVideoPlaying,this),Ta.on(Ha,this.handleAudioPlaying,this),Ta.on(hc,this.handleNetworkQuality,this),Ta.on(Pa,this.handleHeartbeatStats,this),Ta.on(Ja,this.handleRemoteStreamAdded,this),Ta.on(za,this.handleRemoteStreamSubscribeStart,this),Ta.on(Wa,this.handleRemoteStreamSubscribed,this),Ta.on(sc,this.handleVideoLoadedData,this),Ta.on(nc,this.handlePlayStream,this),Ta.on(Ma,this.handlePublishStart,this),Ta.on(Ya,this.handleLocalStreamInitStart,this),Ta.on(Za,this.handleLocalStreamInitEnd,this),Ta.on(ec,this.handleLocalStreamInitFailed,this)}uninstallEvents(){Ta.off(Ea,this.handleJoinStart,this),Ta.off(La,this.handleWSStart,this),Ta.off(Oa,this.handleWSEnd,this),Ta.off(ba,this.handleJoinSendCMD,this),Ta.off(Ra,this.handleJoinReceivedCMDResponce,this),Ta.off(Na,this.handleReceivedPublishUserList,this),Ta.off(dc,this.handleConnectionStateChanged,this),Ta.off(ka,this.handleLeaveStart,this),Ta.off(Da,this.handleLeaveSuccess,this),Ta.off(Ca,this.handleJoinSuccess,this),Ta.off(wa,this.handleJoinFailed,this),Ta.off(Aa,this.handleLeaveSendCMD,this),Ta.off(lc,this.handleSendSubscribeCMD,this),Ta.off(ja,this.handleVideoPlaying,this),Ta.off(Ha,this.handleAudioPlaying,this),Ta.off(hc,this.handleNetworkQuality,this),Ta.off(Pa,this.handleHeartbeatStats,this),Ta.off(Ja,this.handleRemoteStreamAdded,this),Ta.off(za,this.handleRemoteStreamSubscribeStart,this),Ta.off(Wa,this.handleRemoteStreamSubscribed,this),Ta.off(sc,this.handleVideoLoadedData,this),Ta.off(nc,this.handlePlayStream,this),Ta.off(Ma,this.handlePublishStart,this),Ta.off(Ya,this.handleLocalStreamInitStart,this),Ta.off(Za,this.handleLocalStreamInitEnd,this),Ta.off(ec,this.handleLocalStreamInitFailed,this)}destroy(){this.uninstallEvents(),Yd.clearInterval(this.intervalId_),this.client_=null}handleJoinStart(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_start_time&&(this.pathJoinRoom_.uint64_start_time=Date.now(),this.checkStorage())}handleWSStart({client:e}){this.hitTest(e)&&0===this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_start_time&&(this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_start_time=Date.now())}handleWSEnd({client:e,error:t}){this.hitTest(e)&&0===this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_end_time&&(this.pathJoinRoom_.uint64_send_request_acc_ip_cmd_end_time=Date.now(),t&&(this.pathJoinRoom_.int32_send_request_acc_ip_cmd_ret=t instanceof Yc?Number(t.getExtraCode()||t.getCode()):Xc.UNKNOWN,this.pathJoinRoom_.int32_end_ret=2))}handleJoinSendCMD(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_start_time=Date.now())}handleJoinReceivedCMDResponce(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time&&(this.pathJoinRoom_.uint64_send_request_enter_room_cmd_end_time=Date.now(),this.pathJoinRoom_.int32_send_request_enter_room_cmd_ret=e.code,0!==e.code&&(this.pathJoinRoom_.int32_end_ret=3))}handleJoinSuccess(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_end_time&&(this.pathJoinRoom_.uint64_end_time=Date.now(),this.pathJoinRoom_.int32_end_ret=0)}handleJoinFailed({client:e}){this.hitTest(e)&&(this.pathJoinRoom_.uint64_end_time=Date.now(),0===this.pathJoinRoom_.int32_end_ret&&(this.pathJoinRoom_.int32_end_ret=3),this.prepareReport(),this.report())}handleReceivedPublishUserList(e){this.hitTest(e.client)&&0===this.pathJoinRoom_.uint64_recv_userlist_time&&(this.pathJoinRoom_.uint64_recv_userlist_time=Date.now(),this.firstPublishedUserList_=e.data.data&&e.data.data.userList||[])}handleConnectionStateChanged({client:e,state:t,connection:i}){if(this.hitTest(e)&&t===Ii){this.client_.getUplinkConnection()===i&&0===this.pathJoinRoom_.uint64_send_first_video_frame_time&&this.localStreamStats_.publishStartTime>this.pathJoinRoom_.uint64_end_time&&this.localStreamStats_.publishStartTime-this.pathJoinRoom_.uint64_end_time<=100&&(this.pathJoinRoom_.uint64_send_first_video_frame_time=Date.now());const e=this.pathMainVideoMap_.get(`${i.getUserId()}_${gi}`);e&&0===e.statsToReport.uint64_pc_connected_time&&(e.statsToReport.uint64_pc_connected_time=Date.now())}}handleLeaveStart(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_start_time=Date.now())}handleLeaveSuccess(e){this.hitTest(e.client)&&0===this.pathLeaveRoom_.uint64_end_time&&(this.pathLeaveRoom_.uint64_end_time=Date.now(),0!==this.pathJoinRoom_.uint64_end_time?this.basicInfo.uint32_joining_duration=this.pathLeaveRoom_.uint64_end_time-this.pathJoinRoom_.uint64_end_time:this.log_.warn("pathJoinRoom endTime is 0"),this.report())}handleLeaveSendCMD(e){this.hitTest(e.client)&&(this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_start_time=Date.now(),this.pathLeaveRoom_.uint64_send_request_exit_room_cmd_end_time=Date.now())}handleRemoteStreamAdded({client:e,stream:t}){if(this.hitTest(e)){const e=t.getUserId(),i=t.getType(),n=`${e}_${i}`,s=this.remoteStreamStatsMap_.get(n);if(s)s.stream=t;else{const s={userId:e,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:{...wh},stream:t};s.statsToReport.msg_user_info=new kh({userId:e,tinyId:t.getTinyId(),role:hi}),s.statsToReport.uint32_stream_type=i===gi?2:7,this.remoteStreamStatsMap_.set(n,s)}}}handleRemoteStreamSubscribeStart({client:e,stream:t}){if(this.hitTest(e)){const e=`${t.getUserId()}_${t.getType()}`,i=this.remoteStreamStatsMap_.get(e);i&&0===i.subscribeStartTime&&(i.subscribeStartTime=Date.now())}}handleSendSubscribeCMD(e){if(this.hitTest(e.client)){const t=new kh(e),i=Date.now(),n=`${e.userId}_${gi}`;e.trackState.video&&e.subscribeState.video&&!this.pathMainVideoMap_.has(n)&&this.pathMainVideoMap_.set(n,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0,uint64_pc_connected_time:0},userId:e.userId,sendSubscribeCMDTime:i}),e.trackState.audio&&e.subscribeState.audio&&!this.pathMainAudioMap_.has(n)&&this.pathMainAudioMap_.set(n,{statsToReport:{msg_user_info:t,uint64_start_enter_time:this.pathJoinRoom_.uint64_start_time,uint64_play_first_frame_time:0},userId:e.userId,sendSubscribeCMDTime:i});const s=`${e.userId}_${fi}`;e.trackState.auxiliary&&e.subscribeState.auxiliary&&!this.pathAuxiliaryMap_.has(s)&&this.pathAuxiliaryMap_.set(s,{sendSubscribeCMDTime:i})}}handleRemoteStreamSubscribed({client:e,stream:t}){if(this.hitTest(e)){const e=`${t.getUserId()}_${t.getType()}`,i=this.remoteStreamStatsMap_.get(e);i&&0===i.subscribedTime&&(i.subscribedTime=Date.now(),i.stream=t)}}handlePlayStream({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`;if(this.remoteStreamStatsMap_.has(t)){const e=this.remoteStreamStatsMap_.get(t);0===e.playStreamTime&&(e.playStreamTime=Date.now())}}handleVideoLoadedData({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`;if(this.pathMainVideoMap_.has(t)){const e=this.pathMainVideoMap_.get(t);0===e.statsToReport.uint64_combine_first_frame_time&&(e.statsToReport.uint64_combine_first_frame_time=Date.now())}}handleVideoPlaying({stream:e}){if(!e.isRemote()||!e.getConnection()||!this.hitTest(e.getConnection().getClient()))return;const t=`${e.getConnection().getUserId()}_${e.getType()}`,i=Date.now();if(this.pathMainVideoMap_.has(t)){const e=this.pathMainVideoMap_.get(t);if(0===e.statsToReport.uint64_render_first_frame_time&&(e.statsToReport.uint64_render_first_frame_time=i),this.remoteStreamStatsMap_.has(t)){const{statsToReport:n,playStreamTime:s,subscribedTime:r}=this.remoteStreamStatsMap_.get(t);0===n.uint32_video_render_first&&s-r<=100&&(n.uint32_video_render_first=i-e.sendSubscribeCMDTime)}}if(e.getType()===fi&&this.pathAuxiliaryMap_.has(t)&&this.remoteStreamStatsMap_.has(t)){const{statsToReport:e,playStreamTime:n,subscribedTime:s}=this.remoteStreamStatsMap_.get(t);0===e.uint32_video_render_first&&n-s<=100&&(e.uint32_video_render_first=i-this.pathAuxiliaryMap_.get(t).sendSubscribeCMDTime)}}handleAudioPlaying(e){if(!e.stream.isRemote()||!e.stream.getConnection()||!this.hitTest(e.stream.getConnection().getClient()))return;const t=`${e.stream.getConnection().getUserId()}_${e.stream.getType()}`;if(this.pathMainAudioMap_.has(t)){const e=this.pathMainAudioMap_.get(t);0===e.statsToReport.uint64_play_first_frame_time&&(e.statsToReport.uint64_play_first_frame_time=Date.now())}}handleNetworkQuality(e){this.hitTest(e.client)&&(this.networkQuality_.totalUplinkLoss+=e.uplinkLoss,this.networkQuality_.totalUplinkRTT+=e.uplinkRTT,this.networkQuality_.count++,e.downlinkLossAndRTTMap.forEach(({rtt:e,loss:t,userId:i})=>{const n=this.networkQuality_.totalDownlinkRTTAndLossMap.get(i);n?(n.totalRTT+=e,n.totalLoss+=t,n.count++):this.networkQuality_.totalDownlinkRTTAndLossMap.set(i,{totalRTT:e,totalLoss:t,count:1})}))}handleHeartbeatStats(e){if(this.hitTest(e.client)){const{msg_up_stream_info:t,msg_down_stream_info:i}=e.stats;if(t.msg_video_status[0]){const{uint32_video_codec_bitrate:e,uint32_video_enc_fps:i,uint32_video_width:n,uint32_video_height:s}=t.msg_video_status[0];this.localStreamStats_.totalVideoBitrate+=e,this.localStreamStats_.totalVideoFPS+=i,this.localStreamStats_.totalVideoWidth+=n,this.localStreamStats_.totalVideoHeight+=s,this.localStreamStats_.videoCount++}const n=t.msg_audio_status.audioLevel;Math.floor(100*n)>0&&(this.localStreamStats_.totalAudioLevel+=n,this.localStreamStats_.audioLevelCount++),i.forEach(e=>{const{msg_user_info:t,msg_audio_status:i,msg_video_status:n}=e,s=t.str_identifier;if(n.forEach(e=>{const t=2===e.uint32_video_stream_type,i=7===e.uint32_video_stream_type,n=`${s}_${t?gi:fi}`;if(this.remoteStreamStatsMap_.has(n)){const s=this.remoteStreamStatsMap_.get(n);(t&&s.stream.isMainVideoSubscribed||i&&s.stream.isAuxVideoSubscribed)&&(s.totalVideoFPS+=e.uint32_video_receive_fps,s.totalVideoBitrate+=e.uint32_video_codec_bitrate,s.videoCount++,0===s.statsToReport.uint32_video_width&&(s.statsToReport.uint32_video_width=e.uint32_video_width),0===s.statsToReport.uint32_video_height&&(s.statsToReport.uint32_video_height=e.uint32_video_height))}}),i){const e=`${s}_${gi}`;if(this.remoteStreamStatsMap_.has(e)){const t=this.remoteStreamStatsMap_.get(e);t.stream.isMainAudioSubscribed&&(t.totalAudioBitrate+=i.uint32_audio_codec_bitrate,t.audioCount++,Math.floor(100*i.audioLevel)>0&&(t.totalAudioLevel+=i.audioLevel,t.audioLevelCount++))}}})}}handlePublishStart({client:e}){this.hitTest(e)&&0===this.localStreamStats_.publishStartTime&&(this.localStreamStats_.publishStartTime=Date.now())}handleLocalStreamInitStart({audio:e,video:t}){e&&0===this.pathJoinRoom_.uint64_init_audio_start_time&&(this.pathJoinRoom_.uint64_init_audio_start_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_start_time&&(this.pathJoinRoom_.uint64_init_camera_start_time=Date.now())}handleLocalStreamInitEnd({audio:e,video:t}){e&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}handleLocalStreamInitFailed({audio:e,video:t,error:i}){const n=i instanceof Yc?i.getExtraCode()||i.getCode():{NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5}[i.name]||Xc.UNKNOWN;e&&0===this.pathJoinRoom_.uint64_init_audio_end_time&&(this.pathJoinRoom_.int32_init_audio_ret=n,this.pathJoinRoom_.uint64_init_audio_end_time=Date.now()),t&&0===this.pathJoinRoom_.uint64_init_camera_end_time&&(this.pathJoinRoom_.int32_init_camera_ret=n,this.pathJoinRoom_.uint64_init_camera_end_time=Date.now())}hasVideoFlag(e){return this.firstPublishedUserList_.findIndex(t=>t.userId===e&&1&t.flag)>=0}hasAudioFlag(e){return this.firstPublishedUserList_.findIndex(t=>t.userId===e&&8&t.flag)>=0}hasAuxFlag(e){return this.firstPublishedUserList_.findIndex(t=>t.userId===e&&4&t.flag)>=0}hitTest(e){return e===this.client_}async checkStorage(){try{const e=Zd.getItem(this.storageKey_);e&&(await this.upload(e),Zd.deleteItem(this.storageKey_))}catch(e){this.log_.warn(e)}}setStorage(){this.prepareReport();const e=this.getReportData();0!==e.msg_path_enter_room.uint64_start_time&&Zd.setItem(this.storageKey_,e)}prepareReport(){if(this.networkQuality_.count>0&&(this.basicInfo.uint32_avg_rtt=Math.floor(this.networkQuality_.totalUplinkRTT/this.networkQuality_.count),this.basicInfo.uint32_avg_up_loss=Math.floor(this.networkQuality_.totalUplinkLoss/this.networkQuality_.count)),this.localStreamStats_.videoCount>0){this.localStreamStats_.statsToReport.uint32_video_big_capture_fps=Math.floor(this.localStreamStats_.totalVideoFPS/this.localStreamStats_.videoCount),this.localStreamStats_.statsToReport.uint32_video_big_bitrate=Math.floor(this.localStreamStats_.totalVideoBitrate/this.localStreamStats_.videoCount);const e=Math.floor(this.localStreamStats_.totalVideoWidth/this.localStreamStats_.videoCount),t=Math.floor(this.localStreamStats_.totalVideoHeight/this.localStreamStats_.videoCount);this.localStreamStats_.statsToReport.uint32_video_big_resolution=e<<16|t}this.localStreamStats_.audioLevelCount>0&&(this.localStreamStats_.statsToReport.uint32_audio_capture_db=Math.floor(this.localStreamStats_.totalAudioLevel/this.localStreamStats_.audioLevelCount*100)),this.remoteStreamStatsMap_.forEach((e,t)=>{const i=e.userId;if(this.networkQuality_.totalDownlinkRTTAndLossMap.has(i)){const{totalLoss:t,count:n}=this.networkQuality_.totalDownlinkRTTAndLossMap.get(i);e.statsToReport.uint32_avg_down_loss=Math.floor(t/n)}e.videoCount>0&&(e.statsToReport.uint32_video_avg_fps=Math.floor(e.totalVideoFPS/e.videoCount),e.statsToReport.uint32_video_avg_bitrate=Math.floor(e.totalVideoBitrate/e.videoCount)),e.audioCount>0&&(e.statsToReport.uint32_audio_recv_bitrate=e.statsToReport.uint32_audio_bitrate=Math.floor(e.totalAudioBitrate/e.audioCount)),e.audioLevelCount>0&&(e.statsToReport.uint32_audio_play_db=Math.floor(e.totalAudioLevel/e.audioLevelCount*100));const n=this.client_.getCallDurationCalculator();n&&(e.statsToReport.uint32_audio_play_time=n.getDuration(t,At),e.statsToReport.uint32_video_play_time=n.getDuration(t,Dt)),e.statsToReport.uint32_video_render_first=Math.min(e.statsToReport.uint32_video_render_first,5e3);const s=this.client_.getBadCaseDetector();if(s){const{dataFreeze:i,count:n}=s.getDataFreezeDuration(t),{renderFreeze:r}=s.getRenderFreezeDuration(t);e.statsToReport.uint32_video_block_count=n,e.statsToReport.uint32_video_block_time=Math.min(i,e.statsToReport.uint32_video_play_time),e.statsToReport.uint32_video_external_block_time=Math.min(r,e.statsToReport.uint32_video_play_time),s.isBlackStream(t)&&0===e.statsToReport.uint32_video_avg_fps?e.statsToReport.uint32_video_black_screen_subjective=1:e.statsToReport.uint32_video_black_screen_subjective=0}(0===e.subscribeStartTime||e.subscribeStartTime-e.streamAddedTime>100||0===e.playStreamTime)&&(this.pathMainAudioMap_.delete(t),this.pathMainVideoMap_.delete(t),e.statsToReport.uint32_video_render_first=0)}),this.pathMainAudioMap_.forEach((e,t)=>{this.hasAudioFlag(e.userId)?e.statsToReport.uint64_play_first_frame_time-e.statsToReport.uint64_start_enter_time>5e3&&(e.statsToReport.uint64_play_first_frame_time=e.statsToReport.uint64_start_enter_time+5e3):this.pathMainAudioMap_.delete(t)}),this.pathMainVideoMap_.forEach((e,t)=>{this.hasVideoFlag(e.userId)?e.statsToReport.uint64_render_first_frame_time-e.statsToReport.uint64_start_enter_time>5e3&&(e.statsToReport.uint64_render_first_frame_time=e.statsToReport.uint64_start_enter_time+5e3):this.pathMainVideoMap_.delete(t)}),this.pathJoinRoom_.uint64_end_time-this.pathJoinRoom_.uint64_start_time>5e3&&(this.pathJoinRoom_.uint64_end_time=this.pathJoinRoom_.uint64_start_time+5e3)}getReportData(){const e=this.client_.getSignalInfo();return{uint32_sdk_app_id:Number(this.client_.getSDKAppId()),msg_user_info:new kh({userId:this.client_.getUserId(),tinyId:this.client_.getTinyId(),role:"anchor"===this.client_.getRole()?hi:ui}),msg_basic_info:this.basicInfo,uint32_acc_ip:no(e.relayIp),uint32_client_ip:no(e.clientIp,"small"),uint32_acc_port:0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(Math.random()*2**31),msg_path_enter_room:this.pathJoinRoom_,msg_path_exit_room:this.pathLeaveRoom_,msg_path_recv_video:[...this.pathMainVideoMap_.values()].map(e=>e.statsToReport),msg_quality_statistics:[...this.remoteStreamStatsMap_.values()].map(e=>e.statsToReport),str_room_name:String(this.client_.getRoomId()),msg_path_recv_audio:[...this.pathMainAudioMap_.values()].map(e=>e.statsToReport),uint32_info_client_ip:no(e.clientIp,"small"),error_code:[],msg_local_statistics:this.localStreamStats_.statsToReport}}async report(){try{const e=this.getReportData();await this.upload(e),Zd.deleteItem(this.storageKey_),this.initData()}catch(e){this.log_.warn(e)}}async upload(e){if(bt||0===e.msg_path_enter_room.uint64_start_time||[kn,An,Dn].findIndex(e=>e===location.host)>=0)return;const t=Number(this.client_.getSDKAppId()),i=jr(t,ai),n=await ya.post(i,JSON.stringify(e));if("ok"!==n.data)throw"key point upload failed: "+n.data}}function Dh(){return function(e,t,i){const n=i.value,s=new Set;return i.value=async function(...e){if(s.has(this))throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:xn,data:{name:t}})});try{s.add(this);const t=await n.apply(this,e);return s.delete(this),t}catch(i){throw s.delete(this),i}},i}}async function Ph({userId:e,sdkAppId:t,useStringRoomId:i,roomId:n,userSig:s}){const r={delta:0,count:[1,1],msg:[]};try{const o=new FormData;o.append("userId",String(e)),o.append("sdkAppId",String(t)),o.append("isStrGroupId",i),o.append("groupId",String(n)),o.append("sdkVersion","4.14.0"),o.append("userSig",String(s));const a=io(),c=await function(e,t,i){return new Promise((n,s)=>{let r=null;var o;(o=[Oh(e=>t.count[0]=e+1,(e,i)=>{t.msg[0]=e.message,r||i()})(Mh(i,zt),e,{get timeout(){return 1e3*Jr(2+t.count[0])}}),Oh(e=>t.count[1]=e+1,(e,i)=>{t.msg[1]=e.message,r||i()})(Mh(i,Wt),e,{get timeout(){return 1e3*Jr(2+t.count[1])}})],new Promise((e,t)=>{let i=[];o.forEach(n=>{n.then(e).catch(e=>{i.push(e),i.length===o.length&&t(i)})})})).then(e=>{r=e,n(r)}).catch(s)})}(o,r,t);return r.delta=io()-a,Nh({stat:r,userId:e}),c}catch(o){const t=Yr(o)?o[0]:o,i=Qr(t.code)?t.code:0,s="get websocket url failed: "+(t.message.includes("timeout")?"timeout":t.message),a=new Yc({code:Xc.SCHEDULE_FAILED,extraCode:i,message:Fr({key:as,data:{error:s,code:i}})});throw vc.error(a),Nh({stat:r,userId:e,roomId:n,error:a}),a}}function Nh({stat:e,userId:t,error:i}){i?Fd.logFailedEvent({eventType:en,error:i,userId:t}):Fd.logSuccessEvent({eventType:en,delta:e.delta,userId:t}),Fd.uploadEvent({log:"stat-schedule:"+JSON.stringify(e),userId:t})}function Mh(e,t=zt){let i;return i=Br(e)?t===zt?In:Tn:t===zt?Sn:yn,`https://${i}/api/v1/config`}function Lh(e,t,i){return new Promise((n,s)=>{ya.post(e,t,i).then(e=>{0===e.data.code?n(e.data.data):s({code:e.data.code,message:e.data.msg})}).catch(s)})}const Oh=(e,t)=>mc({retryFunction:Lh,settings:{retries:3,timeout:0},onError:t,onRetrying:e});var xh,Uh,Vh,Fh,$h,Bh,jh,Hh,Gh,Jh,zh,Wh,qh,Kh,Qh,Xh,Yh=new class{constructor(){}call(e,t){return Wr(this[e])?this[e](t):Promise.reject(new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Cr,data:{name:e}})}))}updatePrivateMapKey({privateMapKey:e,client:t}){return t.setProperty("privateMapKey",e),Promise.resolve()}};let Zh=(xh=Dh(),Uh=ah(rh.CLIENT.join),Vh=Dh(),Fh=Dh(),$h=ah(rh.CLIENT.publish),Bh=Dh(),jh=ah(rh.CLIENT.unpublish),Hh=ah(...rh.CLIENT.subscribe),Gh=ah(rh.CLIENT.unsubscribe),Jh=Dh(),zh=ah(rh.CLIENT.switchRole),Wh=ah(rh.CLIENT.startPublishCDNStream),qh=ah(rh.CLIENT.startMixTranscode),Kh=oh(...rh.CLIENT.sendSEIMessage),Qh=function({timesInSecond:e,maxSizeInSecond:t,getSize:i}){return function(n,s,r){const o=r.value,a=new Map;return Ta.on(Ua,({client:e})=>a.delete(e)),r.value=function(...n){let r=a.get(this);if(r||(r={callCountInSecond:0,timestamp:0,totalSizeInSecond:0},a.set(this,r)),0===r.timestamp?r.timestamp=Date.now():Date.now()-r.timestamp>1e3&&(r.timestamp=Date.now(),r.callCountInSecond=0,r.totalSizeInSecond=0),i&&(r.totalSizeInSecond+=i(...n)),0!==r.timestamp&&Date.now()-r.timestamp<1e3&&(r.callCountInSecond>=e||r.totalSizeInSecond>t))throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Or,data:{isTimes:r.callCountInSecond>=e,isSize:r.totalSizeInSecond>t,name:s,timesInSecond:e,maxSizeInSecond:t}})});return r.callCountInSecond++,o.apply(this,n)},r}}({timesInSecond:30,maxSizeInSecond:8e3,getSize:(...e)=>e[0].byteLength}),e((Xh=class{constructor(e){this.name_=bn,this.mode_=e.mode,this.sdpSemantics_="plan-b",qr(e.sdpSemantics)?function(){if(!dl())return!1;if(qr(window.RTCRtpTransceiver))return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let t=!1;try{e.addTransceiver(At),t=!0}catch(i){}return e.close(),t}()&&(this.sdpSemantics_="unified-plan"):this.sdpSemantics_=e.sdpSemantics,this.sdkAppId_=e.sdkAppId,this.userId_=e.userId,this.log_=vc.createLogger({id:`c${e.seq}|${this.userId_}`,userId:this.userId_,sdkAppId:this.sdkAppId_}),this.userSig_=e.userSig,this.roomId_=0,this.useStringRoomId_=e.useStringRoomId||!1,this.pureAudioPushMode_=null,this.version_=e.version,this.log_.info("using sdpSemantics: "+this.sdpSemantics_),this.signalChannel_=null,this.role_="anchor",this.privateMapKey_="",this.tinyId_=0,this.env_="",this.proxy_=null,this.connections_=new Map,this.mutedStates_=new Map,this.userMap_=new Map,this.syncUserListInterval_=-1,this.localStream_=null,this.uplinkConnection_=null,this.emitter_=co(new Ia,this.name_),this.isJoined_=!1,this.heartbeat_=-1,this.lastHeartBeatTime_=-1,this.stats_=new Ml(this),this.joinTimeout_=-1,this.changeBigSmallRecords_=new Map,this.networkQuality_=null,this.badCaseDetector_=null,this.networkType_=Hr(),this.autoSubscribe_=!!qr(e.autoSubscribe)||e.autoSubscribe,this.joinedTimestamp_=0,this.joinOptions_={},this.basis_=function(){const e={browser:wt().name+"/"+wt().version,os:fl(),displayResolution:vl(),isScreenShareSupported:rl(),isWebRTCSupported:il(),isGetUserMediaSupported:Sl(),isWebAudioSupported:yl(),isWebSocketsSupported:"WebSocket"in window&&2===window.WebSocket.CLOSING,isWebCodecSupported:Tl(),isMediaSessionSupported:"mediaSession"in navigator&&!qr(navigator.mediaSession.setActionHandler),isWebTransportSupported:!qr(window.WebTransport)};return navigator.userAgent.includes("miniProgram")&&(e.browser="mini/"+e.browser),e}(),this.initBussinessInfo_(e),this.publishedCDN_=!1,this.publishCDNData_=null,this.mixedMCU_=!1,this.mixTranscodeData_=null,this.checkSystemResult_=null,this.enableAudioVolumeEvaluation_=!1,this.audioVolumeIntervalId_=null,this.mixTranscodeManager_=null,this.publishCDNManager_=new Rh({client:this}),this.keyPointManager_=new Ah({client:this,frameWorkType:e.frameWorkType}),this.getUserList=mc({retryFunction:this.getUserList,settings:{retries:3},onError:(e,t)=>t()}),this.isPublishing_=!1,this.isEnableSmallStream_=!1,this.smallStreamConfig_={bitrate:100,frameRate:15,height:120,width:160},this.turnServers_=[],this.iceTransportPolicy_=e.iceTransportPolicy,this.schedule_={domains:null,iceServers:null,iceTransportPolicy:null},this.enableAutoPlayDialog_=!!qr(e.enableAutoPlayDialog)||e.enableAutoPlayDialog,this.signalInfo_={},this.enableSEI_=!qr(e.enableSEI)&&e.enableSEI,this.isDestroyed_=!1}initBussinessInfo_(e){this.bussinessInfo_=e.bussinessInfo;let t={};if(Kr(e.bussinessInfo)&&(t=JSON.parse(e.bussinessInfo)),!qr(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Yn})});this.pureAudioPushMode_=e.pureAudioPushMode,t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.pure_audio_push_mod=this.pureAudioPushMode_}if(!qr(e.streamId)){if(!(Kr(e.streamId)&&String(e.streamId)&&String(e.streamId).length<=64))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Zn})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_streamid_main=e.streamId}if(!qr(e.userDefineRecordId)){const i=/^[A-Za-z0-9_-]{1,64}$/gi;if(null===e.userDefineRecordId.match(i))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:es})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!qr(e.userDefinePushArgs)){if(!(Kr(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:ts})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_push_args=e.userDefinePushArgs}Vd(t)||(this.bussinessInfo_=JSON.stringify(t))}setProxyServer(e){if(this.log_.info("set proxy server: "+JSON.stringify(e)),Kr(e)){if(!e.startsWith("wss://"))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:is})});this.proxy_=e}else if(Gr(e)){const{websocketProxy:t,loggerProxy:i}=e;t&&(this.proxy_=t),i&&ci(i)}}async schedule(e){const t=await Ph({userId:this.userId_,sdkAppId:this.sdkAppId_,roomId:e,useStringRoomId:this.useStringRoomId_,version:this.version_,userSig:this.userSig_});t&&(this.log_.info("schedule: "+JSON.stringify(t)),this.schedule_={...this.schedule_,...t},Ta.emit(Va,this.schedule_))}getSignalChannelUrl(){const e={mainUrl:"",backupUrl:""},t=$r();return t?e.mainUrl=e.backupUrl=`wss://${t}.rtc.qq.com`:this.proxy_?e.mainUrl=e.backupUrl=this.proxy_:Array.isArray(this.schedule_.domains)&&this.schedule_.domains.length>0&&(e.mainUrl=e.backupUrl="wss://"+this.schedule_.domains[0],this.schedule_.domains[1]&&(e.backupUrl="wss://"+this.schedule_.domains[1])),e}getUserId(){return this.userId_}getUserSig(){return this.userSig_}getRole(){return this.role_}getSignalInfo(){return this.signalInfo_}getRoomId(){return this.roomId_}getSDKAppId(){return this.sdkAppId_}getTinyId(){return this.tinyId_}setTurnServer(e){this.log_.info("set turn server: "+JSON.stringify(e));const t=[];Array.isArray(e)?e.forEach(e=>t.push(to(e))):Gr(e)&&t.push(to(e)),this.turnServers_=t}getIceTransportPolicy(){return this.iceTransportPolicy_||this.schedule_.iceTransportPolicy||"all"}initialize(){this.log_.info("setup signal channel");const{mainUrl:e,backupUrl:t}=this.getSignalChannelUrl();return this.signalChannel_=new $d({sdkAppId:this.sdkAppId_,userId:this.userId_,userSig:this.userSig_,url:e,backupUrl:t,client:this}),this.networkQuality_||(this.networkQuality_=new Ll({connections:this.connections_,signalChannel:this.signalChannel_,userId:this.userId_,client:this}),this.networkQuality_.on(Cl.NETWORK_QUALITY,e=>{this.emitter_.emit(Cl.NETWORK_QUALITY,e)})),this.deviceDetector_||(this.deviceDetector_=new Ol({client:this})),this.subscriptionManager_||(this.subscriptionManager_=new uh({client:this})),this.badCaseDetector_||(this.badCaseDetector_=new Ih({client:this,stats:this.stats_})),this.callDurationCalculator_||(this.callDurationCalculator_=new Ch({client:this})),this.mixTranscodeManager_||(this.mixTranscodeManager_=new bh({client:this,signalChannel:this.signalChannel_})),this.publishCDNManager_&&this.publishCDNManager_.setSignalChannel({signalChannel:this.signalChannel_}),this.signalChannel_.on(Tc,e=>{this.log_.info(`SignalChannel state changed from ${e.prevState} to ${e.state}`),this.emitter_.emit(Cl.CONNECTION_STATE_CHANGED,e)}),this.signalChannel_.on(bc,e=>{this.reset(),this.emitter_.emit(Cl.ERROR,e)}),this.signalChannel_.once(yc,e=>{this.tinyId_=e.signalInfo.tinyId,Ta.emit(Oa,{client:this})}),this.signalChannel_.on(Pc.PEER_JOIN,this.onPeerJoin,this),this.signalChannel_.on(Pc.PEER_LEAVE,this.onPeerLeave,this),this.signalChannel_.on(Pc.UPDATE_REMOTE_MUTE_STAT,e=>{Date.now()-this.lastHeartBeatTime_>=1e4&&this.doHeartbeat(),Ta.emit(Na,{client:this,data:e.data}),this.onPublishedUserList(e.data),this.onUpdateRemoteMuteStat(e.data)}),this.signalChannel_.on(Pc.CLIENT_BANNED,e=>{let t,i=e.data.data.reason;if(Fd.uploadEvent({log:"stat-banned:"+i,userId:this.userId_}),i===qt)t="you got banned by the admin";else if(i===Kt)t="duplicated userId joining the room";else if(i===Xt)t="the room has been disbanded by the admin",i=i.replace("_","-");else if(i===Qt)return this.log_.warn(`${i} last heart beat time: ${this.lastHeartBeatTime_} interval: ${Date.now()-this.lastHeartBeatTime_}, visibility: ${document.visibilityState}`),void this.reJoin();this.log_["kick"===i?"error":"info"](`user was banned because of [${i}]`),this.reset(),this.emitter_.emit(Cl.CLIENT_BANNED,{reason:i,message:Fr({key:Is,data:{message:t,reason:i}})||i})}),Ta.emit(La,{client:this}),this.signalChannel_.connect()}async preJoin(e){this.joinOptions_=e,this.checkSystemResult_=await sl(),this.checkDestroy();let t=$r();t||(t=ti,this.proxy_&&(this.proxy_.startsWith(Zt)?t=ii:this.proxy_.startsWith(ei)&&(t=ni))),this.env_=t,Fd.setConfig({env:t,sdkAppId:this.sdkAppId_,userId:this.userId_,roomId:e.roomId}),this.uploadTrtcStats();const{isH264EncodeSupported:i,isVp8EncodeSupported:n}=this.checkSystemResult_.detail;if(!il()||!i&&!n)throw new Yc({code:Xc.NOT_SUPPORTED,message:Fr({key:gr})})}async join(e){const t=io();return Ta.emit(Ea,{client:this,roomId:e.roomId}),xd(this.userId_,{eventId:vd,eventDesc:"joining room",timestamp:me(),userId:this.userId_,tinyId:this.tinyId_}),await this.preJoin(e),new Promise(async(i,n)=>{this.joinReject_=n;try{this.proxy_||this.schedule_.domains||await this.schedule(e.roomId),this.checkDestroy(),await this.initialize(e),await this.doJoin(e),this.signalInfo_=this.signalChannel_.getSignalInfo(),Ta.emit(Ca,{client:this}),this.joinedTimestamp_=io(),Fd.logSuccessEvent({userId:this.userId_,eventType:Di,delta:this.joinedTimestamp_-t}),Fd.logSuccessEvent({userId:this.userId_,eventType:Ai}),Fd.uploadEvent({log:"stat-autoplay-dialog:"+this.enableAutoPlayDialog_,userId:this.userId_}),Fd.uploadEvent({log:`stat-conv-${bt}-${location.hostname}`,userId:this.userId_}),i()}catch(s){Ta.emit(wa,{client:this,error:s}),Fd.logFailedEvent({userId:this.userId_,eventType:Ai,error:s}),this.reset(),n(s)}this.joinReject_=null})}checkDestroy(){if(this.isDestroyed_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ys,data:{funName:"join"}})})}async uploadTrtcStats(){let e,t;try{const t=await mu.getMicrophones();e=t&&t.length}catch(l){}try{const e=await mu.getCameras();t=e&&e.length}catch(l){}const i={microphone:e,camera:t},{isH264EncodeSupported:n,isVp8EncodeSupported:s,isH264DecodeSupported:r,isVp8DecodeSupported:o}=this.checkSystemResult_.detail,a={webRTC:this.basis_.isWebRTCSupported,getUserMedia:this.basis_.isGetUserMediaSupported,webSocket:this.basis_.isWebSocketsSupported,screenShare:this.basis_.isScreenShareSupported,webAudio:this.basis_.isWebAudioSupported,h264Encode:n,h264Decode:r,vp8Encode:s,vp8Decode:o},c={browser:this.basis_.browser,os:this.basis_.os,trtc:a,devices:i},d={isWebCodecSupported:this.basis_.isWebCodecSupported,isMediaSessionSupported:this.basis_.isMediaSessionSupported,isWebTransportSupported:this.basis_.isWebTransportSupported};Fd.uploadEvent({log:"trtcstats-"+JSON.stringify(c),userId:this.userId_}),this.log_.info("TrtcStats-"+JSON.stringify(c)),Fd.uploadEvent({log:"trtcadvancedstats-"+JSON.stringify(d),userId:this.userId_})}doJoin(e){return new Promise((t,i)=>{this.roomId_=e.roomId,qr(e.role)||(this.role_=e.role),qr(e.privateMapKey)||(this.privateMapKey_=e.privateMapKey),this.log_.info(`Join() => joining room: ${e.roomId} useStringRoomId: ${this.useStringRoomId_} mode: ${this.mode_} role: ${this.role_}`);const n={roomId:String(e.roomId),useStringRoomId:this.useStringRoomId_,privateMapKey:this.privateMapKey_,trtcRole:"anchor"===this.role_?hi:ui,trtcScene:"live"===this.mode_?li:di,sdpSemantics:this.sdpSemantics_,version:ho(this.version_),ua:navigator&&navigator.userAgent||"",autoSubscribe:this.autoSubscribe_,terminalType:be?4:Ie?2:Se?3:Ye?12:Xe?5:Ze?13:1,netType:mn[Hr()],bussinessInfo:this.bussinessInfo_};if(this.publishCDNManager_){const{bussinessInfo:e,pushUserCdnInfo:t}=this.publishCDNManager_.handleCDNConfigForJoinData(this.bussinessInfo_);Object.assign(n,{bussinessInfo:e,pushUserCdnInfo:t})}this.log_.debug("join room signal data: "+JSON.stringify(n)),this.joinTimeout_=setTimeout(()=>{this.log_.error("join room timeout observed"),i(new Yc({code:Xc.JOIN_ROOM_FAILED,message:Fr({key:os})}))},5e3),Ta.emit(ba,{client:this}),this.signalChannel_.once(Ic,e=>{this.clearJoinTimeout(),Ta.emit(Oa,{client:this,error:e}),i(e)}),this.signalChannel_.send(Mc,n),this.signalChannel_.once(Pc.JOIN_ROOM_RESULT,e=>{this.clearJoinTimeout();const{code:n,message:s,data:r}=e.data;this.onPublishedUserList({data:{userList:r.publishers}}),Ta.emit(Ra,{client:this,code:n}),0===n?(this.isJoined_=!0,this.log_.info("Join room success, start heartbeat"),this.startHeartbeat(),this.badCaseDetector_&&this.badCaseDetector_.start(),this.syncUserList(),this.startSyncUserListInterval(),t()):(this.log_.error("Join room failed result: "+n+" error: "+s),i(new Yc({code:Xc.JOIN_ROOM_FAILED,extraCode:n,message:Fr({key:as,data:{error:s,code:n}})})))})})}async reJoin(){if(this.isJoined_){this.isJoined_=!1;try{this.log_.warn("reJoin pending: "+this.joinOptions_.roomId),this.subscriptionManager_&&this.subscriptionManager_.markAllStream(),this.signalChannel_.close(),await this.signalChannel_.connect(),await this.doJoin({...this.joinOptions_,role:this.role_,privateMapKey:this.privateMapKey_}),this.log_.warn("reJoin success"),Fd.logSuccessEvent({userId:this.userId_,eventType:Pi}),this.checkConnectionsToReconnect(),this.republish(),this.mixTranscodeManager_&&this.mixTranscodeManager_.reStartMixTranscode()}catch(e){this.log_.warn("reJoin fail "+e),this.reset(),Fd.logFailedEvent({userId:this.userId_,eventType:Pi,error:e}),this.emitter_.emit(Cl.ERROR,new Yc({code:Xc.JOIN_ROOM_FAILED,message:Fr({key:cs,data:{roomId:this.joinOptions_.roomId}})}))}}else this.log_.warn("reJoin abort")}republish(){if(!this.uplinkConnection_||!this.localStream_||this.uplinkConnection_.getIsReconnecting())return;this.log_.warn("republish pending");const e=this.localStream_;this.doUnpublish(e).then(()=>this.publish(e)).then(()=>this.log_.warn("republish success")).catch(e=>this.log_.warn("republish fail "+e))}async leave(){Ta.emit(ka,{client:this}),xd(this.userId_,{eventId:Sd,eventDesc:"leaving room",timestamp:me(),userId:this.userId_,tinyId:this.tinyId_});try{await this.doHeartbeat()}catch(t){}this.doLeave(),Ta.emit(Da,{client:this}),Fd.logSuccessEvent({userId:this.userId_,eventType:Ni});const e=Math.floor((io()-this.joinedTimestamp_)/1e3);Fd.logSuccessEvent({userId:this.userId_,eventType:Mi,delta:e})}doLeave(){this.isJoined_&&(Ta.emit(Aa,{client:this}),this.log_.info("leave() => leaving room"),this.signalChannel_.send(Lc),this.reset())}clearNetworkQuality(){this.networkQuality_&&(this.networkQuality_.stop(),this.networkQuality_=null)}closeConnections(){this.connections_.forEach(e=>{this.closeDownLink(e.getTinyId())})}clearJoinTimeout(){clearTimeout(this.joinTimeout_),this.joinTimeout_=-1}destroy(){var e,t,i;if(this.isJoined_)throw this.log_.warn(xr.INVALID_DESTROY),new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ds})});this.isDestroyed_||(this.log_.info("destroy client"),this.joinReject_&&(this.joinReject_(new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ys,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.off("*"),null===(e=this.callDurationCalculator_)||void 0===e||e.destroy(),null===(t=this.keyPointManager_)||void 0===t||t.destroy(),null===(i=this.deviceDetector_)||void 0===i||i.destroy(),this.callDurationCalculator_=null,this.keyPointManager_=null,this.deviceDetector_=null,this.badCaseDetector_=null,this.publishCDNManager_=null,this.isDestroyed_=!0,Ta.emit(Ua,{client:this}))}reset(){this.keyPointManager_&&this.keyPointManager_.prepareReport(),this.mixTranscodeManager_&&(this.mixTranscodeManager_.reset(),this.mixTranscodeManager_=null),this.publishCDNManager_&&this.publishCDNManager_.reset(),this.userMap_.clear(),this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.mutedStates_.clear(),this.clearNetworkQuality(),this.badCaseDetector_&&this.callDurationCalculator_&&this.uploadAllCallStats(),this.closeUplink(),this.isJoined_=!1,this.signalChannel_&&(this.log_.info("destroying SignalChannel"),this.signalChannel_.close(),this.signalChannel_=null)}startSyncUserListInterval(){-1===this.syncUserListInterval_&&(this.syncUserListInterval_=Yd.setInterval(this.syncUserList.bind(this),1e4))}stopSyncUserListInterval(){Yd.clearInterval(this.syncUserListInterval_),this.syncUserListInterval_=-1}async syncUserList(){try{const e=await this.getUserList();0!==this.userMap_.size&&this.userMap_.forEach(t=>{e.findIndex(({userId:e})=>e===t.userId)<0&&(this.log_.info("peer leave detected: "+t.userId),this.cleanUser({userId:t.userId,tinyId:t.tinyId}))}),e.forEach(e=>{const{userId:t}=e;this.userMap_.has(t)||t===this.userId_||(this.userMap_.set(t,e),this.emitter_.emit(Cl.PEER_JOIN,{userId:t}))})}catch(e){this.log_.warn("sync user list failed: "+e)}}getUserList(){return new Promise((e,t)=>{this.signalChannel_.send(qc),this.signalChannel_.once(Pc.USER_LIST_RES,i=>{const{code:n,message:s}=i.data;if(0!==n){const e=Fr({key:br,data:{signalResponse:Pc.USER_LIST_RES,code:n,message:s}});t(e)}else{const t=(i.data.data&&i.data.data.userList||[]).map(({userId:e,srcTinyId:t,role:i})=>new Th({userId:e,tinyId:t,role:i}));e(t)}}),setTimeout(t,2e3)})}async publish(e){e.setPublishState(fn),this.isPublishing_=!0;const t=io();Ta.emit(Ma,{client:this,stream:e}),this.log_.info("publish() => publishing local stream");const i=new vh({userId:this.userId_,tinyId:this.tinyId_,client:this,isUplink:!0,signalChannel:this.signalChannel_,enableSEI:this.enableSEI_});e.setConnection(i),i.initialize(),i.on(Rl.ERROR,e=>{const t=e.getCode();t!==Xc.ICE_TRANSPORT_ERROR&&(t===Xc.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emitter_.emit(Cl.ERROR,e))});try{this.localStream_=await i.publish(e),this.localStream_.getBeautyStatus()&&this.log_.info("beauty stream is published successfully"),this.log_.info("local stream is published successfully"),this.isPublishing_=!1,e.setPublishState(vn),this.uplinkConnection_=i;const n=io()-t;Fd.logSuccessEvent({userId:this.userId_,eventType:Li}),Fd.logSuccessEvent({userId:this.userId_,eventType:Oi,delta:n}),e.hasAudio()&&xd(this.userId_,{eventId:ed,eventDesc:"publish audio track",timestamp:me(),userId:this.userId_,tinyId:this.tinyId_}),e.hasVideo()&&xd(this.userId_,{eventId:Zc,eventDesc:"publish video track",timestamp:me(),userId:this.userId_,tinyId:this.tinyId_}),this.networkQuality_&&this.networkQuality_.setUplinkConnection(this.uplinkConnection_),this.deviceDetector_&&this.deviceDetector_.setLocalStream(this.localStream_),Ta.emit(Xa,{localStream:this.localStream_,client:this}),this.notPublishWithoutH264Supported_=!1}catch(n){throw n instanceof Yc&&n.getCode()===Xc.NOT_SUPPORTED_H264&&(this.notPublishWithoutH264Supported_=!0),e.setPublishState(gn),i.close(),this.log_.error("failed to publish stream "+n),this.isPublishing_=!1,Fd.logFailedEvent({userId:this.userId_,eventType:Li,error:n}),n}}async unpublish(){if(this.localStream_){this.log_.info("unpublish() => unpublishing local stream");try{await this.doUnpublish(),Fd.logSuccessEvent({userId:this.userId_,eventType:xi})}catch(e){throw Fd.logFailedEvent({userId:this.userId_,eventType:xi,error:e}),e}}}doUnpublish(){return this.signalChannel_.sendWaitForResponse({command:Vc,commandDesc:"unpublish",responseCommand:Pc.UNPUBLISH_RESULT}).then(()=>{this.closeUplink()}).catch(()=>{this.closeUplink()})}closeUplink(){this.uplinkConnection_&&(this.uplinkConnection_.getIsReconnecting()&&this.uplinkConnection_.stopReconnection(),this.uplinkConnection_.close(),this.uplinkConnection_=null,this.networkQuality_&&this.networkQuality_.setUplinkConnection(null),this.localStream_.hasAudio()&&xd(this.userId_,{eventId:id,eventDesc:"unpublish audio track",timestamp:me(),userId:this.userId_,tinyId:this.tinyId_}),this.localStream_.hasVideo()&&xd(this.userId_,{eventId:td,eventDesc:"unpublish video track",timestamp:me(),userId:this.userId_,tinyId:this.tinyId_}),this.localStream_.setClient(null),this.localStream_.setConnection(null),this.localStream_=null,this.deviceDetector_&&this.deviceDetector_.setLocalStream(null))}closeDownLink(e){const t=this.connections_.get(e);t&&(t.getIsReconnecting()&&t.stopReconnection(),this.subscriptionManager_&&this.subscriptionManager_.delete(t.getUserId()),t.close(),this.connections_.delete(e),this.mutedStates_.delete(e))}async subscribe(e,t){this.log_.info(`subscribe() => subscribe to [${e.getUserId()}] ${e.getType()} stream with options: ${JSON.stringify(t)}`),qr(t)&&(t={audio:!0,video:!0}),qr(t.video)&&(t.video=!0),qr(t.audio)&&(t.audio=!0);try{const i=e.getConnection();Ta.emit(za,{client:this,stream:e}),await i.subscribe(e,t),this.subscriptionManager_&&this.subscriptionManager_.addSubscriptionRecord(e.getUserId(),e,t),this.notSubscribeWithoutH264Supported_=!1,Fd.logSuccessEvent({userId:this.userId_,eventType:Ui})}catch(i){const t=i instanceof Yc?i.getCode():Xc.UNKNOWN;t===Xc.NOT_SUPPORTED_H264&&(this.notSubscribeWithoutH264Supported_=!0);const n=new Yc({code:t,message:Fr({key:gs,data:{message:i.message,stream:e}})});throw Fd.logFailedEvent({userId:this.userId_,eventType:Ui,error:n}),this.log_.error(n),n}}async unsubscribe(e){this.log_.info(`unsubscribe() => unsubscribe to [${e.getUserId()}] ${e.getType()} stream`);try{const t=e.getConnection();await t.unsubscribe(e),this.subscriptionManager_&&this.subscriptionManager_.addUnsubscriptionRecord(e.getUserId(),e),Ta.emit(qa,{client:this,stream:e}),Fd.logSuccessEvent({userId:this.userId_,eventType:Vi})}catch(t){throw Fd.logFailedEvent({userId:this.userId_,eventType:Vi,error:t}),t}}async switchRole(e){this.role_!==e&&("audience"===e&&this.localStream_&&await this.unpublish(this.localStream_),this.log_.info("switchRole() => switch role to: "+e),await this.doSwitchRole(e))}doSwitchRole(e){return new Promise((t,i)=>{const n={role:"anchor"===e?hi:ui,privateMapKey:this.privateMapKey_};this.log_.info("switchRole signal data: "+JSON.stringify(n));const s=setTimeout(()=>{this.log_.error("switchRole timeout observed"),this.signalChannel_.off(Pc.SWITCH_ROLE_RES,r),i(new Yc({code:Xc.SWITCH_ROLE_FAILED,message:Fr({key:Ss})}))},5e3),r=n=>{clearTimeout(s);const{code:r,message:o}=n.data;0===r?(this.role_=e,t()):(this.log_.error(`switchRole failed, errCode: ${r}, errMsg: ${o}`),i(new Yc({code:Xc.SWITCH_ROLE_FAILED,message:Fr({key:ys,data:{message:o,code:r}})})))};this.signalChannel_.once(Pc.SWITCH_ROLE_RES,r),this.signalChannel_.send(Kc,n)})}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}getRemoteMutedState(){const e=[];return this.mutedStates_.forEach((t,i,n)=>{const s=this.connections_.get(i);s&&e.push({userId:s.getUserId(),...t})}),e}async getTransportStats(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e.rtt=t.rtt}for(let[t,i]of this.connections_){const t=await this.stats_.getReceiverStats(i);e.downlinksRTT[t.userId]=t.rtt}return e}async getLocalAudioStats(){const e={};if(e[this.userId_]={bytesSent:0,packetsSent:0},this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e[this.userId_]={bytesSent:t.audio.bytesSent,packetsSent:t.audio.packetsSent}}return e}async getLocalVideoStats(){const e={};if(e[this.userId_]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},this.uplinkConnection_){const t=await this.stats_.getSenderStats(this.uplinkConnection_);e[this.userId_]={bytesSent:t.video.bytesSent,packetsSent:t.video.packetsSent,framesEncoded:t.video.framesEncoded,framesSent:t.video.framesSent,frameWidth:t.video.frameWidth,frameHeight:t.video.frameHeight}}return e}async getRemoteAudioStats(){const e={};for(let[t,i]of this.connections_){const{audioDelay:t}=i.getDelay(),n=await this.stats_.getReceiverStats(i);n.hasAudio&&(e[n.userId]={bytesReceived:n.audio.bytesReceived,packetsReceived:n.audio.packetsReceived,packetsLost:n.audio.packetsLost,end2EndDelay:t})}return e}async getRemoteVideoStats(e=gi){const t={};for(let[i,n]of this.connections_){const i=await this.stats_.getReceiverStats(n),{videoDelay:s}=n.getDelay();e===gi&&i.hasVideo&&(t[i.userId]={bytesReceived:i.video.bytesReceived,packetsReceived:i.video.packetsReceived,packetsLost:i.video.packetsLost,framesDecoded:i.video.framesDecoded,frameWidth:i.video.frameWidth,frameHeight:i.video.frameHeight,end2EndDelay:s}),e===fi&&i.hasAuxiliary&&(t[i.userId]={bytesReceived:i.auxiliary.bytesReceived,packetsReceived:i.auxiliary.packetsReceived,packetsLost:i.auxiliary.packetsLost,framesDecoded:i.auxiliary.framesDecoded,frameWidth:i.auxiliary.frameWidth,frameHeight:i.auxiliary.frameHeight,end2EndDelay:s})}return t}getSdpSemantics(){return this.sdpSemantics_}getIceServers(){return 0===this.turnServers_.length&&this.schedule_.iceServers?this.schedule_.iceServers:this.turnServers_}getConnections(){return this.connections_}getMutedStates(){return this.mutedStates_}startHeartbeat(){if(-1===this.heartbeat_){const e=2e3;this.log_.info("startHeartbeat..."),this.heartbeat_=Yd.setInterval(this.doHeartbeat.bind(this),e)}}stopHeartbeat(){-1!==this.heartbeat_&&(this.log_.info("stopHeartbeat"),Yd.clearInterval(this.heartbeat_),this.heartbeat_=-1,this.lastHeartBeatTime_=-1)}async doHeartbeat(){const e=this.badCaseDetector_.getMonitorFreeze(),t=await this.stats_.getStatsReport({uplinkConnection:this.uplinkConnection_,downlinkConnections:this.connections_,freezeMap:e});if(Ta.emit(Pa,{client:this,stats:t}),this.badCaseDetector_.resetMonitor(),!this.signalChannel_)return;const i=this.signalChannel_.isConnected()?function(e){let t=Od.get(e),i=[];return t?(Od.delete(e),i=t.map(e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,str_event_json:e.eventDesc}))):i=[],i}(this.userId_):[],n={str_sdk_version:this.version_,uint64_datetime:(new Date).getTime(),msg_user_info:{str_identifier:this.userId_,uint64_tinyid:this.tinyId_},msg_device_info:{uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:mn[this.networkType_]},...t,msg_event_msg:i};this.signalChannel_.send(Oc,n);const s=Date.now();this.lastHeartBeatTime_>0&&s-this.lastHeartBeatTime_>1e4&&this.log_.warn("heartbeat took "+(s-this.lastHeartBeatTime_)),this.lastHeartBeatTime_=s,!this.isRelayChanged_&&this.isRelayMaybeFailed()&&(this.reJoin(),this.isRelayChanged_=!0)}onRemoteStreamAdded(e){const t=e.content,{userId:i,tinyId:n,audio:s,bigVideo:r,auxVideo:o,smallVideo:a}=t;if(null===i)return void this.log_.warn("received null userId on stream added");this.userMap_.has(i)||(this.userMap_.set(i,new Th({userId:i,tinyId:n,role:"anchor"})),this.emitter_.emit(Cl.PEER_JOIN,{userId:i}));const c=this.connections_.get(n);if(c){if(c.getIsReconnecting())return;this.log_.warn("duplicated stream-added observed, rebuild the connection"),c.close(),this.connections_.delete(n)}const d={audio:s,video:r,auxiliary:o,smallVideo:a};this.log_.info(`remote peer [${i}] published stream. trackState: ${JSON.stringify(d)}`),this.createDownlinkConnection({userId:i,tinyId:n,trackState:d})}createDownlinkConnection({userId:e,tinyId:t,trackState:i}){const n=new Sh({userId:e,tinyId:t,client:this,isUplink:!1,signalChannel:this.signalChannel_,autoSubscribe:this.autoSubscribe_,trackState:i,enableSEI:this.enableSEI_});this.connections_.set(t,n),this.installDownlinkEvents(n,e,t),this.autoSubscribe_?(n.initialize(),n.connect().catch(()=>{!n.getMainStream()&&n.hasMainStream()&&this.initRemoteStream({type:gi,userId:e,downlinkConnection:n}),!n.getAuxStream()&&n.hasAuxStream()&&this.initRemoteStream({type:fi,userId:e,downlinkConnection:n})})):(n.hasMainStream()&&this.initRemoteStream({type:gi,userId:e,downlinkConnection:n}),n.hasAuxStream()&&this.initRemoteStream({type:fi,userId:e,downlinkConnection:n}))}initRemoteStream({type:e,userId:t,downlinkConnection:i}){const n=new hh({type:e,userId:t,client:this});n.setConnection(i),i.setRemoteStream(e===gi?pi:_i,n),n.setIsStreamAddedEventEmitted(!0),Ta.emit(Ja,{client:this,stream:n}),this.emitter_.emit(Cl.STREAM_ADDED,{stream:n})}installDownlinkEvents(e,t,i){e.on(Rl.SEI_MESSAGE,e=>{this.emitter_.emit(Cl.SEI_MESSAGE,e)}),e.on(Rl.STREAM_ADDED,e=>{e.stream.setIsStreamAddedEventEmitted(!0),Ta.emit(Ja,{client:this,stream:e.stream}),this.emitter_.emit(Cl.STREAM_ADDED,{stream:e.stream})}),e.on(Rl.STREAM_REMOVED,e=>{this.changeBigSmallRecords_.delete(e.stream.getUserId()),e.stream.stop(),e.stream.setIsStreamAddedEventEmitted(!1),this.subscriptionManager_&&this.subscriptionManager_.deleteAutoRecoveryFlag(e.stream.getUserId(),e.stream.getType()),Ta.emit(Qa,{client:this,stream:e.stream}),this.emitter_.emit(Cl.STREAM_REMOVED,{stream:e.stream})}),e.on(Rl.STREAM_UPDATED,e=>{Ta.emit(Ka,{client:this,stream:e.stream}),this.emitter_.emit(Cl.STREAM_UPDATED,{stream:e.stream})}),e.on(Rl.STREAM_SUBSCRIBED,e=>{Ta.emit(Wa,{client:this,stream:e.stream}),this.emitter_.emit(Cl.STREAM_SUBSCRIBED,{stream:e.stream})}),e.on(Rl.ERROR,e=>{const t=e.getCode();t!==Xc.ICE_TRANSPORT_ERROR&&(t===Xc.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLink(i),this.emitter_.emit(Cl.ERROR,e))})}onPeerJoin(e){const{srcTinyId:t,userId:i,role:n}=e.data.data;this.userMap_.has(i)||(this.userMap_.set(i,new Th({userId:i,tinyId:t,role:n})),this.emitter_.emit(Cl.PEER_JOIN,{userId:i}))}onPeerLeave(e){const{srcTinyId:t,userId:i,reason:n=0}=e.data.data;this.log_.info(`peer leave [${i}]: ${On[n]}`),this.cleanUser({userId:i,tinyId:t})}cleanUser({userId:e,tinyId:t}){this.userMap_.delete(e),this.closeDownLink(t),this.emitter_.emit(Cl.PEER_LEAVE,{userId:e})}onPublishedUserList(e){try{const t=e.data.userList.map(e=>e.userId);this.connections_.forEach(e=>{const i=e.getUserId(),n=e.getTinyId();t.findIndex(e=>e===i)<0&&(this.log_.info(`peer unpublished detected [${i}]`),this.closeDownLink(n))}),e.data.userList.forEach(({userId:e,srcTinyId:t,flag:i})=>{if(e===this.userId_)return;const n=!!(1&i),s=!!(8&i),r=!!(4&i),o=!!(2&i),a=this.connections_.get(t);if(this.changeBigSmallRecords_.has(e)&&this.checkSubscribeBigSmallVideo(a,o),a){const{audio:i,video:c,auxiliary:d,smallVideo:l}=a.getTrackState();!c&&n&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:pn,kind:Dt}),!i&&s&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:pn,kind:At}),!d&&r&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:pn,kind:Pt}),!l&&o&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:pn,kind:Nt}),c&&!n&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:_n,kind:Dt}),i&&!s&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:_n,kind:At}),d&&!r&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:_n,kind:Pt}),l&&!o&&Ta.emit(Ga,{client:this,tinyId:t,userId:e,action:_n,kind:Nt})}else this.log_.info(`peer published detected [${e}]`),this.onRemoteStreamAdded({content:{audio:s,bigVideo:n,auxVideo:r,smallVideo:o,userId:e,tinyId:t}})})}catch(t){}}onUpdateRemoteMuteStat(e){const t=e.data;(t&&t.userList||[]).forEach(e=>{const{srcTinyId:t,userId:i}=e;if(0===t||t===this.tinyId_)return;const n=this.connections_.get(t);if(!n)return void this.mutedStates_.delete(t);const s=n.getMainStream();if(!s||!s.getIsStreamAddedEventEmitted())return;const r=!!(1&e.flag),o=!!(8&e.flag),a=!!(2&e.flag),c=!!(64&e.flag),d=!!(16&e.flag),l=this.mutedStates_.get(t);if(void 0===l)return this.mutedStates_.set(t,{hasAudio:o,hasVideo:r,hasSmall:a,audioMuted:c,videoMuted:d}),r?d?this.emitter_.emit(Cl.MUTE_VIDEO,{userId:i}):this.emitter_.emit(Cl.UNMUTE_VIDEO,{userId:i}):this.emitter_.emit(Cl.MUTE_VIDEO,{userId:i}),void(o?c?this.emitter_.emit(Cl.MUTE_AUDIO,{userId:i}):this.emitter_.emit(Cl.UNMUTE_AUDIO,{userId:i}):this.emitter_.emit(Cl.MUTE_AUDIO,{userId:i}));{const e=!c&&o;(!l.audioMuted&&l.hasAudio)!==e&&(e?this.emitter_.emit(Cl.UNMUTE_AUDIO,{userId:i}):this.emitter_.emit(Cl.MUTE_AUDIO,{userId:i}));const n=!d&&r;(!l.videoMuted&&l.hasVideo)!==n&&(n?this.emitter_.emit(Cl.UNMUTE_VIDEO,{userId:i}):this.emitter_.emit(Cl.MUTE_VIDEO,{userId:i})),this.mutedStates_.set(t,{hasAudio:o,hasVideo:r,hasSmall:a,audioMuted:c,videoMuted:d})}})}getEnv(){return this.env_}getSubscriptionManager(){return this.subscriptionManager_}async startPublishCDNStream(e={}){if(this.log_.info(`startPublishCDNStream params: ${JSON.stringify(e)}; isJoined: ${this.isJoined_}; isPublished: ${!!this.localStream_}`),!this.localStream_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ts})});await this.publishCDNManager_.startPublishTencentCDN(e),e.appId&&e.bizId&&e.url&&await this.publishCDNManager_.startPublishGivenCDN(e)}async stopPublishCDNStream(){if(!this.publishCDNManager_.getIsPublishingTencentCDN())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Es})});this.log_.info("stopPublishCDNStream"),await this.publishCDNManager_.stopPublishTencentCDN(),this.publishCDNManager_.getIsPublishingGivenCDN()&&await this.publishCDNManager_.stopPublishGivenCDN()}async startMixTranscode(e){if(!this.isJoined_||!this.mixTranscodeManager_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ws})});qr(e.mode)&&(e.mode=rn.MANUAL);try{this.log_.info("startMixTranscode with config "+JSON.stringify(e)),Fd.uploadEvent({log:"mix-transcode-mode:"+e.mode,userId:this.userId_}),await this.mixTranscodeManager_.startMixTranscode(e),Fd.logSuccessEvent({userId:this.userId_,eventType:Xi})}catch(t){throw Fd.logFailedEvent({userId:this.userId_,eventType:Xi,error:t}),t}}async stopMixTranscode(){if(!this.isJoined_||!this.mixTranscodeManager_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ks})});try{await this.mixTranscodeManager_.stopMixTranscode(),Fd.logSuccessEvent({userId:this.userId_,eventType:Yi})}catch(e){throw Fd.logFailedEvent({userId:this.userId_,eventType:Yi,error:e}),e}}getSystemResult(){return this.checkSystemResult_}enableAudioVolumeEvaluation(e=2e3,t=!1){if(!Qr(e))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:As})});if(this.log_.info("enableAudioVolumeEvaluation with interval: "+e),e<=0)return this.enableAudioVolumeEvaluation_=!1,Yd.clearInterval(this.audioVolumeIntervalId_),void(this.audioVolumeIntervalId_=null);e=Math.floor(Math.max(e,16)),Ta.emit(Fa,{interval:e}),this.audioVolumeIntervalId_&&(Yd.clearInterval(this.audioVolumeIntervalId_),this.audioVolumeIntervalId_=null),this.enableAudioVolumeEvaluation_=!0,this.audioVolumeIntervalId_=Yd.setInterval(()=>{const e=[];if(this.localStream_){const t=Math.floor(100*this.localStream_.getAudioLevel());e.push({userId:this.userId_,audioVolume:t,stream:this.localStream_})}this.connections_.forEach(t=>{const i=t.getSubscribedMainStream();if(i){const n=Math.floor(100*i.getAudioLevel());e.push({userId:t.getUserId(),audioVolume:n,stream:i})}}),this.emitter_.emit(Cl.AUDIO_VOLUME,{result:e})},e,t)}callExperimentalAPI(e,t){return Yh.call(e,{client:this,...t})}setProperty(e,t){const i=e+"_";qr(this[i])||(this[i]=t)}uploadAllCallStats(){this.callDurationCalculator_.getDurationMap().forEach(({userId:e,type:t},i)=>{const n=this.callDurationCalculator_.getDuration(i,Dt),{dataFreeze:s}=this.badCaseDetector_.getDataFreezeDuration(i),{renderFreeze:r}=this.badCaseDetector_.getRenderFreezeDuration(i),o={userId:e,type:t,duration:n,dataFreeze:s,renderFreeze:r};Fd.uploadEvent({log:"callStats-"+JSON.stringify(o),userId:this.userId_})}),this.badCaseDetector_.stop(),this.callDurationCalculator_.reset()}async enableSmallStream(){if(this.isPublished()||this.isPublishing_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ds})});if(!Il())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ns})});this.setIsEnableSmallStream(!0),this.log_.info("SmallStream successfully enabled")}async disableSmallStream(){if(this.isPublished()||this.isPublishing_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ps})});this.setIsEnableSmallStream(!1),this.log_.info("SmallStream successfully disabled")}setSmallStreamProfile(e){e&&e.framerate&&(e.frameRate=e.framerate),Object.keys(this.smallStreamConfig_).forEach(t=>{e[t]&&(this.smallStreamConfig_[t]=e[t])}),this.log_.info(`setSmallStreamProfile: bitrate=${this.smallStreamConfig_.bitrate}, frameRate=${this.smallStreamConfig_.frameRate}, height=${this.smallStreamConfig_.height}, width=${this.smallStreamConfig_.width}`);const{width:t,height:i,bitrate:n,frameRate:s}=this.smallStreamConfig_;if(t<0||i<0||n<0||s<0)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Ms})})}async setRemoteVideoStreamType(e,t){switch(t){case"big":case"small":await this.changeVideoType(e,t)}}async changeVideoType(e,t){if(!(e instanceof hh))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Ls})});if(!e.getConnection())throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:ms})});const i=e.getUserId(),n={stream:e,options:{video:"big"===t,smallVideo:"small"===t},isSubscribing:!1,reSubscribeCount:10};this.changeBigSmallRecords_.set(i,n),this.log_.info(`change video type: streamType=${e.getType()}, set ${t}`)}async checkSubscribeBigSmallVideo(e,t){if(!e.isBigStreamSubscribed&&!e.isSmallStreamSubscribed)return;const i=e.getUserId();let n=this.changeBigSmallRecords_.get(i)||{};const{video:s,smallVideo:r}=e.getSubscribeState(),{stream:o,options:a,isSubscribing:c,reSubscribeCount:d}=n;if(!(a.video&&s||a.smallVideo&&r&&t)&&!c&&(t&&e.isBigStreamSubscribed||e.isSmallStreamSubscribed))try{if(a&&o&&!c&&d>=1){this.log_.info("subscribe small video: userId="+i),n.isSubscribing=!0,n.reSubscribeCount=d-1;let e={video:a.video,smallVideo:a.smallVideo};const s=o.getConnection();!t&&s.isSmallStreamSubscribed&&(e={video:!0,smallVideo:!1}),await(null==s?void 0:s.subscribe(o,e)),n.isSubscribing=!1,this.log_.info(`changeType ${i} ${a.smallVideo?"small":"big"} video success, count ${11-d}`)}}catch(l){this.log_.info(`resubscribe ${i} ${a.smallVideo?"small":"big"} video failed, count ${11-d}`),0===d&&(n.isSubscribing=!1)}}setIsEnableSmallStream(e){this.isEnableSmallStream_=e}getIsEnableSmallStream(){return this.isEnableSmallStream_}get smallStreamConfig(){return this.smallStreamConfig_}isPublished(){return!!this.localStream_}getUplinkConnection(){return this.uplinkConnection_}getLocalStream(){return this.localStream_}getMode(){return this.mode_}getBadCaseDetector(){return this.badCaseDetector_}getCallDurationCalculator(){return this.callDurationCalculator_}getIsJoined(){return this.isJoined_}getAllConnections(){const e=[...this.connections_.values()];return this.uplinkConnection_&&e.push(this.uplinkConnection_),e}isRelayMaybeFailed(){const e=this.getAllConnections();if(0===e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].getReconnectionCount()<6)return!1;return!0}getUseStringRoomId(){return this.useStringRoomId_}checkConnectionsToReconnect(){this.getAllConnections().forEach(e=>{if(!e.getIsReconnecting()){const t=e.getPeerConnection();t&&t.connectionState===Ri&&(this.log_.warn(`[${e.getUserId()}] pc is closed but not reconnect`),e.startReconnection())}})}getEnableAutoPlayDialog(){return this.enableAutoPlayDialog_}sendSEIMessage(e,t){this.uplinkConnection_.sendSEI(e,t)}}).prototype,"join",[xh,Uh],Object.getOwnPropertyDescriptor(Xh.prototype,"join"),Xh.prototype),e(Xh.prototype,"leave",[Vh],Object.getOwnPropertyDescriptor(Xh.prototype,"leave"),Xh.prototype),e(Xh.prototype,"publish",[Fh,$h],Object.getOwnPropertyDescriptor(Xh.prototype,"publish"),Xh.prototype),e(Xh.prototype,"unpublish",[Bh,jh],Object.getOwnPropertyDescriptor(Xh.prototype,"unpublish"),Xh.prototype),e(Xh.prototype,"subscribe",[Hh],Object.getOwnPropertyDescriptor(Xh.prototype,"subscribe"),Xh.prototype),e(Xh.prototype,"unsubscribe",[Gh],Object.getOwnPropertyDescriptor(Xh.prototype,"unsubscribe"),Xh.prototype),e(Xh.prototype,"switchRole",[Jh,zh],Object.getOwnPropertyDescriptor(Xh.prototype,"switchRole"),Xh.prototype),e(Xh.prototype,"startPublishCDNStream",[Wh],Object.getOwnPropertyDescriptor(Xh.prototype,"startPublishCDNStream"),Xh.prototype),e(Xh.prototype,"startMixTranscode",[qh],Object.getOwnPropertyDescriptor(Xh.prototype,"startMixTranscode"),Xh.prototype),e(Xh.prototype,"sendSEIMessage",[Kh,Qh],Object.getOwnPropertyDescriptor(Xh.prototype,"sendSEIMessage"),Xh.prototype),Xh);const eu=mc({retryFunction:async function(e){if(ul())return;const t=await async function(e){let t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression};if(e.audio)if(Vd(e.microphoneId)){t={sampleRate:e.sampleRate,channelCount:e.channelCount,...t};const i=(await mu.getMicrophones()).filter(({deviceId:e})=>e.length>0);i.length>0&&(t.deviceId={exact:i[0].deviceId})}else t={deviceId:{exact:e.microphoneId},sampleRate:e.sampleRate,channelCount:e.channelCount,...t};else t=!1;let i={};const n={ideal:e.width,max:e.width},s={ideal:e.height,max:e.height};i=!qr(e.facingMode)&&e.video?{facingMode:e.facingMode,width:n,height:s,frameRate:e.frameRate}:!Vd(e.cameraId)&&e.video?{deviceId:{exact:e.cameraId},width:n,height:s,frameRate:e.frameRate}:!!e.video&&(!!qr(e.width)||{width:n,height:s,frameRate:e.frameRate});return{audio:t,video:i}}(e);let i,n;vc.info("getUserMedia with constraints: "+JSON.stringify(t)),t.audio&&(i=await mu.getMicrophones(),vc.info("microphones: "+JSON.stringify(i))),t.video&&(n=await mu.getCameras(),vc.info("cameras: "+JSON.stringify(n)));try{return await navigator.mediaDevices.getUserMedia(t)}catch(s){if("NotFoundError"===s.name){if(n&&0===n.length)throw new Yc({code:Xc.DEVICE_NOT_FOUND,message:Fr({key:Er})});if(i&&0===i.length)throw new Yc({code:Xc.DEVICE_NOT_FOUND,message:Fr({key:Tr})})}throw new Yc({code:Xc.INITIALIZE_FAILED,name:s.name,message:s.message,constraint:s.constraint})}},settings:{retries:3,timeout:500},onError:(e,t,i)=>{"NotReadableError"===e.name?t():i(e)},onRetrying:e=>{vc.warn(`getUserMedia NotReadableError observed, retrying [${e}/3]`)}});function tu(e){let t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression,sampleRate:e.sampleRate,channelCount:e.channelCount};return qr(e.microphoneId)||(t.deviceId={exact:e.microphoneId}),{audio:t,video:!1}}function iu(e){let t={},i={width:{ideal:e.width,max:e.width},height:{ideal:e.height,max:e.height},frameRate:e.frameRate};return qr(e.screenSource)||(i.displaySurface=e.screenSource),t.video=i,qr(e.audioConstraints)||(t.audio=e.audioConstraints),t}const nu=new Map([["120p",{width:160,height:120,frameRate:15,bitrate:200}],["120p_2",{width:160,height:120,frameRate:15,bitrate:100}],["180p",{width:320,height:180,frameRate:15,bitrate:350}],["180p_2",{width:320,height:180,frameRate:15,bitrate:150}],["240p",{width:320,height:240,frameRate:15,bitrate:400}],["240p_2",{width:320,height:240,frameRate:15,bitrate:200}],["360p",{width:640,height:360,frameRate:15,bitrate:800}],["360p_2",{width:640,height:360,frameRate:15,bitrate:400}],["480p",{width:640,height:480,frameRate:15,bitrate:900}],["480p_2",{width:640,height:480,frameRate:15,bitrate:500}],["720p",{width:1280,height:720,frameRate:15,bitrate:1500}],["1080p",{width:1920,height:1080,frameRate:15,bitrate:2e3}],["1440p",{width:2560,height:1440,frameRate:30,bitrate:4860}],["4K",{width:3840,height:2160,frameRate:30,bitrate:9e3}]]),su=new Map([["480p",{width:640,height:480,frameRate:5,bitrate:900}],["480p_2",{width:640,height:480,frameRate:30,bitrate:1e3}],["720p",{width:1280,height:720,frameRate:5,bitrate:1200}],["720p_2",{width:1280,height:720,frameRate:30,bitrate:3e3}],["1080p",{width:1920,height:1080,frameRate:5,bitrate:1600}],["1080p_2",{width:1920,height:1080,frameRate:30,bitrate:4e3}]]),ru=new Map([["standard",{sampleRate:48e3,channelCount:1,bitrate:40}],["standard-stereo",{sampleRate:48e3,channelCount:2,bitrate:64}],["high",{sampleRate:48e3,channelCount:1,bitrate:128}],["high-stereo",{sampleRate:48e3,channelCount:2,bitrate:192}]]);var ou,au,cu;let du=(ou=ah(...rh.LOCAL_STREAM.switchDevice),au=oh(rh.LOCAL_STREAM.setAudioCaptureVolume),e((cu=class extends lh{constructor(e){super({...e,isRemote:!1,type:"local"}),this.name_=Rn,this.client_=null,this.video_=e.video,this.audio_=e.audio,this.cameraId_=e.cameraId,this.cameraGroupId_="",this.facingMode_=e.facingMode,this.microphoneId_=e.microphoneId,this.microphoneGroupId_="",this.videoSource_=e.videoSource,this.audioSource_=e.audioSource,this.screen_=e.screen,this.screenSource_=e.screenSource,this.screenAudio_=e.screenAudio,this.audioProfile_={echoCancellation:!!qr(e.echoCancellation)||e.echoCancellation,autoGainControl:!!qr(e.autoGainControl)||e.autoGainControl,noiseSuppression:!!qr(e.noiseSuppression)||e.noiseSuppression,sampleRate:48e3,channelCount:1,bitrate:40},this.videoProfile_=nu.get("480p_2"),this.screenProfile_=su.get("1080p"),this.videoSetting_=null,this.muteState_={video:!1,audio:!1,auxVideo:!1},this.beautyStatus_=!1,this.recoverCaptureCount_=0,this.initState(),this.canvas_=null,this.canvasInterval_=-1,this.gain_={audioTrack:null,source:null,gainNode:null},this.captureVolume_=100,this.log_.info("stream created: "+this.id_)}initState(){this.isAddingTrack_=!1,this.isRemovingTrack_=!1,this.setIsReadyToPublish(!1),this.setPublishState(gn)}installEvents(){super.installEvents(),Ta.on(Xa,this.onStreamPublished,this),Ta.on(oc,this.onVideoTrackStopped,this),Ta.on(tc,this.onVideoTrackStopped,this),Ta.on(cc,this.onAudioTrackStopped,this),Ta.on(ac,this.onAudioTrackStopped,this)}uninstallEvents(){super.uninstallEvents(),Ta.off(Xa,this.onStreamPublished,this),Ta.off(oc,this.onVideoTrackStopped,this),Ta.off(tc,this.onVideoTrackStopped,this),Ta.off(cc,this.onAudioTrackStopped,this),Ta.off(ac,this.onAudioTrackStopped,this)}initialize(){return new Promise((e,t)=>{if(pl())t(new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:mr})}));else{if(qr(this.audio_)){const t=new MediaStream;return qr(this.audioSource_)||(t.addTrack(this.audioSource_),this.updateAudioPlayingState(!0)),qr(this.videoSource_)||(t.addTrack(this.videoSource_),this.updateVideoPlayingState(!0)),this.setMediaStream(t),Fd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:zi,kind:"custom"}),this.setIsReadyToPublish(!0),e()}this.screen_?(this.log_.info("initialize stream audio: "+this.audio_+" screenAudio: "+this.screenAudio_+" screen: "+this.screen_),async function(e){if(ul())return;let t=null;if(_t&&mt<74||ft){const i=iu(e);vc.info("getDisplayMedia with constraints: "+JSON.stringify(i));let n=await navigator.mediaDevices.getDisplayMedia(i);if(e.screenAudio)return vc.warn("Your browser not support capture system audio"),n;if(e.audio){const i=tu(e);return vc.info("getUserMedia with constraints: "+JSON.stringify(i)),t=await navigator.mediaDevices.getUserMedia(i),n.addTrack(t.getAudioTracks()[0]),n}return n}if(e.screenAudio){e.audioConstraints={echoCancellation:!0,noiseSuppression:!0,sampleRate:44100};const t=iu(e);return vc.info("getDisplayMedia with constraints: "+JSON.stringify(t)),await navigator.mediaDevices.getDisplayMedia(t)}{const i=iu(e);vc.info("getDisplayMedia with constraints: "+JSON.stringify(i));let n=await navigator.mediaDevices.getDisplayMedia(i);if(e.audio){const i=tu(e);return vc.info("getUserMedia with constraints: "+JSON.stringify(i)),t=await navigator.mediaDevices.getUserMedia(i),n.addTrack(t.getAudioTracks()[0]),n}return n}}({audio:this.audio_,screenAudio:this.screenAudio_,microphoneId:this.microphoneId_,screenSource:this.screenSource_,width:this.screenProfile_.width,height:this.screenProfile_.height,frameRate:this.screenProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation}).then(t=>{this.setMediaStream(t),this.updateAudioPlayingState(this.audio_||this.screenAudio_),this.updateVideoPlayingState(!0);const i=this.getVideoTrack();return this.listenForScreenSharingStopped(i),this.setVideoContentHint(Gt),this.updateDeviceIdInUse(),this.setIsReadyToPublish(!0),this.log_.info(JSON.stringify(i.getSettings())),Fd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:zi,kind:"getDisplayMedia"}),e()}).catch(e=>{Fd.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:zi,kind:"getDisplayMedia",error:e}),this.log_.error("getDisplayMedia error observed "+e),t(e instanceof Yc?e:new Yc({code:Xc.INITIALIZE_FAILED,name:e.name,message:e.message}))})):(Ta.emit(Ya,{stream:this,audio:this.audio_,video:this.video_}),this.log_.info("initialize stream audio: "+this.audio_+" video: "+this.video_),eu({audio:this.audio_,video:this.video_,facingMode:this.facingMode_,cameraId:this.cameraId_,microphoneId:this.microphoneId_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount,autoGainControl:this.audioProfile_.autoGainControl,noiseSuppression:this.audioProfile_.noiseSuppression,echoCancellation:this.audioProfile_.echoCancellation}).then(t=>{Ta.emit(Za,{stream:this,audio:this.audio_,video:this.video_}),this.setMediaStream(t);const i=this.getVideoTrack();return i&&(El&&(this.videoSetting_=i.getSettings()),bl&&this.log_.info("video capabilities: "+JSON.stringify(i.getCapabilities()))),this.updateAudioPlayingState(this.audio_),this.updateVideoPlayingState(this.video_),this.updateDeviceIdInUse(),this.log_.info("gotStream hasAudio: "+this.hasAudio()+" hasVideo: "+this.hasVideo()),this.setIsReadyToPublish(!0),Fd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:zi,kind:"getUserMedia"}),e()}).catch(e=>{Ta.emit(ec,{stream:this,audio:this.audio_,video:this.video_,error:e}),Fd.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:zi,kind:"getUserMedia",error:e}),this.log_.error("getUserMedia error observed "+e),t(e)}))}})}listenForScreenSharingStopped(e){e.addEventListener("ended",e=>{this.log_.info("screen sharing was stopped because the video track is ended"),this.emitter_.emit(kl)})}muteAudio(){const e=super.muteAudio();return e&&(this.log_.info("localStream mute audio"),this.sendMutedFlag(At,!0)),e}muteVideo(){const e=super.muteVideo();return e&&(this.log_.info("localStream mute video"),this.sendMutedFlag(Dt,!0)),e}unmuteAudio(){const e=super.unmuteAudio();return e&&(this.log_.info("localStream unmute audio"),this.sendMutedFlag(At,!1)),e}unmuteVideo(){const e=super.unmuteVideo();return e&&(this.log_.info("localStream unmute video"),this.sendMutedFlag(Dt,!1)),e}sendMutedFlag(e,t){this.setMuteState(e,t);const i=this.getConnection();if(i){i.sendMutedFlag(this.muteState_);const n=i.getUserId(),s=i.getTinyId();let r,o=`${t?Ot:xt} local ${e} track`;r=e===At?t?nd:rd:t?sd:od,xd(n,{eventId:r,eventDesc:o,timestamp:me(),userId:n,tinyId:s})}}setMuteState(e,t){this.muteState_[e]=t,this.log_.info(`set ${e} muted state: [${t?"mute":"unmute"}]`)}setAudioProfile(e){let t;"object"==typeof e?t=e:(t=ru.get(e),void 0===t&&(t=ru.get("standard"))),this.log_.info("setAudioProfile: "+JSON.stringify(t)),this.audioProfile_={...this.audioProfile_,...t}}async setVideoProfile(e){if(this.connection_&&!hl())throw new Yc({code:Xc.NOT_SUPPORTED,message:Fr({key:fr})});let t;Gr(e)?t={...this.videoProfile_,...e}:Kr(e)&&(t=nu.get(e),qr(t)&&(t=nu.get("480p_2"))),t&&t.width*t.height>921600&&Et&&(t.width=1280,t.height=720,this.log_.warn("reset to 1280 * 720 on iOS 13~14")),this.log_.info("setVideoProfile "+JSON.stringify(t));const i=this.getVideoTrack();i&&await i.applyConstraints(t);const n=this.videoProfile_.bitrate!==t.bitrate;this.videoProfile_=t,n&&this.connection_&&(await this.connection_.setBandwidth(t.bitrate,Dt),this.connection_.updateMediaSettings(this.mediaStream_))}getVideoBitrate(){return this.screen_?this.screenProfile_.bitrate:this.videoProfile_.bitrate}getAudioBitrate(){return this.audioProfile_.bitrate}setScreenProfile(e){let t=e;Kr(e)&&(t=su.get(e)||su.get("1080p")),this.log_.info("setScreenProfile "+JSON.stringify(e)),this.screenProfile_=t}getVideoProfile(){return this.screen_?this.screenProfile_:this.videoProfile_}getAudioProfile(){return this.audioProfile_}setVideoContentHint(e){const t=this.getVideoTrack();t&&"contentHint"in t&&(this.log_.info("set video track contentHint to: "+e),t.contentHint=e,t.contentHint!==e&&this.log_.warn("Invalid video track contentHint: "+e))}async switchDevice(e,t){const i=e===At;if(i){if(this.microphoneId_===t)return;this.microphoneId_=t,this.audio_=!0}else{if(this.cameraId_===t)return;t===Mt||t===Lt?this.facingMode_=t:this.cameraId_=t,this.video_=!0}if(!this.getMediaStream())return;if(this.setIsReadyToPublish(!1),this.log_.info("switchDevice "+e+" to: "+t),!i){const e=this.getVideoTrack();if(e&&e.stop(),st){const e=this.getAudioTrack();e&&(this.log_.info("stop audio track first in huawei env"),e.stop())}}if(i){const e=this.getAudioTrack(),t=this.getMicrophoneTrackMixed();e&&e.stop(),t&&t.stop()}const n=await eu({audio:this.audio_&&e===At||st,video:this.video_&&e===Dt,facingMode:t===Mt||t===Lt?t:void 0,cameraId:this.cameraId_,microphoneId:this.microphoneId_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount});let s=null;if(i){const e=n.getAudioTracks()[0];if(e&&this.isAudioTrackMixed()){const t=this.getAudioTrack(),i=mu.AudioMixerPlugin.getAudioTrackMap();s=mu.AudioMixerPlugin.mix({targetTrack:e,sourceList:i.get(t.id).sourceList,trackList:i.get(t.id).trackList})}else s=e}else{s=n.getVideoTracks()[0],s&&this.isVideoTrackBeautified()&&(s=await this.generateBeautyTrack(s));const e=n.getAudioTracks()[0];e&&st&&await this.replaceTrack_(e)}await this.replaceTrack_(s),this.updateDeviceIdInUse();const r=this.getConnection();if(r){const e=r.getUserId(),t=r.getTinyId();let n=ld,s="switch camera";i&&(n=hd,s="switch microphone"),xd(e,{eventId:n,eventDesc:s,timestamp:me(),userId:e,tinyId:t})}this.log_.info(`switch ${i?"microphone":"camera"} success `),this.setIsReadyToPublish(!0)}async addTrack(e){if(this.isAddingTrack_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Fs})});if(this.isRemovingTrack_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:$s})});if(this.publishState_===fn)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Bs})});const t=this.getMediaStream();if(!t)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:js})});if(e.kind===At&&t.getAudioTracks().length>0||e.kind===Dt&&t.getVideoTracks().length>0)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Hs})});if(e.kind===Dt&&El){const t=e.getSettings();!this.videoSetting_||t.width===this.videoSetting_.width&&t.height===this.videoSetting_.height||this.log_.warn(`video resolution of the track (${t.width} x ${t.height}) shall be kept the same as the previous: ${this.videoSetting_.width} x ${this.videoSetting_.height}. It may cause abnormal Cloud Recording.`)}try{this.isAddingTrack_=!0,this.keepMuteState(e),t.addTrack(e);const i=this.getConnection();i&&await i.addTrack(e),e.kind===At?(this.audio_=!0,this.updateAudioPlayingState(!0)):(this.video_=!0,this.updateVideoPlayingState(!0)),this.isAddingTrack_=!1}catch(i){throw t.removeTrack(e),this.isAddingTrack_=!1,i}}async removeTrack(e){if(e.kind===At)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Gs})});if(this.isAddingTrack_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Js})});if(this.isRemovingTrack_)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:zs})});if(this.publishState_===fn)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ws})});const t=this.getMediaStream();if(!t)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:js})});if(-1===t.getTracks().indexOf(e))throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:qs})});if(1===t.getTracks().length)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Ks})});try{this.isRemovingTrack_=!0;const i=this.getConnection();i&&await i.removeTrack(e),t.removeTrack(e),e.kind===At?(this.audio_=!1,this.updateAudioPlayingState(!1)):(this.video_=!1,this.updateVideoPlayingState(!1)),this.isRemovingTrack_=!1}catch(i){throw this.isRemovingTrack_=!1,i}}async replaceTrack(e){const t=this.getMediaStream();if(!t)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Vs})});if(this.publishState_===fn)throw new Yc({code:Xc.INVALID_OPERATION,message:Fr({key:Us})});if(e.kind===At&&t.getAudioTracks().length<=0||e.kind===Dt&&t.getVideoTracks().length<=0)throw new Yc({code:Xc.INVALID_PARAMETER,message:Fr({key:Qs,data:e})});if(e.kind===Dt&&El){const t=e.getSettings();!this.videoSetting_||t.width===this.videoSetting_.width&&t.height===this.videoSetting_.height||this.log_.warn(`video resolution of the track (${t.width} x ${t.height}) shall be kept the same as the previous: ${this.videoSetting_.width} x ${this.videoSetting_.height}. It may cause abnormal Cloud Recording.`)}if(this.keepMuteState(e),e.kind===At){if(t.removeTrack(t.getAudioTracks()[0]),t.addTrack(e),super.restartAudio(),this.gain_.gainNode)return void this.reconnectGainNode(e)}else t.removeTrack(t.getVideoTracks()[0]),t.addTrack(e),super.restartVideo();const i=this.getConnection();i&&await i.replaceTrack(e)}async updateStream(e){if(this.mediaStream_){this.log_.info("updateStream() try to recover local stream");try{const t=await mu.getCameras(),i=await mu.getMicrophones();let n=this.audio_&&e.audio,s=this.video_&&e.video;if(s&&0===t.length&&(s=!1,this.log_.info("updateStream() video flag is true, but no camera detected, set video to false")),n&&0===i.length&&(n=!1,this.log_.info("updateStream() audio flag is true, but no microphone detected, set audio to false")),!1===n&&!1===s)return void this.log_.info("updateStream() both audio and video are false, recover stream aborted");const r=e&&t.findIndex(({deviceId:t})=>t===e.cameraId)>=0,o=e&&i.findIndex(({deviceId:t})=>t===e.microphoneId)>=0,a=(await eu({audio:n,video:s,cameraId:r?e.cameraId:void 0,microphoneId:o?e.microphoneId:void 0,facingMode:this.facingMode_,width:this.videoProfile_.width,height:this.videoProfile_.height,frameRate:this.videoProfile_.frameRate,sampleRate:this.audioProfile_.sampleRate,channelCount:this.audioProfile_.channelCount})).getTracks();for(let e=0;e<a.length;e++){const t=a[e];if(t.kind===At&&this.isAudioTrackMixed()){const e=this.getAudioTrack(),i=mu.AudioMixerPlugin.getAudioTrackMap().get(e.id);if(!i.hasMicrophone){t.stop();continue}const n=mu.AudioMixerPlugin.mix({targetTrack:t,sourceList:i.sourceList,trackList:i.trackList});await this.replaceTrack_(n)}else if(t.kind===Dt&&this.isVideoTrackBeautified()){const e=await this.generateBeautyTrack(t);await this.replaceTrack_(e)}else await this.replaceTrack_(t)}this.updateDeviceIdInUse(),Fd.logSuccessEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:Ki}),this.log_.info("updateStream() recover local stream successfully"),this.emitter_.emit(Dl,{isCamera:e.video,isMicrophone:e.audio,cameraId:this.cameraId_,microphoneId:this.microphoneId_})}catch(t){Fd.logFailedEvent({userId:this.client_?this.client_.getUserId():this.userId_,eventType:Ki,error:t}),this.log_.error("updateStream() failed to recover local stream, "+t),this.emitter_.emit(Pl,new Yc({code:Xc.DEVICE_AUTO_RECOVER_FAILED,message:t.message}))}}}async replaceTrack_(e){const t=this.mediaStream_.getAudioTracks(),i=this.mediaStream_.getVideoTracks();if(e.kind===At&&t.length<=0||e.kind===Dt&&i.length<=0)return void this.log_.info(`there is no previous ${e.kind} track, replacement ignored`);if(this.keepMuteState(e),e.kind===At){if(this.mediaStream_.removeTrack(t[0]),this.mediaStream_.addTrack(e),super.restartAudio(),this.gain_.gainNode)return void this.reconnectGainNode(e)}else{if(El){const t=e.getSettings();!this.videoSetting_||t.width===this.videoSetting_.width&&t.height===this.videoSetting_.height||this.log_.warn(`the resolution of video track to be replaced (${t.width} x ${t.height}) is different from the previous video settings (${this.videoSetting_.width} x ${this.videoSetting_.height}). It may cause a cloud recording exception`)}this.mediaStream_.removeTrack(i[0]),this.mediaStream_.addTrack(e),super.restartVideo()}const n=this.getConnection();n&&await n.replaceTrack(e)}updateDeviceIdInUse(){if(!this.mediaStream_)return this.cameraId_="",this.cameraGroupId_="",this.microphoneId_="",void(this.microphoneGroupId_="");if(El){this.mediaStream_.getTracks().forEach(e=>{if(e.kind===At&&this.isAudioTrackMixed()){const e=this.getMicrophoneTrackMixed();if(e){const{deviceId:t,groupId:i}=e.getSettings();t&&(this.microphoneId_=t,this.microphoneGroupId_=i)}return}if(e.kind===Dt&&this.isVideoTrackBeautified()){const e=this.getBeautyOriginTrack();if(e){const{deviceId:t,groupId:i}=e.getSettings();t&&(this.cameraId_=t,this.cameraGroupId_=i)}return}const{deviceId:t,groupId:i}=e.getSettings();t&&(e.kind===At?(this.microphoneId_=t,this.microphoneGroupId_=i):e.kind!==Dt||this.screen_||(this.cameraId_=t,this.cameraGroupId_=i))})}const e=this.mediaStream_.getAudioTracks(),t=this.mediaStream_.getVideoTracks();e&&0===e.length&&(this.microphoneId_="",this.microphoneGroupId_=""),t&&0===t.length&&(this.cameraId_="",this.cameraGroupId_="")}isAudioTrackMixed(){if(mu.AudioMixerPlugin){const e=mu.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id))return!0}return!1}getMicrophoneTrackMixed(){if(mu.AudioMixerPlugin){const e=mu.AudioMixerPlugin.getAudioTrackMap(),t=this.getAudioTrack();if(e&&t&&e.has(t.id)){const i=e.get(t.id);return i.hasMicrophone?i.microphoneTrack:null}}return null}isVideoTrackBeautified(){if(mu.beautyTrackMap){const e=mu.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id))return!0}return!1}getBeautyOriginTrack(){if(mu.beautyTrackMap){const e=mu.beautyTrackMap,t=this.getVideoTrack();if(t&&e.has(t.id)){const i=e.get(t.id);if(i.originTrack)return i.originTrack}}return null}async generateBeautyTrack(e){let t=null;const i=this.getVideoTrack(),n=mu.beautyTrackMap.get(i.id),s=n.param;if(n.type)switch(n.type){case"beauty":t=n.pluginInstance.generateBeautyTrack(e);break;case"virtual":t=await n.pluginInstance.generateVirtualTrack({videoTrack:e,type:s.type,img:s.img});break;case"mixed":t=await n.pluginInstance.generateMixedTrack({videoTrack:e,type:s.type,img:s.img})}else t=n.pluginInstance.generateBeautyTrack(e);return n.pluginInstance.deleteSource(i.id),this.log_.info("regenerate beauty track, track id = "+e.id),t}getScreen(){return this.screen_}hasScreenTrack(){if(this.screen_)return!0;const e=this.getVideoTrack();return!!e&&(e.contentHint===Gt||e.contentHint===Jt)}getVideo(){return this.video_}getAudio(){return this.audio_}getCameraId(){return this.cameraId_}getMicrophoneId(){return this.microphoneId_}getMicrophoneGroupId(){return this.microphoneGroupId_}getIsReadyToPublish(){return this.isReadyToPublish_}setIsReadyToPublish(e){this.isReadyToPublish_=e}setPublishState(e){this.publishState_=e}setBeautyStatus(e){this.beautyStatus_=!!e}getBeautyStatus(){return this.beautyStatus_}onStreamPublished(e){const{localStream:t,client:i}=e;t===this&&(this.client_=i,this.log_.setUserId(i.getUserId()),this.log_.setSdkAppId(i.getSDKAppId()),this.syncMuteState())}syncMuteState(){const e=this.getAudioTrack(),t=this.getVideoTrack();if(e){const t=!e.enabled;this.setMuteState(At,t)}if(t){const e=!t.enabled;this.setMuteState(Dt,e)}this.connection_&&this.connection_.sendMutedFlag(this.muteState_)}keepMuteState(e){e instanceof MediaStreamTrack&&this.muteState_[e.kind]&&(e.enabled=!1,this.log_.warn(`prev ${e.kind} track is muted, keep mute state`))}async onVideoTrackStopped({stream:e,type:t}){if(e!==this||!this.video_||!this.cameraId_||this.recoverCaptureCount_>10||(Ee||be||ft)&&t===Ot)return;const i=this.getVideoTrack();if(i){const e=i.getSettings().deviceId;if((await mu.getCameras()).findIndex(t=>t.deviceId===e)<0)return}this.recoverCaptureCount_+=1,Fd.uploadEvent({log:"stat-local-video-"+t,userId:this.userId_}),this.updateStream({audio:!1,video:!0,cameraId:this.cameraId_})}async onAudioTrackStopped({stream:e,type:t}){if(e!==this||!this.audio_||!this.microphoneId_||this.recoverCaptureCount_>10||(Ee||be||ft)&&t===Ot)return;const i=this.getAudioTrack();if(i){const{groupId:e,deviceId:t}=i.getSettings();if((await mu.getMicrophones()).findIndex(i=>i.deviceId===t&&(qr(e)||e===i.groupId))<0)return}this.recoverCaptureCount_+=1,Fd.uploadEvent({log:"stat-local-audio-"+t,userId:this.userId_}),this.updateStream({audio:!0,video:!1,microphoneId:this.microphoneId_})}setAudioVolume(e){super.setAudioVolume(e)}clearCanvas(){this.canvasInterval_&&(Yd.clearInterval(this.canvasInterval_),this.canvasInterval_=-1,this.canvas_=null)}genCanvasTrack(e){this.log_.info("gen canvas track");const{width:t,height:i,frameRate:n}=e.getSettings();this.canvas_=document.createElement("canvas");const s=this.canvas_.getContext("2d");this.canvas_.width=t,this.canvas_.height=i,this.canvasInterval_=Yd.setInterval(()=>{if(this.hasVideo()){const e=this.getVideoTrack().getSettings();e.width===this.canvas_.width&&e.height===this.canvas_.height||(this.canvas_.width=e.width,this.canvas_.height=e.height)}this.videoPlayer_&&this.videoPlayer_.element_&&s.drawImage(this.videoPlayer_.element_,0,0,this.canvas_.width,this.canvas_.height)},Math.max(66,Math.floor(1e3/n)));return this.canvas_.captureStream().getVideoTracks()[0]}setClient(e){this.client_=e}setAudioCaptureVolume(e=100){if(!this.hasAudio()||e<0||!ll())return!1;if(this.captureVolume_===e)return!0;this.captureVolume_=e,this.log_.info("setCaptureVolume "+e),e/=100;const t=oo();if(this.gain_.gainNode)this.gain_.gainNode.gain.value=e;else{var i;const n=new MediaStream;n.addTrack(this.getAudioTrack());const s=t.createMediaStreamDestination(),r=t.createMediaStreamSource(n),o=t.createGain();o.gain.value=e,r.connect(o),o.connect(s);const a=s.stream.getAudioTracks()[0],c=e=>this.log_.info("gained audio track "+e);a.onmute=()=>c("muted"),a.onunmute=()=>c("unmuted"),a.onended=()=>c("ended"),this.gain_={source:r,audioTrack:a,gainNode:o},null===(i=this.connection_)||void 0===i||i.replaceTrack(a),super.restartAudio()}return!0}getGainedTrack(){return this.gain_.audioTrack}reconnectGainNode(e){this.log_.warn("reconnect gain node");const t=new MediaStream;t.addTrack(e);const i=oo().createMediaStreamSource(t);i.connect(this.gain_.gainNode),this.gain_.source.disconnect(),this.gain_.source=i}close(){const{audioTrack:e,source:t,gainNode:i}=this.gain_;i&&(t.disconnect(),i.disconnect(),e.onmute=null,e.onunmute=null,e.onended=null,e.stop(),this.gain_={source:null,gainNode:null,audioTrack:null}),super.close()}}).prototype,"switchDevice",[ou],Object.getOwnPropertyDescriptor(cu.prototype,"switchDevice"),cu.prototype),e(cu.prototype,"setAudioCaptureVolume",[au],Object.getOwnPropertyDescriptor(cu.prototype,"setAudioCaptureVolume"),cu.prototype),cu);var lu,hu,uu;let pu=0,_u=0;var mu=new(lu=oh(rh.TRTC.createClient),hu=oh(rh.TRTC.createStream),e((uu=class{constructor(){this.name_=En,this.VERSION="4.14.0",this.Logger={loggerManager:vc,LogLevel:Mn,setLogLevel(e){vc.setLogLevel(e),e<=1&&Vr()},enableUploadLog(){vc.enableUploadLog()},disableUploadLog(){vc.warn("disableUploadLog"),vc.disableUploadLog()}}}async checkSystemRequirements(){return await sl()}isScreenShareSupported(){return rl()}isSmallStreamSupported(){return Il()}async getDevices(){if(pl()||ul())return[];return(await navigator.mediaDevices.enumerateDevices()).filter(e=>e.kind!==jt||"communications"!=e.deviceId).map((e,t)=>{let i=e.label;e.label||(i=e.kind+"_"+t);const n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})}async getCameras(){if(pl()||ul())return[];return(await navigator.mediaDevices.enumerateDevices()).filter(e=>e.kind===Ht).map((e,t)=>{let i=e.label;e.label||(i="camera_"+t);const n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})}async getMicrophones(){if(pl()||ul())return[];return(await navigator.mediaDevices.enumerateDevices()).filter(e=>e.kind===jt&&"communications"!==e.deviceId).map((e,t)=>{let i=e.label;e.label||(i="microphone_"+t);const n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})}async getSpeakers(){if(pl()||ul())return[];return(await navigator.mediaDevices.enumerateDevices()).filter(e=>"audiooutput"===e.kind).map((e,t)=>{let i=e.label;e.label||(i="speaker_"+t);const n={label:i,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n})}createClient(e){Sc&&(Sc=!1,vc.getLogLevel()!=mu.Logger.LogLevel.NONE&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info("*   API Document: "+Nn+"index.html"),console.info("*   Changelog: https://cloud.tencent.com/document/product/647/38958"),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),vc.info("TRTC Web SDK Version: 4.14.0"),vc.info("UserAgent: "+navigator.userAgent),vc.info("URL of current page: "+location.href));const t={version:this.VERSION},i=new Zh({...t,...e,seq:++pu});return Ta.emit(xa,{client:i}),i}createStream(e){return new du({...e,seq:++_u})}}).prototype,"createClient",[lu],Object.getOwnPropertyDescriptor(uu.prototype,"createClient"),uu.prototype),e(uu.prototype,"createStream",[hu],Object.getOwnPropertyDescriptor(uu.prototype,"createStream"),uu.prototype),uu);export default mu;
